---
import specialites from "../data/specialites.json";
import villes from "../data/villes.json";

type Specialite = { slug: string; label: string };
type Ville = { slug: string; specialites?: string[] };

const url = (p: string) => (p.length > 1 ? p.replace(/\/+$/, "") : p);

interface Props {
  // slugs de spécialités à afficher (ex: ["droit-immobilier", "droit-des-affaires"])
  related?: string[];
  // optionnel : slug de ville courante (si présent, on pointe vers /specialites/<sp>/<ville> quand possible)
  ville?: string;
  // optionnel : titre du bloc
  title?: string;
  // optionnel : texte d’intro
  intro?: string;
  // limite d’items (par défaut 2)
  limit?: number;
}

const {
  related = [],
  ville,
  title = "Axes de travail fréquents",
  intro = "Quelques domaines sur lesquels nous structurons souvent la visibilité locale d’un cabinet :",
  limit = 2,
} = Astro.props;

const allSpecialites = specialites as Specialite[];
const allVilles = villes as Ville[];

const city = ville ? allVilles.find((v) => v.slug === ville) : undefined;
const cityAllowed = new Set(city?.specialites ?? []);

// on prend les spécialités demandées, existantes, et on limite
const selected = related
  .map((slug) => allSpecialites.find((s) => s.slug === slug))
  .filter(Boolean)
  .slice(0, limit) as Specialite[];

// construit la meilleure URL : /specialites/sp/ville si autorisé, sinon /specialites/sp
function spHref(spSlug: string) {
  if (ville && cityAllowed.size > 0 && cityAllowed.has(spSlug)) {
    return url(`/specialites/${spSlug}/${ville}`);
  }
  return url(`/specialites/${spSlug}`);
}

const shouldRender = selected.length > 0;
---

{shouldRender && (
  <section class="related-specialites">
    <h2>{title}</h2>
    <p>{intro}</p>
    <ul>
      {selected.map((sp) => (
        <li>
          <a href={spHref(sp.slug)}>{sp.label}</a>
        </li>
      ))}
    </ul>
  </section>
)}