---
// src/components/Testimonails.astro
import ui from "../data/ui.json";

type ProofItem = {
  quote: string;
  author?: string;
  meta?: string;
  icon?: string;
};

type ProofBlock = {
  enabled?: boolean;
  title?: string;
  intro?: string;
  cta?: { label: string; href: string };
  note?: string;
  items?: ProofItem[];
  background?: string;
};

interface Props {
  variant?: "home" | "service" | "local" | "ads" | string;
}

const { variant = "home" } = Astro.props as Props;

const proofRoot = (ui as any)?.proof as ProofBlock & { variants?: Record<string, ProofBlock> };

const enabledGlobal = proofRoot?.enabled ?? true;
const background = proofRoot?.background ?? "#f1f3f7";

// Variante demandée (si elle existe)
const v = proofRoot?.variants?.[variant] as ProofBlock | undefined;

// Contenu final (fallbacks)
const title = v?.title ?? proofRoot?.title ?? "Retours de mission (anonymisés)";
const intro = v?.intro ?? proofRoot?.intro ?? "";
const cta = v?.cta ?? proofRoot?.cta;
const note = v?.note ?? proofRoot?.note ?? "";
const items: ProofItem[] = (v?.items?.length ? v.items : proofRoot?.items) ?? [];

const shouldRender = enabledGlobal && items.length > 0;
---

{shouldRender && (
  <div class="section py-6 mb-0" style={`background-color: ${background}`}>
    <div class="container">
      <div class="row justify-content-between align-items-center col-mb-30">

        <div class="col-lg-4">
          <div class="d-flex mb-2">
            <i class="bi-star-fill h5 me-1 text-warning"></i>
            <i class="bi-star-fill h5 me-1 text-warning"></i>
            <i class="bi-star-fill h5 me-1 text-warning"></i>
            <i class="bi-star-fill h5 me-1 text-warning"></i>
            <i class="bi-star-fill h5 me-1 text-warning"></i>
          </div>
          <h2 class="h3 font-secondary fw-bold mb-4">{title}</h2>
          {intro && <p class="lead op-08">{intro}</p>}

          {cta && (
            <a href={cta.href} class="btn py-3 px-4 mt-3 rounded-1 btn-dark bg-color h-op-09">
              {cta.label}
            </a>
          )}

          {note && <div class="small op-06 mt-3">{note}</div>}
        </div>

        <div class="col-lg-7">
          <div class="row row-cols-1 row-cols-md-2 g-4 align-items-stretch">
            {items.map((it) => (
              <div class="col">
                <div class="card rounded-6 overflow-hidden h-100">
                  <div class="card-body p-4 d-flex flex-column">
                    <p class="mb-4 font-secondary flex-grow-1">“{it.quote}”</p>

                    <div class="d-flex align-items-center justify-content-between">
                      <div>
                        {it.author && <h3 class="h6 mb-0 fw-medium">{it.author}</h3>}
                        {it.meta && <small class="text-muted">{it.meta}</small>}
                      </div>

                      <span class="material-symbols-outlined op-06">
                        {it.icon ?? "format_quote"}
                      </span>
                    </div>
                  </div>
                  <div class="bg-icon bi-star-fill op-02"></div>
                </div>
              </div>
            ))}
          </div>
        </div>

      </div>
    </div>
  </div>
)}