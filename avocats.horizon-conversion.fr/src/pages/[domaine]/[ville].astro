---
import Layout from "../../components/Layout.astro";
import CTA from "../../components/CTA.astro";
import FAQAccordion from "../../components/FAQAccordion.astro";

import domaines from "../../data/domaines.json";
import villes from "../../data/villes.json";

import { buildTitle, metaDescription } from "../../lib/seo";

export function getStaticPaths() {
  // ✅ zéro variable externe → zéro “is not defined”
  const enabledDepts = ["60", "95"];
  // option : limiter les domaines
  const enabledDomainSlugs = domaines.map((d) => d.slug); // ou ["divorce","prudhommes","penal"]

  const enabledVilles = villes.filter((v) => enabledDepts.includes(v.departement));
  const enabledDomaines = domaines.filter((d) => enabledDomainSlugs.includes(d.slug));

  return enabledDomaines.flatMap((d) =>
    enabledVilles.map((v) => ({
      params: { domaine: d.slug, ville: v.slug },
      props: { d, v },
    }))
  );
}

const { d, v } = Astro.props;

// SEO
const title = buildTitle([`${d.nom} à ${v.nom}`, "SEO local & prise de contact", "Horizon Conversion"]);
const description = metaDescription(
  `Accompagnement webmarketing pour cabinets d’avocats (${d.nom.toLowerCase()}) à ${v.nom} : structure SEO local, pages utiles, suivi des demandes et optimisation conversion.`
);

// Breadcrumbs (UI + Schema)
const crumbs = [
  { name: "Accueil", url: "/" },
  { name: d.nom, url: `/domaines/${d.slug}` },
  { name: v.nom, url: `/villes/${v.slug}` },
  { name: `${d.nom} à ${v.nom}`, url: `/${d.slug}/${v.slug}` },
];

// FAQ locale + FAQ domaine
const localFaq = [
  {
    q: `Faut-il une page dédiée "${d.nom} ${v.nom}" ?`,
    a: `Souvent oui, si elle apporte une information utile (périmètre, accès, organisation) et s’intègre à une structure cohérente (domaine + ville).`,
  },
  {
    q: `Comment mesurer les demandes depuis Google à ${v.nom} ?`,
    a: `On suit les formulaires (source/UTM), les clics d’appel, et on relie les pages consultées au parcours de contact.`,
  },
];

const faqItems = [...(d.faq ?? []), ...localFaq];

// Schema.org JSON-LD
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: crumbs.map((c, idx) => ({
    "@type": "ListItem",
    position: idx + 1,
    name: c.name,
    item: new URL(c.url, Astro.url.origin).toString(),
  })),
};

const faqSchema = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  mainEntity: faqItems.map((it) => ({
    "@type": "Question",
    name: it.q,
    acceptedAnswer: { "@type": "Answer", text: it.a },
  })),
};
---
<Layout title={title} description={description}>
  <script type="application/ld+json">{JSON.stringify(breadcrumbSchema)}</script>
  <script type="application/ld+json">{JSON.stringify(faqSchema)}</script>

  <section>
    <nav aria-label="Fil d’Ariane">
      <ol>
        {crumbs.map((c, i) => (
          <li>
            {i < crumbs.length - 1 ? <a href={c.url}>{c.name}</a> : <span aria-current="page">{c.name}</span>}
          </li>
        ))}
      </ol>
    </nav>

    <h1>{d.nom} à {v.nom} : visibilité Google et prise de contact</h1>
    <p>
      Page d’information dédiée à la structuration SEO locale pour cabinets d’avocats à {v.nom} (dépt. {v.departement}).
      Objectif : pages claires, navigation cohérente et suivi des prises de contact.
    </p>

    <div class="grid">
      <div>
        <h2>Ce qu’on met en place</h2>
        <ul>
          <li>Pages service + pages locales structurées (domaine → ville → contact)</li>
          <li>Contenus utiles (FAQ + explications) plutôt que volume</li>
          <li>Suivi des demandes : formulaires, clics d’appel, sources (UTM)</li>
        </ul>
      </div>

      <div>
        <h2>Pour {v.nom} : focus local</h2>
        <ul>
          <li>Clarifier le périmètre (zone couverte, accès, modalités de RDV)</li>
          <li>Maillage interne cohérent entre pages domaine et ville</li>
          <li>Méthode + livrables + délais (sans promesse)</li>
        </ul>
      </div>
    </div>

    <CTA
      label={`Demander un audit visibilité (${d.nom} • ${v.nom})`}
      href={`/contact?domaine=${d.slug}&ville=${v.slug}`}
    />

    <p>
      Voir aussi : <a href={`/domaines/${d.slug}`}>{d.nom}</a> • <a href={`/villes/${v.slug}`}>{v.nom}</a>
    </p>
  </section>

  <section>
    <h2>Questions fréquentes</h2>
    <FAQAccordion items={faqItems} />
  </section>
</Layout>

<style>
  nav ol{display:flex;gap:8px;list-style:none;padding:0;flex-wrap:wrap}
  nav li::after{content:"›";margin-left:8px}
  nav li:last-child::after{content:""}
  .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
</style>