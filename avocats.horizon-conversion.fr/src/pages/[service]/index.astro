---
// src/pages/[service]/index.astro
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Hero from "../../components/Hero.astro";
import Services from "../../components/Services.astro";
import RelatedSpecialites from "../../components/RelatedSpecialites.astro";
import Contact from "../../components/Contact.astro";
import Testimonails from "../../components/Testimonails.astro";
import Faqs from "../../components/Faqs.astro";
import ZonesGrid from "../../components/ZonesGrid.astro";
import Reassurance from "../../components/Reassurance.astro";
import NextSteps from "../../components/NextSteps.astro";
import Promo from "../../components/Promo.astro";
import Footer from "../../components/Footer.astro";

import ui from "../../data/ui.json";
import services from "../../data/services.json";
import villes from "../../data/villes.json";

import { href, canonicalUrl } from "../../lib/href";

type Service = {
  slug: string;
  label: string;
  hubTitle?: string;
  hubDesc?: string;
  titleTpl?: string;
  descTpl?: string;

  relatedSpecialites?: string[];
  relatedTitle?: string;
  relatedIntro?: string;

  faqTitle?: string;
  faqIntro?: string;
  faqIntroHub?: string;
  faqs?: { q: string; a: string }[];
  reassuranceVariant?: string;
};
type Ville = { slug: string; name: string; dept?: string; regionHint?: string; services?: string[] };

const SITE = "https://avocats.horizon-conversion.fr";

export async function getStaticPaths() {
  return (services as Service[]).map((s) => ({
    params: { service: s.slug },
  }));
}

const { service: serviceSlug } = Astro.params;

const service = (services as Service[]).find((s) => s.slug === serviceSlug);
if (!service) throw new Error(`Service inconnu: ${serviceSlug}`);

const canonical = canonicalUrl(SITE, `/${service.slug}`);

const villesOk = (villes as Ville[]).filter((v) => !v.services?.length || v.services.includes(service.slug));

const title = service.hubTitle ?? `${service.label} pour cabinets d’avocats`;
const description =
  service.hubDesc ??
  `Intervention Sud Oise & Nord 95 : ${service.label}, orienté demandes qualifiées (appel + formulaire), approche sobre et conforme.`;

const hero = {
  ...ui.hero.defaultInner,
  eyebrow: `Horizon Conversion — ${service.label}`,
  title: service.hubTitle ?? `${service.label} pour cabinets d’avocats`,
  subtitle: service.hubDesc ?? description,
  primaryCta: { label: "Demander un audit", href: "/contact/" },
  secondaryCta: { label: "Voir les packs", href: "/offres/" }
};

const hrefForCity = (c: Ville) => href("/" + service.slug + "/" + c.slug);

const renderCityLabel = (c: Ville) =>
  service.label + " à " + c.name + (c.dept ? ` (${c.dept})` : "");

const forced = Astro.url.searchParams.get("reassurance"); // ex: seo | refonte | tracking | ads | service
const reassuranceVariant = forced ?? (service as any).reassuranceVariant ?? "service";
---

<BaseLayout title={title} description={description} canonical={canonical}>

  <Header />

  <Hero {...hero} />

  <!-- Content
  ============================================= -->
  <section id="content">
  	<div class="content-wrap overflow-visible py-0">

  	  <Services />

        <RelatedSpecialites
          related={service.relatedSpecialites}
          title={service.relatedTitle}
          intro={service.relatedIntro}
          limit={2}
        />

        <ZonesGrid
          badge="Zone"
          title="Villes couvertes"
          intro="Sélection de pages locales utiles (pas de surproduction). Cliquez pour voir la page dédiée."
          cities={villesOk}
          hrefFor={hrefForCity}
          renderLabel={renderCityLabel}
          columns={2}
        />

        <Testimonails variant={service.slug === "google-ads" ? "ads" : "service"} />

        <Faqs
          title={service.faqTitle}
          intro={service.faqIntroHub ?? service.faqIntro}
          items={(service.faqs ?? []).slice(0, 4)}
          canonical={canonical}
        />

        <Contact />

        <Reassurance variant={reassuranceVariant} />

        <NextSteps
          badge="Suite"
          title="Pour aller plus loin"
          intro="Deux pages utiles pour cadrer le budget et la méthode."
          cards={[
            { title: "Voir les packs", desc: "Comparer les options et les livrables, simplement.", href: "/offres/" },
            { title: "Comprendre la méthode", desc: "Priorités, déroulé, et cadre de collaboration.", href: "/methode/" }
          ]}
        />

        <Promo variant={service.slug === "google-ads" ? "ads" : "service"} />

  	</div>
  </section><!-- #content end -->

  <Footer />

</BaseLayout>