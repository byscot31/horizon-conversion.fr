---
// src/pages/[service]/[ville].astro
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Hero from "../../components/Hero.astro";
import Services from "../../components/Services.astro";
import Testimonails from "../../components/Testimonails.astro";
import ScopeCards from "../../components/ScopeCards.astro";
import RelatedSpecialites from "../../components/RelatedSpecialites.astro";
import Contact from "../../components/Contact.astro";
import Faqs from "../../components/Faqs.astro";
import OtherServicesGrid from "../../components/OtherServicesGrid.astro";
import Reassurance from "../../components/Reassurance.astro";
import LinkedPages from "../../components/LinkedPages.astro";
import Promo from "../../components/Promo.astro";
import Footer from "../../components/Footer.astro";

import ui from "../../data/ui.json";
import services from "../../data/services.json";
import villes from "../../data/villes.json";

type Service = {
  slug: string;
  label: string;
  hubTitle?: string;
  hubDesc?: string;
  titleTpl?: string;
  descTpl?: string;

  relatedSpecialites?: string[];
  relatedTitle?: string;
  relatedIntro?: string;

  faqTitle?: string;
  faqIntroHub?: string;
  faqIntroLocalTpl?: string;
  faqs?: { q: string; a: string }[];

  localFaqsTpl?: { qTpl: string; aTpl: string }[];
};
type Ville = {
  slug: string;
  name: string;
  dept?: string;
  regionHint?: string;
  services?: string[]; // matrice de services autorisés
};

const SITE = "https://avocats.horizon-conversion.fr";
const url = (p: string) => (p.length > 1 ? p.replace(/\/+$/, "") : p);

function tpl(s: string, vars: Record<string, string>) {
  return s.replace(/\{(\w+)\}/g, (_, k) => vars[k] ?? "");
}

export async function getStaticPaths() {
  const svc = services as Service[];
  const vls = villes as Ville[];

  return vls.flatMap((v) => {
    const allowed = new Set(v.services ?? []);
    return svc
      .filter((s) => allowed.size === 0 || allowed.has(s.slug))
      .map((s) => ({ params: { service: s.slug, ville: v.slug } }));
  });
}

const { service: serviceSlug, ville: villeSlug } = Astro.params;

const service = (services as Service[]).find((s) => s.slug === serviceSlug);
const ville = (villes as Ville[]).find((v) => v.slug === villeSlug);

if (!service || !ville) throw new Error(`Route invalide: ${serviceSlug}/${villeSlug}`);
if (ville.services?.length && !ville.services.includes(service.slug)) {
  throw new Error(`Page non autorisée (matrice): ${service.slug}/${ville.slug}`);
}

const pageTitle = service.titleTpl
  ? tpl(service.titleTpl, { ville: ville.name })
  : `${service.label} pour cabinets d’avocats à ${ville.name}`;

const pageDesc = service.descTpl
  ? tpl(service.descTpl, { ville: ville.name })
  : `Prestation ${service.label} pour cabinets d’avocats à ${ville.name}.`;

const canonical = url(`${SITE}/${service.slug}/${ville.slug}`);

const otherServices = (services as Service[])
  .filter((s) => s.slug !== service.slug)
  .filter((s) => !ville.services?.length || ville.services.includes(s.slug));

const objectiveByService: Record<string, string> = {
  "referencement-local": "Objectif : renforcer la visibilité locale du cabinet et faciliter la prise de contact.",
  "refonte-site": "Objectif : un site clair et rassurant, conçu pour faciliter la prise de contact et soutenir la visibilité locale.",
  "optimisation-parcours-contact": "Objectif : améliorer concrètement le parcours menant à l’appel et au formulaire.",
  "mesure-demandes": "Objectif : suivre clairement l’origine des demandes et piloter avec des indicateurs simples.",
  "google-ads": "Objectif : option d’accélération, uniquement si le dispositif est prêt et cadré."
};

const zone = ville.regionHint ? `${ville.regionHint} — ${ville.name}` : ville.name;

const localFaqs = (service.localFaqsTpl ?? []).map((it: any) => ({
  q: tpl(it.qTpl, { ville: ville.name, zone }),
  a: tpl(it.aTpl, { ville: ville.name, zone })
}));

const faqIntroLocal = service.faqIntroLocalTpl
  ? tpl(service.faqIntroLocalTpl, { ville: ville.name, zone })
  : service.faqIntroHub;

const hero = {
  ...ui.hero.defaultInner,
  eyebrow: `${service.label} — ${zone}`,
  title: service.titleTpl ? tpl(service.titleTpl, { ville: ville.name }) : pageTitle,
  subtitle: service.descTpl ? tpl(service.descTpl, { ville: ville.name }) : pageDesc,
  primaryCta: { label: "Demander un audit", href: "/contact" },
  secondaryCta: { label: "Voir les packs", href: "/offres" }
};

const otherServicesForGrid = otherServices.map((s) => ({ slug: s.slug, label: s.label }));

const hubServiceHref = url("/" + service.slug);

const hubServiceDesc = service.label + " — pages locales";
---

<BaseLayout title={pageTitle} description={pageDesc} canonical={canonical}>

  <Header />

  <Hero {...hero} />

  <!-- Content
  ============================================= -->
  <section id="content">
  	<div class="content-wrap overflow-visible py-0">

  	<Services />

  	<ScopeCards serviceSlug={service.slug} />

    <RelatedSpecialites
      related={service.relatedSpecialites}
      ville={villeSlug}
      title={service.relatedTitle}
      intro={service.relatedIntro}
      limit={2}
    />

  	<Testimonails variant={service.slug === "google-ads" ? "ads" : "local"} />

    <Faqs
      title={service.faqTitle}
      intro={faqIntroLocal}
      items={[...(service.faqs ?? []).slice(0, 4), ...localFaqs]}
      canonical={canonical}
    />

    <Contact />

    <OtherServicesGrid
      villeName={ville.name}
      villeSlug={ville.slug}
      services={otherServicesForGrid}
    />

    <Reassurance />

    <LinkedPages
      cards={[
        { title: "Toutes les villes", desc: hubServiceDesc, href: hubServiceHref },
        { title: "Découvrir les packs", desc: "Options et livrables", href: "/offres" },
        { title: "Comprendre la méthode", desc: "Déroulé et cadre", href: "/methode" }
      ]}
    />

    <Promo />

  </section><!-- #content end -->

  <Footer />

</BaseLayout>