---
import villes from "../data/villes.json";
import metiers from "../data/metiers.json";

/**
 * PopularCombos.astro (client-first)
 * Affiche :
 * - un bloc "Accès rapide" : villes principales × métiers (liens Ville → Métier)
 * - + un <details> pour accéder à toutes les villes sans rendre la page illisible
 */

const {
  title = "Accès rapide : trouver un artisan près de chez vous",
  subtitle = "Choisis ta ville, puis le métier (plomberie, électricité, serrurerie…). Devis gratuit, réponse rapide.",
  limitVilles = 6,
  limitMetiers = 6,
  topVillePriority = "A", // tri interne : "A" recommandé
  showAllToggle = true,
  allToggleLabel = "Voir toutes les villes",
  ctaDevisHref = "/contact/",
  ctaDevisLabel = "Demander un devis",
  showCityCta = true,
} = Astro.props;

const byNameFR = (a, b) => String(a.name).localeCompare(String(b.name), "fr");

// Tri interne : A d’abord puis nom (mais on ne l’affiche pas côté user)
const byPrioThenName = (a, b) => {
  const ap = String(a.priority || "");
  const bp = String(b.priority || "");
  if (ap !== bp) return ap === "A" ? -1 : 1;
  return byNameFR(a, b);
};

const allMetiers = [...metiers].sort(byNameFR);

// TOP villes : seulement A (ou prio fournie) + limite
const topVilles = [...villes]
  .filter((v) => !topVillePriority || v.priority === topVillePriority)
  .sort(byNameFR)
  .slice(0, limitVilles);

const topMetiers = allMetiers.slice(0, limitMetiers);

// ALL villes : tri interne A puis B, groupé par zone
const allVilles = [...villes].sort(byPrioThenName);

const zones = [
  { key: "sud-oise", label: "Sud Oise (60)" },
  { key: "nord-95", label: "Nord 95" },
];

const villesByZone = (zoneKey) => allVilles.filter((v) => v.zone === zoneKey);
---

<section class="section m-0">
  <div class="container">
    <div class="heading-block border-bottom-0 text-center mb-4">
      <div class="badge rounded-pill badge-default">Accès rapide</div>
      <h2 class="text-transform-none ls-0">{title}</h2>
      <p class="text-muted mb-0">{subtitle}</p>
    </div>

    <!-- TOP COMBOS : villes principales × métiers -->
    <div class="row g-3">
      {topVilles.map((v) => (
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm">
            <div class={`card-body p-4 ${v.priority === "A" ? "border border-2 rounded-3" : ""}`}>
              <div class="d-flex justify-content-between align-items-start">
                <h3 class="h6 mb-1">{v.name}</h3>
                <span class="badge bg-light text-dark">{v.dept}</span>
              </div>

              <p class="small text-muted mb-3">
                Dépannage & travaux à {v.name} : choisis le métier ci-dessous.
              </p>

              <div class="d-flex flex-wrap gap-2 mb-3">
                {showCityCta && (
                  <a class="btn btn-outline-secondary btn-sm" href={`/villes/${v.slug}/`}>
                    Voir {v.name}
                  </a>
                )}
                <a class="btn btn-outline-primary btn-sm" href={ctaDevisHref}>
                  {ctaDevisLabel}
                </a>
              </div>

              <div class="small fw-semibold mb-2">Choisir le métier</div>
              <div class="d-flex flex-wrap gap-2">
                {topMetiers.map((m) => (
                  <a
                    class="btn btn-sm btn-outline-secondary"
                    href={`/villes/${v.slug}/${m.slug}/`}
                    aria-label={`${m.name} à ${v.name} — devis gratuit`}
                    title={`${m.name} à ${v.name}`}
                  >
                    {m.name}
                  </a>
                ))}
              </div>

              <div class="small text-muted mt-3">
                Exemples : “{topMetiers[0]?.name} {v.name}”, “dépannage {topMetiers[1]?.name?.toLowerCase()} {v.name}”.
              </div>
            </div>
          </div>
        </div>
      ))}
    </div>

    {showAllToggle && (
      <div class="mt-4">
        <details class="card shadow-sm">
          <summary class="card-body p-4" style="cursor: pointer;">
            <span class="fw-semibold">{allToggleLabel}</span>
            <span class="text-muted small ms-2">— si ta ville n’est pas dans la liste</span>
          </summary>

          <div class="card-body pt-0 px-4 pb-4">
            <div class="row g-3">

              {zones.map((z) => {
                const vz = villesByZone(z.key);
                if (!vz.length) return null;

                return (
                  <div class="col-12">
                    <div class="small text-uppercase ls-1 fw-bold text-muted mt-2 mb-2">
                      {z.label}
                    </div>

                    <div class="row g-3">
                      {vz.map((v) => (
                        <div class="col-md-6 col-lg-4">
                          <details class="card h-100 shadow-sm">
                            <summary class="card-body p-3" style="cursor: pointer;">
                              <div class="d-flex justify-content-between align-items-start">
                                <span class="fw-semibold">{v.name}</span>
                                <span class="badge bg-light text-dark">{v.dept}</span>
                              </div>
                              <div class="small text-muted mt-1">Ouvre pour choisir le métier</div>
                            </summary>

                            <div class="card-body pt-0 px-3 pb-3">
                              <div class="d-flex flex-wrap gap-2 mb-2">
                                {showCityCta && (
                                  <a class="btn btn-outline-secondary btn-sm" href={`/villes/${v.slug}/`}>
                                    Voir {v.name}
                                  </a>
                                )}
                                <a class="btn btn-outline-primary btn-sm" href={ctaDevisHref}>
                                  {ctaDevisLabel}
                                </a>
                              </div>

                              <div class="d-flex flex-wrap gap-2">
                                {allMetiers.map((m) => (
                                  <a
                                    class="btn btn-sm btn-outline-secondary"
                                    href={`/villes/${v.slug}/${m.slug}/`}
                                    aria-label={`${m.name} à ${v.name} — devis gratuit`}
                                    title={`${m.name} à ${v.name}`}
                                  >
                                    {m.name}
                                  </a>
                                ))}
                              </div>
                            </div>
                          </details>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}

            </div>
          </div>
        </details>
      </div>
    )}
  </div>
</section>
