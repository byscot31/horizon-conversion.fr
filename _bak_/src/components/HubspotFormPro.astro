---
// src/components/HubspotFormPro.astro
const {
  title = "Diagnostic gratuit (15 min)",
  subtitle = "Décrivez votre objectif : je vous réponds sous 24h ouvrées.",
  submitLabel = "Envoyer ma demande",
  consentText = "En soumettant, vous acceptez d’être recontacté afin de traiter votre demande.",
  // optionnel : override si besoin
  portalId: portalIdProp,
  formId: formIdProp,
  // IMPORTANT : HubSpot attend parfois des noms internes (ex: 0-2/phone)
  hsPhoneName = "0-2/phone",
} = Astro.props;

const portalId =
  portalIdProp ??
  import.meta.env.PUBLIC_HUBSPOT_PORTAL_ID ??
  "147409378";

const formId =
  formIdProp ??
  import.meta.env.PUBLIC_HUBSPOT_FORM_ID_PRO ??
  "6d118aa7-ff18-4747-b66a-fb6df88b5c4a";

if (!portalId || !formId) {
  console.warn("[HubspotFormPro] portalId/formId manquants.");
}

// IDs uniques (évite collisions si plusieurs forms sur une page)
const uid = `hspro-${String(formId).slice(0, 8)}-${Math.random().toString(16).slice(2, 8)}`;
---

<div class="card shadow-sm">
  <div class="card-body p-4">
    <h3 class="h5 mb-1">{title}</h3>
    <p class="small text-muted mb-3">{subtitle}</p>

    <div class="form-result alert" hidden></div>

    <form class="js-hs-pro-form" novalidate data-hs-uid={uid}>
      <div class="row g-3">

        <div class="col-md-6">
          <label class="form-label" for={`${uid}-lastname`}>Nom *</label>
          <input id={`${uid}-lastname`} name="lastname" class="form-control" autocomplete="family-name" required />
        </div>

        <div class="col-md-6">
          <label class="form-label" for={`${uid}-firstname`}>Prénom *</label>
          <input id={`${uid}-firstname`} name="firstname" class="form-control" autocomplete="given-name" required />
        </div>

        <div class="col-md-6">
          <label class="form-label" for={`${uid}-email`}>Email *</label>
          <input id={`${uid}-email`} name="email" type="email" class="form-control" autocomplete="email" required />
        </div>

        <div class="col-md-6">
          <label class="form-label" for={`${uid}-phone`}>Téléphone *</label>
          <input id={`${uid}-phone`} name="phone" class="form-control" autocomplete="tel" required />
        </div>

        <div class="col-md-6">
          <label class="form-label" for={`${uid}-company`}>Entreprise</label>
          <input id={`${uid}-company`} name="company" class="form-control" autocomplete="organization" />
        </div>

        <div class="col-md-6">
          <label class="form-label" for={`${uid}-website`}>Site web</label>
          <input id={`${uid}-website`} name="website" class="form-control" type="url" autocomplete="url" />
        </div>

        <div class="col-12">
          <label class="form-label" for={`${uid}-message`}>Objectif principal *</label>
          <textarea
            id={`${uid}-message`}
            name="message"
            class="form-control"
            rows="4"
            required
            placeholder="Ex : Plus d’appels, plus de demandes, visibilité locale Google/Maps, améliorer la conversion…"></textarea>
        </div>

        <!-- Hidden tracking (à conserver uniquement si ces champs existent dans le form HubSpot) -->
        <input type="hidden" name="utm_source" />
        <input type="hidden" name="utm_medium" />
        <input type="hidden" name="utm_campaign" />
        <input type="hidden" name="utm_term" />
        <input type="hidden" name="utm_content" />
        <input type="hidden" name="source_page" />
        <input type="hidden" name="referrer" />

        <!-- Honeypot -->
        <div style="position:absolute;left:-5000px;" aria-hidden="true">
          <label for={`${uid}-hp`}>Website</label>
          <input id={`${uid}-hp`} name="hs_website" tabindex="-1" autocomplete="off" />
        </div>

        <div class="col-12">
          <button class="button button-rounded w-100 text-transform-none ls-0 m-0 js-submit" type="submit">
            {submitLabel}
          </button>
          <div class="small text-muted mt-2">{consentText}</div>
        </div>

      </div>
    </form>
  </div>
</div>

<script is:inline define:vars={{ portalId, formId, consentText, hsPhoneName }}>
  const qs = (sel, root=document) => root.querySelector(sel);

  function getCookie(name) {
    const v = `; ${document.cookie}`;
    const parts = v.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
    return "";
  }

  function persistUtm(params) {
    const keys = ["utm_source","utm_medium","utm_campaign","utm_term","utm_content"];
    const hasAny = keys.some(k => params.get(k));
    const storeKey = "hc_utm";

    if (hasAny) {
      const payload = {};
      keys.forEach(k => payload[k] = params.get(k) || "");
      localStorage.setItem(storeKey, JSON.stringify(payload));
      return payload;
    }

    try { return JSON.parse(localStorage.getItem(storeKey) || "{}"); }
    catch { return {}; }
  }

  function setHidden(form) {
    const params = new URLSearchParams(window.location.search);
    const utm = persistUtm(params);

    const set = (name, value) => {
      const el = form.querySelector(`[name="${name}"]`);
      if (el) el.value = value || "";
    };

    set("utm_source", utm.utm_source || "");
    set("utm_medium", utm.utm_medium || "");
    set("utm_campaign", utm.utm_campaign || "");
    set("utm_term", utm.utm_term || "");
    set("utm_content", utm.utm_content || "");
    set("source_page", window.location.href);
    set("referrer", document.referrer || "");
  }

  function getResultBox(form) {
    return form.closest(".card")?.querySelector(".form-result");
  }

  // Mapping minimal : HubSpot attend parfois un nom interne (ex: 0-2/phone)
  function mapFieldName(name) {
    if (name === "phone") return hsPhoneName; // ✅ fix principal
    return name;
  }

  async function submitToHubSpot(form) {
    const result = getResultBox(form);
    const btn = qs(".js-submit", form);

    // Honeypot
    const hp = form.querySelector('[name="hs_website"]');
    if (hp && hp.value) return;

    const data = new FormData(form);

    // Validation minimale
    const required = ["firstname","lastname","email","phone","message"];
    const ok = required.every((r) => String(data.get(r) || "").trim());
    if (!ok) {
      if (result) {
        result.hidden = false;
        result.className = "form-result alert alert-danger";
        result.textContent = "Merci de remplir les champs obligatoires.";
      }
      return;
    }

    const fields = [];
    for (const [name, value] of data.entries()) {
      if (name === "hs_website") continue;

      const hsName = mapFieldName(name);
      fields.push({ name: hsName, value: String(value ?? "") });
    }

    const hutk = getCookie("hubspotutk");

    // Endpoint Forms v3 legacy (unauthenticated)
    const endpoint = `https://api.hsforms.com/submissions/v3/integration/submit/${portalId}/${formId}`; // :contentReference[oaicite:1]{index=1}

    const payload = {
      submittedAt: Date.now(),
      fields,
      context: {
        pageUri: window.location.href,
        pageName: document.title,
        hutk: hutk || undefined,
      },
      legalConsentOptions: {
        consent: {
          consentToProcess: true,
          text: consentText,
          communications: []
        }
      }
    };

    if (btn) btn.disabled = true;
    if (result) {
      result.hidden = false;
      result.className = "form-result alert alert-info";
      result.textContent = "Envoi en cours…";
    }

    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        // HubSpot renvoie souvent un JSON stringifié dans txt
        throw new Error(txt || `HTTP ${res.status}`);
      }

      form.reset();
      setHidden(form);

      if (result) {
        result.hidden = false;
        result.className = "form-result alert alert-success";
        result.textContent = "✅ Demande envoyée. Je vous recontacte rapidement.";
      }
    } catch (e) {
      console.error("[HubspotFormPro] submit error:", e);
      if (result) {
        result.hidden = false;
        result.className = "form-result alert alert-danger";
        result.textContent = "❌ Erreur d’envoi. Veuillez réessayer ou me contacter directement.";
      }
    } finally {
      if (btn) btn.disabled = false;
    }
  }

  function bindAllForms() {
    document.querySelectorAll("form.js-hs-pro-form").forEach((form) => {
      if (form.dataset.hsBound === "1") return;
      form.dataset.hsBound = "1";

      setHidden(form);

      form.addEventListener("submit", (ev) => {
        ev.preventDefault();
        submitToHubSpot(form);
      });
    });
  }

  bindAllForms();
  document.addEventListener("DOMContentLoaded", bindAllForms);
  document.addEventListener("astro:page-load", bindAllForms);
</script>
