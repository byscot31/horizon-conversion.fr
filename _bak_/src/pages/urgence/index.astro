---
import Layout from "@layouts/Layout.astro";
import MainMenu from "@components/MainMenu.astro";
import HubspotCustomForm from "@components/HubspotCustomForm.astro";

import villes from "@data/villes.json";
import metiers from "@data/metiers.json";
import services from "@data/services.json";

const SITE_URL =
  import.meta.env.PUBLIC_SITE_URL ??
  (Astro.site ? Astro.site.toString().replace(/\/$/, "") : "");

const BRAND = import.meta.env.PUBLIC_BRAND_NAME ?? "Horizon Conversion";
const REGION = import.meta.env.PUBLIC_REGION_LABEL ?? "Sud Oise (60) / Nord 95";
const PHONE = import.meta.env.PUBLIC_PHONE ?? "+33660921008";
const PHONE_DISPLAY = import.meta.env.PUBLIC_PHONE_DISPLAY ?? PHONE;

const telHref = `tel:${String(PHONE).replace(/\s+/g, "")}`;

const canonical = "/urgence/";

const title = `Urgence d√©pannage ‚Äî Plombier / √âlectricien / Serrurier | ${REGION} | ${BRAND}`;
const description =
  `Urgence d√©pannage √† domicile (${REGION}) : fuite d‚Äôeau, panne √©lectrique, porte claqu√©e, d√©g√¢t des eaux‚Ä¶ ` +
  `Appel rapide, diagnostic clair, prix annonc√© avant intervention.`;

const villesA = [...villes]
  .filter((v) => v.priority === "A")
  .sort((a, b) => String(a.name).localeCompare(String(b.name), "fr"));

const defaultCitySlug =
  villesA.find((v) => v.slug === "senlis")?.slug ?? villesA[0]?.slug ?? "senlis";

const defaultCity = villesA.find((v) => v.slug === defaultCitySlug) ?? villesA[0];

const urgentServices = [...services]
  .filter(
    (s) =>
      String(s.intent || "").toLowerCase() === "urgence" ||
      String(s.urgency || "").toLowerCase() === "24-7"
  )
  .sort(
    (a, b) =>
      (Number(a.order ?? 999) - Number(b.order ?? 999)) ||
      String(a.name).localeCompare(String(b.name), "fr")
  );

const getMetierName = (slug) => metiers.find((m) => m.slug === slug)?.name ?? slug;

const topCitiesList = villesA.slice(0, 8).map((v) => v.name).join(", ");

// FAQ (ton "vous")
const faq = [
  {
    q: "Intervenez-vous vraiment en urgence ?",
    a: "Oui, selon disponibilit√©. Le plus simple est d‚Äôappeler : nous confirmons le d√©lai et nous vous indiquons quoi faire imm√©diatement en attendant."
  },
  {
    q: "Quels types d‚Äôurgences prenez-vous en charge ?",
    a: "Les urgences courantes √† domicile : fuite d‚Äôeau / d√©g√¢t des eaux, panne √©lectrique, porte claqu√©e / serrure, probl√®me de chauffe-eau ou chauffage (selon √©quipement)."
  },
  {
    q: "Combien cela co√ªte en urgence ?",
    a: "Cela d√©pend de la situation (acc√®s, horaire, complexit√©, pi√®ces). Nous vous annon√ßons une fourchette et/ou un devis avant intervention, pour √©viter les surprises."
  },
  {
    q: "Dans quelle zone intervenez-vous ?",
    a: `Intervention locale : ${REGION}. Villes prioritaires : ${topCitiesList} (et communes autour selon planning).`
  },
  {
    q: "Que devez-vous pr√©parer avant l‚Äôarriv√©e ?",
    a: "Si possible : l‚Äôacc√®s au compteur (eau/√©lectricit√©), une photo/vid√©o du probl√®me, et l‚Äôadresse compl√®te. En cas de danger imm√©diat, mettez-vous d‚Äôabord en s√©curit√©."
  }
];

const faqJsonLd = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faq.map((f) => ({
    "@type": "Question",
    "name": f.q,
    "acceptedAnswer": { "@type": "Answer", "text": f.a }
  })),
};

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Accueil", "item": "/" },
    { "@type": "ListItem", "position": 2, "name": "Urgence", "item": canonical }
  ],
};

const jsonLd = [breadcrumbJsonLd, faqJsonLd].filter(Boolean);
---

<Layout title={title} description={description} canonical={canonical} jsonLd={jsonLd}>
  <MainMenu slot="header" />

  <!-- HERO -->
  <section class="page-title page-title-center dark include-header include-topbar">
    <div class="container">
      <div class="page-title-row py-5">
        <div class="page-title-content">
          <div class="badge rounded-pill border border-light text-light">Urgence ‚Ä¢ D√©pannage √† domicile</div>
          <h1>Urgence d√©pannage : nous vous aidons rapidement</h1>
          <p class="lead mb-0">
            {REGION} ‚Äî fuite d‚Äôeau, panne √©lectrique, porte claqu√©e, d√©g√¢t des eaux‚Ä¶<br />
            <strong>Prix annonc√© avant intervention</strong> ‚Ä¢ <strong>r√©ponse claire</strong> ‚Ä¢ <strong>intervention soign√©e</strong>
          </p>

          <div class="d-flex flex-wrap justify-content-center gap-2 mt-4">
            <a href={telHref} class="button button-rounded button-large text-transform-none ls-0">
              üìû Appeler {PHONE_DISPLAY}
            </a>
            <a href="#devis" class="button button-rounded button-large button-light text-dark bg-white border text-transform-none ls-0">
              üìù Demander un rappel / un devis
            </a>
          </div>

          <div class="d-flex flex-wrap justify-content-center gap-3 mt-4 small text-light-50">
            <span>‚úÖ D√©pannage (selon disponibilit√©)</span>
            <span>‚úÖ Fourchette / devis avant</span>
            <span>‚úÖ {REGION}</span>
          </div>
        </div>

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Accueil</a></li>
            <li class="breadcrumb-item active" aria-current="page">Urgence</li>
          </ol>
        </nav>
      </div>
    </div>
  </section>

  <section id="content">
    <div class="content-wrap pb-0">

      <div class="container">

        <!-- INTRO + ACC√àS RAPIDE -->
        <div class="row align-items-start g-4">
          <div class="col-lg-7">
            <div class="badge rounded-pill badge-default mb-2">Particuliers ‚Ä¢ Maison / appartement</div>
            <h2 class="display-6 fw-bold mb-3">Un probl√®me urgent ? Nous s√©curisons d‚Äôabord, puis nous d√©pannons.</h2>

            <p class="text-muted mb-3">
              Quand cela fuit, disjoncte ou que la porte est bloqu√©e, vous voulez surtout : une r√©ponse rapide,
              une explication claire, et <strong>aucune mauvaise surprise</strong>.
            </p>

            <div class="row g-3 mt-3">
              <div class="col-12 col-sm-6">
                <div class="p-3 border rounded-3 h-100">
                  <div class="fw-semibold mb-1">D√©pannage plomberie</div>
                  <div class="small text-muted">fuite d‚Äôeau ‚Ä¢ robinet ‚Ä¢ WC ‚Ä¢ d√©g√¢t des eaux</div>
                </div>
              </div>
              <div class="col-12 col-sm-6">
                <div class="p-3 border rounded-3 h-100">
                  <div class="fw-semibold mb-1">D√©pannage √©lectricit√©</div>
                  <div class="small text-muted">disjoncteur ‚Ä¢ prise ‚Ä¢ tableau ‚Ä¢ coupure</div>
                </div>
              </div>
              <div class="col-12 col-sm-6">
                <div class="p-3 border rounded-3 h-100">
                  <div class="fw-semibold mb-1">Serrurerie</div>
                  <div class="small text-muted">porte claqu√©e ‚Ä¢ cl√© cass√©e ‚Ä¢ serrure bloqu√©e</div>
                </div>
              </div>
              <div class="col-12 col-sm-6">
                <div class="p-3 border rounded-3 h-100">
                  <div class="fw-semibold mb-1">Chauffage / eau chaude</div>
                  <div class="small text-muted">panne ‚Ä¢ plus d‚Äôeau chaude ‚Ä¢ s√©curit√©</div>
                </div>
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2 mt-4">
              <a href={telHref} class="btn btn-outline-secondary btn-sm">üìû {PHONE_DISPLAY}</a>
              <a href="/villes/" class="btn btn-outline-secondary btn-sm">üìç Villes</a>
              <a href="/metiers/" class="btn btn-outline-secondary btn-sm">üß∞ M√©tiers</a>
              <a href="#devis" class="btn btn-outline-primary btn-sm">üìù Devis / rappel</a>
            </div>

            <div class="clear line my-5"></div>

            <!-- URGENCE : QUOI FAIRE EN ATTENDANT -->
            <div class="card shadow-sm">
              <div class="card-body p-4">
                <div class="badge rounded-pill badge-default mb-2">Urgence</div>
                <h3 class="h4 mb-2">Que faire en attendant (sans prendre de risques)</h3>
                <p class="text-muted mb-3">
                  Objectif : <strong>s√©curiser</strong> et <strong>limiter les d√©g√¢ts</strong> en attendant l‚Äôintervention.
                  En cas de danger imm√©diat (fum√©e, odeur forte, √©tincelles‚Ä¶), mettez-vous en s√©curit√© et appelez les secours.
                </p>

                <div class="toggle faq pb-3 mb-3">
                  <div class="toggle-header">
                    <div class="toggle-icon color">
                      <i class="toggle-closed bi-question-circle"></i>
                      <i class="toggle-open bi-question-circle"></i>
                    </div>
                    <div class="toggle-title fw-semibold ps-1">Fuite d‚Äôeau / d√©g√¢t des eaux</div>
                    <div class="toggle-icon color">
                      <i class="toggle-closed fa-solid fa-chevron-down text-black-50"></i>
                      <i class="toggle-open fa-solid fa-chevron-up color"></i>
                    </div>
                  </div>
                  <div class="toggle-content text-black-50 ps-4">
                    <ul class="mb-0">
                      <li>Coupez l‚Äôeau au <strong>robinet d‚Äôarr√™t</strong> (ou au compteur si n√©cessaire).</li>
                      <li>√âloignez les appareils √©lectriques / multiprises de la zone humide.</li>
                      <li>√âpongez (serpilli√®re + seau) pour limiter la propagation.</li>
                      <li>Si possible, prenez une photo/vid√©o : cela aide √† diagnostiquer plus vite.</li>
                    </ul>
                  </div>
                </div>

                <div class="toggle faq pb-3 mb-3">
                  <div class="toggle-header">
                    <div class="toggle-icon color">
                      <i class="toggle-closed bi-question-circle"></i>
                      <i class="toggle-open bi-question-circle"></i>
                    </div>
                    <div class="toggle-title fw-semibold ps-1">Panne √©lectrique / disjoncteur qui saute</div>
                    <div class="toggle-icon color">
                      <i class="toggle-closed fa-solid fa-chevron-down text-black-50"></i>
                      <i class="toggle-open fa-solid fa-chevron-up color"></i>
                    </div>
                  </div>
                  <div class="toggle-content text-black-50 ps-4">
                    <ul class="mb-0">
                      <li>Coupez les appareils non essentiels et v√©rifiez le <strong>tableau √©lectrique</strong>.</li>
                      <li>Si cela re-saute, ne forcez pas : il peut y avoir un d√©faut (prise, appareil, humidit√©‚Ä¶).</li>
                      <li>√âvitez toute manipulation si vous constatez <strong>√©tincelles</strong>, odeur de br√ªl√© ou chaleur anormale.</li>
                      <li>En attendant, s√©curisez (lampe/chargeur) et limitez l‚Äôouverture du r√©frig√©rateur.</li>
                    </ul>
                  </div>
                </div>

                <div class="toggle faq pb-3 mb-3">
                  <div class="toggle-header">
                    <div class="toggle-icon color">
                      <i class="toggle-closed bi-question-circle"></i>
                      <i class="toggle-open bi-question-circle"></i>
                    </div>
                    <div class="toggle-title fw-semibold ps-1">Porte claqu√©e / serrure bloqu√©e</div>
                    <div class="toggle-icon color">
                      <i class="toggle-closed fa-solid fa-chevron-down text-black-50"></i>
                      <i class="toggle-open fa-solid fa-chevron-up color"></i>
                    </div>
                  </div>
                  <div class="toggle-content text-black-50 ps-4">
                    <ul class="mb-0">
                      <li>V√©rifiez si une autre entr√©e est accessible (sans forcer).</li>
                      <li>√âvitez les techniques ‚Äúinternet‚Äù qui ab√Æment la porte ou la serrure.</li>
                      <li>Pr√©parez un justificatif (adresse/identit√©) : cela facilite la prise en charge.</li>
                    </ul>
                  </div>
                </div>

                <div class="toggle faq pb-3 mb-0">
                  <div class="toggle-header">
                    <div class="toggle-icon color">
                      <i class="toggle-closed bi-question-circle"></i>
                      <i class="toggle-open bi-question-circle"></i>
                    </div>
                    <div class="toggle-title fw-semibold ps-1">Odeur suspecte / situation dangereuse</div>
                    <div class="toggle-icon color">
                      <i class="toggle-closed fa-solid fa-chevron-down text-black-50"></i>
                      <i class="toggle-open fa-solid fa-chevron-up color"></i>
                    </div>
                  </div>
                  <div class="toggle-content text-black-50 ps-4">
                    <ul class="mb-0">
                      <li>Si vous √™tes en danger : <strong>mettez-vous en s√©curit√©</strong> et appelez les secours (<strong>112</strong> / <strong>18</strong> / <strong>15</strong>).</li>
                      <li>N‚Äôallumez/√©teignez pas d‚Äôappareil √©lectrique si vous suspectez un risque (√©tincelles, forte odeur, fum√©e).</li>
                      <li>Si possible sans risque, a√©rez et √©loignez les personnes de la zone.</li>
                    </ul>
                  </div>
                </div>

              </div>
            </div>

            <div class="clear line my-5"></div>

            <!-- PRIX / TRANSPARENCE -->
            <div class="card shadow-sm">
              <div class="card-body p-4">
                <div class="badge rounded-pill badge-default mb-2">Prix</div>
                <h3 class="h4 mb-2">Prix : transparence avant intervention</h3>
                <p class="text-muted mb-0">
                  En d√©pannage, le prix d√©pend de la <strong>complexit√©</strong>, de l‚Äô<strong>accessibilit√©</strong>, de l‚Äô<strong>horaire</strong> (soir / week-end)
                  et des <strong>pi√®ces</strong> √©ventuelles. Pour vous rassurer : nous expliquons le diagnostic et nous
                  <strong>annon√ßons une fourchette</strong> (ou un devis) <strong>avant</strong> de lancer l‚Äôintervention.
                  Objectif : pas de surprise.
                </p>
              </div>
            </div>

          </div>

          <div class="col-lg-5">
            <!-- S√©lecteur ville + services urgence -->
            <div class="card shadow-sm">
              <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h3 class="h5 mb-1">Acc√®s rapide (urgence)</h3>
                    <p class="small text-muted mb-0">Choisissez votre ville, puis le probl√®me.</p>
                  </div>
                  <a href={telHref} class="btn btn-outline-secondary btn-sm">üìû {PHONE_DISPLAY}</a>
                </div>

                <hr class="my-3" />

                <label class="form-label small text-muted mb-1" for="u-city">Votre ville</label>
                <select id="u-city" class="form-select">
                  {villesA.map((v) => (
                    <option value={v.slug} selected={v.slug === defaultCitySlug}>{v.name} ({v.dept})</option>
                  ))}
                </select>

                <div class="small text-muted mt-2">
                  Votre commune n‚Äôest pas dans la liste ? <a href="/villes/">Voir toutes les villes</a>
                </div>

                <div class="clear"></div>
                <div class="mt-4">
                  <div class="small text-uppercase ls-1 fw-bold text-muted mb-2">Urgences courantes</div>

                  {urgentServices.length ? (
                    <div class="d-grid gap-2">
                      {urgentServices.map((s) => (
                        <a
                          class="btn btn-outline-secondary text-start js-urg-link"
                          href={`/villes/${defaultCitySlug}/${s.metier}/${s.slug}/`}
                          data-metier={s.metier}
                          data-service={s.slug}
                        >
                          <div class="fw-semibold">{s.name}</div>
                          <div class="small text-muted">{s.short}</div>
                        </a>
                      ))}
                    </div>
                  ) : (
                    <div class="small text-muted">Ajoutez des services ‚Äúurgence‚Äù dans <code>services.json</code>.</div>
                  )}
                </div>

                <hr class="my-4" />

                <div class="p-3 border rounded-3">
                  <div class="fw-semibold mb-1">üìç Zone couverte</div>
                  <div class="small text-muted">
                    {REGION}. Intervention selon planning, y compris communes autour de {defaultCity?.name ?? "votre ville"}.
                  </div>
                </div>

                <div class="d-flex flex-wrap gap-2 mt-3">
                  <a href="#devis" class="btn btn-outline-primary btn-sm">üìù Demander un rappel</a>
                  <a href="/metiers/" class="btn btn-outline-secondary btn-sm">Voir les m√©tiers</a>
                </div>
              </div>
            </div>

            <div class="card shadow-sm mt-3">
              <div class="card-body p-4">
                <h3 class="h6 mb-2">Recherches fr√©quentes</h3>
                <p class="small text-muted mb-0">
                  ‚Äúurgence plombier {REGION}‚Äù, ‚Äúfuite d‚Äôeau urgente‚Äù, ‚Äúd√©g√¢t des eaux‚Äù, ‚Äúdisjoncteur qui saute‚Äù,
                  ‚Äúserrurier porte claqu√©e‚Äù, ‚Äúouverture de porte rapide‚Äù.
                </p>
              </div>
            </div>

          </div>
        </div>

        <div class="clear line my-6"></div>

        <!-- FAQ -->
        <div class="heading-block border-bottom-0 text-center">
          <div class="badge rounded-pill badge-default">FAQ</div>
          <h3 class="text-transform-none ls-0">Questions fr√©quentes</h3>
        </div>

        <div class="row justify-content-center">
          <div class="col-lg-10">
            <div class="faqs">
              {faq.map((f) => (
                <div class="toggle faq pb-3 mb-4">
                  <div class="toggle-header">
                    <div class="toggle-icon color">
                      <i class="toggle-closed bi-question-circle"></i>
                      <i class="toggle-open bi-question-circle"></i>
                    </div>
                    <div class="toggle-title fw-semibold ps-1">{f.q}</div>
                    <div class="toggle-icon color">
                      <i class="toggle-closed fa-solid fa-chevron-down text-black-50"></i>
                      <i class="toggle-open fa-solid fa-chevron-up color"></i>
                    </div>
                  </div>
                  <div class="toggle-content text-black-50 ps-4">
                    {f.a}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        <div class="clear line my-6"></div>

        <!-- FORM -->
        <div id="devis" class="section mt-0" style="padding: 70px 0;">
          <div class="container">
            <div class="row justify-content-between align-items-start g-4">
              <div class="col-lg-5">
                <div class="heading-block border-bottom-0 mb-2">
                  <div class="badge rounded-pill badge-default">Rappel / devis</div>
                  <h2 class="text-transform-none ls-0 mb-0">Demande rapide ‚Äî Urgence</h2>
                </div>

                <p class="text-muted mb-3">
                  D√©crivez votre probl√®me (adresse, niveau d‚Äôurgence, d√©tail). Nous vous rappelons rapidement pour confirmer le d√©lai
                  et vous donner une estimation avant intervention.
                </p>

                <div class="d-flex flex-wrap gap-2">
                  <a href={telHref} class="btn btn-outline-secondary btn-sm">üìû {PHONE_DISPLAY}</a>
                  <a href="/villes/" class="btn btn-outline-secondary btn-sm">üìç Villes</a>
                </div>

                <p class="small text-muted mt-3 mb-0">
                  Conseil : indiquez si vous avez d√©j√† coup√© l‚Äôeau / l‚Äô√©lectricit√© et si la situation est stabilis√©e.
                </p>
              </div>

              <div class="col-lg-6">
                <HubspotCustomForm
                  title="Urgence ‚Äî demande rapide"
                  subtitle={`Zone : ${REGION} ‚Ä¢ nous vous r√©pondons rapidement`}
                  submitLabel="Envoyer ma demande"
                />
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Script l√©ger : met √† jour les liens Service√óVille selon la ville choisie -->
      <script is:inline>
        (() => {
          const citySelect = document.querySelector("#u-city");
          const links = Array.from(document.querySelectorAll(".js-urg-link"));

          function updateLinks() {
            const city = citySelect?.value || "{defaultCitySlug}";
            links.forEach((a) => {
              const metier = a.getAttribute("data-metier");
              const service = a.getAttribute("data-service");
              if (!metier || !service) return;
              a.setAttribute("href", `/villes/${city}/${metier}/${service}/`);
            });
          }

          citySelect?.addEventListener("change", updateLinks);
          updateLinks();
        })();
      </script>

    </div>
  </section>
</Layout>
