---
import Layout from "@layouts/Layout.astro";
import HubspotCustomForm from "@components/HubspotCustomForm.astro";

import travaux from "@data/travaux.json";
import villes from "@data/villes.json";
import metiers from "@data/metiers.json";
import services from "@data/services.json";

const SITE_URL =
  import.meta.env.PUBLIC_SITE_URL ??
  (Astro.site ? Astro.site.toString().replace(/\/$/, "") : "");

const brand = import.meta.env.PUBLIC_BRAND_NAME ?? "Horizon Conversion";
const regionLabel = import.meta.env.PUBLIC_REGION_LABEL ?? "Sud Oise (60) / Nord 95";
const phone = import.meta.env.PUBLIC_PHONE ?? "+33660921008";
const phoneDisplay = import.meta.env.PUBLIC_PHONE_DISPLAY ?? phone;

const telHref = `tel:${String(phone).replace(/\s+/g, "")}`;

const canonical = "/travaux/";
const title = `Travaux & d√©pannages ‚Äî Exemples d‚Äôinterventions | ${regionLabel} | ${brand}`;
const description =
  `Exemples de d√©pannages et travaux r√©alis√©s pr√®s de chez vous (${regionLabel}). ` +
  `Fuite, WC bouch√©, porte claqu√©e, disjoncteur‚Ä¶ Devis annonc√© avant intervention.`;

// Helpers
const byNameFR = (a, b) => String(a.name).localeCompare(String(b.name), "fr");

const getVille = (slug) => villes.find((v) => v.slug === slug);
const getMetier = (slug) => metiers.find((m) => m.slug === slug);
const getService = (sSlug, mSlug) => services.find((s) => s.slug === sSlug && s.metier === mSlug);

const villeName = (slug) => getVille(slug)?.name ?? slug;
const metierName = (slug) => getMetier(slug)?.name ?? slug;
const serviceName = (sSlug, mSlug) => getService(sSlug, mSlug)?.name ?? sSlug;

// Sort initial: plus r√©cent d'abord
const items = [...travaux].sort((a, b) => String(b.date).localeCompare(String(a.date)));

// Filtres (options)
const metierOptions = [...new Set(items.map((t) => t.metier))]
  .map((slug) => ({ slug, name: metierName(slug) }))
  .sort(byNameFR);

const villeOptions = [...new Set(items.map((t) => t.ville))]
  .map((slug) => ({ slug, name: villeName(slug) }))
  .sort(byNameFR);

const serviceOptions = [...new Set(items.map((t) => `${t.metier}::${t.service}`))]
  .map((key) => {
    const [m, s] = key.split("::");
    return { key, metier: m, service: s, name: serviceName(s, m) };
  })
  .sort((a, b) => String(a.name).localeCompare(String(b.name), "fr"));

// Suggestions longue tra√Æne (chips) depuis travaux.keywords
const cityNames = new Set(villes.map((v) => String(v.name).toLowerCase()));
const chipCounts = new Map();
for (const t of items) {
  for (const kw of t.keywords ?? []) {
    const k = String(kw).trim();
    if (!k) continue;
    const low = k.toLowerCase();
    // √©vite de proposer "senlis", "chantilly", etc.
    if (cityNames.has(low)) continue;
    chipCounts.set(k, (chipCounts.get(k) ?? 0) + 1);
  }
}
const chips = [...chipCounts.entries()]
  .sort((a, b) => b[1] - a[1] || String(a[0]).localeCompare(String(b[0]), "fr"))
  .slice(0, 10)
  .map(([label]) => label);

// JSON-LD
const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Accueil", "item": SITE_URL ? `${SITE_URL}/` : "/" },
    { "@type": "ListItem", "position": 2, "name": "Travaux", "item": SITE_URL ? `${SITE_URL}${canonical}` : canonical },
  ],
};

const itemListJsonLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "itemListElement": items.slice(0, 24).map((t, i) => ({
    "@type": "ListItem",
    "position": i + 1,
    "name": t.title,
    "url": SITE_URL ? `${SITE_URL}/travaux/${t.slug}/` : `/travaux/${t.slug}/`,
  })),
};

const jsonLd = [breadcrumbJsonLd, itemListJsonLd];
---

<Layout title={title} description={description} canonical={canonical} jsonLd={jsonLd}>
  <section class="page-title page-title-center dark include-header include-topbar">
    <div class="container">
      <div class="page-title-row mt-5">
        <div class="page-title-content">
          <div class="badge rounded-pill border border-light text-light">Travaux</div>
          <h1>Travaux & d√©pannages</h1>
          <p class="lead mb-0">{regionLabel} ‚Äî exemples d‚Äôinterventions r√©centes</p>
        </div>

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Accueil</a></li>
            <li class="breadcrumb-item active" aria-current="page">Travaux</li>
          </ol>
        </nav>
      </div>
    </div>
  </section>

  <section id="content">
    <div class="content-wrap pb-0">
      <div class="container">

        <!-- Intro + CTA -->
        <div class="row align-items-start g-4">
          <div class="col-lg-7">
            <div class="badge rounded-pill badge-default mb-2">Devis annonc√© avant intervention</div>
            <h2 class="display-6 fw-bold mb-3">D√©couvrez des exemples concrets, avant de choisir</h2>

            <p class="text-muted mb-3">
              Fuite d‚Äôeau, WC bouch√©, porte claqu√©e, tableau √©lectrique qui disjoncte‚Ä¶
              Ici, vous retrouvez des interventions <strong>r√©elles</strong> avec le probl√®me, la solution et le r√©sultat.
            </p>

            <ul class="iconlist ms-3 mb-4">
              <li><i class="fa-solid fa-check text-smaller color"></i> Explications claires (ce que nous faisons, et pourquoi)</li>
              <li><i class="fa-solid fa-check text-smaller color"></i> Devis / tarif annonc√© avant intervention (selon le cas)</li>
              <li><i class="fa-solid fa-check text-smaller color"></i> Intervention locale : {regionLabel}</li>
            </ul>

            <div class="d-flex flex-wrap gap-2">
              <a href={telHref} class="button button-rounded button-large text-transform-none ls-0 m-0">
                üìû Appeler ‚Äî {phoneDisplay}
              </a>
              <a href="#devis" class="button button-rounded button-large button-light text-dark bg-white border text-transform-none ls-0 m-0">
                üìù Demander un devis
              </a>
            </div>

            {chips.length ? (
              <div class="mt-4">
                <div class="small text-muted mb-2">Id√©es de recherche (exemples fr√©quents) :</div>
                <div class="d-flex flex-wrap gap-2">
                  {chips.map((c) => (
                    <button type="button" class="btn btn-sm btn-outline-secondary js-chip" data-chip={c}>
                      {c}
                    </button>
                  ))}
                </div>
              </div>
            ) : null}
          </div>

          <div class="col-lg-5">
            <div class="card shadow-sm">
              <div class="card-body p-4">
                <h3 class="h5 mb-2">Filtrer rapidement</h3>
                <p class="small text-muted mb-3">
                  Saisissez un mot (ex : ‚Äúporte claqu√©e‚Äù, ‚ÄúWC bouch√©‚Äù, ‚Äúdisjoncteur‚Äù) ou choisissez une ville / un m√©tier.
                </p>

                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label small text-muted mb-1" for="t-search">Rechercher</label>
                    <input id="t-search" class="form-control" type="search" placeholder="Ex : fuite, chauffe-eau, serrure, toiture‚Ä¶" />
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small text-muted mb-1" for="t-ville">Ville</label>
                    <select id="t-ville" class="form-select">
                      <option value="all">Toutes</option>
                      {villeOptions.map((v) => <option value={v.slug}>{v.name}</option>)}
                    </select>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small text-muted mb-1" for="t-metier">M√©tier</label>
                    <select id="t-metier" class="form-select">
                      <option value="all">Tous</option>
                      {metierOptions.map((m) => <option value={m.slug}>{m.name}</option>)}
                    </select>
                  </div>

                  <div class="col-12">
                    <label class="form-label small text-muted mb-1" for="t-service">Type d‚Äôintervention</label>
                    <select id="t-service" class="form-select">
                      <option value="all">Toutes</option>
                      {serviceOptions.map((s) => <option value={s.key}>{s.name}</option>)}
                    </select>
                  </div>

                  <div class="col-12 d-flex align-items-center gap-2">
                    <input id="t-urgent" class="form-check-input" type="checkbox" />
                    <label for="t-urgent" class="form-check-label">Afficher d‚Äôabord les urgences</label>
                  </div>
                </div>

                <div class="d-flex flex-wrap gap-2 mt-3">
                  <button class="btn btn-outline-secondary btn-sm" type="button" id="t-reset">R√©initialiser</button>
                  <div class="small text-muted ms-auto" id="t-count"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="clear line my-6"></div>

        <!-- Grille travaux -->
        <div class="heading-block border-bottom-0 text-center">
          <div class="badge rounded-pill badge-default">R√©alisations</div>
          <h3 class="text-transform-none ls-0">Derni√®res interventions</h3>
          <p class="text-muted mb-0">Cliquez sur une intervention pour voir le d√©tail (photos, √©tapes, r√©sultat).</p>
        </div>

        <div class="row col-mb-30 mt-4" id="travaux-grid">
          {items.map((t) => {
            const v = getVille(t.ville);
            const m = getMetier(t.metier);
            const s = getService(t.service, t.metier);

            const vName = v?.name ?? t.ville;
            const mName = m?.name ?? t.metier;
            const sName = s?.name ?? t.service;

            const isMoneyService = Boolean(v && v.priority === "A" && s && s.is_top);
            const metierVilleHref = v && v.priority === "A" ? `/villes/${v.slug}/${t.metier}/` : null;
            const serviceVilleHref = isMoneyService ? `/villes/${v.slug}/${t.metier}/${t.service}/` : null;

            const searchText = [
              t.title, t.problem, t.solution, t.results,
              ...(t.keywords ?? []),
              vName, mName, sName
            ].join(" ").toLowerCase();

            return (
              <div
                class="col-md-6 col-lg-4 travaux-item"
                data-date={t.date}
                data-urgent={t.urgent ? "1" : "0"}
                data-ville={t.ville}
                data-metier={t.metier}
                data-service={`${t.metier}::${t.service}`}
                data-search={searchText}
              >
                <div class="card shadow-sm h-100">
                  {t.photos?.length ? (
                    <a href={`/travaux/${t.slug}/`} class="d-block">
                      <img
                        src={t.photos[0]}
                        alt={t.title}
                        class="w-100 rounded-top"
                        loading="lazy"
                        style="aspect-ratio: 16/10; object-fit: cover;"
                      />
                    </a>
                  ) : null}

                  <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start gap-2 mb-2">
                      <div class="small text-muted">
                        {mName} ‚Ä¢ {vName}
                      </div>
                      {t.urgent ? <span class="badge bg-danger">Urgence</span> : <span class="badge bg-light text-dark">Travaux</span>}
                    </div>

                    <h3 class="h6 mb-2">
                      <a href={`/travaux/${t.slug}/`} class="text-decoration-none">
                        {t.title}
                      </a>
                    </h3>

                    <div class="small text-muted mb-2">
                      <strong>Demande :</strong> {sName}
                    </div>

                    <p class="small text-muted mb-3">
                      <strong>Probl√®me :</strong> {String(t.problem).slice(0, 120)}{String(t.problem).length > 120 ? "‚Ä¶" : ""}
                      <br />
                      <strong>R√©sultat :</strong> {String(t.results).slice(0, 110)}{String(t.results).length > 110 ? "‚Ä¶" : ""}
                    </p>

                    <div class="d-flex flex-wrap gap-2">
                      <a class="btn btn-outline-secondary btn-sm" href={`/travaux/${t.slug}/`}>Voir le d√©tail</a>

                      {serviceVilleHref ? (
                        <a class="btn btn-outline-secondary btn-sm" href={serviceVilleHref}>
                          Demander ‚Äú{sName.toLowerCase()}‚Äù
                        </a>
                      ) : metierVilleHref ? (
                        <a class="btn btn-outline-secondary btn-sm" href={metierVilleHref}>
                          Voir {mName.toLowerCase()} √† {vName}
                        </a>
                      ) : null}

                      <a class="btn btn-outline-primary btn-sm" href="#devis">Devis</a>
                    </div>

                    <div class="small text-muted mt-3 d-flex flex-wrap gap-2">
                      <span>üìÖ {t.date}</span>
                      {t.duration ? <span>‚è±Ô∏è {t.duration}</span> : null}
                    </div>

                    {t.keywords?.length ? (
                      <div class="mt-3 d-flex flex-wrap gap-2">
                        {t.keywords.slice(0, 4).map((kw) => (
                          <button type="button" class="btn btn-sm btn-outline-secondary js-chip" data-chip={kw}>
                            {kw}
                          </button>
                        ))}
                      </div>
                    ) : null}
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        <div class="clear line my-6"></div>

        <!-- CTA devis -->
        <div id="devis" class="section mt-0" style="padding: 70px 0;">
          <div class="container">
            <div class="row justify-content-between align-items-start g-4">
              <div class="col-lg-5">
                <div class="heading-block border-bottom-0 mb-2">
                  <div class="badge rounded-pill badge-default">Devis gratuit</div>
                  <h2 class="text-transform-none ls-0 mb-0">D√©crivez votre besoin</h2>
                </div>

                <p class="text-muted mb-3">
                  Indiquez l‚Äôadresse, le probl√®me, et si c‚Äôest urgent. Nous vous rappelons rapidement.
                </p>

                <div class="d-flex flex-wrap gap-2">
                  <a href={telHref} class="btn btn-outline-secondary btn-sm">üìû {phoneDisplay}</a>
                  <a href="/contact/" class="btn btn-outline-primary btn-sm">Aller sur Contact</a>
                </div>

                <div class="small text-muted mt-3">
                  Astuce : plus votre demande est pr√©cise (sympt√¥mes, acc√®s, urgence), plus nous pouvons vous r√©pondre vite.
                </div>
              </div>

              <div class="col-lg-6">
                <HubspotCustomForm
                  title="Demande de devis"
                  subtitle={`R√©ponse rapide ‚Ä¢ ${regionLabel}`}
                  submitLabel="Envoyer ma demande"
                />
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- Filtrage front (sans $ global) -->
  <script type="module" is:inline>
    (() => {
      const qs = (sel, root = document) => root.querySelector(sel);
      const qsa = (sel, root = document) => Array.from(root.querySelectorAll(sel));

      const input = qs("#t-search");
      const ville = qs("#t-ville");
      const metier = qs("#t-metier");
      const service = qs("#t-service");
      const urgentFirst = qs("#t-urgent");
      const reset = qs("#t-reset");
      const count = qs("#t-count");
      const grid = qs("#travaux-grid");

      function getNodes() {
        return qsa(".travaux-item", grid);
      }

      function applyFilters() {
        const q = (input?.value || "").trim().toLowerCase();
        const v = ville?.value || "all";
        const m = metier?.value || "all";
        const s = service?.value || "all";

        let visible = [];

        getNodes().forEach((el) => {
          const txt = el.getAttribute("data-search") || "";
          const ev = el.getAttribute("data-ville") || "";
          const em = el.getAttribute("data-metier") || "";
          const es = el.getAttribute("data-service") || "";

          const okQ = !q || txt.includes(q);
          const okV = v === "all" || ev === v;
          const okM = m === "all" || em === m;
          const okS = s === "all" || es === s;

          const show = okQ && okV && okM && okS;
          el.style.display = show ? "" : "none";
          if (show) visible.push(el);
        });

        // tri optionnel: urgences d'abord, sinon r√©cent d'abord (data-date)
        if (urgentFirst?.checked) {
          visible.sort((a, b) => {
            const ua = a.getAttribute("data-urgent") === "1" ? 1 : 0;
            const ub = b.getAttribute("data-urgent") === "1" ? 1 : 0;
            if (ua !== ub) return ub - ua;
            return String(b.getAttribute("data-date") || "").localeCompare(String(a.getAttribute("data-date") || ""));
          });
        } else {
          visible.sort((a, b) =>
            String(b.getAttribute("data-date") || "").localeCompare(String(a.getAttribute("data-date") || ""))
          );
        }

        // r√©injecte l'ordre (sans recr√©er)
        visible.forEach((el) => grid.appendChild(el));

        if (count) count.textContent = `${visible.length} intervention(s) affich√©e(s)`;
      }

      function setSearch(val) {
        if (!input) return;
        input.value = String(val || "");
        applyFilters();
        input.focus();
      }

      // chips => remplissent la recherche
      qsa(".js-chip").forEach((btn) => {
        btn.addEventListener("click", () => setSearch(btn.getAttribute("data-chip") || ""));
      });

      [input, ville, metier, service].forEach((el) => el && el.addEventListener("input", applyFilters));
      [ville, metier, service].forEach((el) => el && el.addEventListener("change", applyFilters));
      urgentFirst?.addEventListener("change", applyFilters);

      reset?.addEventListener("click", () => {
        if (input) input.value = "";
        if (ville) ville.value = "all";
        if (metier) metier.value = "all";
        if (service) service.value = "all";
        if (urgentFirst) urgentFirst.checked = false;
        applyFilters();
      });

      applyFilters();
    })();
  </script>
</Layout>
