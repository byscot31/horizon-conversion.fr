---
import Layout from "@layouts/Layout.astro";
import travaux from "@data/travaux.json";
import villes from "@data/villes.json";
import metiers from "@data/metiers.json";
import services from "@data/services.json";

export function getStaticPaths() {
  return travaux.map((t) => ({ params: { slug: t.slug } }));
}

const { slug } = Astro.params;
const t = travaux.find((x) => x.slug === slug);
if (!t) throw new Error(`Travail introuvable: ${slug}`);

const brand = import.meta.env.PUBLIC_BRAND_NAME ?? "Horizon Conversion";
const PHONE = import.meta.env.PUBLIC_PHONE ?? "+33660921008";
const PHONE_DISPLAY = import.meta.env.PUBLIC_PHONE_DISPLAY ?? "06 60 92 10 08";
const telHref = `tel:${String(PHONE).replace(/\s+/g, "")}`;

const canonical = `/travaux/${t.slug}/`;

const ville = villes.find((v) => v.slug === t.ville);
const metier = metiers.find((m) => m.slug === t.metier);
const service = services.find((s) => s.slug === t.service && s.metier === t.metier);

const villeName = ville?.name ?? t.ville;
const metierName = metier?.name ?? t.metier;
const serviceName = service?.name ?? t.service;

const around = (ville?.around ?? [])
  .map((s) => villes.find((v) => v.slug === s))
  .filter(Boolean)
  .slice(0, 8);

const aroundNames = around.map((v) => v.name).slice(0, 6).join(", ");

const title = `${t.title} ‚Äî ${serviceName} √† ${villeName} | ${brand}`;
const description = `${serviceName} √† ${villeName} : ${t.problem} ‚Üí ${t.results}. Devis annonc√© avant, intervention soign√©e.`
  .replace(/\s+/g, " ")
  .slice(0, 160);

// Breadcrumb + Article + FAQ (rassurance)
const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Accueil", "item": "/" },
    { "@type": "ListItem", "position": 2, "name": "R√©alisations", "item": "/travaux/" },
    { "@type": "ListItem", "position": 3, "name": t.title, "item": canonical },
  ],
};

const faq = [
  {
    q: "Combien de temps cela prend-il ?",
    a: t.duration
      ? `Selon le cas, cette intervention prend environ : ${t.duration}. Pour votre situation, nous confirmons apr√®s diagnostic.`
      : "Cela d√©pend du probl√®me et de l‚Äôacc√®s. Nous confirmons le d√©lai apr√®s un diagnostic rapide (photos + description).",
  },
  {
    q: "Quel prix pr√©voir ?",
    a:
      "Le tarif d√©pend de la complexit√©, de l‚Äôacc√®s, des pi√®ces √©ventuelles et du niveau d‚Äôurgence. " +
      "Nous annon√ßons toujours le prix (ou une fourchette) avant d‚Äôintervenir, pour √©viter les surprises.",
  },
  {
    q: `Intervenez-vous aussi autour de ${villeName} ?`,
    a: aroundNames
      ? `Oui : ${aroundNames}${around.length > 6 ? "‚Ä¶" : ""} et les communes proches selon planning.`
      : "Oui, selon planning, dans les communes proches.",
  },
];

const faqJsonLd = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faq.map((f) => ({
    "@type": "Question",
    "name": f.q,
    "acceptedAnswer": { "@type": "Answer", "text": f.a },
  })),
};

const jsonLd = [
  breadcrumbJsonLd,
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": t.title,
    "datePublished": t.date,
    "dateModified": t.date,
    "about": `${serviceName} ${villeName}`,
    "articleSection": "R√©alisations",
    "image": t.photos && t.photos.length ? t.photos : undefined,
    "mainEntityOfPage": canonical,
  },
  faqJsonLd,
].filter(Boolean);

// Travaux li√©s (m√™me m√©tier en priorit√©, sinon m√™me ville)
const related = [...travaux]
  .filter((x) => x.slug !== t.slug)
  .sort((a, b) => String(b.date).localeCompare(String(a.date)))
  .filter((x) => x.metier === t.metier || x.ville === t.ville)
  .slice(0, 4);
---

<Layout title={title} description={description} canonical={canonical} jsonLd={jsonLd}>
  <section class="page-title page-title-center dark include-header include-topbar">
    <div class="container">
      <div class="page-title-row mt-5">
        <div class="page-title-content">
          <div class="badge rounded-pill border border-light text-light">R√©alisation</div>
          <h1>{t.title}</h1>
          <p class="lead mb-0">{serviceName} ‚Ä¢ {metierName} √† {villeName}</p>
        </div>

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Accueil</a></li>
            <li class="breadcrumb-item"><a href="/travaux/">R√©alisations</a></li>
            <li class="breadcrumb-item active" aria-current="page">{t.title}</li>
          </ol>
        </nav>
      </div>
    </div>
  </section>

  <section id="content">
    <div class="content-wrap pb-0">
      <div class="container">

        <div class="row g-4">
          {/* CONTENU */}
          <div class="col-lg-7">

            {/* Photos */}
            {t.photos?.length ? (
              <div class="row g-2">
                {t.photos.map((p) => (
                  <div class="col-6">
                    <img src={p} alt={`${t.title} √† ${villeName}`} class="rounded-3 w-100" loading="lazy" />
                  </div>
                ))}
              </div>
            ) : (
              <div class="card">
                <div class="card-body p-4">
                  <p class="mb-0 text-muted">
                    Ajoutez des photos dans <code>travaux.json</code> (champ <code>photos</code>).
                  </p>
                </div>
              </div>
            )}

            <div class="clear line my-5"></div>

            {/* R√©sum√© ‚Äúclient-first‚Äù */}
            <div class="card">
              <div class="card-body p-4">
                <h2 class="h5 mb-2">En bref</h2>
                <p class="text-muted mb-3">
                  Intervention √† <strong>{villeName}</strong> pour <strong>{serviceName.toLowerCase()}</strong>.
                  Objectif : r√©soudre le probl√®me proprement, vous expliquer clairement, et annoncer le prix avant intervention.
                </p>

                <div class="row g-3 small">
                  <div class="col-12 col-md-6">
                    <div class="p-3 border rounded">
                      <div class="fw-semibold mb-1">üìç Zone</div>
                      {villeName}{aroundNames ? ` ‚Ä¢ autour : ${aroundNames}${around.length > 6 ? "‚Ä¶" : ""}` : ""}
                    </div>
                  </div>
                  <div class="col-12 col-md-6">
                    <div class="p-3 border rounded">
                      <div class="fw-semibold mb-1">‚è±Ô∏è Dur√©e</div>
                      {t.duration ?? "Selon le cas (confirm√© apr√®s diagnostic)"}
                    </div>
                  </div>
                </div>

                <div class="d-flex flex-wrap gap-2 mt-3">
                  <a class="button button-rounded m-0" href="/contact/">üìù Demander un devis</a>
                  <a class="button button-border button-rounded m-0" href={telHref}>üìû Appeler {PHONE_DISPLAY}</a>
                </div>
              </div>
            </div>

            <h2 class="h4 mt-5 mb-3">Le besoin (ce que vous souhaitiez)</h2>
            <p class="text-muted">{t.problem}</p>

            <h2 class="h4 mt-4 mb-3">Ce que nous avons fait (solution)</h2>
            <p class="text-muted">{t.solution}</p>

            {t.steps?.length ? (
              <>
                <h2 class="h4 mt-4 mb-3">√âtapes de l‚Äôintervention</h2>
                <ol class="ms-3">
                  {t.steps.map((s) => <li class="mb-2">{s}</li>)}
                </ol>
              </>
            ) : null}

            {t.materials?.length ? (
              <>
                <h2 class="h4 mt-4 mb-3">Mat√©riel / √©l√©ments utilis√©s</h2>
                <ul class="iconlist ms-3">
                  {t.materials.map((m) => (
                    <li class="mb-2">
                      <i class="fa-solid fa-check text-smaller color"></i> {m}
                    </li>
                  ))}
                </ul>
              </>
            ) : null}

            <div class="card mt-4">
              <div class="card-body p-4">
                <h3 class="h5 mb-2">R√©sultat</h3>
                <p class="mb-0">{t.results}</p>
              </div>
            </div>

            {/* Urgence : quoi faire en attendant */}
            <div class="card mt-4 border">
              <div class="card-body p-4">
                <h3 class="h5 mb-2">Urgence : quoi faire en attendant</h3>
                <p class="small text-muted mb-3">
                  Si la situation pr√©sente un danger (eau, √©lectricit√©, fum√©e, odeur de gaz),
                  privil√©giez la s√©curit√© et appelez les secours si n√©cessaire.
                </p>
                <ul class="iconlist ms-3 mb-0">
                  <li class="mb-2"><i class="fa-solid fa-check text-smaller color"></i> Coupez l‚Äôeau au robinet d‚Äôarr√™t en cas de fuite ou de d√©g√¢t des eaux.</li>
                  <li class="mb-2"><i class="fa-solid fa-check text-smaller color"></i> Coupez l‚Äô√©lectricit√© au disjoncteur en cas de risque √©lectrique (√©tincelles, odeur, humidit√©).</li>
                  <li class="mb-2"><i class="fa-solid fa-check text-smaller color"></i> S√©curisez la zone : √©loignez enfants/animaux, √©vitez de toucher aux √©l√©ments douteux.</li>
                  <li class="mb-2"><i class="fa-solid fa-check text-smaller color"></i> Prot√©gez : bassine/serpill√®res, a√©rez si besoin, prenez 2‚Äì3 photos pour d√©crire la situation.</li>
                </ul>
              </div>
            </div>

            {/* Prix / fourchette (ultra prudent) */}
            <div class="card mt-3">
              <div class="card-body p-4">
                <h3 class="h5 mb-2">Prix : √† quoi vous attendre</h3>
                <p class="text-muted mb-0">
                  Le tarif d√©pend de la complexit√©, de l‚Äôacc√®s, du mat√©riel / des pi√®ces √©ventuelles et du niveau d‚Äôurgence.
                  Dans tous les cas, <strong>le prix (ou une fourchette) est annonc√© avant d‚Äôintervenir</strong> afin d‚Äô√©viter les mauvaises surprises.
                </p>
              </div>
            </div>

            {/* FAQ courte */}
            <div class="clear line my-5"></div>
            <div class="heading-block border-bottom-0 text-center">
              <div class="badge rounded-pill badge-default">Questions</div>
              <h3 class="text-transform-none ls-0">FAQ</h3>
            </div>

            <div class="faqs">
              {faq.map((f) => (
                <div class="toggle faq pb-3 mb-4">
                  <div class="toggle-header">
                    <div class="toggle-icon color">
                      <i class="toggle-closed bi-question-circle"></i>
                      <i class="toggle-open bi-question-circle"></i>
                    </div>
                    <div class="toggle-title fw-semibold ps-1">{f.q}</div>
                    <div class="toggle-icon color">
                      <i class="toggle-closed fa-solid fa-chevron-down text-black-50"></i>
                      <i class="toggle-open fa-solid fa-chevron-up color"></i>
                    </div>
                  </div>
                  <div class="toggle-content text-black-50 ps-4">{f.a}</div>
                </div>
              ))}
            </div>

            <div class="clear line my-5"></div>

            {/* CTA final */}
            <div class="d-flex flex-wrap gap-2">
              <a class="button button-rounded m-0" href="/contact/">üìù Demander un devis</a>
              <a class="button button-border button-rounded m-0" href={`/villes/${t.ville}/${t.metier}/`}>
                Voir {metierName} √† {villeName}
              </a>
              <a class="button button-light button-rounded bg-white border text-dark m-0" href={`/villes/${t.ville}/${t.metier}/${t.service}/`}>
                Voir {serviceName} √† {villeName}
              </a>
            </div>
          </div>

          {/* SIDEBAR */}
          <div class="col-lg-5">
            <div class="card shadow-sm">
              <div class="card-body p-4">
                <h3 class="h5 mb-2">Infos rapides</h3>

                <ul class="iconlist ms-3 mb-3">
                  <li class="mb-2"><i class="fa-solid fa-location-dot text-smaller color"></i> {villeName}</li>
                  <li class="mb-2"><i class="fa-solid fa-screwdriver-wrench text-smaller color"></i> {metierName}</li>
                  <li class="mb-2"><i class="fa-solid fa-tag text-smaller color"></i> {serviceName}</li>
                  <li class="mb-2"><i class="fa-solid fa-clock text-smaller color"></i> Dur√©e : {t.duration ?? "‚Äî"}</li>
                  <li class="mb-2"><i class="fa-solid fa-calendar text-smaller color"></i> Date : {t.date}</li>
                  {t.urgent ? <li class="mb-2"><i class="fa-solid fa-triangle-exclamation text-smaller color"></i> Urgence</li> : null}
                </ul>

                <div class="d-flex flex-wrap gap-2">
                  <a href={telHref} class="button button-rounded button-small m-0">üìû Appeler {PHONE_DISPLAY}</a>
                  <a href="/contact/" class="button button-border button-rounded button-small m-0">Devis gratuit</a>
                </div>

                <hr class="my-3" />

                <div class="small text-muted">
                  Vous avez le m√™me souci ? Allez directement √† la page la plus proche de votre cas :
                  <div class="mt-2 d-flex flex-wrap gap-2">
                    <a class="btn btn-sm btn-outline-secondary" href={`/villes/${t.ville}/${t.metier}/`}>
                      {metierName} √† {villeName}
                    </a>
                    <a class="btn btn-sm btn-outline-secondary" href={`/villes/${t.ville}/${t.metier}/${t.service}/`}>
                      {serviceName}
                    </a>
                  </div>
                </div>
              </div>
            </div>

            {/* R√©alisations li√©es */}
            {related.length ? (
              <div class="card shadow-sm mt-3">
                <div class="card-body p-4">
                  <h3 class="h5 mb-2">Autres r√©alisations</h3>
                  <p class="small text-muted mb-3">Exemples r√©cents (m√™me secteur / m√™me type d‚Äôintervention).</p>

                  <div class="d-grid gap-2">
                    {related.map((x) => (
                      <a class="btn btn-outline-secondary text-start" href={`/travaux/${x.slug}/`}>
                        {x.title}
                      </a>
                    ))}
                  </div>

                  <div class="small text-muted mt-3">
                    <a href="/travaux/">Voir toutes les r√©alisations ‚Üí</a>
                  </div>
                </div>
              </div>
            ) : null}

            {/* Zone autour (rassurance) */}
            {around.length ? (
              <div class="card shadow-sm mt-3">
                <div class="card-body p-4">
                  <h3 class="h6 mb-2 text-uppercase ls-1">Secteur</h3>
                  <p class="small text-muted mb-3">
                    Intervention sur {villeName} et communes proches (selon planning).
                  </p>
                  <div class="d-flex flex-wrap gap-2">
                    {around.slice(0, 8).map((v) => (
                      <a class="btn btn-sm btn-outline-secondary" href={`/villes/${v.slug}/`}>{v.name}</a>
                    ))}
                  </div>
                </div>
              </div>
            ) : null}
          </div>
        </div>

      </div>
    </div>
  </section>
</Layout>
