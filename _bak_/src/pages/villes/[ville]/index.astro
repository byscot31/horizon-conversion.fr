---
import Layout from "@layouts/Layout.astro";
import HubspotCustomForm from "@components/HubspotCustomForm.astro";

import villes from "@data/villes.json";
import metiers from "@data/metiers.json";
import services from "@data/services.json";

export function getStaticPaths() {
  const A = villes.filter((v) => v.priority === "A");
  return A.map((v) => ({ params: { ville: v.slug } }));
}

const { ville: villeSlug } = Astro.params;

const ville = villes.find((v) => v.slug === villeSlug);
if (!ville) throw new Error(`Ville introuvable: ${villeSlug}`);

const brand = import.meta.env.PUBLIC_BRAND_NAME ?? "Horizon Conversion";
const phone = import.meta.env.PUBLIC_PHONE ?? "+33660921008";
const phoneDisplay = import.meta.env.PUBLIC_PHONE_DISPLAY ?? "06 60 92 10 08";
const regionLabel = import.meta.env.PUBLIC_REGION_LABEL ?? "Sud Oise (60) / Nord 95";

const telHref = `tel:${String(phone).replace(/\s+/g, "")}`;

const canonical = `/villes/${ville.slug}/`;
const noindex = ville.priority !== "A";

// Villes autour (liens)
const around = (ville.around ?? [])
  .map((slug) => villes.find((v) => v.slug === slug))
  .filter(Boolean)
  .slice(0, 12);

const aroundNames = around.map((v) => v.name).slice(0, 8).join(", ");

// M√©tiers (texte ‚Äúnaturel‚Äù)
const metiersNames = metiers.map((m) => m.name);
const metiersShort = metiersNames.slice(0, 6).join(", ") + (metiersNames.length > 6 ? "‚Ä¶" : "");

// SEO title/desc (client-first)
const title = `D√©pannage & travaux √† ${ville.name} (${ville.dept}) ‚Äî Devis gratuit | ${brand}`;
const description =
  `Besoin d‚Äôun artisan √† ${ville.name} ? D√©pannage, installation et travaux (${metiersShort}). ` +
  `Intervention √† ${ville.name} et autour (${aroundNames || "communes proches"}). Devis annonc√© avant intervention.`;

// Pour chaque m√©tier : 3 services top
function topServicesForMetier(mSlug) {
  return services
    .filter((s) => s.metier === mSlug && s.is_top)
    .slice(0, 3);
}

// FAQ (rassurance + longue tra√Æne) ‚Äî ton "vous"
const faq = [
  {
    q: `Intervenez-vous √† ${ville.name} et autour ?`,
    a: around.length
      ? `Oui. Nous intervenons √† ${ville.name} et dans les communes proches : ${around.map(v => v.name).slice(0, 8).join(", ")}${around.length > 8 ? "‚Ä¶" : ""}.`
      : `Oui. Nous intervenons √† ${ville.name} et alentours selon notre planning.`,
  },
  {
    q: "Le devis est-il gratuit ?",
    a: "Oui : nous annon√ßons le tarif avant intervention/travaux (hors cas particuliers).",
  },
  {
    q: "Quel d√©lai pour un d√©pannage ?",
    a: "Selon la disponibilit√© et l‚Äôurgence. Indiquez-nous votre probl√®me et votre adresse : nous vous confirmons le d√©lai.",
  },
  {
    q: "Combien √ßa co√ªte ?",
    a: "Le prix d√©pend de la complexit√©, de l‚Äôacc√®s, du temps sur place et des pi√®ces √©ventuelles. Apr√®s votre description (et une photo si possible), nous vous donnons une estimation, puis nous confirmons avant d‚Äôintervenir.",
  },
];

const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Accueil", "item": "/" },
    { "@type": "ListItem", "position": 2, "name": "Villes", "item": "/villes/" },
    { "@type": "ListItem", "position": 3, "name": ville.name, "item": canonical },
  ],
};

const faqJsonLd = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faq.map((f) => ({
    "@type": "Question",
    "name": f.q,
    "acceptedAnswer": { "@type": "Answer", "text": f.a },
  })),
};

const jsonLd = [breadcrumbJsonLd, faqJsonLd];

// ‚ÄúUrgence : quoi faire en attendant‚Äù (g√©n√©rique, safe) ‚Äî ton "vous"
const urgenceTips = [
  "S√©curisez la zone (enfants/animaux √† distance) et √©vitez toute manipulation risqu√©e.",
  "Si n√©cessaire : coupez l‚Äôeau (fuite) ou coupez au disjoncteur (odeur de br√ªl√©/√©tincelles).",
  "Prot√©gez le sol et les meubles, et r√©cup√©rez l‚Äôeau si besoin (seau, serpilli√®re).",
  "Prenez 1‚Äì2 photos/vid√©os : cela acc√©l√®re le diagnostic et l‚Äôestimation.",
  "Pr√©parez l‚Äôadresse et l‚Äôacc√®s (digicode, √©tage, stationnement) pour gagner du temps.",
];
---

<Layout title={title} description={description} canonical={canonical} jsonLd={jsonLd} noindex={noindex}>
  <!-- HERO -->
  <section class="page-title page-title-center dark include-header include-topbar">
    <div class="container">
      <div class="page-title-row mt-5">
        <div class="page-title-content">
          <div class="badge rounded-pill border border-light text-light">Ville</div>
          <h1>D√©pannage & travaux √† {ville.name}</h1>
          <p class="lead mb-0">
            Devis annonc√© avant intervention ‚Ä¢ Intervention √† {ville.name} ({ville.dept}) et alentours ‚Ä¢ {regionLabel}
          </p>
        </div>

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Accueil</a></li>
            <li class="breadcrumb-item"><a href="/villes/">Villes</a></li>
            <li class="breadcrumb-item active" aria-current="page">{ville.name}</li>
          </ol>
        </nav>
      </div>
    </div>
  </section>

  <section id="content">
    <div class="content-wrap pb-0">
      <div class="container">

        <!-- INTRO + CTA -->
        <div class="row align-items-start g-4">
          <div class="col-lg-7">
            <div class="badge rounded-pill badge-default mb-2">Devis gratuit ‚Ä¢ Rappel rapide</div>

            <h2 class="display-6 fw-bold mb-3">
              Un artisan pr√®s de {ville.name} pour un d√©pannage ou des travaux
            </h2>

            <p class="text-muted mb-3">
              Panne, urgence, r√©paration, installation ou r√©novation : choisissez d‚Äôabord la cat√©gorie (plomberie, √©lectricit√©, serrurerie‚Ä¶),
              puis la demande la plus proche. Nous vous r√©pondons rapidement et nous annon√ßons le tarif avant de commencer.
            </p>

            <ul class="iconlist ms-3 mb-4">
              <li><i class="fa-solid fa-check text-smaller color"></i> Explications simples et diagnostic clair</li>
              <li><i class="fa-solid fa-check text-smaller color"></i> Prix annonc√© avant intervention</li>
              <li><i class="fa-solid fa-check text-smaller color"></i> Intervention soign√©e √† {ville.name} et autour</li>
            </ul>

            <div class="d-flex flex-wrap gap-2">
              <a href={telHref} class="button button-rounded button-large text-transform-none ls-0 m-0">
                üìû Appeler ‚Äî {phoneDisplay}
              </a>
              <a href="#devis" class="button button-rounded button-large button-light text-dark bg-white border text-transform-none ls-0 m-0">
                üìù √ätre rappel√©
              </a>
            </div>

            <div class="small text-muted mt-3">
              Zone : {ville.name} ({ville.dept}){around.length ? ` ‚Ä¢ Communes proches : ${aroundNames}${around.length > 8 ? "‚Ä¶" : ""}` : ""}
            </div>
          </div>

          <div class="col-lg-5">
            <div class="card shadow-sm">
              <div class="card-body p-4">
                <h3 class="h5 mb-2">Acc√®s rapide</h3>
                <p class="small text-muted mb-3">
                  Choisissez le type d‚Äôartisan √† {ville.name}.
                </p>

                <div class="row g-2">
                  {metiers.slice(0, 8).map((m) => (
                    <div class="col-12">
                      <a class="btn btn-outline-secondary w-100 text-start" href={`/villes/${ville.slug}/${m.slug}/`}>
                        {m.name} √† {ville.name}
                      </a>
                    </div>
                  ))}
                </div>

                <div class="small text-muted mt-3">
                  Vous ne savez pas lequel choisir ? D√©crivez simplement le probl√®me dans le formulaire, nous vous guidons.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- URGENCE -->
        <div class="card shadow-sm mt-5">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-start gap-3 flex-wrap">
              <div>
                <div class="badge rounded-pill bg-danger mb-2">Urgence</div>
                <h3 class="h5 mb-2">Que faire en attendant ?</h3>
                <p class="small text-muted mb-0">
                  Quelques gestes simples pour limiter les d√©g√¢ts, sans prendre de risque.
                </p>
              </div>
              <div class="d-flex flex-wrap gap-2">
                <a href={telHref} class="btn btn-outline-danger btn-sm">üìû Appeler</a>
                <a href="#devis" class="btn btn-outline-secondary btn-sm">üìù √ätre rappel√©</a>
              </div>
            </div>

            <hr class="my-3" />

            <ul class="iconlist ms-3 mb-0">
              {urgenceTips.map((t) => (
                <li><i class="fa-solid fa-triangle-exclamation text-smaller text-danger"></i> {t}</li>
              ))}
            </ul>
          </div>
        </div>

        <div class="clear line my-6"></div>

        <!-- M√âTIERS + TOP SERVICES -->
        <div class="heading-block border-bottom-0 text-center">
          <div class="badge rounded-pill badge-default">Cat√©gories</div>
          <h3 class="text-transform-none ls-0">Choisir une cat√©gorie √† {ville.name}</h3>
          <p class="text-muted mb-0">
            D√©pannage, installation, travaux : cliquez sur la demande la plus proche.
          </p>
        </div>

        <div class="row mt-4 col-mb-30">
          {metiers.map((m) => {
            const top = topServicesForMetier(m.slug);
            return (
              <div class="col-lg-4 col-md-6 d-flex">
                <div class="card h-100 w-100 shadow-sm">
                  <div class="card-body p-4">
                    <h3 class="h5 mb-2">{m.name} √† {ville.name}</h3>
                    <p class="small text-muted mb-3">
                      Pour une panne, une urgence, une r√©paration ou des travaux : nous vous confirmons le d√©lai et le prix avant intervention.
                    </p>

                    <div class="d-flex flex-wrap gap-2 mb-3">
                      <a class="button button-rounded button-small m-0" href={`/villes/${ville.slug}/${m.slug}/`}>
                        Voir {m.name.toLowerCase()}
                      </a>
                      <a class="button button-border button-rounded button-small m-0" href="#devis">
                        Devis
                      </a>
                    </div>

                    {top?.length ? (
                      <>
                        <div class="small fw-semibold mb-2">Demandes fr√©quentes :</div>
                        <div class="d-grid gap-2">
                          {top.map((s) => (
                            <a
                              class="btn btn-sm btn-outline-secondary text-start"
                              href={`/villes/${ville.slug}/${m.slug}/${s.slug}/`}
                            >
                              {s.name}
                            </a>
                          ))}
                        </div>
                      </>
                    ) : (
                      <div class="small text-muted">
                        (√Ä compl√©ter) Ajoutez 3 demandes fr√©quentes pour ce m√©tier (ex : d√©pannage, r√©paration, installation).
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        <div class="clear line my-6"></div>

        <!-- PRIX (ultra prudent) -->
        <div class="row justify-content-center">
          <div class="col-lg-10">
            <div class="card shadow-sm">
              <div class="card-body p-4">
                <div class="badge rounded-pill badge-default mb-2">Tarifs</div>
                <h3 class="h5 mb-2">Combien cela co√ªte ?</h3>

                <p class="text-muted mb-3">
                  Le prix d√©pend de la complexit√©, de l‚Äôacc√®s, du temps sur place et des pi√®ces √©ventuelles.
                  Apr√®s votre description (et une photo si possible), nous vous donnons une estimation puis nous confirmons
                  <strong> avant</strong> d‚Äôintervenir.
                </p>

                <div class="row g-3 small">
                  <div class="col-md-6">
                    <div class="p-3 border rounded">
                      ‚úÖ <strong>Devis clair</strong><br />
                      Vous savez √† quoi vous attendre (pas de surprise).
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="p-3 border rounded">
                      ‚úÖ <strong>Selon l‚Äôurgence</strong><br />
                      Nous vous confirmons le d√©lai et le tarif avant d√©placement.
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

        <div class="clear line my-6"></div>

        <!-- COMMUNES AUTOUR -->
        {around.length ? (
          <>
            <div class="heading-block border-bottom-0 text-center">
              <div class="badge rounded-pill badge-default">Zone</div>
              <h3 class="text-transform-none ls-0">Autour de {ville.name}</h3>
              <p class="text-muted mb-0">
                Nous intervenons aussi dans les communes proches.
              </p>
            </div>

            <div class="row col-mb-20 mt-4">
              {around.map((v) => (
                <div class="col-lg-3 col-md-4 col-6">
                  <a class="card h-100 text-decoration-none" href={`/villes/${v.slug}/`}>
                    <div class="card-body p-3">
                      <div class="fw-semibold">{v.name}</div>
                      <div class="small text-muted">{v.dept}</div>
                    </div>
                  </a>
                </div>
              ))}
            </div>

            <div class="clear line my-6"></div>
          </>
        ) : null}

        <!-- FAQ -->
        <div class="heading-block border-bottom-0 text-center">
          <div class="badge rounded-pill badge-default">FAQ</div>
          <h3 class="text-transform-none ls-0">Questions fr√©quentes</h3>
        </div>

        <div class="row justify-content-center">
          <div class="col-lg-10">
            <div class="faqs">
              {faq.map((f) => (
                <div class="toggle faq pb-3 mb-4">
                  <div class="toggle-header">
                    <div class="toggle-icon color">
                      <i class="toggle-closed bi-question-circle"></i>
                      <i class="toggle-open bi-question-circle"></i>
                    </div>
                    <div class="toggle-title fw-semibold ps-1">{f.q}</div>
                    <div class="toggle-icon color">
                      <i class="toggle-closed fa-solid fa-chevron-down text-black-50"></i>
                      <i class="toggle-open fa-solid fa-chevron-up color"></i>
                    </div>
                  </div>
                  <div class="toggle-content text-black-50 ps-4">{f.a}</div>
                </div>
              ))}
            </div>
          </div>
        </div>

        <div class="clear line my-6"></div>

        <!-- FORM -->
        <div id="devis" class="section mt-0" style="padding: 70px 0;">
          <div class="container">
            <div class="row justify-content-between align-items-start g-4">
              <div class="col-lg-5">
                <div class="heading-block border-bottom-0 mb-2">
                  <div class="badge rounded-pill badge-default">Devis gratuit</div>
                  <h2 class="text-transform-none ls-0 mb-0">Demande rapide ‚Äî {ville.name}</h2>
                </div>

                <p class="text-muted">
                  D√©crivez votre besoin (adresse, urgence, d√©tail). Nous vous rappelons rapidement pour confirmer le d√©lai et le prix.
                </p>

                <div class="small text-muted">
                  Conseil : si vous connaissez le m√©tier, choisissez-le plus haut puis s√©lectionnez la demande pr√©cise.
                </div>
              </div>

              <div class="col-lg-6">
                <HubspotCustomForm
                  title={`Devis ‚Äî ${ville.name}`}
                  subtitle={`${ville.name} (${ville.dept})`}
                  submitLabel="Envoyer ma demande"
                />
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>
</Layout>
