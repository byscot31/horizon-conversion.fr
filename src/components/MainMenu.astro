---
/**
 * MainMenu.astro
 * Usage (dans une page):
 *
 * <Layout ...>
 *   <MainMenu slot="header" />
 *   ...page...
 * </Layout>
 */

import villes from "../data/villes.json";
import metiers from "../data/metiers.json";

const PHONE = import.meta.env.PUBLIC_PHONE ?? "+33600000000";
const PHONE_DISPLAY = import.meta.env.PUBLIC_PHONE_DISPLAY ?? PHONE;

const telHref = `tel:${String(PHONE).replace(/\s+/g, "")}`;

// Helpers
const path = Astro.url.pathname || "/";

const isActive = (href) => {
  // active exact ou parent (ex: /travaux/ active sur /travaux/xxx/)
  if (href === "/") return path === "/";
  return path === href || path.startsWith(href);
};

// petits sous-ensembles pour mega menu (tu peux ajuster)
const metiersList = [...metiers];
const villesA = villes.filter(v => v.priority === "A");
const villesB = villes.filter(v => v.priority === "B");

// Split en colonnes
const chunk = (arr, n) => {
  const out = [];
  for (let i = 0; i < arr.length; i += n) out.push(arr.slice(i, i + n));
  return out;
};

// M√©tiers en 2 colonnes
const metierCols = chunk(metiersList, Math.ceil(metiersList.length / 2));

// Villes (priority A en 2 colonnes, B en 2 colonnes)
const villesACols = chunk(villesA, Math.ceil(villesA.length / 2));
const villesBCols = chunk(villesB, Math.ceil(villesB.length / 2));
---
<ul class="menu-container">

  <li class={`menu-item ${isActive("/") ? "current" : ""}`}>
    <a class="menu-link" href="/"><div>Accueil</div></a>
  </li>

  <!-- M√©tiers (Mega Menu) -->
  <li class={`menu-item mega-menu mega-menu-full ${isActive("/metiers/") ? "current" : ""}`}>
    <a class="menu-link" href="/metiers/"><div>M√©tiers</div></a>

    <div class="mega-menu-content">
      <div class="container">
        <div class="row g-4 py-4">

          {metierCols.map((col) => (
            <ul class="sub-menu-container mega-menu-column col-lg-3">
              {col.map((m) => (
                <li class={`menu-item ${isActive(`/${m.slug}/`) ? "current" : ""}`}>
                  <a class="menu-link" href={`/${m.slug}/`}><div>{m.name}</div></a>
                </li>
              ))}
            </ul>
          ))}

          <div class="col-lg-6">
            <div class="widget p-4 rounded-3 bg-light">
              <h5 class="mb-2">Besoin d‚Äôun d√©pannage ?</h5>
              <p class="mb-3 small">R√©ponse rapide ‚Ä¢ Devis gratuit ‚Ä¢ Sud Oise / Nord 95</p>
              <div class="d-flex flex-wrap gap-2">
                <a href="/contact/" class="button button-rounded button-small m-0">Demander un devis</a>
                <a href={telHref} class="button button-border button-rounded button-small m-0">Appeler</a>
              </div>
              <hr class="my-3" />
              <p class="small text-muted mb-0">
                Astuce SEO : pages <strong>Ville √ó M√©tier</strong> + <strong>Service √ó Ville</strong> pour capter les requ√™tes locales.
              </p>
            </div>
          </div>

        </div>
      </div>
    </div>
  </li>

  <!-- Villes (Mega Menu) -->
  <li class={`menu-item mega-menu mega-menu-full ${isActive("/villes/") ? "current" : ""}`}>
    <a class="menu-link" href="/villes/"><div>Villes</div></a>

    <div class="mega-menu-content">
      <div class="container">
        <div class="row g-4 py-4">

          <div class="col-12">
            <div class="small text-uppercase ls-1 text-muted mb-2">Villes prioritaires (A)</div>
          </div>

          {villesACols.map((col) => (
            <ul class="sub-menu-container mega-menu-column col-lg-3">
              {col.map((v) => (
                <li class={`menu-item ${isActive(`/villes/${v.slug}/`) ? "current" : ""}`}>
                  <a class="menu-link" href={`/villes/${v.slug}/`}><div>{v.name}</div></a>
                </li>
              ))}
            </ul>
          ))}

          <div class="col-12">
            <div class="small text-uppercase ls-1 text-muted mb-2 mt-3">Communes autour (B)</div>
          </div>

          {villesBCols.map((col) => (
            <ul class="sub-menu-container mega-menu-column col-lg-3">
              {col.slice(0, 8).map((v) => (
                <li class={`menu-item ${isActive(`/villes/${v.slug}/`) ? "current" : ""}`}>
                  <a class="menu-link" href={`/villes/${v.slug}/`}><div>{v.name}</div></a>
                </li>
              ))}
            </ul>
          ))}

          <div class="col-lg-6">
            <div class="widget p-4 rounded-3 bg-light">
              <h6 class="mb-2 text-uppercase ls-1">Maillage local</h6>
              <p class="mb-3 small">
                Chaque page ville renvoie vers ‚Äú<em>Ville √ó M√©tier</em>‚Äù + les communes autour, et les pages ‚Äú<em>Service √ó Ville</em>‚Äù.
              </p>
              <a href="/villes/" class="btn btn-outline-secondary btn-sm">Voir toutes les villes</a>
            </div>
          </div>

        </div>
      </div>
    </div>
  </li>

  <li class={`menu-item ${isActive("/travaux/") ? "current" : ""}`}>
    <a class="menu-link" href="/travaux/"><div>Travaux</div></a>
  </li>

  <li class={`menu-item ${isActive("/avis/") ? "current" : ""}`}>
    <a class="menu-link" href="/avis/"><div>Avis</div></a>
  </li>

  <li class={`menu-item ${isActive("/pro/") ? "current" : ""}`}>
    <a class="menu-link" href="/pro/"><div>Pro</div></a>
  </li>

  <li class={`menu-item ${isActive("/contact/") ? "current" : ""}`}>
    <a class="menu-link" href="/contact/"><div>Contact / Devis</div></a>
  </li>

  <li class={`menu-item ${isActive("/urgence/") ? "current" : ""}`}>
    <a class="menu-link" href="/urgence/">
      <div><span class="text-danger fw-semibold">Urgence</span></div>
    </a>
  </li>

</ul>

<!-- Menu actions mobile (2 actions max) -->
<ul class="menu-container mobile-primary-menu">
  <li class="menu-item">
    <a class="menu-link" href={telHref}><div>üìû Appeler {PHONE_DISPLAY}</div></a>
  </li>
  <li class="menu-item">
    <a class="menu-link" href="/contact/"><div>üìù Devis gratuit</div></a>
  </li>
</ul>
