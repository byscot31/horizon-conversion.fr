---
import villes from "@data/villes.json";
import metiers from "@data/metiers.json";
import services from "@data/services.json";

/**
 * PopularCombosByMetier.astro (client-first)
 * Objectif :
 * - Navigation claire pour particuliers
 * - Pour chaque métier : page métier + accès rapide par ville + demandes fréquentes (service×ville)
 */

const {
  title = "Accès rapide par métier",
  subtitle = "Choisis ton métier, puis ta ville : tu arrives sur la page la plus utile pour ton besoin (devis gratuit, réponse rapide).",
  limitMetiers = 6,
  limitVilles = 4,
  limitServices = 4,
  topVillePriority = "A", // tri interne uniquement
  showAllToggle = true,
  allToggleLabel = "Voir tous les métiers",
  ctaDevisHref = "/contact/",
  ctaDevisLabel = "Demander un devis",
} = Astro.props;

const byNameFR = (a, b) => String(a.name).localeCompare(String(b.name), "fr");

const sortVilles = (arr) =>
  [...arr].sort((a, b) => {
    // tri interne : A d’abord, sans l’afficher
    if (a.priority !== b.priority) return a.priority === "A" ? -1 : 1;
    return byNameFR(a, b);
  });

const topVilles = sortVilles(
  topVillePriority ? villes.filter((v) => v.priority === topVillePriority) : villes
).slice(0, limitVilles);

const allMetiers = [...metiers].sort(byNameFR);
const topMetiers = allMetiers.slice(0, limitMetiers);

const topServicesFor = (metierSlug) =>
  services
    .filter((s) => s.metier === metierSlug)
    .sort((a, b) => (b.is_top === true) - (a.is_top === true) || byNameFR(a, b))
    .filter((s) => s.is_top)
    .slice(0, limitServices);

// petit helper pour varier microcopy
const examplesFor = (mName, vName) => {
  const m = String(mName).toLowerCase();
  return `Ex : “${m} à ${vName}”, “dépannage ${m} ${vName}”, “devis ${m} ${vName}”.`;
};
---

<section class="section m-0">
  <div class="container">
    <div class="heading-block border-bottom-0 text-center mb-4">
      <div class="badge rounded-pill badge-default">Liens rapides</div>
      <h2 class="text-transform-none ls-0">{title}</h2>
      <p class="text-muted mb-0">{subtitle}</p>
    </div>

    <!-- TOP : cartes par métier -->
    <div class="row g-3">
      {topMetiers.map((m) => {
        const sTop = topServicesFor(m.slug);

        return (
          <div class="col-lg-4 col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-semibold">{m.name}</div>
                    <div class="small text-muted">Dépannage • installation • petits travaux</div>
                  </div>
                  <span class="badge bg-light text-dark">
                    {sTop.length ? `${sTop.length} demandes fréquentes` : "Demandes fréquentes"}
                  </span>
                </div>

                <div class="d-flex flex-wrap gap-2 mt-2 mb-3">
                  <a
                    class="btn btn-outline-secondary btn-sm"
                    href={`/${m.slug}/`}
                    aria-label={`Voir la page ${m.name}`}
                  >
                    Voir {m.name}
                  </a>
                  <a class="btn btn-outline-primary btn-sm" href={ctaDevisHref}>
                    {ctaDevisLabel}
                  </a>
                </div>

                <div class="small fw-semibold mb-2">Choisir votre ville</div>

                <div class="d-flex flex-column gap-2">
                  {topVilles.map((v) => (
                    <details class="border rounded-3 p-2">
                      <summary style="cursor:pointer;">
                        <span class="fw-semibold">{v.name}</span>
                        <span class="small text-muted ms-2">{v.dept}</span>
                      </summary>

                      <div class="pt-2">
                        <div class="d-flex flex-wrap gap-2 mb-2">
                          <a
                            class="btn btn-sm btn-outline-secondary"
                            href={`/villes/${v.slug}/${m.slug}/`}
                            aria-label={`${m.name} à ${v.name} — devis gratuit`}
                            title={`${m.name} à ${v.name}`}
                          >
                            {m.name} à {v.name}
                          </a>
                          <a class="btn btn-sm btn-outline-primary" href={ctaDevisHref}>
                            Devis
                          </a>
                        </div>

                        <div class="small text-muted mb-2">
                          {examplesFor(m.name, v.name)}
                        </div>

                        {sTop.length ? (
                          <>
                            <div class="small fw-semibold mb-1">Demandes fréquentes</div>
                            <div class="d-flex flex-wrap gap-2">
                              {sTop.map((s) => (
                                <a
                                  class="btn btn-sm btn-outline-secondary"
                                  href={`/villes/${v.slug}/${m.slug}/${s.slug}/`}
                                  aria-label={`${s.name} à ${v.name} — devis gratuit`}
                                  title={`${s.name} à ${v.name}`}
                                >
                                  {s.name}
                                </a>
                              ))}
                            </div>
                            <div class="small text-muted mt-2">
                              Cliquez la demande la plus proche de votre problème.
                            </div>
                          </>
                        ) : (
                          <div class="small text-muted">Demandes en cours d’ajout pour ce métier.</div>
                        )}
                      </div>
                    </details>
                  ))}
                </div>

              </div>
            </div>
          </div>
        );
      })}
    </div>

    {showAllToggle && (
      <div class="mt-4">
        <details class="card shadow-sm">
          <summary class="card-body p-4" style="cursor:pointer;">
            <span class="fw-semibold">{allToggleLabel}</span>
            <span class="text-muted small ms-2">— si tu cherches un autre métier</span>
          </summary>

          <div class="card-body pt-0 px-4 pb-4">
            <div class="row g-3">
              {allMetiers.map((m) => {
                const sTop = topServicesFor(m.slug);

                return (
                  <div class="col-lg-4 col-md-6">
                    <details class="card h-100 shadow-sm">
                      <summary class="card-body p-3" style="cursor:pointer;">
                        <div class="d-flex justify-content-between align-items-start">
                          <span class="fw-semibold">{m.name}</span>
                          <span class="badge bg-light text-dark">
                            {sTop.length ? `${sTop.length} top` : "Top"}
                          </span>
                        </div>
                        <div class="small text-muted">Ouvre pour choisir une ville + une demande</div>
                      </summary>

                      <div class="card-body pt-0 px-3 pb-3">
                        <div class="d-flex flex-wrap gap-2 mb-3">
                          <a class="btn btn-outline-secondary btn-sm" href={`/${m.slug}/`}>
                            Voir {m.name}
                          </a>
                          <a class="btn btn-outline-primary btn-sm" href={ctaDevisHref}>
                            {ctaDevisLabel}
                          </a>
                          <a class="btn btn-outline-secondary btn-sm" href="/villes/">
                            Toutes les villes
                          </a>
                        </div>

                        <div class="small fw-semibold mb-2">Villes principales</div>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                          {topVilles.map((v) => (
                            <a
                              class="btn btn-sm btn-outline-secondary"
                              href={`/villes/${v.slug}/${m.slug}/`}
                              aria-label={`${m.name} à ${v.name} — devis gratuit`}
                              title={`${m.name} à ${v.name}`}
                            >
                              {v.name}
                            </a>
                          ))}
                        </div>

                        <div class="small fw-semibold mb-2">Demandes fréquentes</div>
                        <div class="d-flex flex-wrap gap-2">
                          {sTop.map((s) => (
                            <a
                              class="btn btn-sm btn-outline-secondary"
                              href={`/${m.slug}/#service-${s.slug}`}
                              title={s.name}
                            >
                              {s.name}
                            </a>
                          ))}
                          {!sTop.length && <span class="small text-muted">À venir.</span>}
                        </div>
                      </div>
                    </details>
                  </div>
                );
              })}
            </div>
          </div>
        </details>
      </div>
    )}
  </div>
</section>
