---
import villes from "@data/villes.json";
import metiers from "@data/metiers.json";
import services from "@data/services.json";

/**
 * PopularCombosByMetier.astro
 * Objectif :
 * - Maillage fort mais lisible
 * - Pour chaque métier : liens /[metier]/ + Ville×Métier + Service×Ville (via top villes)
 */

const {
  title = "Combos populaires",
  subtitle = "Accès direct aux pages “Métier × Ville” et “Service × Ville” (SEO local).",
  limitMetiers = 6,
  limitVilles = 4,     // nb de villes affichées par métier
  limitServices = 4,   // nb de services top par métier et par ville
  topVillePriority = "A",
  showAllToggle = true,
  allToggleLabel = "Voir tous les métiers (accordéons)",
} = Astro.props;

const byNameFR = (a, b) => String(a.name).localeCompare(String(b.name), "fr");
const sortVilles = (arr) =>
  [...arr].sort((a, b) => {
    if (a.priority !== b.priority) return a.priority === "A" ? -1 : 1;
    return byNameFR(a, b);
  });

const topVilles = sortVilles(
  topVillePriority ? villes.filter((v) => v.priority === topVillePriority) : villes
).slice(0, limitVilles);

const allMetiers = [...metiers].sort(byNameFR);
const topMetiers = allMetiers.slice(0, limitMetiers);

const topServicesFor = (metierSlug) =>
  services
    .filter((s) => s.metier === metierSlug)
    .sort((a, b) => (b.is_top === true) - (a.is_top === true) || byNameFR(a, b))
    .filter((s) => s.is_top)
    .slice(0, limitServices);

const prettify = (s) =>
  String(s)
    .replace(/-/g, " ")
    .replace(/\b\w/g, (m) => m.toUpperCase());
---

<section class="section m-0">
  <div class="container">
    <div class="heading-block border-bottom-0 text-center mb-4">
      <div class="badge rounded-pill badge-default">Liens rapides</div>
      <h2 class="text-transform-none ls-0">{title}</h2>
      <p class="text-muted mb-0">{subtitle}</p>
    </div>

    <!-- TOP : cartes par métier -->
    <div class="row g-3">
      {topMetiers.map((m) => {
        const sTop = topServicesFor(m.slug);
        return (
          <div class="col-lg-4 col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-body p-4">

                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-semibold">{m.name}</div>
                    <div class="small text-muted">Pages métier + villes prioritaires</div>
                  </div>
                  <span class="badge bg-light text-dark">{sTop.length} services</span>
                </div>

                <div class="d-flex flex-wrap gap-2 mt-2 mb-3">
                  <a class="btn btn-outline-secondary btn-sm" href={`/${m.slug}/`}>Page métier</a>
                  <a class="btn btn-outline-primary btn-sm" href="/contact/">Devis</a>
                </div>

                <div class="small fw-semibold mb-2">Métiers × Villes (priorité {topVillePriority})</div>

                <div class="d-flex flex-column gap-2">
                  {topVilles.map((v) => (
                    <details class="border rounded-3 p-2">
                      <summary style="cursor:pointer;">
                        <span class="fw-semibold">{v.name}</span>
                        <span class="small text-muted ms-2">{v.dept}</span>
                        <span class={`badge ms-2 ${v.priority === "A" ? "bg-success" : "bg-secondary"}`}>{v.priority}</span>
                      </summary>

                      <div class="pt-2">
                        <div class="d-flex flex-wrap gap-2 mb-2">
                          <a class="btn btn-sm btn-outline-secondary" href={`/villes/${v.slug}/${m.slug}/`}>
                            Voir {m.name} à {v.name}
                          </a>
                        </div>

                        {sTop.length ? (
                          <>
                            <div class="small text-muted mb-1">Services top (Service × Ville)</div>
                            <div class="d-flex flex-wrap gap-2">
                              {sTop.map((s) => (
                                <a
                                  class="btn btn-sm btn-outline-secondary"
                                  href={`/villes/${v.slug}/${m.slug}/${s.slug}/`}
                                  aria-label={`${s.name} - ${m.name} à ${v.name}`}
                                >
                                  {s.name}
                                </a>
                              ))}
                            </div>
                          </>
                        ) : (
                          <div class="small text-muted">Services à venir pour ce métier.</div>
                        )}
                      </div>
                    </details>
                  ))}
                </div>

              </div>
            </div>
          </div>
        );
      })}
    </div>

    {showAllToggle && (
      <div class="mt-4">
        <details class="card shadow-sm">
          <summary class="card-body p-4" style="cursor:pointer;">
            <span class="fw-semibold">{allToggleLabel}</span>
            <span class="text-muted small ms-2">— plus de liens, mais rangés</span>
          </summary>

          <div class="card-body pt-0 px-4 pb-4">
            <div class="row g-3">
              {allMetiers.map((m) => {
                const sTop = topServicesFor(m.slug);
                return (
                  <div class="col-lg-4 col-md-6">
                    <details class="card h-100 shadow-sm">
                      <summary class="card-body p-3" style="cursor:pointer;">
                        <div class="d-flex justify-content-between align-items-start">
                          <span class="fw-semibold">{m.name}</span>
                          <span class="badge bg-light text-dark">{sTop.length} top</span>
                        </div>
                        <div class="small text-muted">Ouvre pour voir villes + services</div>
                      </summary>

                      <div class="card-body pt-0 px-3 pb-3">
                        <div class="d-flex flex-wrap gap-2 mb-3">
                          <a class="btn btn-outline-secondary btn-sm" href={`/${m.slug}/`}>Page métier</a>
                          <a class="btn btn-outline-primary btn-sm" href="/contact/">Devis</a>
                        </div>

                        <div class="small fw-semibold mb-2">Villes</div>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                          {sortVilles(villes).slice(0, 10).map((v) => (
                            <a class="btn btn-sm btn-outline-secondary" href={`/villes/${v.slug}/${m.slug}/`}>
                              {v.name}
                            </a>
                          ))}
                          <a class="btn btn-sm btn-outline-secondary" href="/villes/">Toutes les villes</a>
                        </div>

                        <div class="small fw-semibold mb-2">Services top</div>
                        <div class="d-flex flex-wrap gap-2">
                          {sTop.map((s) => (
                            <a class="btn btn-sm btn-outline-secondary" href={`/${m.slug}/#service-${s.slug}`}>
                              {s.name}
                            </a>
                          ))}
                          {!sTop.length && <span class="small text-muted">Services à venir.</span>}
                        </div>
                      </div>
                    </details>
                  </div>
                );
              })}
            </div>
          </div>
        </details>
      </div>
    )}
  </div>
</section>
