---
import villes from "../data/villes.json";
import metiers from "../data/metiers.json";

/**
 * PopularCombos.astro
 * Affiche :
 * - un bloc "Top combos" (ex: 6 villes A × 6 métiers = 36 liens)
 * - + un <details> pour accéder à tous les combos sans rendre la page illisible
 */

const {
  title = "Combos populaires",
  subtitle = "Accès direct aux pages Ville × Métier (maillage local).",
  limitVilles = 6,
  limitMetiers = 6,
  topVillePriority = "A", // "A" recommandé
  showAllToggle = true,
  allToggleLabel = "Voir tous les combos (A + B)",
} = Astro.props;

const byNameFR = (a, b) => String(a.name).localeCompare(String(b.name), "fr");
const byPrioThenName = (a, b) =>
  String(a.priority).localeCompare(String(b.priority)) || byNameFR(a, b);

const allMetiers = [...metiers].sort(byNameFR);

// TOP: villes A (ou autre) limitées
const topVilles = [...villes]
  .filter((v) => !topVillePriority || v.priority === topVillePriority)
  .sort(byNameFR)
  .slice(0, limitVilles);

const topMetiers = allMetiers.slice(0, limitMetiers);

// ALL: tout (A + B), groupé par priorité puis nom
const allVilles = [...villes].sort(byPrioThenName);

// regroupement par zone pour lisibilité
const zones = [
  { key: "sud-oise", label: "Sud Oise (60)" },
  { key: "nord-95", label: "Nord 95" },
];

const villesByZone = (zoneKey) => allVilles.filter((v) => v.zone === zoneKey);
---

<section class="section m-0">
  <div class="container">
    <div class="heading-block border-bottom-0 text-center mb-4">
      <div class="badge rounded-pill badge-default">SEO local</div>
      <h2 class="text-transform-none ls-0">{title}</h2>
      <p class="text-muted mb-0">{subtitle}</p>
    </div>

    <!-- TOP COMBOS : 6 villes × 6 métiers -->
    <div class="row g-3">
      {topVilles.map((v) => (
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm">
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-start">
                <h3 class="h6 mb-1">{v.name}</h3>
                <span class="badge bg-light text-dark">{v.priority} • {v.dept}</span>
              </div>

              <div class="d-flex flex-wrap gap-2 mt-2 mb-3">
                <a class="btn btn-outline-secondary btn-sm" href={`/villes/${v.slug}/`}>Page ville</a>
                <a class="btn btn-outline-primary btn-sm" href="/contact/">Devis</a>
              </div>

              <div class="small fw-semibold mb-2">Ville × Métier</div>
              <div class="d-flex flex-wrap gap-2">
                {topMetiers.map((m) => (
                  <a
                    class="btn btn-sm btn-outline-secondary"
                    href={`/villes/${v.slug}/${m.slug}/`}
                    aria-label={`${m.name} à ${v.name}`}
                  >
                    {m.name}
                  </a>
                ))}
              </div>
            </div>
          </div>
        </div>
      ))}
    </div>

    {showAllToggle && (
      <div class="mt-4">
        <details class="card shadow-sm">
          <summary class="card-body p-4" style="cursor: pointer;">
            <span class="fw-semibold">{allToggleLabel}</span>
            <span class="text-muted small ms-2">— sans surcharger la page</span>
          </summary>

          <div class="card-body pt-0 px-4 pb-4">
            <div class="row g-3">

              {zones.map((z) => {
                const vz = villesByZone(z.key);
                if (!vz.length) return null;

                return (
                  <div class="col-12">
                    <div class="small text-uppercase ls-1 fw-bold text-muted mt-2 mb-2">{z.label}</div>

                    <div class="row g-3">
                      {vz.map((v) => (
                        <div class="col-md-6 col-lg-4">
                          <details class="card h-100 shadow-sm">
                            <summary class="card-body p-3" style="cursor: pointer;">
                              <div class="d-flex justify-content-between align-items-start">
                                <span class="fw-semibold">{v.name}</span>
                                <span class="badge bg-light text-dark">{v.priority} • {v.dept}</span>
                              </div>
                              <div class="small text-muted mt-1">Ouvre pour voir tous les métiers</div>
                            </summary>

                            <div class="card-body pt-0 px-3 pb-3">
                              <div class="d-flex flex-wrap gap-2 mb-2">
                                <a class="btn btn-outline-secondary btn-sm" href={`/villes/${v.slug}/`}>Page ville</a>
                                <a class="btn btn-outline-primary btn-sm" href="/contact/">Devis</a>
                              </div>

                              <div class="d-flex flex-wrap gap-2">
                                {allMetiers.map((m) => (
                                  <a
                                    class="btn btn-sm btn-outline-secondary"
                                    href={`/villes/${v.slug}/${m.slug}/`}
                                    aria-label={`${m.name} à ${v.name}`}
                                  >
                                    {m.name}
                                  </a>
                                ))}
                              </div>
                            </div>
                          </details>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}

            </div>
          </div>
        </details>
      </div>
    )}
  </div>
</section>
