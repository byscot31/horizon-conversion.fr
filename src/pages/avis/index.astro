---
import Layout from "@layouts/Layout.astro";
import avis from "@data/avis.json";
import villes from "@data/villes.json";
import metiers from "@data/metiers.json";
import services from "@data/services.json";

const brand = import.meta.env.PUBLIC_BRAND_NAME ?? "Horizon Conversion";
const regionLabel = import.meta.env.PUBLIC_REGION_LABEL ?? "Sud Oise (60) / Nord 95";
const canonical = "/avis/";

const SITE_URL =
  import.meta.env.PUBLIC_SITE_URL ??
  (Astro.site ? Astro.site.toString().replace(/\/$/, "") : "");

const title = `Avis clients ‚Äî ${brand}`;
const description = `Avis clients et retours d‚Äôintervention. Zone : ${regionLabel}.`;

const items = [...avis].sort((a, b) => String(b.date).localeCompare(String(a.date)));

function villeName(slug) {
  return villes.find((v) => v.slug === slug)?.name ?? slug;
}
function metierName(slug) {
  return metiers.find((m) => m.slug === slug)?.name ?? slug;
}
function serviceName(mSlug, sSlug) {
  return services.find((s) => s.metier === mSlug && s.slug === sSlug)?.name ?? sSlug;
}

// stats
const ratingCount = items.length;
const averageRating =
  ratingCount ? items.reduce((sum, r) => sum + Number(r.rating ?? 5), 0) / ratingCount : 5;

const verifiedCount = items.filter((r) => !!r.verified).length;

// options filtres
const villeOptions = [...new Map(villes.map((v) => [v.slug, v.name])).entries()]
  .map(([slug, name]) => ({ slug, name }))
  .sort((a, b) => a.name.localeCompare(b.name, "fr"));

const metierOptions = [...metiers]
  .map((m) => ({ slug: m.slug, name: m.name }))
  .sort((a, b) => a.name.localeCompare(b.name, "fr"));

// JSON-LD
const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Accueil", "item": SITE_URL ? `${SITE_URL}/` : "/" },
    { "@type": "ListItem", "position": 2, "name": "Avis", "item": SITE_URL ? `${SITE_URL}${canonical}` : canonical },
  ],
};

const businessJsonLd = {
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  "name": brand,
  "areaServed": regionLabel,
  "url": SITE_URL ? `${SITE_URL}/` : undefined,
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": Number(averageRating.toFixed(2)),
    "reviewCount": ratingCount,
  },
};

const jsonLd = [breadcrumbJsonLd, businessJsonLd];
---

<Layout title={title} description={description} canonical={canonical} jsonLd={jsonLd}>
  <section class="page-title page-title-center dark include-header include-topbar">
    <div class="container">
      <div class="page-title-row mt-5">
        <div class="page-title-content">
          <div class="badge rounded-pill border border-light text-light">Avis</div>
          <h1>Avis clients</h1>
          <p class="lead mb-0">
            {regionLabel} ‚Ä¢ <strong>{averageRating.toFixed(1)}/5</strong> (sur {ratingCount} avis)
            {verifiedCount ? ` ‚Ä¢ ${verifiedCount} avis v√©rifi√©s` : ""}
          </p>
        </div>

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Accueil</a></li>
            <li class="breadcrumb-item active" aria-current="page">Avis</li>
          </ol>
        </nav>
      </div>
    </div>
  </section>

  <section id="content">
    <div class="content-wrap pb-0">
      <div class="container">

        <!-- Intro (client-first) -->
        <div class="row justify-content-center text-center">
          <div class="col-lg-9">
            <div class="badge rounded-pill badge-default mb-2">Confiance</div>
            <h2 class="display-6 fw-bold mb-3">Des retours concrets, sur de vraies interventions</h2>
            <p class="text-muted mb-0">
              Lis les avis par ville et par type d‚Äôintervention. Si tu veux, tu peux demander un devis en 1 minute.
            </p>
          </div>
        </div>

        <div class="clear line my-6"></div>

        <!-- Filtres -->
        <div class="row justify-content-center">
          <div class="col-lg-11">
            <div class="card shadow-sm">
              <div class="card-body p-4">
                <div class="row g-3 align-items-end">
                  <div class="col-md-5">
                    <label class="form-label small text-muted mb-1" for="r-search">Rechercher dans les avis</label>
                    <input
                      id="r-search"
                      class="form-control"
                      type="search"
                      placeholder="Ex : fuite, serrure, disjoncteur, chauffe-eau, d√©pannage‚Ä¶"
                    />
                  </div>

                  <div class="col-md-3">
                    <label class="form-label small text-muted mb-1" for="r-ville">Ville</label>
                    <select id="r-ville" class="form-select">
                      <option value="all">Toutes les villes</option>
                      {villeOptions.map((v) => (
                        <option value={v.slug}>{v.name}</option>
                      ))}
                    </select>
                  </div>

                  <div class="col-md-2">
                    <label class="form-label small text-muted mb-1" for="r-metier">Cat√©gorie</label>
                    <select id="r-metier" class="form-select">
                      <option value="all">Toutes</option>
                      {metierOptions.map((m) => (
                        <option value={m.slug}>{m.name}</option>
                      ))}
                    </select>
                  </div>

                  <div class="col-md-2">
                    <label class="form-label small text-muted mb-1" for="r-min">Note mini</label>
                    <select id="r-min" class="form-select">
                      <option value="all">Toutes</option>
                      <option value="5">5/5</option>
                      <option value="4">4/5 et +</option>
                      <option value="3">3/5 et +</option>
                    </select>
                  </div>
                </div>

                <div class="d-flex flex-wrap gap-3 align-items-center mt-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="r-verified" />
                    <label class="form-check-label small" for="r-verified">Afficher uniquement les avis v√©rifi√©s</label>
                  </div>

                  <button class="btn btn-outline-secondary btn-sm ms-auto" type="button" id="r-reset">
                    R√©initialiser
                  </button>

                  <div class="small text-muted" id="r-count"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="clear line my-6"></div>

        <!-- Grid avis -->
        <div class="row col-mb-30" id="reviews-grid">
          {items.map((r) => {
            const vName = villeName(r.ville);
            const mName = metierName(r.metier);
            const sName = serviceName(r.metier, r.service);
            const txt = String(r.text ?? "");
            const short = txt.length > 220 ? `${txt.slice(0, 220)}‚Ä¶` : txt;

            return (
              <div
                class="col-lg-4 col-md-6 d-flex review-item"
                data-text={`${r.author} ${vName} ${mName} ${sName} ${txt}`.toLowerCase()}
                data-ville={String(r.ville)}
                data-metier={String(r.metier)}
                data-rating={String(Number(r.rating ?? 5))}
                data-verified={r.verified ? "1" : "0"}
              >
                <div class="card h-100 w-100 shadow-sm">
                  <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start gap-3 mb-2">
                      <div>
                        <h3 class="h6 mb-1 fw-bold">{r.author}</h3>
                        <div class="small text-muted">
                          {r.date} ‚Ä¢ {vName}
                        </div>
                      </div>
                      <div class="text-end">
                        <div class="badge rounded-pill bg-dark">{Number(r.rating ?? 5)}/5</div>
                        {r.verified && <div class="small text-success mt-1">‚úì v√©rifi√©</div>}
                      </div>
                    </div>

                    <div class="small text-muted mb-2">
                      <strong>{mName}</strong> ‚Ä¢ {sName}
                    </div>

                    <p class="mb-3">{short}</p>

                    <div class="d-flex flex-wrap gap-2">
                      <a class="btn btn-outline-secondary btn-sm" href={`/avis/${String(r.id)}/`}>
                        Lire l‚Äôavis
                      </a>

                      <a class="btn btn-light btn-sm border" href={`/villes/${r.ville}/`}>
                        {vName}
                      </a>

                      <a class="btn btn-light btn-sm border" href={`/villes/${r.ville}/${r.metier}/${r.service}/`}>
                        Intervention
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        <div class="clear line my-6"></div>

        <!-- CTA devis -->
        <div class="section mt-0" style="padding: 70px 0;">
          <div class="container">
            <div class="row justify-content-center text-center">
              <div class="col-lg-8">
                <div class="badge rounded-pill badge-default mb-2">Devis gratuit</div>
                <h3 class="text-transform-none ls-0 mb-3">Besoin d‚Äôaide chez toi ?</h3>
                <p class="text-muted mb-4">
                  Dis-nous ta ville et ce qui ne va pas (urgence ou rendez-vous) : on te rappelle rapidement.
                </p>
                <div class="d-flex flex-wrap justify-content-center gap-2">
                  <a href="/contact/" class="button button-rounded button-large m-0">üìù Demander un devis</a>
                  <a href="/villes/" class="button button-border button-rounded button-large m-0">üìç Choisir ma ville</a>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- Filtrage front (isol√©, l√©ger, sans $ global) -->
  <script is:inline>
    (() => {
      const qs = (sel, root = document) => root.querySelector(sel);
      const qsa = (sel, root = document) => Array.from(root.querySelectorAll(sel));

      const input = qs("#r-search");
      const ville = qs("#r-ville");
      const metier = qs("#r-metier");
      const min = qs("#r-min");
      const verified = qs("#r-verified");
      const reset = qs("#r-reset");
      const count = qs("#r-count");

      function applyFilters() {
        const q = (input?.value || "").trim().toLowerCase();
        const v = ville?.value || "all";
        const m = metier?.value || "all";
        const minVal = min?.value || "all";
        const onlyVerified = !!verified?.checked;

        const cards = qsa(".review-item");
        let visible = 0;

        cards.forEach((el) => {
          const text = el.getAttribute("data-text") || "";
          const elVille = el.getAttribute("data-ville") || "";
          const elMetier = el.getAttribute("data-metier") || "";
          const elRating = Number(el.getAttribute("data-rating") || "0");
          const elVerified = el.getAttribute("data-verified") === "1";

          const okQ = !q || text.includes(q);
          const okV = v === "all" || elVille === v;
          const okM = m === "all" || elMetier === m;
          const okMin = minVal === "all" || elRating >= Number(minVal);
          const okVer = !onlyVerified || elVerified;

          const show = okQ && okV && okM && okMin && okVer;
          el.style.display = show ? "" : "none";
          if (show) visible++;
        });

        if (count) count.textContent = `${visible} avis affich√©(s)`;
      }

      [input, ville, metier, min].forEach((el) => el && el.addEventListener("input", applyFilters));
      [ville, metier, min].forEach((el) => el && el.addEventListener("change", applyFilters));
      verified?.addEventListener("change", applyFilters);

      reset?.addEventListener("click", () => {
        if (input) input.value = "";
        if (ville) ville.value = "all";
        if (metier) metier.value = "all";
        if (min) min.value = "all";
        if (verified) verified.checked = false;
        applyFilters();
      });

      applyFilters();
    })();
  </script>
</Layout>
