---
import Layout from "@layouts/Layout.astro";
import MainMenu from "@components/MainMenu.astro";
import HubspotCustomForm from "@components/HubspotCustomForm.astro";
import TopServicesGlobal from "@components/TopServicesGlobal.astro";

import metiers from "@data/metiers.json";
import villes from "@data/villes.json";
import travaux from "@data/travaux.json";
import avis from "@data/avis.json";

const SITE_URL =
  import.meta.env.PUBLIC_SITE_URL ??
  (Astro.site ? Astro.site.toString().replace(/\/$/, "") : "");

const BRAND = import.meta.env.PUBLIC_BRAND_NAME ?? "Horizon Conversion";
const REGION = import.meta.env.PUBLIC_REGION_LABEL ?? "Sud Oise (60) / Nord 95";
const PHONE = import.meta.env.PUBLIC_PHONE ?? "+33600000000";
const PHONE_DISPLAY = import.meta.env.PUBLIC_PHONE_DISPLAY ?? PHONE;

const telHref = `tel:${String(PHONE).replace(/\s+/g, "")}`;

const villesA = villes.filter((v) => v.priority === "A");
const getVilleName = (slug) => villes.find((v) => v.slug === slug)?.name ?? slug;
const getMetierName = (slug) => metiers.find((m) => m.slug === slug)?.name ?? slug;

const avgRating =
  avis && avis.length
    ? Math.round((avis.reduce((sum, a) => sum + (a.rating ?? 5), 0) / avis.length) * 10) / 10
    : 5;

const jsonLd = [
  {
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    "name": BRAND,
    "url": SITE_URL ? `${SITE_URL}/` : undefined,
    "telephone": PHONE,
    "areaServed": REGION,
    "address": { "@type": "PostalAddress", "addressCountry": "FR" }
  },
  { "@context": "https://schema.org", "@type": "WebSite", "name": BRAND, "url": SITE_URL ? `${SITE_URL}/` : undefined }
].filter(Boolean);

const title = `${BRAND} ‚Äî D√©pannage urgent & travaux maison | ${REGION}`;
const description =
  `D√©pannage plomberie, √©lectricit√©, serrurerie, toiture, chauffage. Intervention ${REGION}. ` +
  `Devis annonc√© avant intervention, r√©ponse rapide, travail propre.`;
---

<Layout title={title} description={description} canonical="/" jsonLd={jsonLd}>
  <MainMenu slot="header" />

  <!-- HERO -->
  <section class="page-title page-title-parallax parallax scroll-detect page-title-center dark include-header include-topbar">
    <img src="/images/services/page-title.jpg" class="parallax-bg" alt="" />
    <div id="particles-line"></div>

    <div class="container">
      <div class="page-title-row">
        <div class="page-title-content">
          <div class="badge rounded-pill border border-light text-light">D√©pannage √† domicile ‚Ä¢ {REGION}</div>

          <h1>D√©pannage urgent & travaux maison</h1>

          <p class="mt-3 mb-0" style="max-width: 860px; margin: 0 auto;">
            <strong>Fuite d‚Äôeau</strong>, <strong>WC bouch√©</strong>, <strong>disjoncteur qui saute</strong>,
            <strong>porte claqu√©e</strong>, <strong>serrure bloqu√©e</strong>, <strong>infiltration toiture</strong>,
            <strong>plus d‚Äôeau chaude</strong>‚Ä¶<br />
            On vous r√©pond vite, et on vous annonce le tarif <strong>avant d‚Äôintervenir</strong>.
          </p>

          <div class="d-flex flex-wrap justify-content-center gap-2 mt-4">
            <a href={telHref} class="button button-rounded button-large text-transform-none ls-0">
              üìû Appeler {PHONE_DISPLAY}
            </a>
            <a href="/contact/" class="button button-rounded button-large button-light text-dark bg-white border text-transform-none ls-0">
              üìù Demander un devis
            </a>
          </div>

          <div class="d-flex flex-wrap justify-content-center gap-3 mt-4 small text-light-50">
            <span>‚úÖ Tarif annonc√© avant intervention</span>
            <span>‚úÖ Intervention soign√©e</span>
            <span>‚úÖ {avgRating}/5 ‚Ä¢ {avis.length} avis</span>
          </div>
        </div>
      </div>
    </div>

    <div class="video-overlay z-1" style="background-image: linear-gradient(to top, rgba(254,150,3,0.45), #39384D);"></div>
  </section>

  <section id="content">
    <div class="content-wrap pb-0">

      <!-- INTRO -->
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-6">
            <div class="badge rounded-pill badge-default">√Ä domicile</div>
            <h2 class="display-5 fw-bold mt-2">On intervient vite, et on fait propre.</h2>

            <p class="mt-3 mb-0">
              D‚Äôabord on comprend le probl√®me (par t√©l√©phone ou message), ensuite on vous propose la solution la plus simple :
              <strong>r√©parer</strong>, <strong>remplacer</strong> ou <strong>s√©curiser</strong>.
              Vous avez une r√©ponse claire, sans blabla.
            </p>

            <div class="row g-3 mt-4">
              <div class="col-12 col-sm-6">
                <div class="feature-box fbox-sm">
                  <div class="fbox-icon"><a href="#"><i class="bi-check-lg bg-info border-0"></i></a></div>
                  <div class="fbox-content">
                    <h3 class="text-transform-none">Urgence / d√©pannage</h3>
                    <p class="mb-0">Selon disponibilit√© : fuite, panne, porte bloqu√©e, infiltration‚Ä¶</p>
                  </div>
                </div>
              </div>

              <div class="col-12 col-sm-6">
                <div class="feature-box fbox-sm">
                  <div class="fbox-icon"><a href="#"><i class="bi-check-lg bg-primary border-0"></i></a></div>
                  <div class="fbox-content">
                    <h3 class="text-transform-none">Prix annonc√©</h3>
                    <p class="mb-0">On vous annonce le tarif avant intervention (hors cas particuliers).</p>
                  </div>
                </div>
              </div>

              <div class="col-12 col-sm-6">
                <div class="feature-box fbox-sm">
                  <div class="fbox-icon"><a href="#"><i class="bi-check-lg bg-danger border-0"></i></a></div>
                  <div class="fbox-content">
                    <h3 class="text-transform-none">Travail propre</h3>
                    <p class="mb-0">Protection, finitions soign√©es, conseils pour √©viter que √ßa revienne.</p>
                  </div>
                </div>
              </div>

              <div class="col-12 col-sm-6">
                <div class="feature-box fbox-sm">
                  <div class="fbox-icon"><a href="#"><i class="bi-check-lg bg-success border-0"></i></a></div>
                  <div class="fbox-content">
                    <h3 class="text-transform-none">Zone locale</h3>
                    <p class="mb-0">{REGION} et alentours.</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2 mt-4">
              <a href={telHref} class="btn btn-outline-secondary btn-sm">üìû {PHONE_DISPLAY}</a>
              <a href="/urgence/" class="btn btn-outline-danger btn-sm">Urgence</a>
              <a href="/travaux/" class="btn btn-outline-secondary btn-sm">R√©alisations</a>
              <a href="/avis/" class="btn btn-outline-secondary btn-sm">Avis</a>
            </div>

            <p class="small text-muted mt-3 mb-0">
              Pour aller plus vite : indiquez votre <strong>ville</strong> + le <strong>sympt√¥me</strong> (ex : ‚Äúfuite sous √©vier‚Äù, ‚ÄúWC qui d√©borde‚Äù, ‚Äúplus de courant‚Äù, ‚Äúcl√© cass√©e‚Äù).
            </p>
          </div>

          <div class="col-lg-6 mt-4 mt-lg-0">
            <img src="/images/services/1.svg" alt="D√©pannage √† domicile" />
          </div>
        </div>

        <div class="clear line my-6"></div>

        <!-- M√âTIERS -->
        <div class="heading-block border-bottom-0 text-center">
          <div class="badge rounded-pill badge-default">Services</div>
          <h3 class="text-transform-none ls-0">Choisissez le type d‚Äôintervention</h3>
          <p class="mb-0">Urgence, d√©pannage, remplacement, r√©novation.</p>
        </div>

        <div class="row mt-4 col-mb-30">
          {metiers.map((m) => (
            <div class="col-sm-6 col-lg-4">
              <div class="card h-100 shadow-sm">
                <div class="card-body p-4">
                  <h3 class="text-transform-none mb-2">{m.name}</h3>
                  <p class="text-muted mb-3">
                    D√©pannage ‚Ä¢ installation ‚Ä¢ r√©paration
                  </p>
                  <div class="d-flex flex-wrap gap-2">
                    <a class="btn btn-outline-secondary btn-sm" href={`/${m.slug}/`}>Voir</a>
                    <a class="btn btn-outline-primary btn-sm" href="/contact/">Devis</a>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>

        <div class="clear line my-6"></div>

        <!-- TOP SERVICES GLOBAL -->
        <div class="row mt-4 col-mb-30">
          <TopServicesGlobal
            title="Urgences & demandes fr√©quentes"
            subtitle="Les demandes les plus courantes (urgent en premier)."
            limit={12}
            onlyTop={true}
            defaultCityPriority="A"
            cityLimit={12}
            ctaTel={false}
            ctaDevis={false}
          />
        </div>

      </div>

      <!-- ZONES / VILLES -->
      <div class="section mb-0">
        <div class="container">

          <div class="heading-block border-bottom-0 text-center">
            <div class="badge rounded-pill badge-default">Zone</div>
            <h3 class="text-transform-none ls-0">Intervention {REGION}</h3>
            <p class="mb-0">Quelques villes o√π l‚Äôon intervient souvent :</p>
          </div>

          <div class="row col-mb-30 align-content-stretch mt-4">

            {villesA.slice(0, 6).map((v) => (
              <div class="col-lg-4 col-md-6 d-flex">
                <div class="card w-100 shadow-sm">
                  <div class="card-body p-4">
                    <h3 class="text-transform-none ls-0 text-larger mb-2">{v.name}</h3>
                    <p class="text-smaller text-muted mb-3">
                      Autour : {(v.around || []).slice(0, 6).map(getVilleName).join(", ")}
                      {(v.around || []).length > 6 ? "‚Ä¶" : ""}
                    </p>

                    <div class="d-flex flex-wrap gap-2">
                      <a href={`/villes/${v.slug}/`} class="btn btn-outline-secondary btn-sm">Voir la ville</a>
                      <a href="/contact/" class="btn btn-outline-primary btn-sm">Devis</a>
                    </div>
                  </div>
                </div>
              </div>
            ))}

            <div class="col-lg-4 col-md-12 d-flex">
              <div class="card w-100 shadow-sm">
                <div class="card-body p-4">
                  <h5 class="mb-2">Toutes les villes</h5>
                  <p class="small text-muted mb-3">
                    Retrouvez votre commune et contactez-nous.
                  </p>
                  <a href="/villes/" class="button button-rounded button-small m-0">Voir toutes les villes</a>

                  <hr class="my-4" />

                  <h6 class="mb-2 text-uppercase ls-1">Besoin d‚Äôun d√©pannage ?</h6>
                  <div class="d-flex flex-wrap gap-2">
                    <a href={telHref} class="btn btn-outline-secondary btn-sm">üìû {PHONE_DISPLAY}</a>
                    <a href="/urgence/" class="btn btn-outline-danger btn-sm">Urgence</a>
                    <a href="/contact/" class="btn btn-outline-primary btn-sm">Devis</a>
                  </div>
                </div>
              </div>
            </div>

          </div>

        </div>
      </div>

      <!-- TRAVAUX -->
      <div class="container py-5">
        <div class="heading-block border-bottom-0 text-center">
          <div class="badge rounded-pill badge-default">R√©alisations</div>
          <h3 class="text-transform-none ls-0">Derniers travaux</h3>
          <p class="mb-0">Quelques exemples r√©cents.</p>
        </div>

        <div class="row col-mb-30 mt-4">
          {[...travaux]
            .sort((a, b) => String(b.date).localeCompare(String(a.date)))
            .slice(0, 6)
            .map((t) => (
              <div class="col-md-6 col-lg-4">
                <div class="card shadow-sm h-100">
                  <div class="card-body p-4">
                    <div class="small text-muted mb-2">
                      {getMetierName(t.metier)} ‚Ä¢ {getVilleName(t.ville)}
                    </div>
                    <h4 class="text-transform-none">{t.title}</h4>
                    <p class="text-muted mb-3">{t.problem}</p>
                    <a href={`/travaux/${t.slug}/`} class="btn btn-outline-secondary btn-sm">Voir</a>
                  </div>
                </div>
              </div>
            ))}
        </div>

        <div class="text-center mt-4">
          <a href="/travaux/" class="button button-large button-rounded text-capitalize ls-0">Voir toutes les r√©alisations</a>
        </div>
      </div>

      <!-- AVIS -->
      <div class="section mt-0" style="background: url('/images/sections/3.jpg') no-repeat top center; background-size: cover; padding: 80px 0 70px;">
        <div class="container">
          <div class="heading-block border-bottom-0 text-center">
            <div class="badge rounded-pill badge-default">Avis</div>
            <h2 class="text-transform-none ls-0">Avis clients</h2>
            <p class="text-light-50 mb-0">{avgRating}/5 ‚Ä¢ {avis.length} avis</p>
          </div>

          <div class="row col-mb-30 mt-4">
            {[...avis]
              .sort((a, b) => String(b.date).localeCompare(String(a.date)))
              .slice(0, 6)
              .map((a) => (
                <div class="col-md-6 col-lg-4">
                  <div class="card rounded-6 shadow border-0 h-100">
                    <div class="card-body p-4">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>{a.author}</strong>
                        <span class="badge bg-light text-dark">{a.rating}/5</span>
                      </div>
                      <div class="small text-muted mb-2">
                        {getMetierName(a.metier)} ‚Ä¢ {getVilleName(a.ville)}
                      </div>
                      <p class="mb-3">{String(a.text).slice(0, 220)}{String(a.text).length > 220 ? "‚Ä¶" : ""}</p>
                      <a class="btn btn-outline-light btn-sm" href={`/avis/${a.id}/`}>Lire</a>
                    </div>
                  </div>
                </div>
              ))}
          </div>

          <div class="text-center mt-4">
            <a href="/avis/" class="button button-large button-rounded text-capitalize ls-0">Voir tous les avis</a>
          </div>
        </div>
      </div>

      <!-- FAQ -->
      <div class="container mb-5">
        <div class="row justify-content-center">
          <div class="col-xl-6 col-lg-8 text-center">
            <div class="heading-block border-bottom-0 text-center mx-auto">
              <div class="badge rounded-pill badge-default">FAQ</div>
              <h2 class="text-transform-none ls-0 mb-3">Questions fr√©quentes</h2>
              <p class="text-muted mb-0">Simple, clair, rapide.</p>
            </div>
          </div>

          <div class="clear"></div>

          <div class="col-lg-10">
            <div id="faqs" class="faqs">

              <div class="toggle faq pb-3 mb-4">
                <div class="toggle-header">
                  <div class="toggle-icon color">
                    <i class="toggle-closed bi-question-circle"></i>
                    <i class="toggle-open bi-question-circle"></i>
                  </div>
                  <div class="toggle-title fw-semibold ps-1">
                    Est-ce que vous pouvez intervenir rapidement ?
                  </div>
                  <div class="toggle-icon color">
                    <i class="toggle-closed fa-solid fa-chevron-down text-black-50"></i>
                    <i class="toggle-open fa-solid fa-chevron-up color"></i>
                  </div>
                </div>
                <div class="toggle-content text-black-50 ps-4">
                  Oui selon disponibilit√©. Dites votre ville + le probl√®me (fuite, panne, porte bloqu√©e‚Ä¶) et on vous confirme le d√©lai.
                </div>
              </div>

              <div class="toggle faq pb-3 mb-4">
                <div class="toggle-header">
                  <div class="toggle-icon color">
                    <i class="toggle-closed bi-question-circle"></i>
                    <i class="toggle-open bi-question-circle"></i>
                  </div>
                  <div class="toggle-title fw-semibold ps-1">
                    Est-ce que vous annoncez le prix avant intervention ?
                  </div>
                  <div class="toggle-icon color">
                    <i class="toggle-closed fa-solid fa-chevron-down text-black-50"></i>
                    <i class="toggle-open fa-solid fa-chevron-up color"></i>
                  </div>
                </div>
                <div class="toggle-content text-black-50 ps-4">
                  Oui : on vous annonce le tarif avant d‚Äôintervenir (hors cas particuliers).
                </div>
              </div>

              <div class="toggle faq pb-3 mb-4">
                <div class="toggle-header">
                  <div class="toggle-icon color">
                    <i class="toggle-closed bi-question-circle"></i>
                    <i class="toggle-open bi-question-circle"></i>
                  </div>
                  <div class="toggle-title fw-semibold ps-1">
                    O√π intervenez-vous ?
                  </div>
                  <div class="toggle-icon color">
                    <i class="toggle-closed fa-solid fa-chevron-down text-black-50"></i>
                    <i class="toggle-open fa-solid fa-chevron-up color"></i>
                  </div>
                </div>
                <div class="toggle-content text-black-50 ps-4">
                  {REGION}. Consultez la page <a href="/villes/">Villes</a> pour trouver votre commune.
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- FORM CTA -->
      <div class="section mt-0" style="background: url('/images/sections/1.jpg') no-repeat center center; background-size: cover; padding: 100px 0;">
        <div class="container">
          <div class="row justify-content-between align-items-center">

            <div class="col-md-5">
              <div class="heading-block border-bottom-0 mb-4">
                <div class="badge rounded-pill badge-default">Devis</div>
                <h2 class="text-transform-none ls-0">Demande de devis</h2>
              </div>
              <p class="text-light-50 mb-0">
                D√©crivez votre probl√®me, indiquez votre ville et vos disponibilit√©s :
                on vous r√©pond rapidement.
              </p>

              <div class="d-flex flex-wrap gap-2 mt-3">
                <a href={telHref} class="btn btn-outline-light btn-sm">üìû {PHONE_DISPLAY}</a>
                <a href="/contact/" class="btn btn-light btn-sm">Contact</a>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mt-4 mt-md-0">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h3 class="h4 mb-3">Demander un devis</h3>

                  <HubspotCustomForm
                    portalId={import.meta.env.PUBLIC_HUBSPOT_PORTAL_ID}
                    formGuid={import.meta.env.PUBLIC_HUBSPOT_FORM_GUID}
                    region={import.meta.env.PUBLIC_HUBSPOT_REGION ?? "eu1"}
                    submitLabel="Envoyer"
                  />
                </div>
              </div>

              <p class="small text-light-50 mt-2 mb-0">
                En envoyant, vous acceptez d‚Äô√™tre recontact√©. Pas de spam.
              </p>
            </div>

          </div>
        </div>
      </div>

    </div>
  </section>

</Layout>
