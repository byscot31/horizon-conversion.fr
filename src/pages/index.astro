---
import Layout from "@layouts/Layout.astro";
import MainMenu from "@components/MainMenu.astro";
import HubspotCustomForm from "@components/HubspotCustomForm.astro";

import metiers from "@data/metiers.json";
import services from "@data/services.json";
import villes from "@data/villes.json";
import travaux from "@data/travaux.json";
import avis from "@data/avis.json";

const SITE_URL =
  import.meta.env.PUBLIC_SITE_URL ??
  (Astro.site ? Astro.site.toString().replace(/\/$/, "") : "");

const BRAND = import.meta.env.PUBLIC_BRAND_NAME ?? "Horizon Conversion";
const REGION = import.meta.env.PUBLIC_REGION_LABEL ?? "Sud Oise (60) / Nord 95";
const PHONE = import.meta.env.PUBLIC_PHONE ?? "+33600000000";
const PHONE_DISPLAY = import.meta.env.PUBLIC_PHONE_DISPLAY ?? PHONE;

const telHref = `tel:${String(PHONE).replace(/\s+/g, "")}`;

// Helpers
const topServices = services.filter((s) => s.is_top === true);
const villesA = villes.filter((v) => v.priority === "A");

const getVilleName = (slug) => villes.find((v) => v.slug === slug)?.name ?? slug;
const getMetierName = (slug) => metiers.find((m) => m.slug === slug)?.name ?? slug;

const avgRating =
  avis && avis.length
    ? Math.round((avis.reduce((sum, a) => sum + (a.rating ?? 5), 0) / avis.length) * 10) / 10
    : 5;

const jsonLd = [
  {
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    "name": BRAND,
    "url": SITE_URL ? `${SITE_URL}/` : undefined,
    "telephone": PHONE,
    "areaServed": REGION,
    "address": {
      "@type": "PostalAddress",
      "addressCountry": "FR"
    }
  },
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": BRAND,
    "url": SITE_URL ? `${SITE_URL}/` : undefined
  }
].filter(Boolean);

const title = `${BRAND} ‚Äî D√©pannage & travaux (plomberie, √©lectricit√©, serrurerie‚Ä¶) | ${REGION}`;
const description =
  `Artisan local : d√©pannage, installation et r√©novation. Intervention rapide dans ${REGION}. ` +
  `Devis gratuit, r√©ponse claire, travail soign√©.`;
---

<Layout title={title} description={description} canonical="/" jsonLd={jsonLd}>
  <MainMenu slot="header" />

  <!-- HERO -->
  <section class="page-title page-title-parallax parallax scroll-detect page-title-center dark include-header include-topbar">
    <img src="/images/services/page-title.jpg" class="parallax-bg" alt="" />
    <div id="particles-line"></div>

    <div class="container">
      <div class="page-title-row">
        <div class="page-title-content">
          <div class="badge rounded-pill border border-light text-light">Artisan local ‚Ä¢ {REGION}</div>
          <h1>{BRAND} : d√©pannage & travaux, r√©ponse rapide</h1>
          <p class="mt-3 mb-0" style="max-width: 820px; margin: 0 auto;">
            Plombier, √©lectricien, serrurier, couvreur, chauffagiste, peintre ‚Äî
            pour une intervention propre, un devis clair, et des demandes qui remontent dans HubSpot.
          </p>

          <div class="d-flex flex-wrap justify-content-center gap-2 mt-4">
            <a href={telHref} class="button button-rounded button-large text-transform-none ls-0">
              üìû Appeler {PHONE_DISPLAY}
            </a>
            <a href="/contact/" class="button button-rounded button-large button-light text-dark bg-white border text-transform-none ls-0">
              üìù Demander un devis
            </a>
          </div>

          <div class="d-flex flex-wrap justify-content-center gap-3 mt-4 small text-light-50">
            <span>‚úÖ Devis avant travaux</span>
            <span>‚úÖ Intervention soign√©e</span>
            <span>‚úÖ {avgRating}/5 sur {avis.length} avis</span>
          </div>
        </div>
      </div>
    </div>

    <div class="video-overlay z-1" style="background-image: linear-gradient(to top, rgba(254,150,3,0.45), #39384D);"></div>
  </section>

  <section id="content">
    <div class="content-wrap pb-0">

      <!-- INTRO + PREUVES -->
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-6">
            <div class="badge rounded-pill badge-default">D√©pannage & travaux</div>
            <h2 class="display-5 fw-bold mt-2">Un artisan local, des r√©ponses claires, des interventions propres.</h2>

            <p class="mt-3">
              Tu veux g√©n√©rer des appels et des demandes qualifi√©es : ici, tout est pens√© conversion.
              Un parcours simple (appel / devis), des preuves, et des pages locales (ville √ó m√©tier √ó service) pour le SEO.
            </p>

            <div class="row g-3 mt-4">
              <div class="col-12 col-sm-6">
                <div class="feature-box fbox-sm">
                  <div class="fbox-icon"><a href="#"><i class="bi-check-lg bg-info border-0"></i></a></div>
                  <div class="fbox-content">
                    <h3 class="text-transform-none">Urgence & RDV</h3>
                    <p class="mb-0">Selon dispo : d√©pannage rapide + cr√©neaux planifi√©s.</p>
                  </div>
                </div>
              </div>

              <div class="col-12 col-sm-6">
                <div class="feature-box fbox-sm">
                  <div class="fbox-icon"><a href="#"><i class="bi-check-lg bg-primary border-0"></i></a></div>
                  <div class="fbox-content">
                    <h3 class="text-transform-none">Devis clair</h3>
                    <p class="mb-0">Tarif annonc√© avant intervention (hors cas particuliers).</p>
                  </div>
                </div>
              </div>

              <div class="col-12 col-sm-6">
                <div class="feature-box fbox-sm">
                  <div class="fbox-icon"><a href="#"><i class="bi-check-lg bg-danger border-0"></i></a></div>
                  <div class="fbox-content">
                    <h3 class="text-transform-none">Travail soign√©</h3>
                    <p class="mb-0">Protection chantier + finitions propres.</p>
                  </div>
                </div>
              </div>

              <div class="col-12 col-sm-6">
                <div class="feature-box fbox-sm">
                  <div class="fbox-icon"><a href="#"><i class="bi-check-lg bg-success border-0"></i></a></div>
                  <div class="fbox-content">
                    <h3 class="text-transform-none">Zone locale</h3>
                    <p class="mb-0">Sud Oise (60) + Nord 95 autour de tes villes cibles.</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2 mt-4">
              <a href={telHref} class="btn btn-outline-secondary btn-sm">üìû {PHONE_DISPLAY}</a>
              <a href="/urgence/" class="btn btn-outline-danger btn-sm">Urgence</a>
              <a href="/travaux/" class="btn btn-outline-secondary btn-sm">Voir les travaux</a>
              <a href="/avis/" class="btn btn-outline-secondary btn-sm">Voir les avis</a>
            </div>
          </div>

          <div class="col-lg-6 mt-4 mt-lg-0">
            <img src="/images/services/1.svg" alt="Artisan local - d√©pannage & travaux" />
          </div>
        </div>

        <div class="clear line my-6"></div>

        <!-- M√âTIERS -->
        <div class="heading-block border-bottom-0 text-center">
          <div class="badge rounded-pill badge-default">M√©tiers</div>
          <h3 class="text-transform-none ls-0">6 m√©tiers pour d√©marrer</h3>
          <p class="mb-0">Des pages d√©di√©es + maillage local par ville.</p>
        </div>

        <div class="row mt-4 col-mb-30">
          {metiers.map((m) => (
            <div class="col-sm-6 col-lg-4">
              <div class="card h-100 shadow-sm">
                <div class="card-body p-4">
                  <h3 class="text-transform-none mb-2">{m.name}</h3>
                  <p class="text-muted mb-3">D√©pannage ‚Ä¢ installation ‚Ä¢ r√©novation</p>
                  <div class="d-flex flex-wrap gap-2">
                    <a class="btn btn-outline-secondary btn-sm" href={`/${m.slug}/`}>Voir la page m√©tier</a>
                    <a class="btn btn-outline-primary btn-sm" href="/contact/">Demander un devis</a>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>

        <div class="clear line my-6"></div>

        <!-- TOP DEMANDES (services top) -->
        <div class="heading-block border-bottom-0 text-center">
          <div class="badge rounded-pill badge-default">Top demandes</div>
          <h3 class="text-transform-none ls-0">Les interventions les plus demand√©es</h3>
          <p class="mb-0">Pages service + d√©clinaisons locales ‚Äúservice √ó ville‚Äù.</p>
        </div>

        <div class="row mt-4 col-mb-30">
          {topServices.slice(0, 12).map((s) => (
            <div class="col-sm-6 col-lg-4">
              <div class="feature-box">
                <div class="fbox-icon mb-3">
                  <a href="#"><i class="bi-check-lg bg-info border-0"></i></a>
                </div>
                <div class="fbox-content">
                  <h3 class="text-transform-none">{s.name}</h3>
                  <p class="mb-3">{s.short}</p>
                  <div class="d-flex flex-wrap gap-2">
                    <a class="btn btn-outline-secondary btn-sm" href={`/${s.metier}/`}>Voir m√©tier</a>
                    <a class="btn btn-outline-primary btn-sm" href="/contact/">Devis</a>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>

      </div>

      <!-- ZONES / VILLES -->
      <div class="section mb-0">
        <div class="container">

          <div class="heading-block border-bottom-0 text-center">
            <div class="badge rounded-pill badge-default">Zones</div>
            <h3 class="text-transform-none ls-0">Villes prioritaires + communes autour</h3>
            <p class="mb-0">Chaque ville renvoie vers ‚ÄúVille √ó M√©tier‚Äù + les villes voisines.</p>
          </div>

          <div class="row col-mb-30 align-content-stretch mt-4">

            {villesA.slice(0, 6).map((v) => (
              <div class="col-lg-4 col-md-6 d-flex">
                <div class="card w-100 shadow-sm">
                  <div class="card-body p-4">
                    <h3 class="text-transform-none ls-0 text-larger mb-2">{v.name}</h3>
                    <p class="text-smaller text-muted mb-3">Villes autour : {(v.around || []).slice(0, 6).map(getVilleName).join(", ")}{(v.around || []).length > 6 ? "‚Ä¶" : ""}</p>

                    <div class="d-flex flex-wrap gap-2">
                      <a href={`/villes/${v.slug}/`} class="btn btn-outline-secondary btn-sm">Voir la ville</a>
                      <a href="/contact/" class="btn btn-outline-primary btn-sm">Devis</a>
                    </div>

                    <hr class="my-3" />

                    <div class="small text-muted">
                      Pages li√©es : {metiers.slice(0, 3).map((m, idx) => (
                        <>
                          <a href={`/villes/${v.slug}/${m.slug}/`}>{m.name}</a>{idx < 2 ? " ‚Ä¢ " : ""}
                        </>
                      ))}
                      {metiers.length > 3 ? " ‚Ä¢ ‚Ä¶" : ""}
                    </div>
                  </div>
                </div>
              </div>
            ))}

            <div class="col-lg-4 col-md-12 d-flex">
              <div class="card w-100 shadow-sm">
                <div class="card-body p-4">
                  <h5 class="mb-2">Toutes les villes</h5>
                  <p class="small text-muted mb-3">Acc√®s aux pages ‚ÄúVille √ó M√©tier‚Äù puis ‚ÄúService √ó Ville‚Äù.</p>
                  <a href="/villes/" class="button button-rounded button-small m-0">Voir toutes les villes</a>

                  <hr class="my-4" />

                  <h6 class="mb-2 text-uppercase ls-1">Besoin d‚Äôun d√©pannage ?</h6>
                  <div class="d-flex flex-wrap gap-2">
                    <a href={telHref} class="btn btn-outline-secondary btn-sm">üìû {PHONE_DISPLAY}</a>
                    <a href="/urgence/" class="btn btn-outline-danger btn-sm">Urgence</a>
                    <a href="/contact/" class="btn btn-outline-primary btn-sm">Devis</a>
                  </div>
                </div>
              </div>
            </div>

          </div>

        </div>
      </div>

      <!-- TRAVAUX / REALISATIONS -->
      <div class="container py-5">
        <div class="heading-block border-bottom-0 text-center">
          <div class="badge rounded-pill badge-default">R√©alisations</div>
          <h3 class="text-transform-none ls-0">Derniers travaux</h3>
        </div>

        <div class="row col-mb-30 mt-4">
          {[...travaux]
            .sort((a, b) => String(b.date).localeCompare(String(a.date)))
            .slice(0, 6)
            .map((t) => (
              <div class="col-md-6 col-lg-4">
                <div class="card shadow-sm h-100">
                  <div class="card-body p-4">
                    <div class="small text-muted mb-2">
                      {getMetierName(t.metier)} ‚Ä¢ {getVilleName(t.ville)}
                    </div>
                    <h4 class="text-transform-none">{t.title}</h4>
                    <p class="text-muted mb-3">{t.problem}</p>
                    <a href={`/travaux/${t.slug}/`} class="btn btn-outline-secondary btn-sm">Voir le d√©tail</a>
                  </div>
                </div>
              </div>
            ))}
        </div>

        <div class="text-center mt-4">
          <a href="/travaux/" class="button button-large button-rounded text-capitalize ls-0">Voir toutes les r√©alisations</a>
        </div>
      </div>

      <!-- AVIS -->
      <div class="section mt-0" style="background: url('/images/sections/3.jpg') no-repeat top center; background-size: cover; padding: 80px 0 70px;">
        <div class="container">
          <div class="heading-block border-bottom-0 text-center">
            <div class="badge rounded-pill badge-default">Avis clients</div>
            <h2 class="text-transform-none ls-0">Ce que disent les clients</h2>
            <p class="text-light-50 mb-0">{avgRating}/5 ‚Ä¢ {avis.length} avis</p>
          </div>

          <div class="row col-mb-30 mt-4">
            {[...avis]
              .sort((a, b) => String(b.date).localeCompare(String(a.date)))
              .slice(0, 6)
              .map((a) => (
                <div class="col-md-6 col-lg-4">
                  <div class="card rounded-6 shadow border-0 h-100">
                    <div class="card-body p-4">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>{a.author}</strong>
                        <span class="badge bg-light text-dark">{a.rating}/5</span>
                      </div>
                      <div class="small text-muted mb-2">
                        {getMetierName(a.metier)} ‚Ä¢ {getVilleName(a.ville)}
                      </div>
                      <p class="mb-3">{String(a.text).slice(0, 220)}{String(a.text).length > 220 ? "‚Ä¶" : ""}</p>
                      <a class="btn btn-outline-light btn-sm" href={`/avis/${a.id}/`}>Lire</a>
                    </div>
                  </div>
                </div>
              ))}
          </div>

          <div class="text-center mt-4">
            <a href="/avis/" class="button button-large button-rounded text-capitalize ls-0">Voir tous les avis</a>
          </div>
        </div>
      </div>

      <!-- FAQ -->
      <div class="container mb-5">
        <div class="row justify-content-center">
          <div class="col-xl-6 col-lg-8 text-center">
            <div class="heading-block border-bottom-0 text-center mx-auto">
              <div class="badge rounded-pill badge-default">FAQ</div>
              <h2 class="text-transform-none ls-0 mb-3">Questions fr√©quentes</h2>
              <p class="text-muted mb-0">Pour rassurer, lever les objections, et aider Google √† comprendre.</p>
            </div>
          </div>

          <div class="clear"></div>

          <div class="col-lg-10">
            <div id="faqs" class="faqs">

              <div class="toggle faq pb-3 mb-4">
                <div class="toggle-header">
                  <div class="toggle-icon color">
                    <i class="toggle-closed bi-question-circle"></i>
                    <i class="toggle-open bi-question-circle"></i>
                  </div>
                  <div class="toggle-title fw-semibold ps-1">
                    Intervenez-vous en urgence ?
                  </div>
                  <div class="toggle-icon color">
                    <i class="toggle-closed fa-solid fa-chevron-down text-black-50"></i>
                    <i class="toggle-open fa-solid fa-chevron-up color"></i>
                  </div>
                </div>
                <div class="toggle-content text-black-50 ps-4">
                  Oui selon disponibilit√©. D√©crivez votre probl√®me et votre ville : on confirme le d√©lai et le tarif avant d√©placement.
                </div>
              </div>

              <div class="toggle faq pb-3 mb-4">
                <div class="toggle-header">
                  <div class="toggle-icon color">
                    <i class="toggle-closed bi-question-circle"></i>
                    <i class="toggle-open bi-question-circle"></i>
                  </div>
                  <div class="toggle-title fw-semibold ps-1">
                    Le devis est-il gratuit ?
                  </div>
                  <div class="toggle-icon color">
                    <i class="toggle-closed fa-solid fa-chevron-down text-black-50"></i>
                    <i class="toggle-open fa-solid fa-chevron-up color"></i>
                  </div>
                </div>
                <div class="toggle-content text-black-50 ps-4">
                  Oui : devis communiqu√© avant travaux (hors cas sp√©cifiques). Tu peux demander un devis en 1 minute via le formulaire.
                </div>
              </div>

              <div class="toggle faq pb-3 mb-4">
                <div class="toggle-header">
                  <div class="toggle-icon color">
                    <i class="toggle-closed bi-question-circle"></i>
                    <i class="toggle-open bi-question-circle"></i>
                  </div>
                  <div class="toggle-title fw-semibold ps-1">
                    Quelles zones couvrez-vous ?
                  </div>
                  <div class="toggle-icon color">
                    <i class="toggle-closed fa-solid fa-chevron-down text-black-50"></i>
                    <i class="toggle-open fa-solid fa-chevron-up color"></i>
                  </div>
                </div>
                <div class="toggle-content text-black-50 ps-4">
                  {REGION}. Consulte la page <a href="/villes/">Villes</a> pour voir les communes et les pages locales associ√©es.
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- FORM CTA -->
      <div class="section mt-0" style="background: url('/images/sections/1.jpg') no-repeat center center; background-size: cover; padding: 100px 0;">
        <div class="container">
          <div class="row justify-content-between align-items-center">

            <div class="col-md-5">
              <div class="heading-block border-bottom-0 mb-4">
                <div class="badge rounded-pill badge-default">Devis</div>
                <h2 class="text-transform-none ls-0">Demande de devis (rapide)</h2>
              </div>
              <p class="text-light-50">
                Explique ton besoin, choisis ta ville et ton m√©tier : on te r√©pond rapidement.
              </p>
              <div class="d-flex flex-wrap gap-2">
                <a href={telHref} class="btn btn-outline-light btn-sm">üìû {PHONE_DISPLAY}</a>
                <a href="/contact/" class="btn btn-light btn-sm">Contact</a>
              </div>
            </div>

            <div class="col-lg-4 col-md-6 mt-4 mt-md-0">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h3 class="h4 mb-3">Demander un devis</h3>

                  <!-- HubSpot custom form -->
                  <HubspotCustomForm
                    portalId={import.meta.env.PUBLIC_HUBSPOT_PORTAL_ID}
                    formGuid={import.meta.env.PUBLIC_HUBSPOT_FORM_GUID}
                    region={import.meta.env.PUBLIC_HUBSPOT_REGION ?? "eu1"}
                    submitLabel="Envoyer ma demande"
                  />
                </div>
              </div>

              <p class="small text-light-50 mt-2 mb-0">
                En envoyant, tu acceptes d‚Äô√™tre recontact√©. Pas de spam.
              </p>
            </div>

          </div>
        </div>
      </div>

    </div>
  </section>

</Layout>
