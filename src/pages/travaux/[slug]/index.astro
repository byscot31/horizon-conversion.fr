---
import Layout from "@layouts/Layout.astro";
import travaux from "@data/travaux.json";
import villes from "@data/villes.json";
import metiers from "@data/metiers.json";
import services from "@data/services.json";

export function getStaticPaths() {
  return travaux.map((t) => ({ params: { slug: t.slug } }));
}

const { slug } = Astro.params;
const t = travaux.find((x) => x.slug === slug);
if (!t) throw new Error(`Travail introuvable: ${slug}`);

const brand = import.meta.env.PUBLIC_BRAND_NAME ?? "Horizon Conversion";
const canonical = `/travaux/${t.slug}/`;

const ville = villes.find(v => v.slug === t.ville);
const metier = metiers.find(m => m.slug === t.metier);
const service = services.find(s => s.slug === t.service && s.metier === t.metier);

const villeName = ville?.name ?? t.ville;
const metierName = metier?.name ?? t.metier;
const serviceName = service?.name ?? t.service;

const title = `${t.title} ‚Äî ${metierName} ${villeName} | ${brand}`;
const description = `${metierName} √† ${villeName} : ${t.problem} ‚Üí ${t.results}`.slice(0, 160);

// JSON-LD (Article + LocalBusiness ‚Äúlight‚Äù via Service)
const jsonLd = [
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": t.title,
    "datePublished": t.date,
    "dateModified": t.date,
    "about": `${metierName} ${villeName}`,
    "articleSection": "Travaux",
    "image": (t.photos && t.photos.length ? t.photos : undefined),
    "mainEntityOfPage": canonical
  }
];
---
<Layout title={title} description={description} canonical={canonical} jsonLd={jsonLd}>
  <section class="page-title page-title-center dark include-header include-topbar">
    <div class="container">
      <div class="page-title-row">
        <div class="page-title-content">
          <div class="badge rounded-pill border border-light text-light">Travaux</div>
          <h1>{t.title}</h1>
          <p class="lead mb-0">{metierName} √† {villeName}</p>
        </div>

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Accueil</a></li>
            <li class="breadcrumb-item"><a href="/travaux/">Travaux</a></li>
            <li class="breadcrumb-item active" aria-current="page">{t.title}</li>
          </ol>
        </nav>
      </div>
    </div>
  </section>

  <section id="content">
    <div class="content-wrap pb-0">
      <div class="container">

        <div class="row g-4">
          <div class="col-lg-7">
            {t.photos?.length ? (
              <div class="row g-2">
                {t.photos.map((p) => (
                  <div class="col-6">
                    <img src={p} alt={t.title} class="rounded-3 w-100" loading="lazy" />
                  </div>
                ))}
              </div>
            ) : (
              <div class="card">
                <div class="card-body p-4">
                  <p class="mb-0 text-muted">Ajoute des photos dans <code>travaux.json</code> (champ <code>photos</code>).</p>
                </div>
              </div>
            )}

            <div class="clear line my-5"></div>

            <h2 class="h4 mb-3">Le contexte</h2>
            <p class="text-muted">{t.problem}</p>

            <h2 class="h4 mt-4 mb-3">La solution</h2>
            <p class="text-muted">{t.solution}</p>

            {t.steps?.length && (
              <>
                <h2 class="h4 mt-4 mb-3">√âtapes</h2>
                <ol class="ms-3">
                  {t.steps.map((s) => <li class="mb-2">{s}</li>)}
                </ol>
              </>
            )}

            {t.materials?.length && (
              <>
                <h2 class="h4 mt-4 mb-3">Mat√©riel / √©l√©ments</h2>
                <ul class="iconlist ms-3">
                  {t.materials.map((m) => (
                    <li class="mb-2">
                      <i class="fa-solid fa-check text-smaller color"></i> {m}
                    </li>
                  ))}
                </ul>
              </>
            )}

            <div class="card mt-4">
              <div class="card-body p-4">
                <h3 class="h5 mb-2">R√©sultat</h3>
                <p class="mb-0">{t.results}</p>
              </div>
            </div>

            <div class="clear line my-5"></div>

            <div class="d-flex flex-wrap gap-2">
              <a class="button button-rounded m-0" href="/contact/">üìù Demander un devis</a>
              <a class="button button-border button-rounded m-0" href={`/villes/${t.ville}/${t.metier}/`}>Voir {metierName} √† {villeName}</a>
              <a class="button button-light button-rounded bg-white border text-dark m-0" href={`/villes/${t.ville}/${t.metier}/${t.service}/`}>
                Voir ‚Äú{serviceName}‚Äù √† {villeName}
              </a>
            </div>
          </div>

          <div class="col-lg-5">
            <div class="card shadow-sm">
              <div class="card-body p-4">
                <h3 class="h5 mb-2">Infos rapides</h3>
                <ul class="iconlist ms-3 mb-0">
                  <li class="mb-2"><i class="fa-solid fa-location-dot text-smaller color"></i> {villeName}</li>
                  <li class="mb-2"><i class="fa-solid fa-screwdriver-wrench text-smaller color"></i> {metierName}</li>
                  <li class="mb-2"><i class="fa-solid fa-tag text-smaller color"></i> {serviceName}</li>
                  <li class="mb-2"><i class="fa-solid fa-clock text-smaller color"></i> Dur√©e : {t.duration ?? "‚Äî"}</li>
                  <li class="mb-2"><i class="fa-solid fa-calendar text-smaller color"></i> Date : {t.date}</li>
                  {t.urgent && <li class="mb-2"><i class="fa-solid fa-triangle-exclamation text-smaller color"></i> Urgence</li>}
                </ul>
              </div>
            </div>

            <div class="card shadow-sm mt-3">
              <div class="card-body p-4">
                <h3 class="h5 mb-2">Maillage SEO</h3>
                <p class="text-muted small mb-0">
                  Cette page renvoie vers <strong>Ville √ó M√©tier</strong> et <strong>Service √ó Ville</strong> pour renforcer la pertinence locale.
                </p>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </section>
</Layout>
