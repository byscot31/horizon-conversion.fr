---
import Layout from "../../../../layouts/Layout.astro";
import HubspotCustomForm from "../../../../components/HubspotCustomForm.astro";

import villes from "../../../../data/villes.json";
import metiers from "../../../../data/metiers.json";
import services from "../../../../data/services.json";

export function getStaticPaths() {
  const A = villes.filter((v) => v.priority === "A");
  const paths = [];

  for (const v of A) {
    for (const m of metiers) {
      paths.push({ params: { ville: v.slug, metier: m.slug } });
    }
  }
  return paths;
}

const { ville: villeSlug, metier: metierSlug } = Astro.params;

const ville = villes.find((v) => v.slug === villeSlug);
const metier = metiers.find((m) => m.slug === metierSlug);

if (!ville || !metier) throw new Error("404");

const noindex = ville.priority !== "A";

const brand = import.meta.env.PUBLIC_BRAND_NAME ?? "Horizon Conversion";
const phone = import.meta.env.PUBLIC_PHONE ?? "+33600000000";
const phoneDisplay = import.meta.env.PUBLIC_PHONE_DISPLAY ?? "06 00 00 00 00";

const title = `${metier.name} √† ${ville.name} (${ville.dept}) ‚Äî Devis gratuit | ${brand}`;
const description = `Besoin d‚Äôun ${metier.name.toLowerCase()} √† ${ville.name} ? D√©pannage, installation, travaux. Devis gratuit, r√©ponse rapide.`;

const canonical = `/villes/${ville.slug}/${metier.slug}/`;

const topServices = services
  .filter((s) => s.metier === metier.slug && s.is_top)
  .slice(0, 9);
---

<Layout title={title} description={description} canonical={canonical} noindex={noindex}>
  <section class="page-title page-title-center dark include-header include-topbar">
    <div class="container">
      <div class="page-title-row">
        <div class="page-title-content">
          <div class="badge rounded-pill border border-light text-light">Ville √ó M√©tier</div>
          <h1>{metier.name} √† {ville.name}</h1>
          <p class="lead mb-0">Devis gratuit ‚Ä¢ R√©ponse rapide ‚Ä¢ {ville.name} ({ville.dept})</p>
        </div>

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Accueil</a></li>
            <li class="breadcrumb-item"><a href="/villes/">Villes</a></li>
            <li class="breadcrumb-item"><a href={`/villes/${ville.slug}/`}>{ville.name}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{metier.name}</li>
          </ol>
        </nav>
      </div>
    </div>
  </section>

  <section id="content">
    <div class="content-wrap pb-0">
      <div class="container">

        <div class="row align-items-start g-4">
          <div class="col-lg-6">
            <h2 class="display-6 fw-bold mb-3">Services {metier.name.toLowerCase()} √† {ville.name}</h2>
            <p class="text-muted mb-4">
              Choisis la demande la plus proche : chaque service a sa page d√©di√©e (service √ó ville) pour mieux se positionner sur Google.
            </p>

            <div class="d-flex flex-wrap gap-2">
              <a href={`tel:${phone}`} class="button button-rounded button-large m-0">üìû {phoneDisplay}</a>
              <a href="#devis" class="button button-border button-rounded button-large m-0">üìù Devis</a>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card shadow-sm">
              <div class="card-body p-4">
                <h3 class="h5 mb-2">Demandes fr√©quentes</h3>
                <div class="row g-2">
                  {topServices.map((s) => (
                    <div class="col-12">
                      <a class="btn btn-outline-secondary w-100 text-start" href={`/villes/${ville.slug}/${metier.slug}/${s.slug}/`}>
                        {s.name}
                      </a>
                    </div>
                  ))}
                </div>
                <div class="small text-muted mt-3">
                  Astuce : tu peux ajouter 3‚Äì5 services ‚Äútop‚Äù par m√©tier pour couvrir 80% de la demande.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="clear line my-6"></div>

        <div id="devis" class="section mt-0" style="padding: 70px 0;">
          <div class="container">
            <div class="row justify-content-between align-items-start g-4">
              <div class="col-lg-5">
                <div class="heading-block border-bottom-0 mb-2">
                  <div class="badge rounded-pill badge-default">Devis gratuit</div>
                  <h2 class="text-transform-none ls-0 mb-0">{metier.name} √† {ville.name}</h2>
                </div>
                <p class="text-muted">Indique ton besoin, on te rappelle rapidement.</p>
              </div>

              <div class="col-lg-6">
                <HubspotCustomForm title={`Devis ${metier.name} ‚Äî ${ville.name}`} subtitle="Tracking auto (UTM + page source)" submitLabel="Envoyer" />
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>
</Layout>
