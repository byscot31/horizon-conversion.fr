---
import Layout from "@layouts/Layout.astro";
import MainMenu from "@components/MainMenu.astro";
import villes from "@data/villes.json";
import metiers from "@data/metiers.json";

const brand = import.meta.env.PUBLIC_BRAND_NAME ?? "Horizon Conversion";
const regionLabel = import.meta.env.PUBLIC_REGION_LABEL ?? "Sud Oise (60) / Nord 95";

const title = `Villes d‚Äôintervention ‚Äî ${regionLabel} | ${brand}`;
const description =
  `Choisis ta ville en ${regionLabel} : d√©pannage plomberie (fuite d‚Äôeau, WC bouch√©), ` +
  `√©lectricit√© (panne, tableau), serrurerie (porte claqu√©e), chauffage, toiture, peinture. ` +
  `Devis gratuit, rappel rapide.`;
const canonical = "/villes/";

// Helpers
const sortVilles = (arr) =>
  [...arr].sort((a, b) => {
    if (a.priority !== b.priority) return a.priority === "A" ? -1 : 1;
    return a.name.localeCompare(b.name, "fr");
  });

const countA = (arr) => arr.filter((v) => v.priority === "A").length;

const sudOiseAll = sortVilles(villes.filter((v) => v.zone === "sud-oise"));
const nord95All = sortVilles(villes.filter((v) => v.zone === "nord-95"));

const topVillesA = sortVilles(villes.filter((v) => v.priority === "A")).slice(0, 6);
const topMetiers = [...metiers].sort((a, b) => a.name.localeCompare(b.name, "fr")).slice(0, 6);

const prettifySlug = (s) =>
  String(s)
    .replace(/-/g, " ")
    .replace(/\b\w/g, (m) => m.toUpperCase());
---

<Layout title={title} description={description} canonical={canonical}>
  <MainMenu slot="header" />

  <section class="page-title page-title-center dark include-header include-topbar">
    <div class="container">
      <div class="page-title-row mt-5">
        <div class="page-title-content">
          <div class="badge rounded-pill border border-light text-light">Zones d‚Äôintervention</div>
          <h1>Villes d‚Äôintervention</h1>
          <p class="lead mb-0">{regionLabel} ‚Äî devis gratuit & r√©ponse rapide</p>
        </div>

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Accueil</a></li>
            <li class="breadcrumb-item active" aria-current="page">Villes</li>
          </ol>
        </nav>
      </div>
    </div>
  </section>

  <section id="content">
    <div class="content-wrap pb-0">
      <div class="container">

        <!-- Intro -->
        <div class="row justify-content-center">
          <div class="col-lg-10 text-center">
            <div class="badge rounded-pill badge-default mb-2">Trouver un artisan pr√®s de chez toi</div>
            <h2 class="display-6 fw-bold mb-3">Choisis ta ville</h2>
            <p class="text-muted mb-3">
              S√©lectionne ta commune pour acc√©der rapidement aux services disponibles (d√©pannage, installation, petits travaux).
              Si c‚Äôest une urgence, tu peux aussi faire une demande : on te rappelle rapidement.
            </p>

            <div class="d-flex flex-wrap justify-content-center gap-2 small text-muted">
              <span class="badge bg-light text-dark">Fuite d‚Äôeau / WC bouch√©</span>
              <span class="badge bg-light text-dark">Panne √©lectrique / tableau</span>
              <span class="badge bg-light text-dark">Porte claqu√©e / serrure</span>
              <span class="badge bg-light text-dark">Chauffage en panne</span>
              <span class="badge bg-light text-dark">Infiltration toiture</span>
              <span class="badge bg-light text-dark">Peinture int√©rieure</span>
            </div>
          </div>
        </div>

        <div class="clear line my-6"></div>

        <!-- Filtres -->
        <div class="row justify-content-center">
          <div class="col-lg-10">
            <div class="card shadow-sm">
              <div class="card-body p-4">
                <div class="row g-3 align-items-end">
                  <div class="col-md-6">
                    <label class="form-label small text-muted mb-1" for="v-search">Rechercher ta ville</label>
                    <input id="v-search" class="form-control" type="search" placeholder="Ex : Senlis, Chantilly, Persan‚Ä¶" />
                  </div>

                  <div class="col-md-3">
                    <label class="form-label small text-muted mb-1" for="v-zone">Zone</label>
                    <select id="v-zone" class="form-select">
                      <option value="all">Toutes</option>
                      <option value="sud-oise">Sud Oise (60)</option>
                      <option value="nord-95">Nord 95</option>
                    </select>
                  </div>

                  <div class="col-md-3">
                    <label class="form-label small text-muted mb-1" for="v-priority">Affichage</label>
                    <select id="v-priority" class="form-select">
                      <option value="all">Toutes les villes</option>
                      <option value="A">Villes principales</option>
                      <option value="B">Villes autour</option>
                    </select>
                  </div>
                </div>

                <div class="d-flex flex-wrap gap-2 mt-3">
                  <button class="btn btn-outline-secondary btn-sm" type="button" id="v-reset">R√©initialiser</button>
                  <div class="small text-muted ms-auto" id="v-count"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="clear line my-6"></div>

        <!-- Acc√®s rapides -->
        <div class="row justify-content-center">
          <div class="col-lg-11">
            <div class="heading-block border-bottom-0 text-center mb-4">
              <div class="badge rounded-pill badge-default">Acc√®s rapide</div>
              <h3 class="text-transform-none ls-0 mb-1">M√©tiers dans les villes les plus demand√©es</h3>
              <p class="text-muted mb-0">
                Clique sur ta ville, puis choisis le m√©tier (plombier, √©lectricien, serrurier‚Ä¶).
              </p>
            </div>

            <div class="row g-3">
              {topVillesA.map((v) => (
                <div class="col-md-6 col-lg-4">
                  <div class="card h-100 shadow-sm">
                    <div class="card-body p-4">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <div class="fw-semibold">{v.name}</div>
                          <div class="small text-muted">{v.dept} ‚Ä¢ {v.zone}</div>
                        </div>
                        <span class="badge bg-success">Ville principale</span>
                      </div>

                      <div class="d-flex flex-wrap gap-2 mt-2 mb-3">
                        <a class="btn btn-outline-secondary btn-sm" href={`/villes/${v.slug}/`}>Voir {v.name}</a>
                        <a class="btn btn-outline-primary btn-sm" href="/contact/">Demander un devis</a>
                      </div>

                      <div class="small fw-semibold mb-2">Choisir un m√©tier</div>
                      <div class="d-flex flex-wrap gap-2">
                        {topMetiers.map((m) => (
                          <a class="btn btn-sm btn-outline-secondary" href={`/villes/${v.slug}/${m.slug}/`}>
                            {m.name} √† {v.name}
                          </a>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            <!-- Tous les combos rang√©s -->
            <div class="mt-4">
              <details class="card shadow-sm">
                <summary class="card-body p-4" style="cursor:pointer;">
                  <span class="fw-semibold">Voir toutes les villes et tous les m√©tiers</span>
                  <span class="text-muted small ms-2">‚Äî pratique si tu h√©sites entre plusieurs communes</span>
                </summary>

                <div class="card-body pt-0 px-4 pb-4">
                  <div class="row g-3">
                    {[...villes].sort((a,b)=>a.name.localeCompare(b.name,"fr")).map((v) => (
                      <div class="col-md-6 col-lg-4">
                        <details class="card h-100 shadow-sm">
                          <summary class="card-body p-3" style="cursor:pointer;">
                            <div class="d-flex justify-content-between align-items-start">
                              <span class="fw-semibold">{v.name}</span>
                              <span class={`badge ${v.priority === "A" ? "bg-success" : "bg-secondary"}`}>
                                {v.priority === "A" ? "Principale" : "Autour"}
                              </span>
                            </div>
                            <div class="small text-muted">{v.dept} ‚Ä¢ {v.zone}</div>
                          </summary>

                          <div class="card-body pt-0 px-3 pb-3">
                            <div class="d-flex flex-wrap gap-2 mb-2">
                              <a class="btn btn-outline-secondary btn-sm" href={`/villes/${v.slug}/`}>Voir {v.name}</a>
                              <a class="btn btn-outline-primary btn-sm" href="/contact/">Devis</a>
                            </div>

                            <div class="d-flex flex-wrap gap-2">
                              {metiers.map((m) => (
                                <a class="btn btn-sm btn-outline-secondary" href={`/villes/${v.slug}/${m.slug}/`}>
                                  {m.name} √† {v.name}
                                </a>
                              ))}
                            </div>
                          </div>
                        </details>
                      </div>
                    ))}
                  </div>
                </div>
              </details>
            </div>
          </div>
        </div>

        <div class="clear line my-6"></div>

        <!-- Tabs -->
        <ul class="nav nav-tabs justify-content-center" id="villesTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-60" data-bs-toggle="tab" data-bs-target="#pane-60" type="button" role="tab" aria-controls="pane-60" aria-selected="true">
              Sud Oise (60) <span class="badge bg-light text-dark ms-2">{sudOiseAll.length}</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-95" data-bs-toggle="tab" data-bs-target="#pane-95" type="button" role="tab" aria-controls="pane-95" aria-selected="false">
              Nord 95 <span class="badge bg-light text-dark ms-2">{nord95All.length}</span>
            </button>
          </li>
        </ul>

        <div class="tab-content pt-4" id="villesTabsContent">

          <!-- Sud Oise -->
          <div class="tab-pane fade show active" id="pane-60" role="tabpanel" aria-labelledby="tab-60" tabindex="0">
            <div class="text-center mb-4">
              <div class="small text-muted">
                Villes principales : <strong>{countA(sudOiseAll)}</strong> ‚Ä¢ Villes autour : <strong>{sudOiseAll.length - countA(sudOiseAll)}</strong>
              </div>
            </div>

            <div class="row col-mb-20" id="grid-60">
              {sudOiseAll.map((v) => (
                <div
                  class="col-lg-3 col-md-4 col-6"
                  data-ville-name={`${v.name}`.toLowerCase()}
                  data-zone={v.zone}
                  data-priority={v.priority}
                >
                  <a class={`card h-100 text-decoration-none ${v.priority === "A" ? "border border-2" : ""}`} href={`/villes/${v.slug}/`}>
                    <div class="card-body p-3">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <div class="fw-semibold">{v.name}</div>
                          <div class="small text-muted">{v.dept} ‚Ä¢ {v.zone}</div>
                        </div>
                        <span class={`badge ${v.priority === "A" ? "bg-success" : "bg-secondary"}`}>
                          {v.priority === "A" ? "Principale" : "Autour"}
                        </span>
                      </div>

                      {v.around?.length ? (
                        <div class="small text-muted mt-2">
                          Autour : {v.around.slice(0, 4).map((x) => prettifySlug(x)).join(", ")}{v.around.length > 4 ? "‚Ä¶" : ""}
                        </div>
                      ) : null}
                    </div>
                  </a>
                </div>
              ))}
            </div>
          </div>

          <!-- Nord 95 -->
          <div class="tab-pane fade" id="pane-95" role="tabpanel" aria-labelledby="tab-95" tabindex="0">
            <div class="text-center mb-4">
              <div class="small text-muted">
                Villes principales : <strong>{countA(nord95All)}</strong> ‚Ä¢ Villes autour : <strong>{nord95All.length - countA(nord95All)}</strong>
              </div>
            </div>

            <div class="row col-mb-20" id="grid-95">
              {nord95All.map((v) => (
                <div
                  class="col-lg-3 col-md-4 col-6"
                  data-ville-name={`${v.name}`.toLowerCase()}
                  data-zone={v.zone}
                  data-priority={v.priority}
                >
                  <a class={`card h-100 text-decoration-none ${v.priority === "A" ? "border border-2" : ""}`} href={`/villes/${v.slug}/`}>
                    <div class="card-body p-3">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <div class="fw-semibold">{v.name}</div>
                          <div class="small text-muted">{v.dept} ‚Ä¢ {v.zone}</div>
                        </div>
                        <span class={`badge ${v.priority === "A" ? "bg-success" : "bg-secondary"}`}>
                          {v.priority === "A" ? "Principale" : "Autour"}
                        </span>
                      </div>

                      {v.around?.length ? (
                        <div class="small text-muted mt-2">
                          Autour : {v.around.slice(0, 4).map((x) => prettifySlug(x)).join(", ")}{v.around.length > 4 ? "‚Ä¶" : ""}
                        </div>
                      ) : null}
                    </div>
                  </a>
                </div>
              ))}
            </div>
          </div>

        </div>

        <div class="clear line my-6"></div>

        <!-- Bottom CTA -->
        <div class="section mt-0" style="padding: 60px 0;">
          <div class="container">
            <div class="row justify-content-center text-center">
              <div class="col-lg-8">
                <div class="badge rounded-pill badge-default mb-2">Tu ne trouves pas ?</div>
                <h3 class="text-transform-none ls-0 mb-3">Indique ta ville et ton besoin</h3>
                <p class="text-muted mb-4">
                  M√™me si ta commune n‚Äôest pas list√©e, indique ton secteur et le souci (fuite, panne, serrure, chauffage‚Ä¶).
                  On te r√©pond rapidement avec une solution claire.
                </p>
                <a href="/contact/" class="button button-rounded button-large m-0">üìù Faire une demande</a>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- Filtrage front (simple, rapide, pas de d√©pendance, pas de $ global) -->
  <script type="module" is:inline>
  (() => {
    const qs = (sel, root = document) => root.querySelector(sel);
    const qsa = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    const input = qs("#v-search");
    const zone = qs("#v-zone");
    const prio = qs("#v-priority");
    const reset = qs("#v-reset");
    const count = qs("#v-count");

    function applyFilters() {
      const q = (input?.value || "").trim().toLowerCase();
      const z = zone?.value || "all";
      const p = prio?.value || "all";

      const cards = qsa("[data-ville-name]");
      let visible = 0;

      cards.forEach((el) => {
        const name = el.getAttribute("data-ville-name") || "";
        const elZone = el.getAttribute("data-zone") || "";
        const elPrio = el.getAttribute("data-priority") || "";

        const okQ = !q || name.includes(q);
        const okZ = z === "all" || elZone === z;
        const okP = p === "all" || elPrio === p;

        const show = okQ && okZ && okP;
        el.style.display = show ? "" : "none";
        if (show) visible++;
      });

      if (count) count.textContent = `${visible} ville(s) affich√©e(s)`;
    }

    [input, zone, prio].forEach((el) => el && el.addEventListener("input", applyFilters));
    [zone, prio].forEach((el) => el && el.addEventListener("change", applyFilters));

    reset?.addEventListener("click", () => {
      if (input) input.value = "";
      if (zone) zone.value = "all";
      if (prio) prio.value = "all";
      applyFilters();
    });

    applyFilters();
  })();
  </script>
</Layout>
