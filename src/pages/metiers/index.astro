---
import Layout from "@layouts/Layout.astro";
import villes from "@data/villes.json";
import metiers from "@data/metiers.json";
import services from "@data/services.json";
import PopularCombosByMetier from "@components/PopularCombosByMetier.astro";

const brand = import.meta.env.PUBLIC_BRAND_NAME ?? "Horizon Conversion";
const regionLabel = import.meta.env.PUBLIC_REGION_LABEL ?? "Sud Oise (60) / Nord 95";

const title = `Trouver un artisan ‚Äî Plombier, √©lectricien, serrurier‚Ä¶ | ${regionLabel} | ${brand}`;
const description =
  `Choisissez votre artisan puis votre ville : d√©pannage en urgence ou rendez-vous rapide. ` +
  `Fuite d‚Äôeau, WC bouch√©, panne √©lectrique, porte claqu√©e, serrure bloqu√©e‚Ä¶ Devis gratuit.`;
const canonical = "/metiers/";

// Helpers
const byNameFR = (a, b) => String(a.name).localeCompare(String(b.name), "fr");
const sortVilles = (arr) =>
  [...arr].sort((a, b) => {
    if (a.priority !== b.priority) return a.priority === "A" ? -1 : 1;
    return byNameFR(a, b);
  });

const villesA = sortVilles(villes.filter((v) => v.priority === "A"));
const villesB = sortVilles(villes.filter((v) => v.priority === "B"));

const servicesFor = (metierSlug) =>
  services
    .filter((s) => s.metier === metierSlug)
    .sort((a, b) => (b.is_top === true) - (a.is_top === true) || byNameFR(a, b));

const topServicesFor = (metierSlug, limit = 6) =>
  servicesFor(metierSlug).filter((s) => s.is_top).slice(0, limit);

const prettify = (s) =>
  String(s)
    .replace(/-/g, " ")
    .replace(/\b\w/g, (m) => m.toUpperCase());
---

<Layout title={title} description={description} canonical={canonical}>
  <section class="page-title page-title-center dark include-header include-topbar">
    <div class="container">
      <div class="page-title-row">
        <div class="page-title-content">
          <div class="badge rounded-pill border border-light text-light">D√©pannage & travaux</div>
          <h1>Trouver le bon artisan</h1>
          <p class="lead mb-0">{regionLabel} ‚Äî devis gratuit & r√©ponse rapide</p>
        </div>

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Accueil</a></li>
            <li class="breadcrumb-item active" aria-current="page">M√©tiers</li>
          </ol>
        </nav>
      </div>
    </div>
  </section>

  <section id="content">
    <div class="content-wrap pb-0">
      <div class="container">

        <!-- Intro -->
        <div class="row justify-content-center">
          <div class="col-lg-9 text-center">
            <div class="badge rounded-pill badge-default mb-2">Rapide & simple</div>
            <h2 class="display-6 fw-bold mb-3">Choisissez votre besoin</h2>
            <p class="text-muted mb-0">
              D‚Äôabord le m√©tier (plombier, √©lectricien, serrurier‚Ä¶), puis votre ville.
              Vous acc√©dez aux demandes les plus courantes : <strong>fuite d‚Äôeau</strong>, <strong>WC bouch√©</strong>,
              <strong>disjoncteur qui saute</strong>, <strong>porte claqu√©e</strong>, <strong>serrure bloqu√©e</strong>,
              <strong>fuite en toiture</strong>‚Ä¶ et vous pouvez demander un devis en 1 minute.
            </p>
          </div>
        </div>

        <div class="clear line my-6"></div>

        <!-- Filtres -->
        <div class="row justify-content-center">
          <div class="col-lg-10">
            <div class="card shadow-sm">
              <div class="card-body p-4">
                <div class="row g-3 align-items-end">
                  <div class="col-md-6">
                    <label class="form-label small text-muted mb-1" for="m-search">Rechercher (m√©tier ou probl√®me)</label>
                    <input
                      id="m-search"
                      class="form-control"
                      type="search"
                      placeholder="Ex : fuite d‚Äôeau, WC bouch√©, disjoncteur, porte claqu√©e, chauffe-eau‚Ä¶"
                    />
                  </div>

                  <div class="col-md-3">
                    <label class="form-label small text-muted mb-1" for="m-zone">Zone</label>
                    <select id="m-zone" class="form-select">
                      <option value="all">Toutes</option>
                      <option value="sud-oise">Sud Oise (60)</option>
                      <option value="nord-95">Nord 95</option>
                    </select>
                  </div>

                  <div class="col-md-3">
                    <label class="form-label small text-muted mb-1" for="m-priority">Villes affich√©es</label>
                    <select id="m-priority" class="form-select">
                      <option value="all">Villes principales + autour</option>
                      <option value="A">Villes principales</option>
                      <option value="B">Villes autour</option>
                    </select>
                  </div>
                </div>

                <div class="d-flex flex-wrap gap-2 mt-3">
                  <button class="btn btn-outline-secondary btn-sm" type="button" id="m-reset">R√©initialiser</button>
                  <div class="small text-muted ms-auto" id="m-count"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="clear line my-6"></div>

        <!-- Bloc combos -->
        <PopularCombosByMetier
          title="Combinaisons populaires"
          subtitle="Acc√®s rapide : m√©tiers + villes les plus demand√©es + probl√®mes fr√©quents. Cliquez pour aller directement √† la page la plus utile."
          limitMetiers={6}
          limitVilles={4}
          limitServices={3}
          topVillePriority="A"
          showAllToggle={true}
          allToggleLabel="Voir tous les m√©tiers (accord√©ons)"
        />

        <div class="clear line my-6"></div>

        <!-- Tous les m√©tiers : accord√©ons -->
        <div class="row justify-content-center">
          <div class="col-lg-11">
            <div class="heading-block border-bottom-0 text-center mb-4">
              <div class="badge rounded-pill badge-default">Catalogue</div>
              <h2 class="text-transform-none ls-0 mb-1">Tous les m√©tiers</h2>
              <p class="text-muted mb-0">
                Ouvrez un m√©tier pour voir : <strong>probl√®mes courants</strong> + <strong>villes d‚Äôintervention</strong> + acc√®s au devis.
              </p>
            </div>

            <div class="row g-3" id="metiers-grid">
              {[...metiers].sort(byNameFR).map((m) => {
                const allS = servicesFor(m.slug);
                const topS = topServicesFor(m.slug, 8);

                return (
                  <div
                    class="col-lg-6 metier-item"
                    data-metier={`${m.name} ${m.slug}`.toLowerCase()}
                    data-services={`${allS.map((s) => s.name).join(" ")}`.toLowerCase()}
                  >
                    <details class="card shadow-sm h-100">
                      <summary class="card-body p-4" style="cursor:pointer;">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <div class="fw-semibold">{m.name}</div>
                            <div class="small text-muted">Urgence ou rendez-vous ‚Ä¢ devis gratuit</div>
                          </div>
                          <span class="badge bg-light text-dark">{topS.length} fr√©quents</span>
                        </div>
                      </summary>

                      <div class="card-body pt-0 px-4 pb-4">
                        <div class="d-flex flex-wrap gap-2 mb-3">
                          <a class="btn btn-outline-secondary btn-sm" href={`/${m.slug}/`}>Voir {m.name}</a>
                          <a class="btn btn-outline-primary btn-sm" href="/contact/">Demander un devis</a>
                          <a class="btn btn-outline-secondary btn-sm" href="/villes/">Choisir une ville</a>
                        </div>

                        <div class="row g-4">
                          <!-- Services top -->
                          <div class="col-md-6">
                            <div class="small text-uppercase ls-1 fw-bold text-muted mb-2">Probl√®mes fr√©quents</div>

                            {topS.length ? (
                              <div class="d-flex flex-wrap gap-2">
                                {topS.map((s) => (
                                  <a
                                    class="btn btn-sm btn-outline-secondary"
                                    href={`/${m.slug}/#service-${s.slug}`}
                                    id={`service-${s.slug}`}
                                  >
                                    {s.name}
                                  </a>
                                ))}
                              </div>
                            ) : (
                              <div class="small text-muted">Bient√¥t plus de d√©tails sur ce m√©tier.</div>
                            )}

                            <div class="small text-muted mt-3">
                              Votre cas n‚Äôest pas list√© ? Pas grave : d√©crivez le probl√®me sur le devis, on vous oriente.
                            </div>
                          </div>

                          <!-- Villes -->
                          <div class="col-md-6">
                            <div class="small text-uppercase ls-1 fw-bold text-muted mb-2">Villes d‚Äôintervention</div>

                            <details class="border rounded-3 p-3 mb-2">
                              <summary style="cursor:pointer;">
                                <span class="fw-semibold">Villes principales</span>
                                <span class="text-muted small ms-2">({villesA.length})</span>
                              </summary>

                              <div class="pt-2 d-flex flex-column gap-2">
                                {villesA.map((v) => (
                                  <div class="p-2 border rounded-3 ville-row" data-zone={v.zone} data-priority={v.priority}>
                                    <div class="d-flex justify-content-between align-items-start">
                                      <div>
                                        <div class="fw-semibold">{v.name}</div>
                                        <div class="small text-muted">{v.dept} ‚Ä¢ {v.zone}</div>
                                      </div>
                                      <span class="badge bg-success">OK</span>
                                    </div>

                                    <div class="d-flex flex-wrap gap-2 mt-2">
                                      <a class="btn btn-sm btn-outline-secondary" href={`/villes/${v.slug}/${m.slug}/`}>
                                        {m.name} √† {v.name}
                                      </a>

                                      {topS.slice(0, 3).map((s) => (
                                        <a class="btn btn-sm btn-outline-secondary" href={`/villes/${v.slug}/${m.slug}/${s.slug}/`}>
                                          {s.name}
                                        </a>
                                      ))}
                                    </div>

                                    {v.around?.length ? (
                                      <div class="small text-muted mt-2">
                                        Communes proches : {v.around.slice(0, 6).map((x) => prettify(x)).join(", ")}{v.around.length > 6 ? "‚Ä¶" : ""}
                                      </div>
                                    ) : null}
                                  </div>
                                ))}
                              </div>
                            </details>

                            <details class="border rounded-3 p-3">
                              <summary style="cursor:pointer;">
                                <span class="fw-semibold">Autres villes autour</span>
                                <span class="text-muted small ms-2">({villesB.length})</span>
                              </summary>

                              <div class="pt-2 d-flex flex-column gap-2">
                                {villesB.map((v) => (
                                  <div class="p-2 border rounded-3 ville-row" data-zone={v.zone} data-priority={v.priority}>
                                    <div class="d-flex justify-content-between align-items-start">
                                      <div>
                                        <div class="fw-semibold">{v.name}</div>
                                        <div class="small text-muted">{v.dept} ‚Ä¢ {v.zone}</div>
                                      </div>
                                      <span class="badge bg-secondary">OK</span>
                                    </div>

                                    <div class="d-flex flex-wrap gap-2 mt-2">
                                      <a class="btn btn-sm btn-outline-secondary" href={`/villes/${v.slug}/${m.slug}/`}>
                                        {m.name} √† {v.name}
                                      </a>

                                      {topS.slice(0, 2).map((s) => (
                                        <a class="btn btn-sm btn-outline-secondary" href={`/villes/${v.slug}/${m.slug}/${s.slug}/`}>
                                          {s.name}
                                        </a>
                                      ))}
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </details>
                          </div>
                        </div>
                      </div>
                    </details>
                  </div>
                );
              })}
            </div>
          </div>
        </div>

        <div class="clear line my-6"></div>

        <!-- Bottom CTA -->
        <div class="section mt-0" style="padding: 60px 0;">
          <div class="container">
            <div class="row justify-content-center text-center">
              <div class="col-lg-8">
                <div class="badge rounded-pill badge-default mb-2">Besoin d‚Äôaide ?</div>
                <h3 class="text-transform-none ls-0 mb-3">Vous ne savez pas quel artisan choisir ?</h3>
                <p class="text-muted mb-4">
                  D√©crivez votre probl√®me (ex : fuite, panne, porte bloqu√©e) + votre ville.
                  On vous rappelle rapidement pour confirmer le bon m√©tier et le cr√©neau.
                </p>
                <a href="/contact/" class="button button-rounded button-large m-0">üìù Demander un devis</a>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- Filtrage front (isol√©, pas de $ global) -->
  <script is:inline>
    (() => {
      const qs = (sel, root = document) => root.querySelector(sel);
      const qsa = (sel, root = document) => Array.from(root.querySelectorAll(sel));

      const input = qs("#m-search");
      const zone = qs("#m-zone");
      const prio = qs("#m-priority");
      const reset = qs("#m-reset");
      const count = qs("#m-count");

      function applyFilters() {
        const q = (input?.value || "").trim().toLowerCase();
        const z = zone?.value || "all";
        const p = prio?.value || "all";

        // 1) filtre m√©tiers (recherche)
        const items = qsa(".metier-item");
        let visibleMetiers = 0;

        items.forEach((item) => {
          const mtxt = item.getAttribute("data-metier") || "";
          const stxt = item.getAttribute("data-services") || "";
          const okQ = !q || mtxt.includes(q) || stxt.includes(q);

          item.style.display = okQ ? "" : "none";
          if (okQ) visibleMetiers++;
        });

        // 2) filtre villes √† l'int√©rieur des accord√©ons
        const villeRows = qsa(".ville-row");
        villeRows.forEach((row) => {
          const rowZone = row.getAttribute("data-zone") || "";
          const rowPrio = row.getAttribute("data-priority") || "";
          const okZ = z === "all" || rowZone === z;
          const okP = p === "all" || rowPrio === p;
          row.style.display = (okZ && okP) ? "" : "none";
        });

        if (count) count.textContent = `${visibleMetiers} m√©tier(s) affich√©(s)`;
      }

      [input, zone, prio].forEach((el) => el && el.addEventListener("input", applyFilters));
      [zone, prio].forEach((el) => el && el.addEventListener("change", applyFilters));

      reset?.addEventListener("click", () => {
        if (input) input.value = "";
        if (zone) zone.value = "all";
        if (prio) prio.value = "all";
        applyFilters();
      });

      applyFilters();
    })();
  </script>
</Layout>
