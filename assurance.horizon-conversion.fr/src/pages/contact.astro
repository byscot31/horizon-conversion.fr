---
// src/pages/contact.astro
import SiteLayout from "../layouts/SiteLayout.astro";
import Hero from "../components/blocks/Hero.astro";
import ContactForm from "../components/blocks/ContactForm.astro";
import PromoCall from "../components/blocks/PromoCall.astro";
import FaqToggles from "../components/blocks/FaqToggles.astro";

import rawPageData from "../data/page_contact.json";
import siteData from "../data/site.json";

import { hydrateStandardPage } from "../lib/seoTokens";
import { listMetiers, getMetierBySlug } from "../lib/data.ts";

const pageData = hydrateStandardPage(rawPageData);

// mÃ©tiers -> options select
const metiersIndex = listMetiers();
const metiersOptions = metiersIndex.map((m) => ({ value: m.slug, label: m.title }));

// map slug -> offres[]
const metiersDetails = await Promise.all(metiersIndex.map((m) => getMetierBySlug(m.slug)));
const offresBySlug = Object.fromEntries(
  metiersDetails.map((m: any) => [m.slug, Array.isArray(m.offres) ? m.offres : []])
);

const faq = pageData.schema?.faq ?? [];
---

<SiteLayout seo={pageData.seo} schema={pageData.schema}>
  <Hero {...pageData.hero} />

  <section id="content">
    <div class="content-wrap pb-0 pt-0 pt-lg-5">
      <ContactForm
          data={pageData.sections.contactForm}
          site={siteData}
          metiersOptions={metiersOptions}
          offresBySlug={offresBySlug}
      />

      <PromoCall data={pageData.sections.promoCall} site={siteData} />

      <FaqToggles data={pageData.sections.faqToggles} faq={faq} />
    </div>
  </section>
</SiteLayout>