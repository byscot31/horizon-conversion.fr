---
import SiteLayout from "../../layouts/SiteLayout.astro";
import FAQ from "../../components/FAQ.astro";
import RelatedLinks from "../../components/RelatedLinks.astro";
import { getMetierBySlug, listPrestations, getDeclinaisonsForMetier } from "../../lib/data";
import LocalModules from "../../components/LocalModules.astro";

export async function getStaticPaths() {
  const { listMetiers } = await import("../../lib/data");
  return listMetiers().map((m) => ({ params: { slug: m.slug } }));
}

const { slug } = Astro.params;
const metier = await getMetierBySlug(slug);

const allPrestations = listPrestations();
const declis = getDeclinaisonsForMetier(metier.id).slice().sort((a: any, b: any) => a.priority - b.priority);

const pageUrl = `https://assurance.horizon-conversion.fr${metier.meta.canonical}`;

const seo = { ...metier.meta };

const linksPrestations = declis
  .map((d: any) => {
    const p = allPrestations.find((x) => x.id === d.prestaId);
    if (!p) return null;
    return {
      label: p.title,
      href: `/prestations/${p.slug}/${metier.slug}/`,
      desc: d.angle || ""
    };
  })
  .filter(Boolean);

const matriLinks = [
  { label: "La méthode", href: "/methode/", desc: "La logique complète : SEO local + Ads + CRO + tracking." },
  { label: "Preuves", href: "/preuves/", desc: "Exemples, résultats, process." },
  { label: "Tarifs", href: "/tarifs/", desc: "Packages et options." },
  { label: "Contact", href: "/contact/", desc: "Diagnostic et plan d’action." }
];
---
<SiteLayout
    seo={seo}
    h1={metier.hero?.h1 ?? metier.label}
    intro={metier.hero?.sub}
    breadcrumbs={[
      { label: "Accueil", href: "/" },
      { label: "Métiers", href: "/metiers/" },
      { label: metier.label, href: `/metiers/${metier.slug}/` }
    ]}
    ctas={{
      primary: metier.hero?.ctaPrimary ?? { label: "Obtenir un diagnostic", href: "/contact/" },
      secondary: metier.hero?.ctaSecondary ?? { label: "Voir la méthode", href: "/methode/" }
    }}
    schema={{
      faq: metier.faq ?? []
    }}
>
  {metier.objections?.length ? (
      <section>
        <h2>Objections fréquentes</h2>
        <ul>
          {metier.objections.map((o) => (
              <li><strong>{o.texte}</strong><br />{o.reponse}</li>
          ))}
        </ul>
      </section>
  ) : null}

  <RelatedLinks title="Prestations recommandées (déclinaisons)" links={linksPrestations} />

  <FAQ items={metier.faq ?? []} />

  <LocalModules
      mode="metier"
      canonicalSeed={metier.meta.canonical}
      context={{ metierLabel: metier.label, offres: metier.offres }}
      config={metier.localModules ?? { enabled: true }}
  />

  <RelatedLinks title="Ressources & pages clés" links={matriLinks} />
</SiteLayout>