---
// src/components/Footer.astro
import footer from "../data/footer.json";
import site from "../data/site.json";

import metiersIndex from "../data/metiers/index.json";
import prestationsIndex from "../data/prestations/index.json";
import ressourcesIndex from "../data/ressources/index.json";

const year = new Date().getFullYear();

const brand = footer?.brand ?? {};
const theme = footer?.theme ?? {};
const left = footer?.left ?? {};
const columns = Array.isArray(footer?.columns) ? footer.columns : [];
const legal = footer?.legal ?? {};

const phoneDisplay = site?.phoneDisplay;
const phoneTel = site?.phoneTel;
const waLink = site?.whatsapp;

const legalText = String(legal?.textPrefix ?? "").replaceAll("{year}", String(year));

const metiersItems = ((metiersIndex as any).items ?? []) as Array<{ slug: string; title: string }>;
const prestationsItems = ((prestationsIndex as any).items ?? []) as Array<{ slug: string; title: string }>;
const ressourcesItems = ((ressourcesIndex as any).items ?? []) as Array<{ slug: string; title: string; date?: string }>;

function pickByFeatured<T extends { slug: string }>(items: T[], featuredSlugs: string[] | undefined, limit: number) {
  const out: T[] = [];
  const seen = new Set<string>();

  const featured = Array.isArray(featuredSlugs) ? featuredSlugs : [];
  for (const s of featured) {
    const it = items.find((x) => x.slug === s);
    if (!it) continue;
    if (seen.has(it.slug)) continue;
    seen.add(it.slug);
    out.push(it);
    if (out.length >= limit) return out;
  }

  for (const it of items) {
    if (seen.has(it.slug)) continue;
    seen.add(it.slug);
    out.push(it);
    if (out.length >= limit) break;
  }

  return out;
}

function sortRessources(items: any[], sort: string | undefined) {
  if (sort !== "date_desc") return items;
  return [...items].sort((a, b) => String(b?.date ?? "").localeCompare(String(a?.date ?? "")));
}

function buildColumnLinks(col: any) {
  const mode = col?.mode ?? "static";
  if (mode === "static") return (col?.links ?? []) as any[];

  const src = col?.auto?.source;
  const limit = col?.auto?.limit ?? 4;

  if (src === "metiers") {
    const picked = pickByFeatured(metiersItems, col?.featuredSlugs, limit);
    return picked.map((m) => ({ label: m.title, href: `/metiers/${m.slug}/` }));
  }

  if (src === "prestations") {
    const picked = pickByFeatured(prestationsItems, col?.featuredSlugs, limit);
    return picked.map((p) => ({ label: p.title, href: `/prestations/${p.slug}/` }));
  }

  if (src === "ressources") {
    const sort = col?.auto?.sort;
    const sorted = sortRessources(ressourcesItems, sort);
    const picked = sorted.slice(0, limit);
    return picked.map((r) => ({ label: r.title, href: `/ressources/${r.slug}/` }));
  }

  return [];
}
---

<footer id="footer" class="bg-white border-0 overflow-hidden">
  <div class="row">

    <!-- Left -->
    <div class="col-md-4 col-padding dark" style={`background-color: ${theme?.leftBg ?? "#021b4c"}`}>
      <div class="row justify-content-between align-items-center">
        <a href={brand?.href ?? "/"} class="fw-bold col color h1 font-primary d-block">
          {brand?.title ?? ""}
          <br />
          <span class="text-white">{brand?.subtitle ?? ""}</span>
        </a>
      </div>

      <hr />

      {left?.heading && <h5 class="font-body text-uppercase ls-2 mt-4">{left.heading}</h5>}

      {(left?.paragraphs ?? []).map((p: string) => (
          <p class="op-08">{p}</p>
      ))}

      {Array.isArray(left?.ctas) && left.ctas.length > 0 && (
          <div class="mt-3 d-flex flex-wrap gap-2">
            {left.ctas.map((c: any) => (
                <a href={c.href} class={c.variant ?? "button button-small button-border button-light"} data-track={c.track}>
                  {c.label}
                </a>
            ))}
          </div>
      )}

      {left?.contact?.enabled && (
          <div class="mt-4 op-08">
            {left?.contact?.zoneText && <small class="d-block op-07">{left.contact.zoneText}</small>}

            <div class="d-flex flex-wrap gap-2 mt-3">
              {left?.contact?.showPhone && phoneTel && (
                  <a href={`tel:${phoneTel}`} class="button button-small button-border button-light" data-track="click_call_footer">
                    {phoneDisplay ?? phoneTel}
                  </a>
              )}
              {left?.contact?.showWhatsApp && waLink && (
                  <a href={waLink} class="button button-small button-border button-light" data-track="click_whatsapp_footer">
                    WhatsApp {phoneDisplay ?? ""}
                  </a>
              )}
            </div>
          </div>
      )}
    </div>

    <!-- Right -->
    <div class="col-md-8" style={`background-color: ${theme?.rightBg ?? "#FDE3A1"}`}>
      <div class="footer-widgets-wrap">
        <div class="row px-5">

          {columns.map((col: any, idx: number) => {
            const links = buildColumnLinks(col);
            return (
                <div class={`col-6 ${idx >= 2 ? "mt-5 mt-lg-0" : ""}`}>
                  <div class="widget">
                    {col?.title && <h4>{col.title}</h4>}

                    <ul class="widget_links">
                      {links.map((l: any) => (
                          <li class="mb-1">
                            <a href={l.href} class="op-08" data-track={l.track}>
                              {l.label}
                            </a>
                          </li>
                      ))}

                      {col?.viewAll?.href && col?.viewAll?.label && (
                          <li class="mb-1">
                            <a href={col.viewAll.href} class="op-08" data-track={col.viewAll.track}>
                              {col.viewAll.label}
                            </a>
                          </li>
                      )}
                    </ul>
                  </div>
                </div>
            );
          })}

        </div>

        <div class="row px-5">
          <div class="col-12">
            <hr />
            <div class="mt-4 pt-1 op-08">
              <small class="op-06 copyright-links">
                {legalText}
                {(legal?.links ?? []).map((l: any) => (
                    <>
                      <span class="mx-2">|</span>
                      <a href={l.href} class="op-08">
                        {l.label}
                      </a>
                    </>
                ))}
              </small>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</footer>

<script is:inline>
  {`
    (function(){
      window.dataLayer = window.dataLayer || [];
      document.addEventListener('click', function(e){
        var a = e.target && e.target.closest ? e.target.closest('[data-track]') : null;
        if(!a) return;
        window.dataLayer.push({
          event: a.getAttribute('data-track'),
          page_path: window.location.pathname,
          href: a.getAttribute('href') || ''
        });
      });
    })();
  `}
</script>