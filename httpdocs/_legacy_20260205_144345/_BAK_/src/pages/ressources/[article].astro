---
// src/pages/ressources/[article].astro

import BaseLayout from "../../layouts/BaseLayout.astro";
import { getAllArticles, getArticlePage, normalizeLinksOut, resolveFaqItems, safeText } from "../../lib/mapping";

import SectionHero from "../../components/SectionHero.astro";
import SectionFAQ from "../../components/SectionFAQ.astro";
import SectionCTA from "../../components/SectionCTA.astro";
import LinksOut from "../../components/LinksOut.astro";
import InternalLinks from "../../components/InternalLinks.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";

export async function getStaticPaths() {
  const articles = getAllArticles();
  return articles.map((a: any) => ({
    params: { article: String(a.slug) },
    props: { page: a }
  }));
}

const { article } = Astro.params;
const { page } = Astro.props as any;

// Sécurité
const p = page || getArticlePage(String(article));

const title = safeText(p?.metaTitle, safeText(p?.h1, "Ressource | Horizon Conversion"));
const description = safeText(p?.metaDescription, "Conseils concrets en SEO local, Ads et CRO.");
const h1 = safeText(p?.h1, String(article));

const linksOut = normalizeLinksOut(p?.linksOut);

// ✅ FAQ optionnelle : support faqRefs (si tu en ajoutes aux articles dans le mapping)
const faqItems = resolveFaqItems({ pageFaqRefs: p?.faqRefs, pageFaq: p?.faq });
const showFaq = Array.isArray(faqItems) && faqItems.length;

const intro = safeText(p?.metaDescription, "Guide concret, orienté demandes qualifiées.");
---

<BaseLayout
  title={title}
  description={description}
  pageContext={{ type: "article", article: String(article) }}
  faqItems={faqItems}
>
  <Breadcrumbs type="article" article={String(article)} />

  <SectionHero
    h1={h1}
    intro={intro}
    bullets={[
      "Plan d’actions simple",
      "Erreurs à éviter",
      "Priorités conversion"
    ]}
  />

  <section style="padding:1.5rem 0">
    <div style="max-width:980px;margin:0 auto;padding:0 1rem">
      <h2 style="margin:0 0 .75rem;font-size:1.25rem">Le guide</h2>
      <p style="margin:0;color:#374151">
        Contenu à rédiger (template). Ici tu peux injecter un champ `contentHtml` depuis tes datas,
        ou passer sur Astro Content Collections si tu veux des .md/.mdx.
      </p>
    </div>
  </section>

  {showFaq ? <SectionFAQ items={faqItems} /> : null}

  <LinksOut links={linksOut} />
  <InternalLinks type="article" article={String(article)} max={10} title="Aller plus loin" />

  <SectionCTA />
</BaseLayout>