---
// src/pages/[service]/[metier]/[ville].astro
import Layout from "../../../layouts/Layout.astro";

// Importer les donn√©es
import services from "../../../data/services.json";
import metiers from "../../../data/metiers.json";
import villes from "../../../data/villes.json";
import intentions from "../../../data/intentions.json";

// D√©finir un objet positionnements par d√©faut (au cas o√π le fichier manquerait)
const positionnements = {
  consultant: {
    badge: "üë§ Consultant ind√©pendant",
    suffixeTitre: "Consultant SEO",
    intro: "En tant que consultant ind√©pendant, je vous accompagne personnellement.",
    argument: "‚úÖ Vous travaillez directement avec l'expert.",
    arguments: ["Expertise directe", "Relation durable", "Pas d'interm√©diaire"],
    cta: "Parler directement √† un expert"
  },
  agence: {
    badge: "üè¢ Agence locale",
    suffixeTitre: "Agence SEO",
    intro: "Notre agence vous accompagne avec des process structur√©s.",
    argument: "üè¢ Une m√©thode d'agence, des outils professionnels.",
    arguments: ["Process √©prouv√©s", "Reporting pro", "Outils experts"],
    cta: "D√©couvrir nos prestations"
  },
  mixte: {
    badge: "üë§ Consultant ¬∑ üè¢ Agence",
    suffixeTitre: "Expert SEO",
    intro: "Le meilleur des deux mondes : consultant et agence.",
    argument: "L'expertise d'un consultant, la fiabilit√© d'une agence.",
    arguments: ["Agilit√©", "Robustesse", "M√©thode √©prouv√©e"],
    cta: "Discutons de votre projet"
  },
  "consultant-premium": {
    badge: "üë§ Consultant expert",
    suffixeTitre: "Consultant SEO expert",
    intro: "Un accompagnement sur-mesure et confidentiel.",
    argument: "Une expertise pointue, une relation privil√©gi√©e.",
    arguments: ["Expertise haut niveau", "Strat√©gie sur-mesure", "R√©sultats prouv√©s"],
    cta: "R√©server un appel strat√©gique"
  }
};

// Fonction pour d√©terminer le positionnement
function getPositionnement(metier, ville) {
  try {
    if (ville.metiersPositionnement?.[metier.id]) {
      return ville.metiersPositionnement[metier.id];
    }
    if (metier.positionnement?.exceptions?.[ville.id]) {
      return metier.positionnement.exceptions[ville.id];
    }
    return metier.positionnement?.default || "mixte";
  } catch (e) {
    return "mixte";
  }
}

// Fonction pour d√©terminer l'intention
function getIntentionPrincipale(serviceId, metierId) {
  const matriceIntentions = {
    "seo-local": {
      "artisans": "transactionnelle",
      "commerces": "transactionnelle",
      "profession-liberale": "investigationnelle",
      "tpe-pme": "navigationnelle",
      "reseaux-franchise": "navigationnelle",
      "tourisme": "navigationnelle"
    },
    "google-ads": {
      "artisans": "transactionnelle",
      "commerces": "transactionnelle",
      "profession-liberale": "investigationnelle",
      "tpe-pme": "transactionnelle",
      "reseaux-franchise": "transactionnelle",
      "tourisme": "transactionnelle"
    },
    "cro": {
      "artisans": "informationnelle",
      "commerces": "transactionnelle",
      "profession-liberale": "transactionnelle",
      "tpe-pme": "investigationnelle",
      "reseaux-franchise": "investigationnelle",
      "tourisme": "transactionnelle"
    }
  };
  return matriceIntentions[serviceId]?.[metierId] || "investigationnelle";
}

export async function getStaticPaths() {
  const paths = [];
  for (const service of services) {
    for (const metier of metiers) {
      for (const ville of villes) {
        paths.push({
          params: {
            service: service.id,
            metier: metier.id,
            ville: ville.id
          },
          props: { service, metier, ville }
        });
      }
    }
  }
  return paths;
}

const { service, metier, ville } = Astro.props;

// S√©curit√© : valeurs par d√©faut
const serviceSafe = service || { id: '', nom: 'Service', nomCourt: 'service', description: '', benefice: '' };
const metierSafe = metier || { id: '', nom: 'M√©tier', nomCourt: 'professionnel', description: '', message: '' };
const villeSafe = ville || { id: '', nom: 'ville', zone: '60', codePostal: '', alentours: [] };

const positionnementId = getPositionnement(metierSafe, villeSafe);
const positionnement = positionnements[positionnementId] || positionnements.mixte;

const intentionId = getIntentionPrincipale(serviceSafe.id, metierSafe.id);
const intentionData = intentions[metierSafe.id]?.intentions?.[intentionId] || {
  description: "Am√©liorez votre visibilit√© locale.",
  cta: "Demander un audit gratuit"
};
const persona = intentions[metierSafe.id]?.persona || {
  nom: "nos clients",
  citation: "Je veux √™tre plus visible dans ma ville.",
  histoire: "Comme beaucoup de professionnels, vous cherchez √† attirer plus de clients locaux."
};

const titre = `${positionnement.suffixeTitre} pour ${metierSafe.nomCourt} √† ${villeSafe.nom}`;
const description = intentionData.description || "Expert SEO local dans l'Oise et le Val-d'Oise.";
---

<Layout title={titre} description={description}>
  <!-- Fil d'Ariane -->
  <nav class="container-custom py-4 text-sm text-gray-600">
    <ol class="flex items-center space-x-2">
      <li><a href="/" class="hover:text-primary-600">Accueil</a></li>
      <li class="text-gray-400">‚Ä∫</li>
      <li><a href="/services" class="hover:text-primary-600">Services</a></li>
      <li class="text-gray-400">‚Ä∫</li>
      <li><a href={`/services/${serviceSafe.id}`} class="hover:text-primary-600">{serviceSafe.nomCourt}</a></li>
      <li class="text-gray-400">‚Ä∫</li>
      <li><a href="/metiers" class="hover:text-primary-600">M√©tiers</a></li>
      <li class="text-gray-400">‚Ä∫</li>
      <li><a href={`/metiers/${metierSafe.id}`} class="hover:text-primary-600">{metierSafe.nomCourt}</a></li>
      <li class="text-gray-400">‚Ä∫</li>
      <li class="text-gray-900 font-medium">{villeSafe.nom}</li>
    </ol>
  </nav>

  <!-- Hero avec intention -->
  <section class="bg-gradient-to-br from-primary-50 to-indigo-50 py-16">
    <div class="container-custom">
      <div class="max-w-4xl mx-auto">
        <div class="mb-4 flex items-center gap-3">
          <span class={`badge-${positionnementId}`}>{positionnement.badge}</span>
          <span class="bg-white px-3 py-1 rounded-full text-sm flex items-center gap-1">
            {intentionId === 'transactionnelle' && 'üî¥ Besoin urgent ?'}
            {intentionId === 'investigationnelle' && 'üîµ Vous comparez ?'}
            {intentionId === 'informationnelle' && 'üü¢ Vous vous renseignez ?'}
          </span>
        </div>

        <h1 class="text-5xl font-bold text-gray-900 mb-4">{titre}</h1>

        <!-- Accroche persona -->
        <div class="bg-white/80 backdrop-blur-sm p-6 rounded-xl mb-6">
          <div class="flex items-start gap-4">
            <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0 text-2xl">
              üë§
            </div>
            <div>
              <p class="text-lg font-medium mb-1">Comme {persona.nom}, {metierSafe.nomCourt} √† {villeSafe.nom}...</p>
              <p class="text-gray-700 italic">"{persona.citation}"</p>
            </div>
          </div>
        </div>

        <p class="text-xl text-gray-700 mb-6">
          {intentionData.description}
        </p>

        <div class="flex flex-col sm:flex-row gap-4">
          <a href="/contact" class="btn-primary text-lg px-8 py-4">
            {intentionData.cta}
          </a>
          <a href="/methodologie" class="btn-secondary text-lg px-8 py-4">
            {intentionId === 'transactionnelle' ? 'Voir mes tarifs' :
              intentionId === 'investigationnelle' ? 'Voir les √©tudes de cas' :
                'Lire les guides gratuits'}
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Section histoire du persona -->
  <section class="bg-gray-50 py-16">
    <div class="container-custom">
      <div class="max-w-3xl mx-auto text-center">
        <h2 class="text-2xl font-bold mb-4">L'histoire de {persona.nom}</h2>
        <p class="text-gray-700 mb-6">{persona.histoire}</p>
        <a href={`/etudes-de-cas/${metierSafe.id === 'artisans' ? 'plombier-meru' :
          metierSafe.id === 'commerces' ? 'caviste-cergy' :
            metierSafe.id === 'profession-liberale' ? 'avocat-montmorency' :
              metierSafe.id === 'tpe-pme' ? 'transport-compiegne' :
                metierSafe.id === 'reseaux-franchise' ? 'franchise-cergy' : 'hotel-chantilly'}`}
           class="text-primary-600 hover:underline">
          Voir comment on l'a aid√© ‚Üí
        </a>
      </div>
    </div>
  </section>

  <!-- Villes alentours -->
  <section class="py-12">
    <div class="container-custom">
      <h3 class="text-lg font-semibold mb-4">Nous intervenons aussi dans les environs de {villeSafe.nom}</h3>
      <div class="flex flex-wrap gap-2">
        {villeSafe.alentours.map(alentour => (
            <span class="bg-white px-3 py-1 rounded-full text-sm border border-gray-200">
            {typeof alentour === 'string' ? alentour.split(' (')[0] : alentour}
          </span>
        ))}
      </div>
    </div>
  </section>

  <!-- Section hubs -->
  <section class="py-12 bg-gray-50">
    <div class="container-custom">
      <h3 class="text-xl font-bold text-center mb-6">En savoir plus</h3>
      <div class="flex flex-wrap justify-center gap-4">
        <a href="/services" class="bg-white px-4 py-2 rounded-full text-sm hover:bg-primary-50 transition-colors">
          Tous nos services
        </a>
        <a href="/metiers" class="bg-white px-4 py-2 rounded-full text-sm hover:bg-primary-50 transition-colors">
          Tous les m√©tiers
        </a>
        <a href={`/villes/${ville.id}`} class="bg-white px-4 py-2 rounded-full text-sm hover:bg-primary-50 transition-colors">
          {ville.nom}
        </a>
        <a href="/etudes-de-cas" class="bg-white px-4 py-2 rounded-full text-sm hover:bg-primary-50 transition-colors">
          √âtudes de cas
        </a>
      </div>
    </div>
  </section>

  <!-- CTA final -->
  <section class="bg-primary-600 text-white py-16">
    <div class="container-custom text-center">
      <h2 class="text-3xl font-bold mb-4">
        {intentionId === 'transactionnelle' && 'Pr√™t √† agir MAINTENANT ?'}
        {intentionId === 'investigationnelle' && 'Vous voulez comparer sereinement ?'}
        {intentionId === 'informationnelle' && 'Besoin de plus d\'informations ?'}
      </h2>
      <p class="text-xl mb-8 opacity-90 max-w-2xl mx-auto">
        {intentionId === 'transactionnelle' && "Je vous propose un audit URGENT sous 24h."}
        {intentionId === 'investigationnelle' && "Je vous envoie une √©tude de cas adapt√©e √† votre m√©tier."}
        {intentionId === 'informationnelle' && "T√©l√©chargez mon guide gratuit."}
      </p>
      <a href="/contact" class="bg-white text-primary-600 hover:bg-gray-100 px-8 py-4 rounded-full font-semibold text-lg inline-block transition-colors">
        {intentionData.cta}
      </a>
    </div>
  </section>
</Layout>