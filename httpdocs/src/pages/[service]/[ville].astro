---
// src/pages/[service]/[ville].astro

import BaseLayout from "../../layouts/BaseLayout.astro";
import services from "../../data/services.json";
import villes from "../../data/villes.json";

import {
  getAllServiceVillePages,
  normalizeLinksOut,
  resolveFaqItems,
  safeText
} from "../../lib/mapping";

import SectionHero from "../../components/SectionHero.astro";
import SectionBenefits from "../../components/SectionBenefits.astro";
import SectionDeliverables from "../../components/SectionDeliverables.astro";
import SectionProcess from "../../components/SectionProcess.astro";
import SectionFAQ from "../../components/SectionFAQ.astro";
import SectionCTA from "../../components/SectionCTA.astro";
import LinksOut from "../../components/LinksOut.astro";
import InternalLinks from "../../components/InternalLinks.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import MiniCases from "../../components/MiniCases.astro";

export async function getStaticPaths() {
  const pages = getAllServiceVillePages();
  return pages.map((p: any) => ({
    params: { service: String(p.service), ville: String(p.ville) },
    props: { page: p }
  }));
}

const { service, ville } = Astro.params;
const { page } = Astro.props as any;

const title = safeText(page?.metaTitle, `${service} ${ville} | Horizon Conversion`);
const description = safeText(page?.metaDescription, "Méthode 3C : SEO local, Ads et CRO.");
const h1 = safeText(page?.h1, `${service} à ${ville}`);

const linksOut = normalizeLinksOut(page?.linksOut);

const svc = (services as any[]).find((s) => String(s.slug) === String(service)) || null;
const vObj = (villes as any[]).find((v) => String(v.slug) === String(ville)) || null;

const vName = safeText(vObj?.nom, String(ville));
const around = Array.isArray(vObj?.alentours) ? vObj.alentours.slice(0, 6) : [];

const localAngle = safeText(vObj?.angleLocal, safeText(vObj?.specificites, ""));
const painPointLocal = safeText(vObj?.painPointLocal, "");
const preuveLocale = safeText(vObj?.preuveLocale, "");

const benefits = Array.isArray(svc?.benefices) ? svc.benefices : [
  "Plus d’appels et demandes qualifiés (et moins de contacts inutiles)",
  "Un message clair qui filtre (zones, délais, types de demandes)",
  "Suivi simple pour piloter mois après mois"
];

const deliverables = Array.isArray(svc?.livrables) ? svc.livrables : [
  "Plan d’actions et priorités",
  "Optimisations mensuelles",
  "Tracking appels/formulaires + reporting lisible"
];

const process = Array.isArray(svc?.process) ? svc.process : [
  "Audit & cadrage (objectifs, zone, offre)",
  "Mise en place des fondations",
  "Optimisations + reporting + ajustements"
];

const faqItems = resolveFaqItems({
  pageFaqRefs: page?.faqRefs,
  pageFaq: page?.faq,
  serviceSlug: String(service)
});
const showFaq = Array.isArray(faqItems) && faqItems.length;

const heroIntro = [
  `À ${vName}, l’objectif n’est pas “plus de visites”, mais plus d’appels et demandes qualifiés.`,
  painPointLocal ? `Problème fréquent : ${painPointLocal}` : "",
  localAngle ? `Angle local : ${localAngle}` : "",
  around.length ? `Zones couvertes : ${around.join(", ")}.` : ""
].filter(Boolean).join(" ");

const tag =
  service === "seo-local"
    ? "seo-local"
    : service === "ads-google-meta"
      ? "ads"
      : "cro";
---

<BaseLayout
  title={title}
  description={description}
  pageContext={{ type: "serviceVille", service, ville }}
  faqItems={faqItems}
>
  <Breadcrumbs type="serviceVille" service={service} ville={ville} />

  <SectionHero
    h1={h1}
    intro={heroIntro}
    bullets={[
      "Filtrage des demandes (hors zone / hors service)",
      "Réassurance : preuves, avis, process",
      "Pilotage senior + exécution d’agence"
    ]}
  />

  {preuveLocale ? (
    <section style="padding:1rem 0">
      <div style="max-width:980px;margin:0 auto;padding:0 1rem">
        <div style="border:1px solid #e5e7eb;border-radius:12px;padding:1rem;background:#fff">
          <strong style="display:block;margin:0 0 .25rem">Preuve locale (concret)</strong>
          <p style="margin:0;color:#374151">{preuveLocale}</p>
        </div>
      </div>
    </section>
  ) : null}

  <SectionBenefits items={benefits} />
  <SectionDeliverables items={deliverables} />
  <SectionProcess steps={process} />

  {/* ✅ Filtrage des demandes : section dédiée anti thin content */}
  <section style="padding:1rem 0">
    <div style="max-width:980px;margin:0 auto;padding:0 1rem">
      <h2 style="margin:0 0 .75rem;font-size:1.25rem">Filtrer les demandes (hors zone / hors service)</h2>
      <div style="border:1px solid #e5e7eb;border-radius:12px;padding:1rem;background:#fff;display:grid;gap:.5rem">
        <p style="margin:0;color:#374151">
          À {vName}, l’objectif est simple : plus de demandes <strong>utiles</strong>, pas plus de bruit.
          On cadre la <strong>zone</strong>, les <strong>services</strong> et les <strong>délais</strong> dès la page et dans le tracking.
        </p>

        <ul style="margin:0;padding-left:1.25rem;display:grid;gap:.35rem;color:#374151">
          <li><strong>Zone</strong> : {around.length ? `on précise ${vName} + alentours (${around.slice(0, 4).join(", ")}…)` : `on précise le périmètre couvert`}, et on exclut le reste.</li>
          <li><strong>Service</strong> : on affiche clairement ce qui est inclus / non inclus pour éviter les demandes hors scope.</li>
          <li><strong>Ads (si concerné)</strong> : exclusions (requêtes/lieux), horaires, messages qui cadrent + landing qui qualifie.</li>
          <li><strong>Tracking</strong> : clics téléphone, formulaires et sources pour savoir ce qui génère des demandes exploitables.</li>
        </ul>
      </div>
    </div>
  </section>

  {/* ✅ Mini-cas “le plus proche” (1 card) */}
  <MiniCases
    title="Un exemple concret (même problématique)"
    intro=""
    limit={1}
    columns={3}
    tag={tag}
  />

  {showFaq ? <SectionFAQ items={faqItems} /> : null}
  <LinksOut links={linksOut} />

  <InternalLinks type="serviceVille" service={service} ville={ville} max={10} title="Liens utiles (ville + services + ressources)" />

  <SectionCTA />
</BaseLayout>