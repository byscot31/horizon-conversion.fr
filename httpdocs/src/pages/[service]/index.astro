---
// src/pages/[service]/index.astro

import BaseLayout from "../../layouts/BaseLayout.astro";
import services from "../../data/services.json";

import { getStaticPageByUrl, normalizeLinksOut, resolveFaqItems, safeText } from "../../lib/mapping";

import SectionHero from "../../components/SectionHero.astro";
import SectionBenefits from "../../components/SectionBenefits.astro";
import SectionDeliverables from "../../components/SectionDeliverables.astro";
import SectionProcess from "../../components/SectionProcess.astro";
import SectionFAQ from "../../components/SectionFAQ.astro";
import SectionCTA from "../../components/SectionCTA.astro";
import LinksOut from "../../components/LinksOut.astro";
import InternalLinks from "../../components/InternalLinks.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";

export async function getStaticPaths() {
  const svcs = services as any[];
  return svcs.map((s) => ({ params: { service: String(s.slug) } }));
}

const { service } = Astro.params;

const page = getStaticPageByUrl(`/${service}`);

const title = safeText(page?.metaTitle, `${service} | Horizon Conversion`);
const description = safeText(page?.metaDescription, "Méthode 3C : SEO local, Ads et CRO.");
const h1 = safeText(page?.h1, `Offre : ${service}`);

const linksOut = normalizeLinksOut(page?.linksOut);

const svc = (services as any[]).find((s) => String(s.slug) === String(service)) || null;

const benefits = Array.isArray(svc?.benefices) ? svc.benefices : [
  "Plus de demandes qualifiées (et moins de contacts inutiles)",
  "Une exécution structurée (pas du “one shot”)",
  "Des actions mesurées et expliquées simplement"
];

const deliverables = Array.isArray(svc?.livrables) ? svc.livrables : [
  "Audit + plan d’actions",
  "Mises à jour et optimisations mensuelles",
  "Suivi des demandes + reporting lisible"
];

const process = Array.isArray(svc?.process) ? svc.process : [
  "Audit & cadrage : objectifs, zones, services",
  "Mise en place des fondations",
  "Optimisations mensuelles + suivi"
];

// ✅ bloc “preuves / mesures” (option data-driven)
const mesures = Array.isArray(svc?.mesures) ? svc.mesures : [
  "Appels (clic tel) + formulaires",
  "Sources (SEO / Ads) et pages d’entrée",
  "Taux de conversion et qualité (hors zone/hors service)"
];

const preuves = Array.isArray(svc?.preuves) ? svc.preuves : [
  "Plan mensuel + priorités (ce qu’on fait et pourquoi)",
  "Journal d’actions (preuve d’exécution)",
  "Reporting lisible (ce qui génère des demandes)"
];

// ✅ FAQ: faqRefs prioritaire, fallback service.faq si vide
const faqItems = resolveFaqItems({
  pageFaqRefs: page?.faqRefs,
  pageFaq: page?.faq,
  serviceSlug: String(service)
});
const showFaq = Array.isArray(faqItems) && faqItems.length;

// Micro-copies adaptées service (évite le “clone”)
const proofTitle =
  service === "seo-local"
    ? "Ce qu’on mesure (SEO local) / Ce qu’on livre"
    : service === "ads-google-meta"
      ? "Ce qu’on mesure (Ads) / Ce qu’on livre"
      : "Ce qu’on mesure (CRO) / Ce qu’on livre";
---

<BaseLayout
  title={title}
  description={description}
  pageContext={{ type: "service", service }}
  faqItems={faqItems}
>
  <Breadcrumbs type="service" service={service} />

  <SectionHero
    h1={h1}
    intro="Vous voulez plus d’appels et de demandes qualifiés, sans dépendre du bouche-à-oreille ? On construit un système mesurable, piloté au mois."
    bullets={[
      "Objectif : demandes utiles (pas du trafic)",
      "Priorités claires + livrables mensuels",
      "Suivi simple : appels, formulaires, sources"
    ]}
  />

  {/* ✅ Bloc “preuve” pour hubs services */}
  <section style="padding:1rem 0">
    <div style="max-width:980px;margin:0 auto;padding:0 1rem">
      <div style="border:1px solid #e5e7eb;border-radius:12px;padding:1rem;background:#fff">
        <strong style="display:block;margin:0 0 .5rem">{proofTitle}</strong>

        <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:1rem">
          <div>
            <div style="font-weight:600;margin:0 0 .35rem">Ce qu’on mesure</div>
            <ul style="margin:0;padding-left:1.15rem;display:grid;gap:.35rem;color:#374151">
              {mesures.map((m: string) => <li>{m}</li>)}
            </ul>
          </div>

          <div>
            <div style="font-weight:600;margin:0 0 .35rem">Ce qu’on livre</div>
            <ul style="margin:0;padding-left:1.15rem;display:grid;gap:.35rem;color:#374151">
              {preuves.map((p: string) => <li>{p}</li>)}
            </ul>
          </div>
        </div>

        <p style="margin:.75rem 0 0;color:#6b7280;font-size:.95rem">
          Pas de promesse “magique”. On pilote par demandes et on ajuste chaque mois.
        </p>
      </div>
    </div>
  </section>

  <SectionBenefits items={benefits} />
  <SectionDeliverables items={deliverables} />
  <SectionProcess steps={process} />

  {showFaq ? <SectionFAQ items={faqItems} /> : null}

  <LinksOut links={linksOut} />
  <InternalLinks type="service" service={service} max={10} title="Pages locales à forte intention" />

  <SectionCTA />
</BaseLayout>