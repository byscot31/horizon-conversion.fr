---
// src/pages/blog/index.astro
import Head from "../../components/Head.astro";
import TopBar from "../../components/TopBar.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import JavaScripts from "../../components/JavaScripts.astro";
import { getCollection } from "astro:content";

const ASSET_BASE =
  (((import.meta as any).env?.PUBLIC_ASSET_BASE as string) || "/_assets_").replace(/\/$/, "");

const SITE =
  (import.meta as any).env?.PUBLIC_SITE_URL ||
  (Astro.site ? String(Astro.site) : "");

const canonical = SITE ? new URL(Astro.url.pathname, SITE).toString() : Astro.url.toString();

const seo = {
  title: "Blog Webmarketing local | Horizon Conversion",
  description:
    "Conseils SEO local, Google Ads, CRO et tracking pour artisans, cabinets et PME (Sud Oise & Nord 95).",
};

const contact = {
  phoneDisplay: "06 60 92 10 08",
  phoneHref: "+33660921008",
  email: "contact@horizon-conversion.fr",
  linkedin: "#",
  instagram: "#",
};

function postUrl(slug: string) {
  return `/blog/${slug}/`;
}

function pageHref(n: number) {
  return n <= 1 ? "/blog/" : `/blog/${n}/`;
}

function formatDate(d: Date) {
  return d.toLocaleDateString("fr-FR", { year: "numeric", month: "long", day: "numeric" });
}

// Règle : page 1 = 1 vedette + 9
const perPage = 9;

const allPosts = (await getCollection("blog"))
  .filter((p) => !p.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const featured = allPosts[0] ?? null;
const rest = featured ? allPosts.slice(1) : allPosts;

const totalPages = Math.max(1, Math.ceil(rest.length / perPage));

// page 1 = les 9 premiers de "rest"
const gridPosts = rest.slice(0, perPage);

const breadcrumb = [
  { label: "Accueil", href: "/" },
  { label: "Blog", href: "/blog/" },
];
---

<!doctype html>
<html dir="ltr" lang="fr-FR">
  <Head {seo} {canonical} ASSET_BASE={ASSET_BASE} />
  <body class="stretched">
    <div id="wrapper">
      <TopBar {contact} ASSET_BASE={ASSET_BASE} />
      <Header {contact} ASSET_BASE={ASSET_BASE} />

      <!-- Page Title -->
      <section class="page-title page-title-parallax parallax scroll-detect page-title-center dark include-header include-topbar">
        <img src={`${ASSET_BASE}/images/services/analysis-title.jpg`} class="parallax-bg" alt="Blog" />
        <div id="particles-line"></div>

        <div class="container">
          <div class="page-title-row">
            <div class="page-title-content">
              <div class="badge rounded-pill border border-light text-light">Ressources</div>
              <h1>Blog</h1>
              <p class="mt-3 mb-0 text-white-50" style="max-width: 920px; margin-inline:auto;">
                SEO local, Google Ads, CRO, tracking : des articles concrets pour générer plus de demandes.
              </p>
            </div>

            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                {breadcrumb.map((b, idx) => (
                  <li
                    class={`breadcrumb-item ${idx === breadcrumb.length - 1 ? "active" : ""}`}
                    aria-current={idx === breadcrumb.length - 1 ? "page" : undefined}
                  >
                    {idx === breadcrumb.length - 1 ? b.label : <a href={b.href}>{b.label}</a>}
                  </li>
                ))}
              </ol>
            </nav>
          </div>
        </div>

        <div class="video-overlay z-1" style="background-image: linear-gradient(to top, rgba(254,150,3,0.5), #39384D);"></div>
      </section>

      <section id="content">
        <div class="content-wrap">
          <div class="container">

            <!-- Vedette -->
            {featured && (
              <div class="card shadow-sm border-0 mb-5">
                <div class="row g-0 align-items-stretch">
                  <div class="col-lg-6">
                    <a href={postUrl(featured.slug)} style="display:block; height:100%;">
                      <img
                        src={(featured.data.cover as any)?.src ?? `${ASSET_BASE}/images/blog/1.jpg`}
                        alt={featured.data.title}
                        style="width:100%; height:100%; object-fit:cover;"
                      />
                    </a>
                  </div>
                  <div class="col-lg-6">
                    <div class="card-body p-5">
                      <div class="badge rounded-pill badge-default">À la une</div>
                      <h2 class="text-transform-none ls-0 mt-3 mb-2">
                        <a href={postUrl(featured.slug)} class="text-dark" style="text-decoration:none;">
                          {featured.data.title}
                        </a>
                      </h2>
                      <div class="text-muted small mb-3">
                        <i class="bi-calendar me-1"></i> {formatDate(featured.data.date)}
                      </div>
                      <p class="mb-4">{featured.data.description}</p>
                      <a href={postUrl(featured.slug)} class="button button-rounded text-transform-none ls-0 m-0">
                        Lire l’article
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            )}

            <!-- Grid 3 colonnes (9 posts) -->
            <div class="row">
              {gridPosts.map((p) => (
                <div class="col-md-4 mb-4">
                  <article class="entry">
                    <div class="entry-image mb-3">
                      <a href={postUrl(p.slug)}>
                        <img
                          src={(p.data.cover as any)?.src ?? `${ASSET_BASE}/images/blog/1.jpg`}
                          alt={p.data.title}
                        />
                      </a>
                    </div>

                    <div class="entry-title">
                      <h3 class="text-transform-none ls-0">
                        <a href={postUrl(p.slug)}>{p.data.title}</a>
                      </h3>
                    </div>

                    <div class="entry-meta">
                      <ul>
                        <li><i class="bi-person"></i><a href="#"> Horizon Conversion</a></li>
                        <li><i class="bi-calendar"></i><a href="#">{formatDate(p.data.date)}</a></li>
                      </ul>
                    </div>

                    <div class="entry-content">
                      <p>{p.data.description}</p>
                      <a href={postUrl(p.slug)} class="more-link"><u>Lire l’article</u></a>
                    </div>
                  </article>
                </div>
              ))}
            </div>

            <!-- Pagination -->
            {totalPages > 1 && (
              <nav aria-label="Pagination blog" class="mt-4">
                <ul class="pagination justify-content-center">

                  <li class="page-item disabled">
                    <a class="page-link" href="#" aria-disabled="true" tabindex="-1">&laquo;</a>
                  </li>

                  {Array.from({ length: totalPages }).map((_, i) => {
                    const n = i + 1;
                    return (
                      <li class={`page-item ${n === 1 ? "active" : ""}`}>
                        <a class="page-link" href={pageHref(n)}>{n}</a>
                      </li>
                    );
                  })}

                  <li class={`page-item ${totalPages <= 1 ? "disabled" : ""}`}>
                    <a class="page-link" href={pageHref(2)} aria-label="Suivant">
                      &raquo;
                    </a>
                  </li>

                </ul>
              </nav>
            )}

          </div>
        </div>
      </section>

      <Footer {contact} ASSET_BASE={ASSET_BASE} />
    </div>

    <div id="gotoTop" class="uil uil-angle-up"></div>
    <JavaScripts ASSET_BASE={ASSET_BASE} />
    <script is:inline src={`${ASSET_BASE}/js/particles/particles.min.js`}></script>
    <script is:inline src={`${ASSET_BASE}/js/particles/particles-line.js`}></script>
  </body>
</html>