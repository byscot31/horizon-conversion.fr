---
// src/pages/blog/[page].astro
import Head from "../../components/Head.astro";
import TopBar from "../../components/TopBar.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import JavaScripts from "../../components/JavaScripts.astro";
import { getCollection } from "astro:content";

const ASSET_BASE =
  (((import.meta as any).env?.PUBLIC_ASSET_BASE as string) || "/_assets_").replace(/\/$/, "");

const SITE =
  (import.meta as any).env?.PUBLIC_SITE_URL ||
  (Astro.site ? String(Astro.site) : "");

const canonical = SITE ? new URL(Astro.url.pathname, SITE).toString() : Astro.url.toString();

const seo = {
  title: "Blog Webmarketing local | Horizon Conversion",
  description:
    "Conseils SEO local, Google Ads, CRO et tracking pour artisans, cabinets et PME (Sud Oise & Nord 95).",
};

const contact = {
  phoneDisplay: "06 60 92 10 08",
  phoneHref: "+33660921008",
  email: "contact@horizon-conversion.fr",
  linkedin: "#",
  instagram: "#",
};

function postUrl(slug: string) {
  return `/blog/${slug}/`;
}

function pageUrl(n: number) {
  return n === 1 ? "/blog/" : `/blog/${n}/`;
}

function formatDate(d: Date) {
  return d.toLocaleDateString("fr-FR", { year: "numeric", month: "long", day: "numeric" });
}

export async function getStaticPaths() {
  const PER_PAGE = 9;

  const allPosts = (await getCollection("blog"))
    .filter((p) => !p.data.draft)
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

  const featured = allPosts[0] ?? null;
  const rest = featured ? allPosts.slice(1) : allPosts;

  const totalPages = Math.max(1, Math.ceil(rest.length / PER_PAGE));

  const pages = Array.from({ length: totalPages }, (_, i) => i + 1).filter((n) => n >= 2);

  return pages.map((n) => ({ params: { page: String(n) } }));
}

// --- DATA ---
const allPosts = (await getCollection("blog"))
  .filter((p) => !p.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const featured = allPosts[0] ?? null;
const rest = featured ? allPosts.slice(1) : allPosts;

const totalPages = Math.max(1, Math.ceil(rest.length / PER_PAGE));

const currentPage = Math.min(Math.max(Number(Astro.params.page ?? "2"), 2), totalPages);

const start = (currentPage - 1) * PER_PAGE;
const end = start + PER_PAGE;
const gridPosts = rest.slice(start, end);

const breadcrumb = [
  { label: "Accueil", href: "/" },
  { label: "Blog", href: "/blog/" },
];
---

<!doctype html>
<html dir="ltr" lang="fr-FR">
  <Head {seo} {canonical} ASSET_BASE={ASSET_BASE} />
  <body class="stretched">
    <div id="wrapper">
      <TopBar {contact} ASSET_BASE={ASSET_BASE} />
      <Header {contact} ASSET_BASE={ASSET_BASE} />

      <section class="page-title page-title-parallax parallax scroll-detect page-title-center dark include-header include-topbar">
        <img src={`${ASSET_BASE}/images/services/analysis-title.jpg`} class="parallax-bg" alt="Blog" />
        <div id="particles-line"></div>

        <div class="container">
          <div class="page-title-row">
            <div class="page-title-content">
              <div class="badge rounded-pill border border-light text-light">Ressources</div>
              <h1>Blog</h1>
              <p class="mt-3 mb-0 text-white-50" style="max-width: 920px; margin-inline:auto;">
                SEO local, Google Ads, CRO, tracking : des articles concrets pour générer plus de demandes.
              </p>
            </div>

            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                {breadcrumb.map((b, idx) => (
                  <li
                    class={`breadcrumb-item ${idx === breadcrumb.length - 1 ? "active" : ""}`}
                    aria-current={idx === breadcrumb.length - 1 ? "page" : undefined}
                  >
                    {idx === breadcrumb.length - 1 ? b.label : <a href={b.href}>{b.label}</a>}
                  </li>
                ))}
              </ol>
            </nav>
          </div>
        </div>

        <div class="video-overlay z-1" style="background-image: linear-gradient(to top, rgba(254,150,3,0.5), #39384D);"></div>
      </section>

      <section id="content">
        <div class="content-wrap">
          <div class="container">

            <div class="row">
              {gridPosts.map((p) => (
                <div class="col-md-4 mb-4">
                  <article class="entry">
                    <div class="entry-image mb-3">
                      <a href={postUrl(p.slug)}>
                        <img
                          src={(p.data.cover as any)?.src ?? `${ASSET_BASE}/images/blog/1.jpg`}
                          alt={p.data.title}
                        />
                      </a>
                    </div>

                    <div class="entry-title">
                      <h3 class="text-transform-none ls-0">
                        <a href={postUrl(p.slug)}>{p.data.title}</a>
                      </h3>
                    </div>

                    <div class="entry-meta">
                      <ul>
                        <li><i class="bi-person"></i><a href="#"> Horizon Conversion</a></li>
                        <li><i class="bi-calendar"></i><a href="#">{formatDate(p.data.date)}</a></li>
                      </ul>
                    </div>

                    <div class="entry-content">
                      <p>{p.data.description}</p>
                      <a href={postUrl(p.slug)} class="more-link"><u>Lire l’article</u></a>
                    </div>
                  </article>
                </div>
              ))}
            </div>

            <nav aria-label="Pagination blog" class="mt-4">
              <ul class="pagination justify-content-center">
                <li class={`page-item ${currentPage <= 1 ? "disabled" : ""}`}>
                  <a class="page-link" href={pageUrl(currentPage - 1)} aria-label="Précédent">&laquo;</a>
                </li>

                {Array.from({ length: totalPages }).map((_, i) => {
                  const n = i + 1;
                  return (
                    <li class={`page-item ${n === currentPage ? "active" : ""}`}>
                      <a class="page-link" href={pageUrl(n)}>{n}</a>
                    </li>
                  );
                })}

                <li class={`page-item ${currentPage >= totalPages ? "disabled" : ""}`}>
                  <a class="page-link" href={pageUrl(currentPage + 1)} aria-label="Suivant">&raquo;</a>
                </li>
              </ul>
            </nav>

          </div>
        </div>
      </section>

      <Footer {contact} ASSET_BASE={ASSET_BASE} />
    </div>

    <div id="gotoTop" class="uil uil-angle-up"></div>
    <JavaScripts ASSET_BASE={ASSET_BASE} />
    <script is:inline src={`${ASSET_BASE}/js/particles/particles.min.js`}></script>
    <script is:inline src={`${ASSET_BASE}/js/particles/particles-line.js`}></script>
  </body>
</html>