---
// src/pages/blog/tag/index.astro
import Head from "../../../components/Head.astro";
import TopBar from "../../../components/TopBar.astro";
import Header from "../../../components/Header.astro";
import Footer from "../../../components/Footer.astro";
import JavaScripts from "../../../components/JavaScripts.astro";
import { getCollection } from "astro:content";

const ASSET_BASE =
  (((import.meta as any).env?.PUBLIC_ASSET_BASE as string) || "/_assets_").replace(/\/$/, "");

const SITE =
  (import.meta as any).env?.PUBLIC_SITE_URL ||
  (Astro.site ? String(Astro.site) : "");

const canonical = SITE ? new URL(Astro.url.pathname, SITE).toString() : Astro.url.toString();

const seo = {
  title: "Tags du blog | Horizon Conversion",
  description: "Parcourez les articles par thématique : SEO local, Google Ads, CRO, tracking, etc.",
};

const contact = {
  phoneDisplay: "06 60 92 10 08",
  phoneHref: "+33660921008",
  email: "contact@horizon-conversion.fr",
  linkedin: "#",
  instagram: "#",
};

function slugifyTag(tag: string) {
  return tag.trim().toLowerCase().replace(/\s+/g, "-");
}

function formatDate(d: Date) {
  return d.toLocaleDateString("fr-FR", { year: "numeric", month: "long", day: "numeric" });
}

const posts = (await getCollection("blog"))
  .filter((p) => !p.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const tagCount = new Map<string, number>();
for (const p of posts) {
  for (const t of p.data.tags ?? []) {
    const key = t.trim();
    if (!key) continue;
    tagCount.set(key, (tagCount.get(key) ?? 0) + 1);
  }
}

const tags = Array.from(tagCount.entries())
  .map(([name, count]) => ({ name, count, slug: slugifyTag(name) }))
  .sort((a, b) => b.count - a.count || a.name.localeCompare(b.name, "fr"));

const latest = posts.slice(0, 6);

const breadcrumb = [
  { label: "Accueil", href: "/" },
  { label: "Blog", href: "/blog/" },
  { label: "Tags", href: "/blog/tag/" },
];
---

<!doctype html>
<html dir="ltr" lang="fr-FR">
  <Head {seo} {canonical} ASSET_BASE={ASSET_BASE} />
  <body class="stretched">
    <div id="wrapper">
      <TopBar {contact} ASSET_BASE={ASSET_BASE} />
      <Header {contact} ASSET_BASE={ASSET_BASE} />

      <section class="page-title page-title-parallax parallax scroll-detect page-title-center dark include-header include-topbar">
        <img src={`${ASSET_BASE}/images/services/analysis-title.jpg`} class="parallax-bg" alt="Tags" />
        <div id="particles-line"></div>
        <div class="container">
          <div class="page-title-row">
            <div class="page-title-content">
              <div class="badge rounded-pill border border-light text-light">Blog</div>
              <h1>Tags</h1>
              <p class="mt-3 mb-0 text-white-50" style="max-width: 900px; margin-inline: auto;">
                Parcourez les articles par thématique (SEO local, Google Ads, CRO, tracking…).
              </p>
            </div>

            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                {breadcrumb.map((b, idx) => (
                  <li class={`breadcrumb-item ${idx === breadcrumb.length - 1 ? "active" : ""}`}>
                    {idx === breadcrumb.length - 1 ? b.label : <a href={b.href}>{b.label}</a>}
                  </li>
                ))}
              </ol>
            </nav>
          </div>
        </div>
        <div class="video-overlay z-1" style="background-image: linear-gradient(to top, rgba(254,150,3,0.5), #39384D);"></div>
      </section>

      <section id="content">
        <div class="content-wrap pb-0">
          <div class="container">

            <div class="row col-mb-50">

              <div class="col-lg-8">
                <div class="heading-block border-bottom-0 mb-3">
                  <div class="badge rounded-pill badge-default">Thématiques</div>
                  <h2 class="h3 text-transform-none ls-0 mb-0">Tous les tags</h2>
                </div>

                <div class="row g-3">
                  {tags.length ? (
                    tags.map((t) => (
                      <div class="col-6 col-md-4">
                        <a href={`/blog/tag/${t.slug}/1/`} class="card h-bg-light border-0 shadow-sm" style="text-decoration:none;">
                          <div class="card-body py-3">
                            <div class="d-flex align-items-center justify-content-between">
                              <strong class="text-dark">{t.name}</strong>
                              <span class="badge bg-dark">{t.count}</span>
                            </div>
                          </div>
                        </a>
                      </div>
                    ))
                  ) : (
                    <p class="text-muted mb-0">Aucun tag pour le moment.</p>
                  )}
                </div>
              </div>

              <div class="col-lg-4">
                <div class="card shadow-sm border-0">
                  <div class="card-body p-4">
                    <div class="badge rounded-pill badge-default">À lire</div>
                    <h3 class="h5 text-transform-none ls-0 mt-2">Derniers articles</h3>
                    <div class="line line-sm my-3"></div>

                    <ul class="list-unstyled mb-0">
                      {latest.map((p) => (
                        <li class="mb-3">
                          <a class="text-dark" href={`/blog/${p.slug}/`} style="text-decoration:none;">
                            <strong class="d-block">{p.data.title}</strong>
                            <small class="text-muted">{formatDate(p.data.date)}</small>
                          </a>
                        </li>
                      ))}
                    </ul>

                    <div class="line line-sm my-4"></div>

                    <a href="/blog/1/" class="button button-rounded w-100 text-transform-none ls-0 m-0">
                      Voir le blog
                    </a>
                  </div>
                </div>
              </div>

            </div>

          </div>
        </div>
      </section>

      <Footer {contact} ASSET_BASE={ASSET_BASE} />
    </div>

    <div id="gotoTop" class="uil uil-angle-up"></div>
    <JavaScripts ASSET_BASE={ASSET_BASE} />
    <script is:inline src={`${ASSET_BASE}/js/particles/particles.min.js`}></script>
    <script is:inline src={`${ASSET_BASE}/js/particles/particles-line.js`}></script>
  </body>
</html>