---
// src/pages/blog/tag/[tag]/[page].astro
import Head from "../../../../../components/Head.astro";
import TopBar from "../../../../../components/TopBar.astro";
import Header from "../../../../../components/Header.astro";
import Sidebar from "../../../../../components/blog/Sidebar.astro";
import Footer from "../../../../../components/Footer.astro";
import JavaScripts from "../../../../../components/JavaScripts.astro";

import { getCollection } from "astro:content";

const ASSET_BASE =
  (((import.meta as any).env?.PUBLIC_ASSET_BASE as string) || "/_assets_").replace(/\/$/, "");

const SITE =
  (import.meta as any).env?.PUBLIC_SITE_URL ||
  (Astro.site ? String(Astro.site) : "");

const canonical = SITE ? new URL(Astro.url.pathname, SITE).toString() : Astro.url.toString();

const contact = {
  phoneDisplay: "06 60 92 10 08",
  phoneHref: "+33660921008",
  email: "contact@horizon-conversion.fr",
  linkedin: "#",
  instagram: "#",
};

const perPage = 10;

function formatDate(d: Date) {
  return d.toLocaleDateString("fr-FR", { year: "numeric", month: "long", day: "numeric" });
}

function postUrl(slug: string) {
  return `/blog/${slug}/`;
}

function tagHref(tag: string, page = 1) {
  return page <= 1
    ? `/blog/tag/${encodeURIComponent(tag)}/`
    : `/blog/tag/${encodeURIComponent(tag)}/${page}/`;
}

export async function getStaticPaths() {
  const posts = (await getCollection("blog"))
    .filter((p) => !p.data.draft)
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

  const tags = Array.from(new Set(posts.flatMap((p) => p.data.tags ?? [])));

  const paths: { params: { tag: string; page: string } }[] = [];

  for (const t of tags) {
    const list = posts.filter((p) => (p.data.tags ?? []).includes(t));
    const totalPages = Math.max(1, Math.ceil(list.length / perPage));

    // page 1 = index.astro, ici on génère 2..N
    for (let page = 2; page <= totalPages; page++) {
      paths.push({ params: { tag: encodeURIComponent(t), page: String(page) } });
    }
  }

  return paths;
}

const tagParam = Astro.params.tag ?? "";
const tag = decodeURIComponent(tagParam);

const pageRaw = Number(Astro.params.page || "2");
const currentPage = Number.isFinite(pageRaw) ? Math.max(2, pageRaw) : 2;

const all = (await getCollection("blog"))
  .filter((p) => !p.data.draft)
  .filter((p) => (p.data.tags ?? []).includes(tag))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const totalPages = Math.max(1, Math.ceil(all.length / perPage));

const safePage = Math.min(currentPage, totalPages);

const start = (safePage - 1) * perPage;
const end = start + perPage;
const gridPosts = all.slice(start, end);

const seo = {
  title: `Tag : ${tag} (page ${safePage}) | Blog Horizon Conversion`,
  description: `Articles liés au tag "${tag}" — page ${safePage}.`,
};

const breadcrumb = [
  { label: "Accueil", href: "/" },
  { label: "Blog", href: "/blog/" },
  { label: tag, href: tagHref(tag, 1) },
  { label: `Page ${safePage}`, href: tagHref(tag, safePage) },
];
---

<!doctype html>
<html dir="ltr" lang="fr-FR">
  <Head {seo} {canonical} ASSET_BASE={ASSET_BASE} />
  <body class="stretched">
    <div id="wrapper">
      <TopBar {contact} ASSET_BASE={ASSET_BASE} />
      <Header {contact} ASSET_BASE={ASSET_BASE} />

      <!-- Page Title -->
      <section class="page-title page-title-parallax parallax scroll-detect page-title-center dark include-header include-topbar">
        <img src={`${ASSET_BASE}/images/services/analysis-title.jpg`} class="parallax-bg" alt={`Tag ${tag}`} />
        <div id="particles-line"></div>

        <div class="container">
          <div class="page-title-row">
            <div class="page-title-content">
              <div class="badge rounded-pill border border-light text-light">Tag</div>
              <h1>{tag} — Page {safePage}</h1>
              <p class="mt-3 mb-0 text-white-50" style="max-width: 920px; margin-inline:auto;">
                Articles liés à <strong>{tag}</strong>.
              </p>
            </div>

            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                {breadcrumb.map((b, idx) => (
                  <li
                    class={`breadcrumb-item ${idx === breadcrumb.length - 1 ? "active" : ""}`}
                    aria-current={idx === breadcrumb.length - 1 ? "page" : undefined}
                  >
                    {idx === breadcrumb.length - 1 ? b.label : <a href={b.href}>{b.label}</a>}
                  </li>
                ))}
              </ol>
            </nav>
          </div>
        </div>

        <div class="video-overlay z-1" style="background-image: linear-gradient(to top, rgba(254,150,3,0.5), #39384D);"></div>
      </section>

      <section id="content">
        <div class="content-wrap">
          <div class="container">
            <div class="row">

              <!-- Main -->
              <div class="col-lg-8">
                <div class="row">
                  {gridPosts.map((p) => (
                    <div class="col-md-6 mb-4">
                      <article class="entry">
                        <div class="entry-image mb-3">
                          <a href={postUrl(p.slug)}>
                            <img
                              src={(p.data.cover as any)?.src ?? `${ASSET_BASE}/images/blog/1.jpg`}
                              alt={p.data.title}
                            />
                          </a>
                        </div>

                        <div class="entry-title">
                          <h3 class="text-transform-none ls-0">
                            <a href={postUrl(p.slug)}>{p.data.title}</a>
                          </h3>
                        </div>

                        <div class="entry-meta">
                          <ul>
                            <li><i class="bi-person"></i><a href="#"> Horizon Conversion</a></li>
                            <li><i class="bi-calendar"></i><a href="#">{formatDate(p.data.date)}</a></li>
                          </ul>
                        </div>

                        <div class="entry-content">
                          <p>{p.data.description}</p>
                          <a href={postUrl(p.slug)} class="more-link"><u>Lire l’article</u></a>
                        </div>
                      </article>
                    </div>
                  ))}
                </div>

                {/* Pagination */}
                {totalPages > 1 && (
                  <nav aria-label="Pagination tag" class="mt-4">
                    <ul class="pagination justify-content-center">

                      <li class={`page-item ${safePage <= 1 ? "disabled" : ""}`}>
                        <a class="page-link" href={tagHref(tag, Math.max(1, safePage - 1))} aria-label="Précédent">&laquo;</a>
                      </li>

                      {Array.from({ length: totalPages }).map((_, i) => {
                        const n = i + 1;
                        return (
                          <li class={`page-item ${n === safePage ? "active" : ""}`}>
                            <a class="page-link" href={tagHref(tag, n)}>{n}</a>
                          </li>
                        );
                      })}

                      <li class={`page-item ${safePage >= totalPages ? "disabled" : ""}`}>
                        <a class="page-link" href={tagHref(tag, safePage + 1)} aria-label="Suivant">&raquo;</a>
                      </li>

                    </ul>
                  </nav>
                )}
              </div>

              <!-- Sidebar -->
              <div class="col-lg-4">
                <Sidebar ASSET_BASE={ASSET_BASE} />
              </div>

            </div>
          </div>
        </div>
      </section>

      <Footer {contact} ASSET_BASE={ASSET_BASE} />
    </div>

    <div id="gotoTop" class="uil uil-angle-up"></div>
    <JavaScripts ASSET_BASE={ASSET_BASE} />
    <script is:inline src={`${ASSET_BASE}/js/particles/particles.min.js`}></script>
    <script is:inline src={`${ASSET_BASE}/js/particles/particles-line.js`}></script>
  </body>
</html>