---
// src/pages/blog/[slug].astro
import Head from "../../components/Head.astro";
import TopBar from "../../components/TopBar.astro";
import Header from "../../components/Header.astro";
import Sidebar from "../../components/blog/Sidebar.astro";
import Footer from "../../components/Footer.astro";
import JavaScripts from "../../components/JavaScripts.astro";

import { getCollection, getEntryBySlug } from "astro:content";

const ASSET_BASE =
  (((import.meta as any).env?.PUBLIC_ASSET_BASE as string) || "/_assets_").replace(/\/$/, "");

const SITE =
  (import.meta as any).env?.PUBLIC_SITE_URL ||
  (Astro.site ? String(Astro.site) : "");

const canonical = SITE
  ? new URL(Astro.url.pathname, SITE).toString()
  : Astro.url.toString();

export async function getStaticPaths() {
  const posts = await getCollection("blog", ({ data }) => !data.draft);
  return posts.map((p) => ({ params: { slug: p.slug } }));
}

const { slug } = Astro.params;
const post = await getEntryBySlug("blog", slug!);
if (!post || post.data.draft) throw new Error("Post introuvable");

const contact = {
  phoneDisplay: "06 60 92 10 08",
  phoneHref: "+33660921008",
  email: "contact@horizon-conversion.fr",
  linkedin: "#",
  instagram: "#",
};

function formatDate(d: Date) {
  return d.toLocaleDateString("fr-FR", { year: "numeric", month: "long", day: "numeric" });
}

function slugifyTag(tag: string) {
  return tag.trim().toLowerCase().replace(/\s+/g, "-");
}

// Partage
const shareUrl = canonical;
const shareText = encodeURIComponent(post.data.title);

// Posts similaires (tags)
const allPosts = (await getCollection("blog"))
  .filter((p) => !p.data.draft && p.slug !== post.slug)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const tags = post.data.tags ?? [];

const similar = allPosts
  .map((p) => {
    const t = p.data.tags ?? [];
    const score = t.filter((x) => tags.includes(x)).length;
    return { p, score };
  })
  .filter((x) => x.score > 0)
  .sort((a, b) => b.score - a.score || b.p.data.date.valueOf() - a.p.data.date.valueOf())
  .slice(0, 3)
  .map((x) => x.p);

// Sidebar: Blogroll (le composant gère aussi Populaires + Tag cloud)
const blogroll = [
  { label: "SEO local", href: "/services/seo-local/" },
  { label: "Google Ads", href: "/services/google-ads/" },
  { label: "CRO", href: "/services/cro/" },
  { label: "Tracking", href: "/services/analytics/" },
  { label: "Zones", href: "/zones/" },
];

const seo = {
  title: `${post.data.title} | Horizon Conversion`,
  description: post.data.description,
};

const breadcrumb = [
  { label: "Accueil", href: "/" },
  { label: "Blog", href: "/blog/" },
  { label: post.data.title, href: `/blog/${post.slug}/` },
];

const { Content } = await post.render();

// Image cover (compat Astro image() + string fallback)
const coverSrc =
  (post.data.cover as any)?.src ||
  (typeof post.data.cover === "string" ? post.data.cover : null) ||
  `${ASSET_BASE}/images/blog/1.jpg`;
---

<!doctype html>
<html dir="ltr" lang="fr-FR">
  <Head {seo} {canonical} ASSET_BASE={ASSET_BASE} />
  <body class="stretched">
    <div id="wrapper">
      <TopBar {contact} ASSET_BASE={ASSET_BASE} />
      <Header {contact} ASSET_BASE={ASSET_BASE} />

      <!-- Page Title -->
      <section class="page-title page-title-parallax parallax scroll-detect page-title-center dark include-header include-topbar">
        <img src={`${ASSET_BASE}/images/services/analysis-title.jpg`} class="parallax-bg" alt={post.data.title} />
        <div id="particles-line"></div>

        <div class="container">
          <div class="page-title-row">
            <div class="page-title-content">
              <div class="badge rounded-pill border border-light text-light">Article</div>
              <h1>{post.data.title}</h1>
              <p class="mt-3 mb-0 text-white-50" style="max-width: 920px; margin-inline:auto;">
                {post.data.description}
              </p>
            </div>

            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                {breadcrumb.map((b, idx) => (
                  <li
                    class={`breadcrumb-item ${idx === breadcrumb.length - 1 ? "active" : ""}`}
                    aria-current={idx === breadcrumb.length - 1 ? "page" : undefined}
                  >
                    {idx === breadcrumb.length - 1 ? b.label : <a href={b.href}>{b.label}</a>}
                  </li>
                ))}
              </ol>
            </nav>
          </div>
        </div>

        <div class="video-overlay z-1" style="background-image: linear-gradient(to top, rgba(254,150,3,0.5), #39384D);"></div>
      </section>

      <section id="content">
        <div class="content-wrap">
          <div class="container">
            <div class="row col-mb-50">

              <!-- Main -->
              <div class="postcontent col-lg-8">

                <!-- Cover -->
                <div class="mb-4">
                  <img
                    src={coverSrc}
                    alt={post.data.title}
                    class="rounded"
                    style="width:100%; height:auto;"
                  />
                </div>

                <!-- Entry Meta -->
                <div class="entry-meta mb-3">
                  <ul>
                    <li><i class="bi-person"></i><a href="#"> Horizon Conversion</a></li>
                    <li><i class="bi-calendar"></i><a href="#">{formatDate(post.data.date)}</a></li>

                    {tags.length > 0 ? (
                      <li>
                        <i class="bi-tags"></i>
                        {tags.map((t) => (
                          <a href={`/blog/tag/${slugifyTag(t)}/1/`} class="ms-1">{t}</a>
                        ))}
                      </li>
                    ) : null}
                  </ul>
                </div>

                <!-- Content -->
                <article class="entry mb-5">
                  <div class="entry-content">
                    <Content />
                  </div>
                </article>

                <!-- Share -->
                <div class="card shadow-sm border-0 mb-5">
                  <div class="card-body p-4 d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
                    <div>
                      <div class="badge rounded-pill badge-default">Partager</div>
                      <h3 class="h5 text-transform-none ls-0 mb-0">Vous avez trouvé ça utile ?</h3>
                      <small class="text-muted">Partagez l’article à quelqu’un que ça peut aider.</small>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                      <a
                        class="button button-rounded button-light text-dark bg-white border m-0"
                        target="_blank"
                        rel="noopener"
                        href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(shareUrl)}`}
                      >
                        LinkedIn
                      </a>
                      <a
                        class="button button-rounded button-light text-dark bg-white border m-0"
                        target="_blank"
                        rel="noopener"
                        href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}&text=${shareText}`}
                      >
                        X
                      </a>
                      <a
                        class="button button-rounded m-0"
                        href={`/contact/?message=${encodeURIComponent("Bonjour, je souhaite un audit suite à la lecture de : " + post.data.title)}`}
                      >
                        Demander un audit
                      </a>
                    </div>
                  </div>
                </div>

                <!-- Similar posts -->
                {similar.length > 0 ? (
                  <div class="mb-5">
                    <div class="heading-block border-bottom-0 mb-3">
                      <div class="badge rounded-pill badge-default">À lire aussi</div>
                      <h3 class="text-transform-none ls-0 mb-0">Articles similaires</h3>
                    </div>

                    <div class="row">
                      {similar.map((p) => {
                        const simCover =
                          (p.data.cover as any)?.src ||
                          (typeof p.data.cover === "string" ? p.data.cover : null) ||
                          `${ASSET_BASE}/images/blog/1.jpg`;

                        return (
                          <div class="col-md-4 mb-4">
                            <article class="entry">
                              <div class="entry-image mb-3">
                                <a href={`/blog/${p.slug}/`}>
                                  <img src={simCover} alt={p.data.title} />
                                </a>
                              </div>
                              <div class="entry-title">
                                <h3 class="h5 text-transform-none ls-0">
                                  <a href={`/blog/${p.slug}/`}>{p.data.title}</a>
                                </h3>
                              </div>
                              <div class="entry-content">
                                <p class="mb-2">{p.data.description}</p>
                                <a class="more-link" href={`/blog/${p.slug}/`}><u>Lire</u></a>
                              </div>
                            </article>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ) : null}

              </div>

              <!-- Sidebar -->
              <div class="col-lg-4">
                <Sidebar ASSET_BASE={ASSET_BASE} currentSlug={post.slug} />
              </div>

            </div>
          </div>
        </div>
      </section>

      <Footer {contact} ASSET_BASE={ASSET_BASE} />
    </div>

    <div id="gotoTop" class="uil uil-angle-up"></div>
    <JavaScripts ASSET_BASE={ASSET_BASE} />
    <script is:inline src={`${ASSET_BASE}/js/particles/particles.min.js`}></script>
    <script is:inline src={`${ASSET_BASE}/js/particles/particles-line.js`}></script>
  </body>
</html>