---
// src/pages/zones/[zone]/index.astro

import BaseLayout from "../../../layouts/BaseLayout.astro";
import zones from "../../../data/zones.json";

import { getStaticPageByUrl, normalizeLinksOut, resolveFaqItems, safeText } from "../../../lib/mapping";

import SectionHero from "../../../components/SectionHero.astro";
import SectionBenefits from "../../../components/SectionBenefits.astro";
import SectionDeliverables from "../../../components/SectionDeliverables.astro";
import SectionProcess from "../../../components/SectionProcess.astro";
import SectionFAQ from "../../../components/SectionFAQ.astro";
import SectionCTA from "../../../components/SectionCTA.astro";
import LinksOut from "../../../components/LinksOut.astro";
import InternalLinks from "../../../components/InternalLinks.astro";
import Breadcrumbs from "../../../components/Breadcrumbs.astro";

export async function getStaticPaths() {
  return (zones as any[]).map((z) => ({ params: { zone: String(z.slug) } }));
}

const { zone } = Astro.params;

const page = getStaticPageByUrl(`/zones/${zone}`);
const zObj = (zones as any[]).find((z) => String(z.slug) === String(zone)) || null;

const title = safeText(page?.metaTitle, `${safeText(zObj?.nom, zone)} | Horizon Conversion`);
const description = safeText(page?.metaDescription, safeText(zObj?.specificites, "SEO local, Ads et CRO en local."));
const h1 = safeText(page?.h1, `${safeText(zObj?.nom, zone)} : générer des demandes qualifiées`);

const linksOut = normalizeLinksOut(page?.linksOut);

const benefits = [
  "Visibilité + conversion : pas juste être “présent”",
  "Pages locales utiles, pensées pour l’intention",
  "Filtrage des demandes : zones, types, délais"
];

const deliverables = [
  "Plan d’actions mensuel (priorités)",
  "Exécution SEO/Ads/CRO",
  "Suivi appels & formulaires"
];

const process = [
  "Audit gratuit et cadrage",
  "Fondations + quick wins",
  "Optimisations mensuelles"
];

// ✅ FAQ: faqRefs
const faqItems = resolveFaqItems({ pageFaqRefs: page?.faqRefs, pageFaq: page?.faq });
const showFaq = Array.isArray(faqItems) && faqItems.length;

const heroIntro = safeText(zObj?.specificites, "On adapte les priorités à la concurrence locale et au type de demandes attendues.");
---

<BaseLayout
  title={title}
  description={description}
  pageContext={{ type: "zone", zone }}
  faqItems={faqItems}
>
  <Breadcrumbs type="zone" zone={zone} />

  <SectionHero
    h1={h1}
    intro={heroIntro}
    bullets={[
      "Interlocuteur unique + exécution d’agence",
      "Priorités claires et suivi mensuel",
      "Objectif : demandes qualifiées"
    ]}
  />

  <SectionBenefits items={benefits} />
  <SectionDeliverables items={deliverables} />
  <SectionProcess steps={process} />

  {showFaq ? <SectionFAQ items={faqItems} /> : null}
  <LinksOut links={linksOut} />

  <InternalLinks type="zone" zone={zone} max={10} title="Villes de la zone + services" />

  <SectionCTA />
</BaseLayout>