---
// src/pages/zones/[zone]/[ville]/[cible]/index.astro
import BaseLayout from "../../../../../layouts/BaseLayout.astro";
import PageTitle from "../../../../../components/PageTitle.astro";

import zonesData from "../../../../../data/zones.json";
import villesData from "../../../../../data/villes.json";
import ciblesData from "../../../../../data/cibles.json";

/** ✅ getStaticPaths requis pour /zones/[zone]/[ville]/[cible]/ */
export async function getStaticPaths() {
  // --- zones.json : attend { zones: { ... } }
  const zonesRoot =
    zonesData && typeof zonesData === "object" && !Array.isArray(zonesData)
      ? zonesData
      : null;

  if (!zonesRoot) {
    throw new Error(`[zones/[zone]/[ville]/[cible]] zones.json invalide (objet attendu)`);
  }

  const zonesObj =
    zonesRoot.zones && typeof zonesRoot.zones === "object" && !Array.isArray(zonesRoot.zones)
      ? zonesRoot.zones
      : null;

  if (!zonesObj) {
    throw new Error(`[zones/[zone]/[ville]/[cible]] zones.json.zones manquant (objet attendu)`);
  }

  const zoneSlugs = Object.values(zonesObj)
    .filter((z) => z && typeof z === "object" && !Array.isArray(z))
    .map((z) => (typeof z.slug === "string" ? z.slug.trim() : ""))
    .filter(Boolean);

  if (zoneSlugs.length === 0) {
    throw new Error(`[zones/[zone]/[ville]/[cible]] aucune zone trouvée dans zones.json.zones (slug requis)`);
  }

  // --- villes.json : attend entries (hors _meta) avec { slug, zoneSlug }
  const villesRoot =
    villesData && typeof villesData === "object" && !Array.isArray(villesData)
      ? villesData
      : null;

  if (!villesRoot) {
    throw new Error(`[zones/[zone]/[ville]/[cible]] villes.json invalide (objet attendu)`);
  }

  const cities = Object.entries(villesRoot)
    .filter(([k, v]) => k !== "_meta" && v && typeof v === "object" && !Array.isArray(v))
    .map(([_, v]) => v)
    .filter(
      (c) =>
        typeof c.slug === "string" &&
        c.slug.trim() &&
        typeof c.zoneSlug === "string" &&
        c.zoneSlug.trim()
    )
    // on garde uniquement les villes dont la zone existe
    .filter((c) => zoneSlugs.includes(String(c.zoneSlug).trim()));

  if (cities.length === 0) {
    throw new Error(
      `[zones/[zone]/[ville]/[cible]] aucune ville valide trouvée (slug + zoneSlug requis et zoneSlug doit exister dans zones.json)`
    );
  }

  // --- cibles.json : attend entries (hors _meta) avec { slug }
  const ciblesRoot =
    ciblesData && typeof ciblesData === "object" && !Array.isArray(ciblesData)
      ? ciblesData
      : null;

  if (!ciblesRoot) {
    throw new Error(`[zones/[zone]/[ville]/[cible]] cibles.json invalide (objet attendu)`);
  }

  const cibles = Object.entries(ciblesRoot)
    .filter(([k, v]) => k !== "_meta" && v && typeof v === "object" && !Array.isArray(v))
    .map(([_, v]) => v)
    .map((c) => (typeof c.slug === "string" ? c.slug.trim() : ""))
    .filter(Boolean);

  if (cibles.length === 0) {
    throw new Error(`[zones/[zone]/[ville]/[cible]] aucune cible trouvée dans cibles.json (slug requis)`);
  }

  // --- Combinaisons : zone/ville/cible
  const paths = [];
  for (const city of cities) {
    const zone = String(city.zoneSlug).trim();
    const ville = String(city.slug).trim();

    for (const cible of cibles) {
      paths.push({
        params: { zone, ville, cible },
        props: { zoneSlug: zone, villeSlug: ville, cibleSlug: cible },
      });
    }
  }

  if (paths.length === 0) {
    throw new Error(`[zones/[zone]/[ville]/[cible]] aucune route générée (check data)`);
  }

  return paths;
}
---

<BaseLayout>
  <PageTitle />
</BaseLayout>