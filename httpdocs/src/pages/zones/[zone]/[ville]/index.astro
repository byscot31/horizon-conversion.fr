---
// src/pages/zones/[zone]/[ville]/index.astro
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import PageTitle from "../../../../components/PageTitle.astro";
import HeroPage from "../../../../components/HeroPage.astro";
import ServicesPage from "../../../../components/ServicesPage.astro";
import Cibles from "../../../../components/Cibles.astro";
import Preuves from "../../../../components/Preuves.astro";
import Faqs from "../../../../components/Faqs.astro";
import ContactForm from "../../../../components/ContactForm.astro";

import siteData from "../../../../data/site.json";
import seoData from "../../../../data/seo.json";
import hero_pageData from "../../../../data/hero_page.json";
import servicesData from "../../../../data/services.json";
import ciblesData from "../../../../data/cibles.json";
import preuvesData from "../../../../data/preuves.json";
import faqs_villesData from "../../../../data/faqs_villes.json";
import formData from "../../../../data/form.json";

import villesData from "../../../../data/villes.json";

/** ✅ getStaticPaths requis pour /zones/[zone]/[ville]/ */
export async function getStaticPaths() {
  const root =
    villesData && typeof villesData === "object" && !Array.isArray(villesData)
      ? villesData
      : null;

  if (!root) {
    throw new Error(`[zones/[zone]/[ville]] villes.json invalide (objet attendu)`);
  }

  const entries = Object.entries(root)
    .filter(([k, v]) => k !== "_meta" && v && typeof v === "object" && !Array.isArray(v))
    .map(([_, v]) => v)
    .filter(
      (c) =>
        typeof c.slug === "string" &&
        c.slug.trim() &&
        typeof c.zoneSlug === "string" &&
        c.zoneSlug.trim()
    );

  if (entries.length === 0) {
    throw new Error(`[zones/[zone]/[ville]] aucune ville trouvée dans villes.json (slug + zoneSlug requis)`);
  }

  return entries.map((city) => ({
    params: {
      zone: String(city.zoneSlug).trim(),
      ville: String(city.slug).trim(),
    },
    props: {
      zoneSlug: String(city.zoneSlug).trim(),
      villeSlug: String(city.slug).trim(),
      cityId: typeof city.id === "string" || typeof city.id === "number" ? String(city.id) : "",
    },
  }));
}
---

<BaseLayout>
  <PageTitle />

  <!-- Content ============================================= -->
  <section id="content">
    <div class="content-wrap pb-0">

      <!-- Hero + Services ============================================= -->
      <div class="container mb-5">

        <HeroPage />

        <ServicesPage />

      </div>

      <div class="clear"></div>

      <Cibles />

      <Preuves />

      <Faqs />

      <ContactForm />

    </div>
  </section>
</BaseLayout>