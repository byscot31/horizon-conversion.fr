---
// src/pages/zones/[zone]/[ville]/index.astro
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import PageTitle from "../../../../components/PageTitle.astro";
import HeroPage from "../../../../components/HeroPage.astro";
import ServicesPage from "../../../../components/ServicesPage.astro";
import CiblesVille from "../../../../components/CiblesVille.astro";
import Preuves from "../../../../components/Preuves.astro";
import Faqs from "../../../../components/Faqs.astro";
import ContactForm from "../../../../components/ContactForm.astro";
import MaillageInterne from "../../../../components/MaillageInterne.astro";
import Ressources from "../../../../components/Ressources.astro";

import { buildModel } from "../../../../lib/pageModel";
import { zones, villes, services, cibles } from "../../../../lib/data";
import { bySlug } from "../../../../lib/collection";

export function getStaticPaths() {
  return (villes ?? []).map((v) => ({ params: { zone: v.zoneSlug, ville: v.slug } }));
}

const zoneSlug = Astro.params.zone;
const villeSlug = Astro.params.ville;

const zone = bySlug(zones, zoneSlug, "zones");
const ville = bySlug((villes ?? []).filter((v) => v.zoneSlug === zoneSlug), villeSlug, "villes");

const canonical = `/zones/${zone.slug}/${ville.slug}/`;

const model = buildModel({
  type: "ville",
  zone,
  ville,
  canonical,
});

const contexte = model.contexte;

const seo = {
  ...model.seo,
  title: `Obtenir plus de demandes à ${ville.name} | ${model.site.name}`,
  description: `À ${ville.name} (${zone.name}), on met en place une page claire + le suivi des appels et formulaires, puis le bon levier (SEO local / Ads). Audit gratuit.`,
  canonical,
};

const breadcrumbItems = model.breadcrumbItems ?? [
  { label: "Accueil", href: "/" },
  { label: "Zones", href: "/zones/" },
  { label: zone.name ?? zone.slug, href: `/zones/${zone.slug}/` },
  { label: ville.name ?? ville.slug, href: canonical },
];
---

<BaseLayout seo={seo} site={model.site}>
  <PageTitle
      contexte={contexte}
      seo={seo}
      breadcrumbItems={breadcrumbItems}
      data={{
        badge: zone.name ?? "Zone",
        h1: `Obtenir plus de demandes à ${ville.name}`,
        chapo: seo.description,
      }}
  />

  <section id="content">
    <div class="content-wrap pb-0">

      <div class="container mb-5">
        <HeroPage data={model.hero.page} contexte={contexte} />
        <ServicesPage data={services} contexte={contexte} />
      </div>

      <CiblesVille data={cibles} contexte={contexte} />

      <Preuves data={model.blocks.preuves} contexte={contexte} />

      <Ressources block={model.blocks.ressources} articles={model.blocks.articles} contexte={contexte} />

      <Faqs
          items={model.faqs}
          data={{ badge: "FAQ", title: `Questions fréquentes à ${ville.name}`, intro: "Réponses simples et concrètes." }}
          contexte={contexte}
      />

      <ContactForm data={model.site} form={model.blocks.form} contexte={contexte} mode="audit" />

      <MaillageInterne data={model.blocks.maillageInterne} contexte={contexte} />

    </div>
  </section>
</BaseLayout>
