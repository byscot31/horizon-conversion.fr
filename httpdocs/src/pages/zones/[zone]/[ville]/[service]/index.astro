---
// src/pages/zones/[zone]/[ville]/[service]/index.astro
import BaseLayout from "../../../../../layouts/BaseLayout.astro";
import PageTitle from "../../../../../components/PageTitle.astro";

import villesData from "../../../../../data/villes.json";
import servicesData from "../../../../../data/services.json";

/**
 * ✅ getStaticPaths : inline, aucune dépendance à des helpers externes
 * Génère Zone × Ville × Service
 */
export async function getStaticPaths() {
  // villes (objet migré : { _meta, cities: {...} } OU direct city-*)
  const villesRoot =
    villesData && typeof villesData === "object" && !Array.isArray(villesData)
      ? (villesData.cities && typeof villesData.cities === "object" && !Array.isArray(villesData.cities)
        ? villesData.cities
        : villesData)
      : null;

  if (!villesRoot) {
    throw new Error(`[zones/[zone]/[ville]/[service]] villes.json invalide (objet attendu)`);
  }

  const cities = Object.values(villesRoot).filter(
    (c) =>
      c &&
      typeof c === "object" &&
      !Array.isArray(c) &&
      typeof c.slug === "string" &&
      c.slug.trim() &&
      typeof c.zoneSlug === "string" &&
      c.zoneSlug.trim()
  );

  if (cities.length === 0) {
    throw new Error(`[zones/[zone]/[ville]/[service]] aucune ville valide trouvée dans villes.json`);
  }

  // services (objet migré : { _meta, ...svc } )
  const servicesRoot =
    servicesData && typeof servicesData === "object" && !Array.isArray(servicesData)
      ? servicesData
      : null;

  if (!servicesRoot) {
    throw new Error(`[zones/[zone]/[ville]/[service]] services.json invalide (objet attendu)`);
  }

  const services = Object.entries(servicesRoot)
    .filter(([k, v]) => k !== "_meta" && v && typeof v === "object" && !Array.isArray(v))
    .map(([_, v]) => v)
    .filter((s) => typeof s.slug === "string" && s.slug.trim());

  if (services.length === 0) {
    throw new Error(`[zones/[zone]/[ville]/[service]] aucun service valide trouvé dans services.json`);
  }

  const paths = [];
  for (const city of cities) {
    for (const svc of services) {
      paths.push({
        params: {
          zone: String(city.zoneSlug),
          ville: String(city.slug),
          service: String(svc.slug),
        },
        props: {
          cityId: typeof city.id === "string" ? city.id : "",
          serviceSlug: String(svc.slug),
        },
      });
    }
  }

  return paths;
}

/** Helpers (OK hors getStaticPaths) */
const trimStr = (v) => (typeof v === "string" ? v.trim() : "");
const isObj = (v) => v && typeof v === "object" && !Array.isArray(v);

/** Props + params */
const { cityId, serviceSlug } = Astro.props;

const zoneParam = String(Astro.params.zone || "");
const villeParam = String(Astro.params.ville || "");
const serviceParam = String(Astro.params.service || serviceSlug || "");

/** Resolve villes root */
const villesRoot =
  isObj(villesData)
    ? (isObj(villesData.cities) ? villesData.cities : villesData)
    : null;

if (!villesRoot) throw new Error(`[zones/[zone]/[ville]/[service]] villes.json invalide (objet attendu)`);

const cities = Object.values(villesRoot).filter((c) => isObj(c));

/** Resolve city */
const city =
  (trimStr(cityId) && isObj(villesRoot[cityId]) ? villesRoot[cityId] : null) ||
  cities.find((c) => trimStr(c.slug) === villeParam && trimStr(c.zoneSlug) === zoneParam) ||
  null;

if (!city) {
  throw new Error(`[zones/[zone]/[ville]/[service]] Ville introuvable: zone="${zoneParam}" ville="${villeParam}"`);
}

if (trimStr(city.zoneSlug) !== zoneParam) {
  throw new Error(
    `[zones/[zone]/[ville]/[service]] Incohérence zoneSlug: ville="${villeParam}" a zoneSlug="${trimStr(city.zoneSlug)}" attendu="${zoneParam}"`
  );
}

const cityName = trimStr(city.name);
if (!cityName) throw new Error(`[zones/[zone]/[ville]/[service]] city.name manquant pour "${villeParam}"`);

const zoneName = trimStr(city.zoneName);
if (!zoneName) throw new Error(`[zones/[zone]/[ville]/[service]] city.zoneName manquant pour "${villeParam}"`);

/** Resolve service */
if (!isObj(servicesData)) throw new Error(`[zones/[zone]/[ville]/[service]] services.json invalide (objet attendu)`);

const servicesList = Object.entries(servicesData)
  .filter(([k, v]) => k !== "_meta" && isObj(v))
  .map(([_, v]) => v);

const service = servicesList.find((s) => trimStr(s.slug) === serviceParam) || null;
if (!service) throw new Error(`[zones/[zone]/[ville]/[service]] Service introuvable: "${serviceParam}"`);

const serviceName = trimStr(service.name);
if (!serviceName) throw new Error(`[zones/[zone]/[ville]/[service]] service.name manquant pour "${serviceParam}"`);

/** PageTitle (généré) */
const pageTitle = {
  badge: "Service",
  title: `${serviceName} à ${cityName}`,
  subtitle: `${zoneName} • Objectif : appels & demandes`,
  image: "/assets/images/hero/page-title.jpg",
};

/** Breadcrumbs (généré) */
const breadcrumbs = [
  { name: "Accueil", url: "/" },
  { name: "Zones", url: "/zones/" },
  { name: zoneName, url: `/zones/${zoneParam}/` },
  { name: cityName, url: `/zones/${zoneParam}/${villeParam}/` },
  { name: serviceName, url: `/zones/${zoneParam}/${villeParam}/${serviceParam}/` },
];

/** SEO (généré) */
const seo = {
  title: `${serviceName} à ${cityName} — Horizon Conversion`,
  description: `À ${cityName} (${zoneName}), ${serviceName} orienté demandes : clarté, contact simple et suivi des conversions.`,
  canonical: `https://horizon-conversion.fr/zones/${zoneParam}/${villeParam}/${serviceParam}/`,
};
---

<BaseLayout seo={seo} breadcrumbs={breadcrumbs}>
  <PageTitle
      badge={pageTitle.badge}
      title={pageTitle.title}
      subtitle={pageTitle.subtitle}
      image={pageTitle.image}
      breadcrumbs={breadcrumbs}
  />
</BaseLayout>