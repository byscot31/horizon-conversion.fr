---
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import SeoHead from "../../../../components/SeoHead.astro";
import FAQ from "../../../../components/FAQ.astro";
import CTA from "../../../../components/CTA.astro";

import { absUrl } from "../../../../lib/seo";
import { seoTemplates, buildCityBlocks } from "../../../../lib/content";
import { cities, services, getCity, getDepartment } from "../../../../lib/data";
import type { ServiceKey } from "../../../../lib/types";

const citySlug = Astro.params.city!;
const serviceKey = Astro.params.service as ServiceKey;

const city = getCity(citySlug);
if (!city) throw new Error("Not found");

const dept = getDepartment(city.dept);
const place = `${city.name} (${city.dept})`;

const tpl = seoTemplates[serviceKey];
if (!tpl) throw new Error("Not found");

const title = tpl.title(place);
const description = tpl.description(place);
const h1 = tpl.h1(city.name);

const path = `/local/ville/${city.slug}/${serviceKey}/`;
const canonical = absUrl(path);

const nearNames = (city.near ?? [])
  .map((slug) => cities.find((c) => c.slug === slug)?.name)
  .filter(Boolean) as string[];

const blocks = buildCityBlocks({
  cityName: city.name,
  deptName: dept?.name ?? "",
  serviceKey,
  nearNames
});
---

<BaseLayout>
  <SeoHead title={title} description={description} canonical={canonical} />
  <body>
    <main style="max-width:900px;margin:0 auto;padding:24px;">
      <h1>{h1}</h1>
      <p>{blocks.intro}</p>
      {blocks.nearLine && <p><em>{blocks.nearLine}</em></p>}

      <section>
        <h2>Ce que vous obtenez</h2>
        <ul>
          {blocks.bullets.map((b) => <li>{b}</li>)}
        </ul>
      </section>

      <CTA sub="20 min. Objectif : clarifier le canal prioritaire + un plan 30/60/90 jours." />

      <FAQ items={blocks.faq} />

      <section>
        <h2>Zones {city.dept}</h2>
        <p>
          Vous êtes sur {city.name} et alentours ? Je travaille aussi sur {city.dept} (département) via une approche SEO local + Ads + CRO.
        </p>
      </section>
    </main>
  </body>
</BaseLayout>

---
export async function getStaticPaths() {
  return cities.flatMap((c) =>
    services.map((s) => ({
      params: { city: c.slug, service: s.key }
    }))
  );
}