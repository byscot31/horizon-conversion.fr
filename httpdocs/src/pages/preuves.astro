---
// src/pages/preuves.astro

import BaseLayout from "../layouts/BaseLayout.astro";
import reviewsData from "../data/reviews.json";

import { getStaticPageByUrl, normalizeLinksOut, resolveFaqItems, safeText } from "../lib/mapping";

import SectionHero from "../components/SectionHero.astro";
import SectionBenefits from "../components/SectionBenefits.astro";
import SectionDeliverables from "../components/SectionDeliverables.astro";
import SectionProcess from "../components/SectionProcess.astro";
import SectionFAQ from "../components/SectionFAQ.astro";
import SectionCTA from "../components/SectionCTA.astro";
import LinksOut from "../components/LinksOut.astro";
import MiniCases from "../components/MiniCases.astro";
import Transparence from "../components/Transparence.astro";

const page = getStaticPageByUrl("/preuves");

const title = safeText(page?.metaTitle, "Preuves | Horizon Conversion");
const description = safeText(page?.metaDescription, "Transparence : livrables, suivi, journal d’actions, (avis si disponibles).");
const h1 = safeText(page?.h1, "Preuves : ce que vous voyez (et ce que vous recevez)");

const linksOut = normalizeLinksOut(page?.linksOut);
const faqItems = resolveFaqItems({ pageFaqRefs: page?.faqRefs, pageFaq: page?.faq });
const showFaq = Array.isArray(faqItems) && faqItems.length;

const benefits = [
  "Vous voyez ce qui est fait (journal d’actions), pas juste un rapport",
  "Vous comprenez ce qui génère des demandes (appels/formulaires/sources)",
  "Vous gardez la main : transparence sur comptes et décisions"
];

const deliverables = [
  "Plan mensuel : priorités + pourquoi + impact attendu",
  "Journal d’actions : preuve d’exécution (ce qui a été fait)",
  "Reporting simple : appels, formulaires, sources, pages qui convertissent",
  "Décisions : on coupe / on garde / on amplifie (avec justification)"
];

const process = [
  "Audit gratuit : situation actuelle + quick wins",
  "Setup : fondations + tracking + cadrage des leads",
  "Mensuel : actions + mesure + ajustements",
  "Amélioration continue : qualité des leads avant volume"
];

const enabled = Boolean((reviewsData as any)?.enabled);
const reviews = enabled && Array.isArray((reviewsData as any)?.reviews) ? (reviewsData as any).reviews : [];
const topReviews = reviews.slice(0, 3);
---

<BaseLayout
  title={title}
  description={description}
  pageContext={{ type: "static", staticLabel: "Preuves", staticUrl: "/preuves" }}
  faqItems={faqItems}
>
  <SectionHero
    h1={h1}
    intro="Vous voulez être sûr que ça avance et que ça sert à quelque chose. Ici, pas de promesse “magique” : on montre une exécution claire et un suivi orienté demandes."
    bullets={[
      "Livrables mensuels (plan + journal + reporting)",
      "Transparence (accès et propriété des comptes)",
      "Pilotage senior + exécution d’agence"
    ]}
  />

  <SectionBenefits items={benefits} />
  <SectionDeliverables items={deliverables} />
  <SectionProcess steps={process} />

  <MiniCases
    title="Mini-cas : problème → actions → mesure"
    intro="Exemples de situations typiques en local (sans chiffres inventés)."
    limit={3}
    columns={3}
  />

  <Transparence columns={3} limit={6} />

  {enabled && topReviews.length ? (
    <section style="padding:1rem 0">
      <div style="max-width:980px;margin:0 auto;padding:0 1rem">
        <h2 style="margin:0 0 .75rem;font-size:1.25rem">Avis</h2>
        <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:.75rem">
          {topReviews.map((r: any) => (
            <div style="border:1px solid #e5e7eb;border-radius:12px;padding:1rem;background:#fff">
              <div style="font-weight:700;margin:0 0 .25rem">{r.authorName}</div>
              <div style="color:#6b7280;font-size:.95rem;margin:0 0 .5rem">Note : {r.ratingValue}/5</div>
              {r.reviewBody ? <p style="margin:0;color:#374151">{r.reviewBody}</p> : null}
              {r.datePublished ? <div style="margin-top:.6rem;color:#9ca3af;font-size:.85rem">{r.datePublished}</div> : null}
            </div>
          ))}
        </div>
      </div>
    </section>
  ) : null}

  {showFaq ? <SectionFAQ items={faqItems} /> : null}
  <LinksOut links={linksOut} />

  <SectionCTA />
</BaseLayout>