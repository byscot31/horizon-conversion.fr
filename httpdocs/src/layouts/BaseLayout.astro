---
// src/layouts/BaseLayout.astro

import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

import reviewsData from "../data/reviews.json";

import { getBreadcrumbs } from "../lib/routing";
import {
  buildBreadcrumbListJsonLd,
  buildFaqPageJsonLd,
  canonicalFromPageContext,
  buildLocalBusinessJsonLd,
  buildArticleJsonLd,
  buildWebSiteJsonLd,
  buildOrganizationJsonLd,
  buildServiceJsonLd,
  type PageContext
} from "../lib/seo";
import type { FaqItem } from "../lib/mapping";

type Props = {
  title: string;
  description: string;

  pageContext?: PageContext;

  // options page-level
  breadcrumbsJsonLd?: boolean;

  // FAQ
  faqItems?: FaqItem[];
  faqJsonLd?: boolean;

  // JSON-LD page-level
  localBusinessJsonLd?: boolean;
  articleJsonLd?: boolean;
  serviceJsonLd?: boolean;

  // Global
  webSiteJsonLd?: boolean;
  organizationJsonLd?: boolean;

  // Organization enrich (facultatif)
  organizationLogoUrl?: string;
  organizationSameAs?: string[];

  // ✅ Overrides optionnels (rare) : si tu veux surcharger ponctuellement
  organizationReviewsEnabled?: boolean;
};

const {
  title,
  description,
  pageContext,

  breadcrumbsJsonLd = true,

  faqItems = [],
  faqJsonLd = true,

  localBusinessJsonLd = true,
  articleJsonLd = true,
  serviceJsonLd = true,

  webSiteJsonLd = true,
  organizationJsonLd = true,

  organizationLogoUrl,
  organizationSameAs,

  organizationReviewsEnabled
} = Astro.props as Props;

// Base URL (Astro.site)
const baseUrl = (Astro.site?.toString() || "").replace(/\/$/, "");

// Canonical absolu auto
let canonicalAbs: string | null = null;
if (baseUrl && pageContext) {
  const rel = canonicalFromPageContext(pageContext);
  canonicalAbs = `${baseUrl}${rel.startsWith("/") ? rel : `/${rel}`}`;
}

// ----- Reviews auto depuis src/data/reviews.json
const reviewsEnabledFromFile = Boolean((reviewsData as any)?.enabled);
const reviewsEnabled =
  typeof organizationReviewsEnabled === "boolean"
    ? organizationReviewsEnabled
    : reviewsEnabledFromFile;

const aggregateRating = reviewsEnabled ? (reviewsData as any)?.aggregateRating : undefined;
const reviews = reviewsEnabled ? (reviewsData as any)?.reviews : undefined;

// Global WebSite / Organization JSON-LD
let webSiteJsonLdObj: any = null;
if (webSiteJsonLd && baseUrl) {
  webSiteJsonLdObj = buildWebSiteJsonLd({ baseUrl, name: "Horizon Conversion" });
}

let organizationJsonLdObj: any = null;
if (organizationJsonLd && baseUrl) {
  organizationJsonLdObj = buildOrganizationJsonLd({
    baseUrl,
    name: "Horizon Conversion",
    logoUrl: organizationLogoUrl,
    sameAs: organizationSameAs,
    aggregateRating,
    reviews
  });
}

// Breadcrumbs JSON-LD auto
let breadcrumbsJsonLdObj: any = null;
if (breadcrumbsJsonLd && baseUrl && pageContext) {
  const crumbs = getBreadcrumbs(pageContext as any);
  breadcrumbsJsonLdObj = buildBreadcrumbListJsonLd({ baseUrl, crumbs });
}

// FAQPage JSON-LD auto
let faqJsonLdObj: any = null;
if (faqJsonLd && Array.isArray(faqItems) && faqItems.length) {
  const filtered = faqItems.filter((x) => x?.q && x?.a);
  if (filtered.length) faqJsonLdObj = buildFaqPageJsonLd({ faq: filtered });
}

// LocalBusiness JSON-LD auto (pages ville/zone)
let localBusinessJsonLdObj: any = null;
if (localBusinessJsonLd && baseUrl && pageContext) {
  localBusinessJsonLdObj = buildLocalBusinessJsonLd({ baseUrl, ctx: pageContext });
}

// Service JSON-LD auto (pages service / service×ville)
let serviceJsonLdObj: any = null;
if (serviceJsonLd && baseUrl && pageContext) {
  serviceJsonLdObj = buildServiceJsonLd({ baseUrl, ctx: pageContext });
}

// Article JSON-LD auto (pages ressources)
let articleJsonLdObj: any = null;
if (articleJsonLd && baseUrl && pageContext) {
  articleJsonLdObj = buildArticleJsonLd({ baseUrl, ctx: pageContext });
}
---

<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{title}</title>
    <meta name="description" content={description} />

    {canonicalAbs ? <link rel="canonical" href={canonicalAbs} /> : null}

    {/* Global */}
    {webSiteJsonLdObj ? (
      <script type="application/ld+json" set:html={JSON.stringify(webSiteJsonLdObj)} />
    ) : null}

    {organizationJsonLdObj ? (
      <script type="application/ld+json" set:html={JSON.stringify(organizationJsonLdObj)} />
    ) : null}

    {/* Page-level */}
    {breadcrumbsJsonLdObj ? (
      <script type="application/ld+json" set:html={JSON.stringify(breadcrumbsJsonLdObj)} />
    ) : null}

    {faqJsonLdObj ? (
      <script type="application/ld+json" set:html={JSON.stringify(faqJsonLdObj)} />
    ) : null}

    {localBusinessJsonLdObj ? (
      <script type="application/ld+json" set:html={JSON.stringify(localBusinessJsonLdObj)} />
    ) : null}

    {serviceJsonLdObj ? (
      <script type="application/ld+json" set:html={JSON.stringify(serviceJsonLdObj)} />
    ) : null}

    {articleJsonLdObj ? (
      <script type="application/ld+json" set:html={JSON.stringify(articleJsonLdObj)} />
    ) : null}

    <!-- Font Imports -->
            <link rel="preconnect" href="https://fonts.googleapis.com" />
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
            <link
              href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;900&display=swap"
              rel="stylesheet"
            />

            <!-- Core Style -->
            <link rel="stylesheet" href="/_assets_/style.css" />
            <link rel="stylesheet" href="/_assets_/css/font-icons.css" />
            <link rel="stylesheet" href="/_assets_/seo.css" />
  </head>

  <body class="stretched">
      <div id="wrapper">

        <TopBar />

        <Header />

        <slot />

        <Footer />

      </div>

      <div id="gotoTop" class="uil uil-angle-up"></div>

  	<div class="scw-switcher-wrap text-center d-none d-lg-block">
  	  <a href="tel:+33660921008 class="scw-trigger-icon scw-trigger">
      	<i class="bi-whatsapp align-baseline pt-1"></i>
        </a>
      </div>

      <script is:inline src="/_assets_/js/plugins.min.js"></script>
      <script is:inline src="/_assets_/js/functions.bundle.js"></script>
</html>