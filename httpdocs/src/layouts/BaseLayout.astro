---
// src/layouts/BaseLayout.astro
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

const { seo, site } = Astro.props;

// ✅ Fallbacks simples (si jamais une page n’envoie rien)
const s = site ?? {};
const meta = seo ?? {};

const title =
	meta.title ??
	s.name ??
	"Horizon Conversion";

const description =
	meta.description ??
	s.defaultDescription ??
	"Audit gratuit et plan clair pour générer des appels et des formulaires.";

const canonicalPath = meta.canonical ?? Astro.url.pathname;
const canonicalUrl = (() => {
	const base = s.url ?? `${Astro.url.origin}`;
	try {
		return new URL(canonicalPath, base).toString();
	} catch {
		return canonicalPath;
	}
})();

const ogImage = meta.ogImage ?? s.ogImage ?? "/assets/images/og.jpg";
const noindex = meta.noindex === true;

// WhatsApp (format wa.me sans +)
const whatsappRaw = String(s.whatsapp ?? "").trim();
const whatsappDigits = whatsappRaw ? whatsappRaw.replace(/[^\d]/g, "") : "";
const whatsappUrl = whatsappDigits ? `https://wa.me/${whatsappDigits}` : "";

// JSON-LD (optionnel)
const orgJsonLd = s?.name
	? {
		"@context": "https://schema.org",
		"@type": "Organization",
		name: s.name,
		url: s.url ?? Astro.url.origin,
		email: s.email,
		telephone: s.phone,
		logo: s.logo ?? "/assets/images/logo.png",
	}
	: null;
---

<!DOCTYPE html>
<html dir="ltr" lang="fr-FR">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta http-equiv="x-ua-compatible" content="IE=edge">

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<meta name="author" content={s.author ?? "Horizon Conversion"}>
	<meta name="description" content={description}>
	{noindex && <meta name="robots" content="noindex, nofollow" />}

	<link rel="canonical" href={canonicalUrl} />

	<!-- Open Graph -->
	<meta property="og:locale" content="fr_FR" />
	<meta property="og:type" content="website" />
	<meta property="og:title" content={title} />
	<meta property="og:description" content={description} />
	<meta property="og:url" content={canonicalUrl} />
	<meta property="og:image" content={ogImage} />

	<!-- Twitter -->
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:title" content={title} />
	<meta name="twitter:description" content={description} />
	<meta name="twitter:image" content={ogImage} />

	<!-- Font Imports -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">

	<!-- Core Style -->
	<link rel="stylesheet" href="/assets/style.css">

	<!-- Font Icons -->
	<link rel="stylesheet" href="/assets/css/font-icons.css">

	<!-- Niche Demos -->
	<link rel="stylesheet" href="/assets/seo.css">

	<!-- Document Title -->
	<title>{title}</title>

	{orgJsonLd && (
		<script type="application/ld+json" set:html={JSON.stringify(orgJsonLd)} />
	)}
</head>

<body class="stretched">
<div id="wrapper">

	<!-- Top Bar ============================================= -->
	<div id="top-bar" class="transparent-topbar">
		<div class="container">
			<div class="row justify-content-between">
				<div class="col-12 col-md-auto">
					<div class="top-links">
						<ul class="top-links-container">
							<li class="top-links-item"><a href="/zones">Zones Sud Oise (60) / Val d'Oise (95)</a></li>
						</ul>
					</div>
				</div>

				<div class="col-12 col-md-auto">
					<div class="top-links">
						<ul class="top-links-container">
							<li class="top-links-item">
								<a
									data-track="click_phone"
									href={`tel:${String(s.phone ?? "+33660921008").replace(/\s/g, "")}`}
								>
									{s.phoneDisplay ?? "06 60 92 10 08"}
								</a>
							</li>

							{whatsappUrl && (
								<li class="top-links-item">
									<a
										data-track="click_whatsapp"
										href={whatsappUrl}
										target="_blank"
										rel="noopener noreferrer"
									>
										{s.whatsappDisplay ?? "WhatsApp"}
									</a>
								</li>
							)}

							<li class="top-links-item">
								<a href={`mailto:${s.email ?? "contact@horizon-conversion.fr"}`}>{s.email ?? "contact@horizon-conversion.fr"}</a>
							</li>
						</ul>
					</div>
				</div>
			</div>

		</div>
	</div><!-- #top-bar end -->

	<Header />

	<slot />

	<Footer />

	<script>
		document.getElementById('hc-year').textContent = new Date().getFullYear();
	</script>

</div><!-- #wrapper end -->

<!-- Go To Top ============================================= -->
<div id="gotoTop" class="uil uil-angle-up"></div>

<!-- WhatsApp -->
<div class="scw-switcher-wrap text-center d-none d-lg-block">
	{whatsappUrl && (
		<a
			data-track="click_whatsapp"
			href={whatsappUrl}
			target="_blank"
			rel="noopener noreferrer"
			class="scw-trigger-icon scw-trigger mt-2"
			aria-label="Contacter Horizon Conversion sur WhatsApp"
		>
			<i class="bi-whatsapp align-baseline pt-1"></i>
		</a>
	)}
</div>

<!-- JavaScripts ============================================= -->
<script is:inline src="/assets/js/plugins.min.js"></script>
<script is:inline src="/assets/js/functions.bundle.js"></script>

<!-- HC Tracking (GA4/GTM) -->
<script is:inline>
	(function () {
		function getDims() {
			var p = (location.pathname || "/").split("/").filter(Boolean);
			var dims = { service: "", ville: "", metier: "" };

			// /services/<service>/
			if (p[0] === "services" && p[1]) dims.service = p[1];

			// /profils/<metier>/
			if (p[0] === "profils" && p[1]) dims.metier = p[1];

			// /zones/<zone>/<ville>/
			if (p[0] === "zones" && p[2]) dims.ville = p[2];

			// /zones/<zone>/<ville>/<service or metier>/
			if (p[0] === "zones" && p[3]) {
				if (!dims.service) dims.service = p[3];
			}

			return dims;
		}

		function sendEvent(name, params) {
			params = params || {};
			var dims = getDims();
			params.service = params.service || dims.service;
			params.ville = params.ville || dims.ville;
			params.metier = params.metier || dims.metier;

			if (window.dataLayer && typeof window.dataLayer.push === "function") {
				window.dataLayer.push(Object.assign({ event: name }, params));
				return;
			}
			if (typeof window.gtag === "function") {
				window.gtag("event", name, params);
			}
		}

		// Click tracking
		document.addEventListener("click", function (e) {
			var el = e.target && e.target.closest ? e.target.closest("[data-track]") : null;
			if (!el) return;
			var t = el.getAttribute("data-track");

			if (t === "click_phone") sendEvent("click_phone", {});
			if (t === "click_whatsapp") sendEvent("click_whatsapp", {});
			if (t === "click_audit") sendEvent("click_audit", {});
			if (t === "click_callback") sendEvent("click_callback", {});
		}, { passive: true });

		// form_view via IntersectionObserver
		var seen = new WeakSet();
		var io = "IntersectionObserver" in window ? new IntersectionObserver(function (entries) {
			entries.forEach(function (entry) {
				if (!entry.isIntersecting) return;
				var form = entry.target;
				if (seen.has(form)) return;
				seen.add(form);
				var mode = form.getAttribute("data-form-mode") || "audit";
				sendEvent("form_view", { mode: mode });
			});
		}, { threshold: 0.25 }) : null;

		if (io) {
			document.querySelectorAll('form[data-track="form"]').forEach(function (f) { io.observe(f); });
		}

		// form_submit
		document.addEventListener("submit", function (e) {
			var form = e.target;
			if (!form || !form.getAttribute) return;
			if (form.getAttribute("data-track") !== "form") return;
			var mode = form.getAttribute("data-form-mode") || "audit";
			sendEvent("form_submit", { mode: mode });
		}, true);
	})();
</script>

</body>
</html>
