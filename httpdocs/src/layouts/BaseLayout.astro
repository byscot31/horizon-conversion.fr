---
// src/layouts/BaseLayout.astro

import TopBar from "../components/TopBar.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

import reviewsData from "../data/reviews.json";

import { getBreadcrumbs } from "../lib/routing";
import {
  buildBreadcrumbListJsonLd,
  buildFaqPageJsonLd,
  canonicalFromPageContext,
  buildLocalBusinessJsonLd,
  buildArticleJsonLd,
  buildWebSiteJsonLd,
  buildOrganizationJsonLd,
  buildServiceJsonLd,
  type PageContext
} from "../lib/seo";
import type { FaqItem } from "../lib/mapping";

type Props = {
  title: string;
  description: string;

  pageContext?: PageContext;

  breadcrumbsJsonLd?: boolean;

  faqItems?: FaqItem[];
  faqJsonLd?: boolean;

  localBusinessJsonLd?: boolean;
  articleJsonLd?: boolean;
  serviceJsonLd?: boolean;

  webSiteJsonLd?: boolean;
  organizationJsonLd?: boolean;

  organizationLogoUrl?: string;
  organizationSameAs?: string[];

  organizationReviewsEnabled?: boolean;
};

const {
  title,
  description,
  pageContext,

  breadcrumbsJsonLd = true,

  faqItems = [],
  faqJsonLd = true,

  localBusinessJsonLd = true,
  articleJsonLd = true,
  serviceJsonLd = true,

  webSiteJsonLd = true,
  organizationJsonLd = true,

  organizationLogoUrl,
  organizationSameAs,

  organizationReviewsEnabled
} = Astro.props as Props;

// Base URL (Astro.site)
const baseUrl = (Astro.site?.toString() || "").replace(/\/$/, "");

// Canonical absolu auto
let canonicalAbs: string | null = null;
if (baseUrl && pageContext) {
  const rel = canonicalFromPageContext(pageContext);
  canonicalAbs = `${baseUrl}${rel.startsWith("/") ? rel : `/${rel}`}`;
}

// ----- Reviews auto depuis src/data/reviews.json
const reviewsEnabledFromFile = Boolean((reviewsData as any)?.enabled);
const reviewsEnabled =
  typeof organizationReviewsEnabled === "boolean"
    ? organizationReviewsEnabled
    : reviewsEnabledFromFile;

const aggregateRating = reviewsEnabled ? (reviewsData as any)?.aggregateRating : undefined;
const reviews = reviewsEnabled ? (reviewsData as any)?.reviews : undefined;

// Global WebSite / Organization JSON-LD
let webSiteJsonLdObj: any = null;
if (webSiteJsonLd && baseUrl) {
  webSiteJsonLdObj = buildWebSiteJsonLd({ baseUrl, name: "Horizon Conversion" });
}

let organizationJsonLdObj: any = null;
if (organizationJsonLd && baseUrl) {
  organizationJsonLdObj = buildOrganizationJsonLd({
    baseUrl,
    name: "Horizon Conversion",
    logoUrl: organizationLogoUrl,
    sameAs: organizationSameAs,
    aggregateRating,
    reviews
  });
}

// Breadcrumbs JSON-LD auto
let breadcrumbsJsonLdObj: any = null;
if (breadcrumbsJsonLd && baseUrl && pageContext) {
  const crumbs = getBreadcrumbs(pageContext as any);
  breadcrumbsJsonLdObj = buildBreadcrumbListJsonLd({ baseUrl, crumbs });
}

// FAQPage JSON-LD auto
let faqJsonLdObj: any = null;
if (faqJsonLd && Array.isArray(faqItems) && faqItems.length) {
  const filtered = faqItems.filter((x) => x?.q && x?.a);
  if (filtered.length) faqJsonLdObj = buildFaqPageJsonLd({ faq: filtered });
}

// LocalBusiness JSON-LD auto (pages ville/zone)
let localBusinessJsonLdObj: any = null;
if (localBusinessJsonLd && baseUrl && pageContext) {
  localBusinessJsonLdObj = buildLocalBusinessJsonLd({ baseUrl, ctx: pageContext });
}

// Service JSON-LD auto (pages service / service×ville)
let serviceJsonLdObj: any = null;
if (serviceJsonLd && baseUrl && pageContext) {
  serviceJsonLdObj = buildServiceJsonLd({ baseUrl, ctx: pageContext });
}

// Article JSON-LD auto (pages ressources)
let articleJsonLdObj: any = null;
if (articleJsonLd && baseUrl && pageContext) {
  articleJsonLdObj = buildArticleJsonLd({ baseUrl, ctx: pageContext });
}

// ✅ GA4
const ga4Id = import.meta.env.PUBLIC_GA4_ID || "";
const debug = Astro.url?.searchParams?.get("debug") === "1";

// ✅ body dataset depuis pageContext (fallbacks safe)
const bodyPageType = (pageContext as any)?.type || (Astro.url?.pathname === "/" ? "home" : "page");
const bodyService = (pageContext as any)?.service || "";
const bodyVille = (pageContext as any)?.ville || "";
const bodyZone = (pageContext as any)?.zone || "";

// (Option) téléphone / WhatsApp
const phoneE164 = "+33660921008";
const phoneTelHref = `tel:${phoneE164.replace(/\s+/g, "")}`;
const whatsappHref = "https://wa.me/33660921008";
---

<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{title}</title>
    <meta name="description" content={description} />

    {canonicalAbs ? <link rel="canonical" href={canonicalAbs} /> : null}

    {/* ✅ GA4 Option A (gtag direct) */}
    {ga4Id ? (
      <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${ga4Id}`}></script>
        <script is:inline>
          {`
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', '${ga4Id}', { anonymize_ip: true });
          `}
        </script>
      </>
    ) : null}

    {/* Global JSON-LD */}
    {webSiteJsonLdObj ? (
      <script type="application/ld+json" set:html={JSON.stringify(webSiteJsonLdObj)} />
    ) : null}

    {organizationJsonLdObj ? (
      <script type="application/ld+json" set:html={JSON.stringify(organizationJsonLdObj)} />
    ) : null}

    {/* Page-level JSON-LD */}
    {breadcrumbsJsonLdObj ? (
      <script type="application/ld+json" set:html={JSON.stringify(breadcrumbsJsonLdObj)} />
    ) : null}

    {faqJsonLdObj ? (
      <script type="application/ld+json" set:html={JSON.stringify(faqJsonLdObj)} />
    ) : null}

    {localBusinessJsonLdObj ? (
      <script type="application/ld+json" set:html={JSON.stringify(localBusinessJsonLdObj)} />
    ) : null}

    {serviceJsonLdObj ? (
      <script type="application/ld+json" set:html={JSON.stringify(serviceJsonLdObj)} />
    ) : null}

    {articleJsonLdObj ? (
      <script type="application/ld+json" set:html={JSON.stringify(articleJsonLdObj)} />
    ) : null}

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;900&display=swap"
      rel="stylesheet"
    />

    <!-- Core Style -->
    <link rel="stylesheet" href="/_assets_/style.css" />
    <link rel="stylesheet" href="/_assets_/css/font-icons.css" />
    <link rel="stylesheet" href="/_assets_/seo.css" />
  </head>

  <body
    class="stretched"
    data-page-type={bodyPageType}
    data-service={bodyService}
    data-ville={bodyVille}
    data-zone={bodyZone}
  >
    {debug ? (
      <script is:inline>
        {`window.__HC_DEBUG__ = true; console.log('[HC] debug=1');`}
      </script>
    ) : null}

    <div id="wrapper">
      <TopBar />
      <Header />

      <slot />

      <Footer />
    </div>

    <div id="gotoTop" class="uil uil-angle-up"></div>

    {/* ✅ Floating quick action (tel + whatsapp) avec tracking */}
    <div class="scw-switcher-wrap text-center d-none d-lg-block">
      <a
        href={whatsappHref}
        class="scw-trigger-icon scw-trigger"
        target="_blank"
        rel="noopener noreferrer"
        data-track="whatsapp"
        aria-label="WhatsApp"
      >
        <i class="bi-whatsapp align-baseline pt-1"></i>
      </a>
    </div>

    {/* ✅ tracker MVP */}
    <script defer src="/_assets_/js/track.js"></script>

    {/* Scripts thème */}
    <script is:inline src="/_assets_/js/plugins.min.js"></script>
    <script is:inline src="/_assets_/js/functions.bundle.js"></script>
  </body>
</html>