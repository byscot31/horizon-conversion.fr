---
// src/components/Ressources.astro
import { pickRessources } from "../lib/pickRessources";

const { block, articles, contexte } = Astro.props;

// block attendu: ressources_block.json (resolved variant)
// articles attendu: articles.json (array)
const badge = block?.badge ?? "Ressources";
const h2 = block?.title ?? "À lire ensuite";
const intro = block?.intro ?? "";
const max = block?.maxItems ?? 3;

// sélection
const items = pickRessources({
  articles: Array.isArray(articles) ? articles : [],
  contexte,
  max,
  intentsPriority: block?.intentsPriority ?? [],
});

function formatDate(iso) {
  if (!iso) return "";
  try {
    const d = new Date(iso);
    return d.toLocaleDateString("fr-FR", { day: "2-digit", month: "short", year: "numeric" });
  } catch {
    return "";
  }
}

const hasItems = items.length > 0;
---

{hasItems && (
<div class="container py-4">
  <div class="heading-block border-bottom-0 text-center">
    <div class="badge rounded-pill badge-default">{badge}</div>
    <h2 class="text-transform-none ls-0">{h2}</h2>
    {intro && <p class="text-muted mb-0">{intro}</p>}
  </div>

  <div class="row mt-5">
    {items.map((a) => {
      const href = a.slug ? `/ressources/${a.slug}/` : "#";
      const img = a.image ?? "/assets/images/blog/1.jpg";
      const author = a.author ?? "Horizon Conversion";
      const date = formatDate(a.publishedAt);

      return (
          <div class="col-md-4">
            <article class="entry">
              <div class="entry-image mb-3">
                <a href={href}><img src={img} alt={a.title ?? "Ressource"} /></a>
              </div>
              <div class="entry-title">
                <h3><a href={href}>{a.title ?? "Article"}</a></h3>
              </div>
              <div class="entry-meta">
                <ul>
                  <li><i class="bi-person"></i><a href="#">{` ${author}`}</a></li>
                  {date && <li><i class="bi-calendar"></i><a href="#">{` ${date}`}</a></li>}
                </ul>
              </div>
              <div class="entry-content">
                <p>{a.excerpt ?? ""}</p>
              </div>
            </article>
          </div>
      );
    })}
  </div>
</div>
  )}
