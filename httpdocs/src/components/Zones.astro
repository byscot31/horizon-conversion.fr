---
// src/components/Zones.astro
import { pickVillesForZone } from "../lib/collection";

const { data, contexte, config } = Astro.props;

// ✅ Supporte data={{ zones, villes }} ou data direct
const zones = Array.isArray(data?.zones) ? data.zones : (Array.isArray(data) ? data : []);
const villes = Array.isArray(data?.villes) ? data.villes : [];

const maxVilles = config?.maxVilles ?? 5;

const badge = config?.badge ?? "Zones";
const title = config?.title ?? "Zones couvertes";
const subtitle = config?.subtitle ?? "Choisissez une zone";

function zoneHref(zoneSlug) {
  return `/zones/${zoneSlug}/`;
}

function villeHref(zoneSlug, villeSlug) {
  return `/zones/${zoneSlug}/${villeSlug}/`;
}

if (!Array.isArray(zones) || !zones.length) {
  // rien
}
---

{Array.isArray(zones) && zones.length > 0 && (
<div class="section bg-transparent">
  <div class="container">

    <div class="heading-block border-bottom-0 text-center mb-5">
      <h2 class="text-transform-none ls-0">{title}</h2>
      <p class="text-muted mb-0">{subtitle}</p>
    </div>

    <div class="row col-mb-30 align-content-stretch">
      {zones.map((z) => {
        const villesZone = pickVillesForZone(villes, z, maxVilles);

        // ✅ si une zone n'a aucune ville (data incomplète), on la masque
          if (!villesZone.length) return null;

        return (
            <div class="col-md-6 d-flex">
              <div class="card h-shadow h-translate-y-sm all-ts w-100">
                <div class="card-body p-5">
                  <div class="feature-box flex-column">
                    <div class="fbox-content">
                      <h3 class="text-transform-none ls-0 text-larger mb-0">{z.name ?? "Zone"}</h3>
                      <p class="text-smaller">{z.excerpt ?? "Zone couverte : pages locales + leviers adaptés."}</p>
                    </div>

                    {villesZone.length > 0 && (
                        <ul class="iconlist ms-3 mt-4 mb-0">
                          {villesZone.map((v) => (
                              <li class="d-block mb-2 text-muted">
                                <a class="link-dark h-text-color" href={villeHref(z.slug, v.slug)}>
                                  <i class="fa-solid fa-arrow-right text-smaller color me-1"></i> {v.name ?? v.slug}
                                </a>
                              </li>
                          ))}
                        </ul>
                    )}

                    <div class="mt-4">
                      <a href={zoneHref(z.slug)} class="button button-rounded text-capitalize m-0 ls-0 w-100">Voir la zone</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        );
      })}
    </div>
  </div>
</div>
  )}
