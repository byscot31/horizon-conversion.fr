---
// src/components/HeroBenefices.astro
import Benefices from "./Benefices.astro";

const { heroData, beneficesData, contexte } = Astro.props;

function fmt(tpl) {
  if (!tpl || typeof tpl !== "string") return "";
  return tpl
    .replaceAll("{service}", contexte?.service?.name ?? "")
    .replaceAll("{ville}", contexte?.ville?.name ?? "")
    .replaceAll("{zone}", contexte?.zone?.name ?? "")
    .replaceAll("{cible}", contexte?.cible?.name ?? "");
}

// ✅ NEW: variante selon contexte.type
const type = contexte?.type;
const variant =
  Array.isArray(heroData?.variants) && type
    ? heroData.variants.find((v) => v?.type === type)
    : null;

const hd = variant ?? (heroData?.defaults ?? heroData ?? {});
const fallbacks = heroData?.fallbacks ?? {};

const badge = fmt(hd.kickerTemplate ?? hd.badgeTemplate) || hd.kicker || fallbacks.kicker || "Horizon Conversion";
const h2 = fmt(hd.titleTemplate) || hd.title || fallbacks.title || "Obtenir plus de demandes";
const p1 = fmt(hd.subtitleTemplate) || hd.subtitle || fallbacks.subtitle || "";
const p2 = fmt(hd.p2Template) || hd.p2 || "";

const cta1 = hd.cta1 ?? { label: hd.primaryCta ?? "Demander un audit (gratuit)", href: "/contact/" };
const cta2 = hd.cta2 ?? { label: hd.secondaryCta ?? "Être rappelé", href: "/contact/" };

const rightTitle = hd.rightTitle ?? "Ce qu’on règle en priorité";
const rightIntro = hd.rightIntro ?? "Les points qui font la différence :";
const rightList = Array.isArray(hd.problems) ? hd.problems : [];
---

<!-- Hero -->
<div class="container mb-5">

  <div class="row align-items-center">
    <div class="col-lg-6">
      <div class="badge rounded-pill badge-default">{badge}</div>
      <h2 class="display-4 fw-bold">{h2}</h2>
      {p1 && <p>{p1}</p>}
      {p2 && <p>{p2}</p>}

      <a href={cta1.href ?? "#"} class="button button-rounded button-large text-transform-none ls-0">
        {cta1.label ?? "Demander un audit (gratuit)"}
      </a>
      <a href={cta2.href ?? "#"} class="button button-rounded button-large button-light text-dark bg-white border text-transform-none ls-0 ms-2">
        {cta2.label ?? "Être rappelé"}
      </a>
    </div>

    <div class="col-lg-6 mt-4 mt-lg-0">
      <div class="card mx-auto mw-md border-0 shadow rounded-4 mb-5 mb-lg-0">
        <div class="card-body p-5">
          <div class="feature-box flex-column">
            <div class="fbox-content">
              <h3 class="text-transform-none ls-0 text-larger">{rightTitle}</h3>
              <p class="text-smaller">{rightIntro}</p>
            </div>

            {rightList.length > 0 && (
                <ul class="iconlist ms-3 mt-4 mb-0">
                  {rightList.slice(0, 6).map((x) => (
                      <li class="mb-2 text-muted">
                        <i class="fa-solid fa-check text-smaller color"></i> {x}
                      </li>
                  ))}
                </ul>
            )}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="clear line my-6"></div>

  {beneficesData && <Benefices data={beneficesData} contexte={contexte} />}
</div>

<div class="clear"></div>
