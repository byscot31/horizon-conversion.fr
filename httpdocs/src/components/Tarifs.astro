---
// src/components/Tarifs.astro
const { data, contexte } = Astro.props;

// data attendu: tarifs.json
const intro = data?.intro ?? {};
const plans = Array.isArray(data?.plans) ? data.plans : (Array.isArray(data?.packs) ? data.packs : []);
const style = data?.style ?? {};

const badge = intro.badge ?? "Tarifs";
const h2 = intro.title ?? "Tarifs simples";
const text = intro.text ?? "On commence par un audit gratuit. Ensuite, vous choisissez un format adapté à votre besoin.";

const backgroundImage = style.backgroundImage ?? "/assets/images/sections/4.png";
const padding = style.padding ?? "140px 0 0";

function priceToParts(p) {
  // accepte "0€", "Sur devis", "1200€", etc.
  if (!p) return { main: "Sur devis", unit: "", tenure: "" };
  const s = String(p).trim();
  // si c’est un nombre ou "1200€"
  const num = s.replace(/[^\d]/g, "");
  if (num && /^\d+$/.test(num)) {
    return { main: num, unit: "€", tenure: "" };
  }
  return { main: s, unit: "", tenure: "" };
}

// rien à afficher si aucun plan
const hasPlans = plans.length > 0;
---

{hasPlans && (
<div class="section m-0" style={`background: url('${backgroundImage}') no-repeat center top; background-size: cover; padding: ${padding};`}>
  <div class="container">
    <div class="row justify-content-between">
      <div class="col-lg-4 mt-4">
        <div class="heading-block border-bottom-0 mb-4">
          <div class="badge rounded-pill badge-default">{badge}</div>
          <h2 class="text-transform-none ls-0">{h2}</h2>
        </div>
        <p>{text}</p>
        {data?.disclaimer && <p class="text-muted small mb-0">{data.disclaimer}</p>}
      </div>

      <div class="col-lg-8">
        <div id="section-pricing" class="page-section p-0 m-0">
          <div id="pricing" class="pricing row align-items-end g-0 col-mb-50 mb-4">

            {plans.slice(0, 3).map((p, idx) => {
              const icon = p.icon ?? (idx === 0 ? "/assets/images/icons/man.svg" : "/assets/images/icons/group.svg");
              const iconWidth = p.iconWidth ?? (idx === 0 ? 50 : 60);
              const price = priceToParts(p.price);
              const highlight = !!p.highlight;
              const cta = p.cta ?? { label: "Demander un audit (gratuit)", href: "/contact/" };

              return (
                  <div class="col-md-6">
                    <div class={`pricing-box ${highlight ? "best-price" : ""}`}>
                      <div class="pricing-title">
                        <img class="mb-2 bg-transparent rounded-0" src={icon} alt="Pricing Icon" width={iconWidth} />
                        <h3>{p.name ?? "Offre"}</h3>
                        {p.badge && <span>{p.badge}</span>}
                      </div>

                      <div class="pricing-price">
                        {price.main}
                        {price.unit && <span class="price-unit">{price.unit}</span>}
                        {p.tenure && <span class="price-tenure">{p.tenure}</span>}
                      </div>

                      <div class="pricing-features border-0 bg-transparent">
                        <ul>
                          {(Array.isArray(p.includes) ? p.includes : []).slice(0, 6).map((it) => (
                              <li>
                                <i class="fa-solid fa-check-circle color me-2"></i>
                                {it}
                              </li>
                          ))}
                        </ul>
                      </div>

                      <div class="pricing-action">
                        <a
                            href={cta.href ?? "#"}
                            class={`button button-large button-rounded w-100 m-0 ls-0 ${
                              highlight ? "text-capitalize" : "button-light text-dark bg-white border text-transform-none"
                            }`}
                        >
                          {cta.label ?? "Demander un audit (gratuit)"}
                        </a>
                      </div>
                    </div>
                  </div>
              );
            })}

          </div>
        </div>
      </div>

    </div>
  </div>
</div>
  )}
