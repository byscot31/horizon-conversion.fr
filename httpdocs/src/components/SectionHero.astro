---
// src/components/SectionHero.astro
type Cta = { label: string; href: string };

interface ServiceData {
  slug: string;
  nom: string;
  h1?: string;
  promesse?: string;
  positionnement?: "consultant" | "agence";
  problemes?: string[];
  livrables?: string[];
  heroImage?: string; // optionnel si tu veux une image
}

interface VilleData {
  slug: string;
  nom: string;
  codePostal: string;
  zone: string;
  tier?: "volume" | "premium";
  alentours?: string[];
  specificites?: string;
}

interface Props {
  service: ServiceData;
  ville?: VilleData;

  // overrides optionnels
  badge?: string;
  title?: string; // h2
  lead?: string;  // 1er paragraphe
  body?: string;  // 2e paragraphe (optionnel)

  primaryCta?: Cta;
  secondaryCta?: Cta;

  // card droite
  cardTitle?: string;
  cardText?: string;
  cardItems?: string[];

  // affichage
  showDivider?: boolean;
}

const {
  service,
  ville,

  badge,
  title,
  lead,
  body,

  primaryCta,
  secondaryCta,

  cardTitle,
  cardText,
  cardItems,

  showDivider = true
} = Astro.props as Props;

const isCityPage = Boolean(ville);
const isVolume = ville?.tier === "volume";
const isPremium = ville?.tier === "premium";

const computedBadge = badge ?? (isCityPage ? `${service.nom} • ${ville!.nom}` : service.nom);

const computedTitle =
  title ??
  (isCityPage
    ? `${service.nom} à ${ville!.nom}`
    : (service.h1 ?? `${service.nom} : plus de demandes locales`));

const around = (ville?.alentours ?? []).slice(0, 5).join(", ");

const computedLead =
  lead ??
  (isCityPage
    ? `${service.promesse ?? "Un plan concret pour générer des demandes locales."} À ${ville!.nom} (${ville!.codePostal}).`
    : `${service.promesse ?? "On transforme votre visibilité en appels et demandes, avec des livrables clairs et un suivi mensuel."}`);

const computedBody =
  body ??
  (isCityPage
    ? [
        ville?.specificites ? `${ville!.specificites}` : "",
        around ? `Intervention aussi autour de ${around}.` : "",
        service.positionnement
          ? (service.positionnement === "consultant"
              ? "Mode consultant : pilotage, priorités, mesure."
              : "Mode agence : production, cohérence, qualité perçue.")
          : ""
      ].filter(Boolean).join(" ")
    : (service.positionnement
        ? (service.positionnement === "consultant"
            ? "Approche consultant : on priorise, on mesure, on optimise. Objectif : des demandes exploitables."
            : "Approche agence : on produit et on aligne message, preuves et parcours pour convertir durablement.")
        : "On avance avec un plan clair, des livrables et un rythme mensuel."
      )
  );

// CTA par défaut → contact avec query params
const contactHref = isCityPage
  ? `/contact?service=${encodeURIComponent(service.slug)}&ville=${encodeURIComponent(ville!.slug)}`
  : `/contact?service=${encodeURIComponent(service.slug)}`;

const ctaPrimary = primaryCta ?? { label: "Demander un audit gratuit", href: contactHref };
const ctaSecondary = secondaryCta ?? { label: "Être rappelé", href: contactHref };

// Card droite : texte + items adaptés
const computedCardTitle =
  cardTitle ??
  (isCityPage
    ? (isPremium ? "Ce qu’on soigne en priorité" : "Plan 30 jours (priorités)")
    : "Ce que vous recevez");

const computedCardText =
  cardText ??
  (isCityPage
    ? (isPremium
        ? "Objectif : confiance, cohérence et demandes plus qualifiées."
        : "Objectif : générer des demandes rapidement, puis stabiliser.")
    : "Des livrables concrets. Un suivi simple. Des décisions basées sur les chiffres.");

const fallbackItems =
  (service.livrables && service.livrables.length ? service.livrables : service.problemes) ?? [];

const computedItems =
  (cardItems && cardItems.length ? cardItems : fallbackItems).slice(0, 6);
---

<div class="container">
  <div class="row align-items-center">
    <div class="col-lg-6">
      <div class="badge rounded-pill badge-default">{computedBadge}</div>

      <h2 class="display-4 fw-bold">{computedTitle}</h2>

      <p>{computedLead}</p>

      {computedBody ? <p class="text-muted">{computedBody}</p> : null}

      <a href={ctaPrimary.href} class="button button-rounded button-large text-transform-none ls-0">
        {ctaPrimary.label}
      </a>

      <a
        href={ctaSecondary.href}
        class="button button-rounded button-large button-light text-dark bg-white border text-transform-none ls-0"
      >
        {ctaSecondary.label}
      </a>
    </div>

    <div class="col-lg-6 mt-4 mt-lg-0">
      <div class="card shadow-sm">
        <div class="card-body">
          <h3 class="mb-3">{computedCardTitle}</h3>
          <p class="text-muted">{computedCardText}</p>

          {computedItems.length ? (
            <ul class="iconlist ms-3 mt-4 mb-0">
              {computedItems.map((it) => (
                <li class="mb-2 text-muted">
                  <i class="fa-solid fa-check text-smaller color"></i> {it}
                </li>
              ))}
            </ul>
          ) : null}
        </div>
      </div>
    </div>
  </div>

  {showDivider ? <div class="clear line my-6"></div> : null}
</div>