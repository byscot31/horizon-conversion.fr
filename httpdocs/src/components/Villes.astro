---
// src/components/Villes.astro
import { resolveAroundLinks } from "../lib/seoRules";

const { data, zone, contexte, config } = Astro.props;

const villes = Array.isArray(data) ? data : (data?.items ?? []);
const max = config?.max ?? 12;

const badge = config?.badge ?? "Villes";
const h2 = config?.title ?? `Villes dans ${zone?.name ?? ""}`;
const subtitle = config?.subtitle ?? "Choisissez votre ville";

if (!villes.length || !zone?.slug) {
  // rien à afficher
}
---

{villes.length > 0 && zone?.slug && (
<div class="section mt-0">
  <div class="container">
    <div class="heading-block border-bottom-0 text-center">
      <div class="badge rounded-pill badge-default">{badge}</div>
      <h2 class="text-transform-none ls-0">{h2}</h2>
      <span>{subtitle}</span>
    </div>

    <div class="row col-mb-30 align-content-stretch">
      {villes.slice(0, max).map((v) => {
        const aroundResolved = resolveAroundLinks(v?.around, villes, { zoneSlug: zone.slug });

        return (
            <div class="col-md-4 d-flex">
              <div class="card w-100">
                <div class="card-body p-5">
                  <div class="feature-box flex-column">
                    <div class="fbox-content">
                      <h3 class="text-transform-none ls-0 text-larger">
                        <a href={`/zones/${zone.slug}/${v.slug}/`} class="link-dark h-text-color">
                          {v.name ?? v.slug}
                        </a>
                      </h3>
                      <p class="text-smaller">{v.excerpt ?? "Pages locales + suivi des demandes + leviers adaptés."}</p>
                    </div>

                    {/* Villes proches (alentours) : lien seulement si match dans villes.json */}
                    {Array.isArray(aroundResolved) && aroundResolved.length > 0 && (
                        <div class="mt-4">
                          <div class="text-muted small mb-2">Villes proches</div>
                          <ul class="iconlist ms-3 mb-0">
                            {aroundResolved.slice(0, 6).map((x) => (
                                <li class="d-block mb-2 text-muted">
                                  {x.href ? (
                                      <a href={x.href} class="link-dark h-text-color">
                                        <i class="fa-solid fa-arrow-right text-smaller color me-1"></i> {x.label}
                                      </a>
                                  ) : (
                                      <>
                                        <i class="fa-solid fa-arrow-right text-smaller color me-1"></i> {x.label}
                                      </>
                                  )}
                                </li>
                            ))}
                          </ul>
                        </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
        );
      })}
    </div>
  </div>
</div>
  )}
