---
// src/components/ServicesZones.astro
import mappingCocon from "../lib/mappingCocon";
import { pickServicesUniques, buildServiceHref } from "../lib/seoRules";

const { data, contexte, config, max } = Astro.props;

// data peut être un tableau ou { items: [...] }
const services = Array.isArray(data) ? data : (data?.items ?? []);
if (!services.length) {
  // rien à afficher si vide
}

const badge = config?.badge ?? "Services utiles";
const h2 = config?.title ?? "Services utiles";
const subtitle = config?.subtitle ?? "Choisir un levier";

const maxItems = typeof max === "number" ? max : (config?.maxItems ?? 6);

// 1) on choisit les slugs à afficher (focus -> secondary -> defaults)
// 2) on map vers les objets service
const wantedSlugs = pickServicesUniques({
  contexte,
  mappingCibles: mappingCocon,
  defaults: mappingCocon.defaults,
  max: maxItems,
});

const picked = wantedSlugs
  .map((slug) => services.find((s) => s?.slug === slug))
  .filter(Boolean);
---

{picked.length > 0 && (
<div class="section mt-0">
  <div class="container">

    <div class="heading-block border-bottom-0 text-center">
      <div class="badge rounded-pill badge-default">{badge}</div>
      <h2 class="text-transform-none ls-0">{h2}</h2>
      <span>{subtitle}</span>
    </div>

    <div class="row col-mb-30 align-content-stretch">
      {picked.map((s) => (
          <div class="col-md-4 d-flex">
            <div class="card w-100">
              <div class="card-body p-5">
                <div class="feature-box flex-column">
                  <div class="fbox-image mb-5 text-center">
                    <img height="150" src={s.icon ?? "/assets/images/services/seo.svg"} alt={s.name ?? "Service"} />
                  </div>

                  <div class="fbox-content">
                    <h3 class="text-transform-none ls-0 text-larger">
                      <a class="link-dark h-text-color" href={buildServiceHref(contexte, s.slug)}>
                        {s.name ?? "Service"}
                      </a>
                    </h3>
                    <p class="text-smaller">{s.excerpt ?? ""}</p>
                  </div>

                  {Array.isArray(s.bullets) && s.bullets.length > 0 && (
                      <ul class="iconlist ms-3 mt-4 mb-0">
                        {s.bullets.slice(0, 5).map((b) => (
                            <li class="d-block mb-2 text-muted">
                              <i class="fa-solid fa-check text-smaller color me-1"></i> {b}
                            </li>
                        ))}
                      </ul>
                  )}

                  <div class="mt-4">
                    <a href={buildServiceHref(contexte, s.slug)} class="button button-rounded text-capitalize m-0 ls-0">Voir le service</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
      ))}
    </div>
  </div>
</div>
  )}