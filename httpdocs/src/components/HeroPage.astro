---
// src/components/HeroPage.astro
const { data, contexte, cta } = Astro.props;

function fmt(tpl) {
  if (!tpl || typeof tpl !== "string") return "";
  return tpl
    .replaceAll("{service}", contexte?.service?.name ?? "")
    .replaceAll("{ville}", contexte?.ville?.name ?? "")
    .replaceAll("{zone}", contexte?.zone?.name ?? "")
    .replaceAll("{cible}", contexte?.cible?.name ?? "");
}

// ✅ NEW: variante selon contexte.type
const type = contexte?.type;
const variant =
  Array.isArray(data?.variants) && type
    ? data.variants.find((v) => v?.type === type)
    : null;

const d = variant ?? (data?.defaults ?? data ?? {});
const fallbacks = data?.fallbacks ?? {};

const badge =
  fmt(d.badgeTemplate ?? d.kickerTemplate) || d.badge || fallbacks.kicker || "Horizon Conversion";
const h2 =
  fmt(d.h2Template ?? d.titleTemplate) || d.h2 || fallbacks.title || "Obtenir plus de demandes";
const p1 =
  fmt(d.p1Template ?? d.subtitleTemplate) ||
  d.p1 ||
  fallbacks.subtitle ||
  "Audit gratuit, plan clair, mise en place simple.";
const p2 = fmt(d.p2Template) || d.p2 || "";

// CTA (priorité: variant -> defaults -> fallback)
const cta1 = d.cta1 ?? { label: d.primaryCta ?? "Demander un audit (gratuit)", href: "/contact/" };
const cta2 = d.cta2 ?? { label: d.secondaryCta ?? "Être rappelé", href: "/contact/" };

const rightTitle = d.rightTitle ?? "Points fréquents";
const rightIntro = d.rightIntro ?? "Ce qu’on règle en priorité :";
const problems = Array.isArray(d.problems) ? d.problems : [];
---

<!-- Hero -->
<div class="row align-items-center">
  <div class="col-lg-6">
    <div class="badge rounded-pill badge-default">{badge}</div>
    <h2 class="display-4 fw-bold">{h2}</h2>
    <p>{p1}</p>
    {p2 && <p>{p2}</p>}

    <a href={cta1.href ?? "#"} class="button button-rounded button-large text-transform-none ls-0">
      {cta1.label ?? "Demander un audit (gratuit)"}
    </a>
    <a
        href={cta2.href ?? "#"}
        class="button button-rounded button-large button-light text-dark bg-white border text-transform-none ls-0 ms-2"
    >
      {cta2.label ?? "Être rappelé"}
    </a>
  </div>

  <div class="col-lg-6 mt-4 mt-lg-0">
    <div class="card mx-auto mw-md border-0 shadow rounded-4 mb-5 mb-lg-0">
      <div class="card-body p-5">
        <div class="feature-box flex-column">
          <div class="fbox-content">
            <h3 class="text-transform-none ls-0 text-larger">{rightTitle}</h3>
            <p class="text-smaller">{rightIntro}</p>
          </div>

          {problems.length > 0 && (
              <ul class="iconlist ms-3 mt-4 mb-0">
                {problems.slice(0, 6).map((x) => (
                    <li class="d-block mb-2 text-muted">
                      <i class="fa-solid fa-check text-smaller color me-1"></i> {x}
                    </li>
                ))}
              </ul>
          )}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="clear line my-6"></div>
