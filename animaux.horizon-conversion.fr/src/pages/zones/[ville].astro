---
// src/pages/zones/[ville].astro
import LayoutSEO from "../../layouts/LayoutSEO.astro";
import {
  ZONES,
  VILLES,
  slugifyCity,
  findCityBySlug,
  type ZoneKey,
} from "../../data/zones.ts";
import { JOBS } from "../../data/jobs.ts";
import { SERVICES } from "../../data/services.ts";
import { getZoneFaq } from "../../data/faq-zones.ts";

export const prerender = true;

const baseUrl = "https://animaux.horizon-conversion.fr";

export function getStaticPaths() {
  return VILLES.map((v) => ({
    params: { ville: slugifyCity(v.town) },
    props: v,
  }));
}

const { ville } = Astro.params as { ville: string };
const props = Astro.props as { town?: string; zoneKey?: ZoneKey };

const resolved =
  props?.town && props?.zoneKey
    ? {
        town: props.town,
        zoneKey: props.zoneKey,
        slug: ville,
        zone: ZONES[props.zoneKey],
      }
    : findCityBySlug(ville);

if (!resolved) throw new Error(`Ville inconnue: ${ville}`);

const { town, zoneKey, zone, slug } = resolved;

const canonical = `${baseUrl}${Astro.url.pathname}`;

// SEO
const title = `${town} | SEO local & Ads pros animaux – Horizon Conversion`;
const description = `Acquisition locale à ${town} : SEO local, Google Maps, Ads, landing pages, conversion & tracking. Zone : ${zone.name}.`;

const breadcrumbs = [
  { name: "Accueil", item: `${baseUrl}/` },
  { name: "Zones", item: `${baseUrl}/zones/` },
  { name: zone.name, item: `${baseUrl}/zones/${zoneKey}/` },
  { name: town, item: canonical },
];

// ✅ VRAIES pages (money) : /zones/{ville}/{metier}/
const jobEntries = Object.entries(JOBS) as Array<[string, any]>;
const metierLinks = jobEntries.map(([metierSlug, job]) => ({
  metierSlug,
  name: job.name as string,
  href: `/zones/${slug}/${metierSlug}/`,
}));

// ✅ VRAIES pages (money) : /zones/{ville}/services/{service}/
const serviceEntries = Object.entries(SERVICES) as Array<[string, any]>;
const serviceCityLinks = serviceEntries.map(([serviceSlug, svc]) => ({
  serviceSlug,
  label: svc.name as string,
  href: `/zones/${slug}/services/${serviceSlug}/`,
}));

// (Optionnel) liens vers pages “prestations” (globales)
const prestationsLinks = [
  { href: "/prestations/seo-local/", label: "Prestation : SEO local & Google Maps" },
  { href: "/prestations/google-ads/", label: "Prestation : Google Ads (Search)" },
  { href: "/prestations/meta-ads/", label: "Prestation : Meta Ads" },
  { href: "/prestations/landing-pages/", label: "Prestation : Landing pages" },
  { href: "/prestations/tracking/", label: "Prestation : Tracking" },
  { href: "/tarifs/", label: "Tarifs / Packs" },
];

// Autres villes de la même zone
const otherTowns = (zone.towns as string[])
  .filter((t) => slugifyCity(t) !== slug)
  .slice(0, 12)
  .map((t) => ({ name: t, href: `/zones/${slugifyCity(t)}/` }));

// ✅ FAQ contextualisée par zoneKey (60 vs 95) + ville
const faqs = getZoneFaq(zoneKey, town, zone.name);

const faqJsonLd =
  faqs.length
    ? {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        mainEntity: faqs.map((f) => ({
          "@type": "Question",
          name: f.q,
          acceptedAnswer: { "@type": "Answer", text: f.a },
        })),
      }
    : null;

const jsonLd = [
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    name: title,
    url: canonical,
    description,
    isPartOf: { "@type": "WebSite", name: "Horizon Conversion Animaux", url: baseUrl },
  },
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: breadcrumbs.map((b, i) => ({
      "@type": "ListItem",
      position: i + 1,
      name: b.name,
      item: b.item,
    })),
  },
  // ✅ ItemList métier×ville
  {
    "@context": "https://schema.org",
    "@type": "ItemList",
    name: `Pages métier × ${town}`,
    itemListElement: metierLinks.slice(0, 30).map((m, i) => ({
      "@type": "ListItem",
      position: i + 1,
      name: `${m.name} à ${town}`,
      url: `${baseUrl}${m.href}`,
    })),
  },
  // ✅ ItemList service×ville
  {
    "@context": "https://schema.org",
    "@type": "ItemList",
    name: `Pages service × ${town}`,
    itemListElement: serviceCityLinks.slice(0, 30).map((s, i) => ({
      "@type": "ListItem",
      position: i + 1,
      name: `${s.label} à ${town}`,
      url: `${baseUrl}${s.href}`,
    })),
  },
  ...(faqJsonLd ? [faqJsonLd] : []),
];
---

<LayoutSEO
  title={title}
  description={description}
  baseUrl={baseUrl}
  canonical={canonical}
  ogType="website"
  ogImage={`${baseUrl}/og/ville-${slug}.jpg`}
  ogImageAlt={`SEO local & Ads à ${town}`}
  breadcrumbs={breadcrumbs}
  jsonLd={jsonLd}
>
  <style>
    .wrap { max-width: 1040px; margin: 0 auto; padding: 28px 16px 72px; }
    .breadcrumbs { font-size: 14px; color: #475569; margin: 4px 0 18px; }
    .breadcrumbs a { color: inherit; text-decoration: none; }

    header.hero {
      border: 1px solid #e2e8f0;
      border-radius: 18px;
      background: linear-gradient(180deg, #f8fafc, #fff);
      padding: 22px;
      display: grid;
      gap: 10px;
    }
    h1 { margin: 0; font-size: 34px; line-height: 1.1; letter-spacing: -0.02em; }
    .sub { margin: 0; color: #334155; max-width: 92ch; line-height: 1.6; }

    .grid {
      margin-top: 18px;
      display: grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap: 18px;
      align-items: start;
    }
    @media (max-width: 920px) { .grid { grid-template-columns: 1fr; } }

    .card {
      border: 1px solid #e2e8f0;
      border-radius: 18px;
      padding: 18px;
      background: #fff;
      box-shadow: 0 6px 20px rgba(15, 23, 42, 0.06);
    }

    h2 { margin: 0 0 10px; font-size: 18px; }
    h3 { margin: 16px 0 10px; font-size: 15px; }
    p { margin: 0; color: #334155; line-height: 1.6; }

    .note {
      margin-top: 12px;
      border: 1px dashed #cbd5e1;
      border-radius: 16px;
      padding: 14px;
      background: #f8fafc;
      color: #334155;
      line-height: 1.6;
    }

    .pills { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .pill {
      display: inline-block;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e2e8f0;
      background: #fff;
      color: #334155;
      text-decoration: none;
    }
    .pill:hover { background: #f8fafc; }

    .list { margin: 10px 0 0; padding-left: 18px; color: #334155; line-height: 1.55; }

    .ctaRow {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 720px) { .ctaRow { grid-template-columns: 1fr; } }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid #0f172a;
      background: #0f172a;
      color: #fff;
      cursor: pointer;
      font-weight: 900;
      text-decoration: none;
    }
    .btn.secondary { background: #fff; color: #0f172a; }

    .meta { color: #475569; font-size: 14px; line-height: 1.6; margin-top: 10px; }
    .link {
      color: #0f172a;
      text-decoration: none;
      border-bottom: 1px solid rgba(15, 23, 42, 0.18);
    }
    .link:hover { border-bottom-color: rgba(15, 23, 42, 0.45); }

    .block {
      margin-top: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 14px;
      background: #fff;
    }
    .block ul { margin: 10px 0 0; padding-left: 18px; }

    /* ✅ FAQ */
    .faq{margin-top:16px}
    .faq details{border:1px solid #e2e8f0;border-radius:16px;padding:12px 14px;background:#fff;margin-bottom:10px}
    .faq summary{cursor:pointer;font-weight:900}
    .faq p{margin:10px 0 0}
  </style>

  <div class="wrap">
    <nav class="breadcrumbs" aria-label="Fil d’Ariane">
      <a href="/">Accueil</a> <span aria-hidden="true">›</span>{" "}
      <a href="/zones/">Zones</a> <span aria-hidden="true">›</span>{" "}
      <a href={`/zones/${zoneKey}/`}>{zone.name}</a> <span aria-hidden="true">›</span>{" "}
      <span>{town}</span>
    </nav>

    <header class="hero">
      <h1>{town}</h1>
      <p class="sub">
        Stratégie locale orientée résultats à <strong>{town}</strong> :
        <strong> SEO local</strong> + <strong>Google Maps</strong> + <strong>Ads</strong>,
        avec des pages dédiées (métier × ville, service × ville) et un tracking propre.
        Zone : <strong>{zone.name}</strong>.
      </p>
    </header>

    <section class="grid">
      <div class="card">
        <h2>Comment on génère des demandes locales à {town}</h2>
        <p>
          Le combo le plus efficace : base SEO local (pages + schémas) + Google Business Profile optimisée,
          puis Ads sur les intentions les plus rentables (pilotage au coût par lead).
        </p>

        <div class="note">
          <strong>Anti “placeholder” :</strong> on affiche des <strong>liens vers des pages réelles</strong>
          (métier × ville + service × ville) pour renforcer la valeur SEO et la compréhension du cluster.
        </div>

        <h2 style="margin-top:16px;">Pages métier × {town}</h2>
        <div class="pills" aria-label="Pages métier × ville">
          {metierLinks.map((m) => (
            <a class="pill" href={m.href}>{m.name} à {town}</a>
          ))}
        </div>

        <h2 style="margin-top:16px;">Pages service × {town}</h2>
        <div class="pills" aria-label="Pages service × ville">
          {serviceCityLinks.map((s) => (
            <a class="pill" href={s.href}>{s.label} à {town}</a>
          ))}
        </div>

        <h3>Prestations (pages générales)</h3>
        <div class="pills" aria-label="Prestations">
          {prestationsLinks.map((s) => (
            <a class="pill" href={s.href}>{s.label}</a>
          ))}
        </div>

        <div class="ctaRow">
          <a class="btn" href="/contact/">Demander un diagnostic</a>
          <a class="btn secondary" href="tel:+33660921008">Appeler : 06 60 92 10 08</a>
        </div>

        <p class="meta">
          Email : <a class="link" href="mailto:contact@horizon-conversion.fr">contact@horizon-conversion.fr</a>
        </p>

        {faqs.length > 0 && (
          <div class="faq" id="faq">
            <h2 style="margin:0 0 10px;">FAQ locale (parking / circulation / saisonnalité)</h2>
            {faqs.map((f) => (
              <details>
                <summary>{f.q}</summary>
                <p>{f.a}</p>
              </details>
            ))}
          </div>
        )}
      </div>

      <aside class="card">
        <h2>Récap : liens utiles</h2>

        <div class="block">
          <h3 style="margin:0;">Métiers à {town}</h3>
          <ul class="list">
            {metierLinks.map((m) => (
              <li><a class="link" href={m.href}>{m.name} à {town}</a></li>
            ))}
          </ul>
        </div>

        <div class="block">
          <h3 style="margin:0;">Services à {town}</h3>
          <ul class="list">
            {serviceCityLinks.map((s) => (
              <li><a class="link" href={s.href}>{s.label} à {town}</a></li>
            ))}
          </ul>
        </div>

        <h2 style="margin-top:16px;">Autres villes de {zone.name}</h2>
        <div class="pills" aria-label="Autres villes">
          {otherTowns.map((t) => (
            <a class="pill" href={t.href}>{t.name}</a>
          ))}
        </div>

        <h2 style="margin-top:16px;">Raccourcis</h2>
        <div class="pills" aria-label="Raccourcis">
          <a class="pill" href={`/zones/${zoneKey}/`}>{zone.name}</a>
          <a class="pill" href="/metiers/">Métiers</a>
          <a class="pill" href="/prestations/">Prestations</a>
          <a class="pill" href="/tarifs/">Tarifs</a>
        </div>
      </aside>
    </section>
  </div>
</LayoutSEO>