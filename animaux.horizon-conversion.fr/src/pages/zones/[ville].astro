---
import LayoutSEO from "../../layouts/LayoutSEO.astro";
import { VILLES, ZONES, slugifyCity, findCityBySlug, type ZoneKey } from "../../data/zones.ts";

export const prerender = true;

const baseUrl = "https://animaux.horizon-conversion.fr";

export function getStaticPaths() {
  return VILLES.map((v) => ({
    params: { ville: slugifyCity(v.town) },
    props: { town: v.town, zoneKey: v.zoneKey },
  }));
}

const { ville } = Astro.params as { ville: string };

// On récupère via props si dispo (plus fiable), sinon fallback via slug
const props = Astro.props as { town?: string; zoneKey?: ZoneKey };
const resolved =
  props?.town && props?.zoneKey
    ? { town: props.town, zone: ZONES[props.zoneKey], slug: ville, zoneKey: props.zoneKey }
    : findCityBySlug(ville);

if (!resolved) throw new Error(`Ville inconnue: ${ville}`);

const { town, zone, zoneKey, slug } = resolved;

const canonical = `${baseUrl}${Astro.url.pathname}`;

// SEO
const title = `${town} | ${zone.name} – Horizon Conversion Animaux`;
const description =
  `Webmarketing local à ${town} : SEO local & Google Maps, pages “1 intention = 1 page”, Google Ads & Meta Ads, conversion & tracking. Zone : ${zone.name}.`;

const breadcrumbs = [
  { name: "Accueil", item: `${baseUrl}/` },
  { name: "Zones", item: `${baseUrl}/zones/` },
  // si tu as déjà des pages /zones/sud-oise-60/ et /zones/val-doise-95/
  { name: zone.name, item: `${baseUrl}/zones/${zoneKey}/` },
  { name: town, item: canonical },
];

// JSON-LD
const jsonLd = [
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    name: title,
    url: canonical,
    description,
    isPartOf: { "@type": "WebSite", name: "Horizon Conversion Animaux", url: baseUrl },
  },
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: breadcrumbs.map((b, i) => ({
      "@type": "ListItem",
      position: i + 1,
      name: b.name,
      item: b.item,
    })),
  },
  {
    "@context": "https://schema.org",
    "@type": "Service",
    name: `Webmarketing local à ${town}`,
    areaServed: [town, zone.name],
    provider: {
      "@type": "Organization",
      name: "Horizon Conversion Animaux",
      url: baseUrl,
      telephone: "+33660921008",
      email: "contact@horizon-conversion.fr",
    },
  },
];

// Contenu “SEO local” (exemples)
const intentExamples = [
  `éducateur canin ${town}`,
  `toiletteur chien ${town}`,
  `pension canine ${town}`,
  `comportementaliste chien ${town}`,
  `ostéopathe animalier ${town}`,
];
---

<LayoutSEO
  title={title}
  description={description}
  baseUrl={baseUrl}
  canonical={canonical}
  ogType="website"
  ogImage={`${baseUrl}/og/ville-${slug}.jpg`}
  ogImageAlt={`Webmarketing local à ${town}`}
  breadcrumbs={breadcrumbs}
  jsonLd={jsonLd}
>

<style>
  :global(body){margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;color:#0f172a;background:#fff}
  .wrap{max-width:1040px;margin:0 auto;padding:28px 16px 72px}
  .breadcrumbs{font-size:14px;color:#475569;margin:4px 0 18px}
  .breadcrumbs a{color:inherit;text-decoration:none}
  header.hero{border:1px solid #e2e8f0;border-radius:18px;background:linear-gradient(180deg,#f8fafc,#fff);padding:22px;display:grid;gap:10px}
  h1{margin:0;font-size:34px;line-height:1.1;letter-spacing:-0.02em}
  .sub{margin:0;color:#334155;max-width:92ch;line-height:1.6}
  .grid{margin-top:18px;display:grid;grid-template-columns:1.15fr .85fr;gap:18px;align-items:start}
  @media (max-width:920px){.grid{grid-template-columns:1fr}}
  .card{border:1px solid #e2e8f0;border-radius:18px;padding:18px;background:#fff;box-shadow:0 6px 20px rgba(15,23,42,.06)}
  h2{margin:0 0 10px;font-size:18px}
  p{margin:0;color:#334155;line-height:1.6}
  ul{margin:10px 0 0;padding-left:18px;color:#334155;line-height:1.55}
  .pills{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .pill{display:inline-block;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #e2e8f0;background:#fff;color:#334155}
  .ctaRow{margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:720px){.ctaRow{grid-template-columns:1fr}}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 14px;border-radius:14px;border:1px solid #0f172a;background:#0f172a;color:#fff;cursor:pointer;font-weight:900;text-decoration:none}
  .btn.secondary{background:#fff;color:#0f172a}
  .meta{color:#475569;font-size:14px;line-height:1.6;margin-top:10px}
  .badge{display:inline-block;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #e2e8f0;background:#f1f5f9;color:#334155;font-weight:900;width:fit-content}
</style>

<div class="wrap">
  <nav class="breadcrumbs" aria-label="Fil d’Ariane">
    <a href="/">Accueil</a> <span aria-hidden="true">›</span>{" "}
    <a href="/zones/">Zones</a> <span aria-hidden="true">›</span>{" "}
    <a href={`/zones/${zoneKey}/`}>{zone.name}</a> <span aria-hidden="true">›</span>{" "}
    <span>{town}</span>
  </nav>

  <header class="hero">
    <span class="badge">{zone.deptLabel}</span>
    <h1>{town}</h1>
    <p class="sub">
      Stratégie locale pour les professionnels des animaux à <strong>{town}</strong> :
      <strong> SEO local</strong> + <strong>Google Maps</strong> + <strong>Ads</strong>,
      avec des pages “<strong>1 intention = 1 page</strong>” et un tracking propre.
    </p>
  </header>

  <section class="grid">
    <div class="card">
      <h2>Ce qu’on met en place à {town}</h2>
      <ul>
        <li>Pages locales dédiées (métier + {town} + service) + FAQ + JSON-LD</li>
        <li>Optimisation Google Business Profile (catégories, services, zones)</li>
        <li>Campagnes Ads orientées RDV (Google/Meta) + exclusions anti-parasites</li>
        <li>Tracking : appels, formulaires, sources (SEO/Maps/Ads)</li>
      </ul>

      <h2 style="margin-top:16px;">Exemples d’intentions locales</h2>
      <div class="pills" aria-label="Intentions locales">
        {intentExamples.map((x) => <span class="pill">{x}</span>)}
      </div>

      <div class="ctaRow">
        <a class="btn" href="/contact/">Demander un diagnostic</a>
        <a class="btn secondary" href="tel:+33660921008">Appeler : 06 60 92 10 08</a>
      </div>

      <p class="meta">
        Email :{" "}
        <a
          href="mailto:contact@horizon-conversion.fr"
          style="color:#0f172a;text-decoration:none;border-bottom:1px solid rgba(15,23,42,.2);"
        >
          contact@horizon-conversion.fr
        </a>
      </p>
    </div>

    <aside class="card">
      <h2>Zone</h2>
      <p>{zone.headline}</p>

      <h2 style="margin-top:16px;">Villes proches</h2>
      <div class="pills" aria-label="Villes proches">
        {zone.towns
          .filter((t) => t !== town)
          .slice(0, 10)
          .map((t) => (
            <a class="pill" href={`/zones/${slugifyCity(t)}/`} style="text-decoration:none;">
              {t}
            </a>
          ))}
      </div>

      <h2 style="margin-top:16px;">Preuves sans avis</h2>
      <p>Process visible, livrables, tracking et transparence.</p>
      <div class="pills">
        <span class="pill">Process</span>
        <span class="pill">Livrables</span>
        <span class="pill">Tracking</span>
        <span class="pill">Qualif stricte</span>
      </div>
    </aside>
  </section>
</div>