---
// src/pages/zones/[ville]/services/[service].astro
import LayoutSEO from "../../../../layouts/LayoutSEO.astro";
import { SERVICES, type ServiceKey } from "../../../../data/services.ts";
import {
  VILLES,
  ZONES,
  slugifyCity,
  findCityBySlug,
  type ZoneKey,
} from "../../../../data/zones.ts";
import { JOBS } from "../../../../data/jobs.ts";

export const prerender = true;
const baseUrl = "https://animaux.horizon-conversion.fr";

export function getStaticPaths() {
  const serviceKeys = Object.keys(SERVICES) as ServiceKey[];
  const paths = [];
  for (const v of VILLES) {
    const villeSlug = slugifyCity(v.town);
    for (const service of serviceKeys) {
      paths.push({
        params: { ville: villeSlug, service },
        props: { town: v.town, zoneKey: v.zoneKey, service },
      });
    }
  }
  return paths;
}

const { ville, service } = Astro.params as { ville: string; service: string };
const props = Astro.props as { town?: string; zoneKey?: ZoneKey; service?: ServiceKey };

const resolvedCity =
  props?.town && props?.zoneKey
    ? { town: props.town, zoneKey: props.zoneKey, zone: ZONES[props.zoneKey], slug: ville }
    : findCityBySlug(ville);

if (!resolvedCity) throw new Error(`Ville inconnue: ${ville}`);

const serviceKey = service as ServiceKey;
const svc = (SERVICES as any)[serviceKey] as (typeof SERVICES)[ServiceKey] | undefined;
if (!svc) throw new Error(`Service inconnu: ${service}`);

const { town, zoneKey, zone, slug } = resolvedCity;
const canonical = `${baseUrl}${Astro.url.pathname}`;

// ---------- Contenu "anti pages similaires" : blocs variables (zone + service) ----------
type FaqItem = { q: string; a: string };
type MiniKpi = { label: string; value: string; note?: string };

const getZoneContext = (zk: ZoneKey, townName: string) => {
  const common = {
    intro: `Contexte local : on ancre la stratégie sur la réalité terrain (déplacements, zones couvertes, contraintes).`,
    nearbyLabel: "Villes proches (selon zone de déplacement réelle)",
  };

  if (zk === ("val-doise-95" as any)) {
    return {
      ...common,
      density: "Zone dense & souvent concurrentielle",
      travel: {
        radius: "≈ 10–25 km (à resserrer si agenda chargé)",
        notes: [
          "Circulation : créneaux serrés → favoriser la prise de RDV + formulaires qualifiants.",
          "Stationnement : adapter les horaires / promesses (ex : “RDV rapides” vs “plages longues”).",
          "Concurrence : pages plus “spécifiques” (prix/process/FAQ) + Ads si besoin.",
        ],
      },
      seasonality: [
        `Saisonnalité fréquente (vacances / week-ends) : anticiper avec pages dédiées + planning GBP.`,
        `À ${townName}, on évite d’élargir trop la zone : mieux vaut une pertinence forte.`,
      ],
    };
  }

  // sud-oise-60 (par défaut)
  return {
    ...common,
    density: "Zone plus “étalée” (déplacements = vrai sujet)",
    travel: {
      radius: "≈ 15–30 km (à ajuster selon service & logistique)",
      notes: [
        "Déplacements : lister clairement les communes couvertes pour éviter les demandes hors secteur.",
        "Frais au-delà d’un rayon : à formaliser (FAQ + conditions) pour qualifier.",
        "Moins de concurrence qu’en zone dense : SEO/Maps peut performer vite avec de bonnes pages.",
      ],
    },
    seasonality: [
      "Pensions/pet-sitting : pics vacances scolaires (prévoir pages & Ads saisonnières).",
      "Toilettage/éducation : pics avant week-ends / périodes “rentrée”.",
    ],
  };
};

const getServicePlaybook = (s: any, zk: ZoneKey, townName: string) => {
  const key = (s?.slug || serviceKey || "") as string;

  // Par service : des angles + sections variables différentes
  if (key.includes("seo") || key.includes("maps")) {
    return {
      angleTitle: `Ce qui fait la différence en SEO local à ${townName}`,
      angleBullets: [
        "Pages ultra ciblées : une intention locale = une page (service + ville + preuves).",
        "Google Business Profile : catégories/services/zones + posts + FAQ + conversions.",
        "Cohérence NAP + maillage interne (ville ↔ zone ↔ métiers ↔ services).",
      ],
      stepsTitle: "Plan de déploiement (30 jours)",
      steps: [
        { t: "Semaine 1", d: "Audit + priorités locales + structure des pages (ville/services/métiers)." },
        { t: "Semaine 2", d: "Optimisation GBP + création des pages “money” + tracking appels/formulaires." },
        { t: "Semaine 3", d: "Maillage interne + FAQ locale + preuves (micro-cas / livrables)." },
        { t: "Semaine 4", d: "Optimisations : titles/metas, CTA, vitesse, et itérations sur requêtes gagnables." },
      ],
      queryExamples: [
        `SEO local ${townName}`,
        `Google Maps ${townName} avis`,
        `pros animaux ${townName} près de moi`,
        `service + ${townName} (intention forte)`,
      ],
      kpis: [
        { label: "Appels / formulaires", value: "↑ leads qualifiés (tracking)", note: "clic-to-call + formulaires" },
        { label: "Visibilité Maps", value: "↑ impressions / actions", note: "itinéraires / appels" },
        { label: "Positions locales", value: "↑ sur requêtes ciblées", note: "ville + service/métier" },
        { label: "Taux de conversion", value: "↑ via pages dédiées", note: "CTA + FAQ + preuves" },
      ] as MiniKpi[],
    };
  }

  if (key.includes("google-ads") || key.includes("ads-search") || key.includes("search")) {
    return {
      angleTitle: `Google Ads à ${townName} : éviter les leads parasites`,
      angleBullets: [
        "Structure par intention (service + ville) + annonces adaptées + extensions d’appel.",
        "Listes de mots-clés négatifs (anti demandes hors zone / hors cible).",
        "Landing page locale dédiée (preuve + CTA) + tracking propre.",
      ],
      stepsTitle: "Plan de déploiement (14 jours)",
      steps: [
        { t: "Jours 1–2", d: "Audit & collecte : offres, zones couvertes, contraintes, objectifs CPL." },
        { t: "Jours 3–5", d: "Structure campagnes + mots-clés + négatifs + annonces + extensions." },
        { t: "Jours 6–10", d: "Landing page locale + tracking (appels, formulaires, UTMs)." },
        { t: "Jours 11–14", d: "Optimisations : requêtes réelles, exclusions, annonces, taux de conv." },
      ],
      queryExamples: [
        `${townName} + devis`,
        `${townName} + urgence`,
        `service + ${townName} prix`,
        `réservation + ${townName}`,
      ],
      kpis: [
        { label: "Coût / lead", value: "↓ via négatifs + LP", note: "pilotage au CPL" },
        { label: "Taux de conv.", value: "↑ LP locale", note: "preuves + FAQ + CTA" },
        { label: "Qualité leads", value: "↑", note: "filtrage zone/besoin" },
        { label: "Appels", value: "↑", note: "extensions + clic-to-call" },
      ] as MiniKpi[],
    };
  }

  if (key.includes("meta") || key.includes("facebook") || key.includes("instagram")) {
    return {
      angleTitle: `Meta Ads à ${townName} : générer de la demande qualifiée`,
      angleBullets: [
        "Angles de confiance (preuves alternatives) + créatifs type UGC.",
        "Ciblage local (rayon/communes) + retargeting visiteurs/engagés.",
        "Formulaire qualifiant : ville, besoin, urgence, budget (anti volume inutile).",
      ],
      stepsTitle: "Plan de déploiement (21 jours)",
      steps: [
        { t: "Semaine 1", d: "Messages/angles + créatifs + setup tracking (Pixel/événements)." },
        { t: "Semaine 2", d: "Tests audiences + tests créas + formulaires qualifiants." },
        { t: "Semaine 3", d: "Optimisations : coût lead, qualité, retargeting + pages locales." },
      ],
      queryExamples: [
        `avant/après ${townName} (preuve)`,
        `rdv rapide ${townName}`,
        `proche de moi ${townName}`,
        `service animaux ${townName}`,
      ],
      kpis: [
        { label: "Coût / lead", value: "↓ via qualif", note: "questions + retargeting" },
        { label: "Taux de qualif", value: "↑", note: "ville/besoin/urgence" },
        { label: "RDV", value: "↑", note: "nurture + relances" },
        { label: "CTR", value: "↑", note: "UGC + angles confiance" },
      ] as MiniKpi[],
    };
  }

  if (key.includes("landing") || key.includes("conversion")) {
    return {
      angleTitle: `Landing page locale à ${townName} : convertir (pas juste “informer”)`,
      angleBullets: [
        "Structure conversion : promesse → preuve → process → FAQ → CTA.",
        "Blocs variables selon la ville (zones couvertes, contraintes, saisonnalité).",
        "Optimisation mobile + vitesse + tracking clic-to-call/form.",
      ],
      stepsTitle: "Plan de déploiement (10 jours)",
      steps: [
        { t: "Jours 1–2", d: "Message principal + objections + offres + zones couvertes." },
        { t: "Jours 3–6", d: "Rédaction + maquette + sections variables (ville / service)." },
        { t: "Jours 7–10", d: "Tracking + QA mobile + itérations CTA/formulaire." },
      ],
      queryExamples: [
        `service ${townName} réservation`,
        `tarif ${townName}`,
        `avis ${townName}`,
        `rdv ${townName}`,
      ],
      kpis: [
        { label: "Taux de conv.", value: "↑", note: "CTA + FAQ + preuve" },
        { label: "Abandon formulaire", value: "↓", note: "moins de champs + qualif" },
        { label: "Appels", value: "↑", note: "clic-to-call visible" },
        { label: "Temps de chargement", value: "↓", note: "CWV / mobile-first" },
      ] as MiniKpi[],
    };
  }

  // tracking (fallback)
  return {
    angleTitle: `Tracking à ${townName} : relier SEO/Maps/Ads à des leads`,
    angleBullets: [
      "Plan d’événements (appels, formulaires, clics RDV) + UTMs cohérents.",
      "Attribution simple : source → page → action → lead (dashboard).",
      "Qualif : ville / besoin / urgence pour mieux piloter.",
    ],
    stepsTitle: "Plan de déploiement (7 jours)",
    steps: [
      { t: "Jours 1–2", d: "Audit tracking + plan d’événements + conventions UTMs." },
      { t: "Jours 3–4", d: "Implémentation (GA4/Matomo, events, call tracking si besoin)." },
      { t: "Jours 5–7", d: "Dashboard + QA + recommandations sur données réelles." },
    ],
    queryExamples: [
      `clic-to-call ${townName}`,
      `form_submit ${townName}`,
      `UTM campagnes ${townName}`,
      `dashboard leads ${townName}`,
    ],
    kpis: [
      { label: "Leads attribués", value: "↑", note: "source/canal clair" },
      { label: "CPL", value: "↓", note: "optimisation data-driven" },
      { label: "Taux de conv.", value: "↑", note: "pages & messages" },
      { label: "Temps de décision", value: "↓", note: "meilleure qualif" },
    ] as MiniKpi[],
  };
};

const getLocalProof = (zk: ZoneKey, s: any) => {
  const key = (s?.slug || serviceKey || "") as string;

  // Mini cas variables selon service pour éviter duplication massive
  if (key.includes("google-ads") || key.includes("search")) {
    return {
      title: "Mini cas (anonymisé) — Ads Search local",
      context:
        "Objectif : remplir des créneaux + réduire les demandes hors zone. Mise en place : campagne intention forte + landing locale + négatifs + tracking appels/form.",
      kpis: [
        { label: "CTR", value: "2,3% → 5,0%" },
        { label: "Conv. landing", value: "3,1% → 6,2%" },
        { label: "Coût / lead", value: "29€ → 18€" },
        { label: "Leads qualifiés", value: "↑ (ville / besoin filtrés)" },
      ],
      disclaimer: "Données indicatives et anonymisées. Résultats variables selon offre, concurrence et budget.",
    };
  }

  if (key.includes("seo") || key.includes("maps")) {
    return {
      title: "Mini cas (anonymisé) — SEO local & Maps",
      context:
        "Objectif : augmenter appels/itinéraires via pages locales + optimisation GBP + maillage interne (zone/ville/métier/service).",
      kpis: [
        { label: "Actions GBP", value: "+35% (appels/itinéraires)" },
        { label: "Requêtes locales", value: "↑ sur intentions ciblées" },
        { label: "Leads trackés", value: "↑ (clic-to-call + formulaires)" },
        { label: "Pages indexées", value: "↑ (cluster ville/service)" },
      ],
      disclaimer: "Données indicatives et anonymisées. Dépend du marché local et de la régularité d’optimisation.",
    };
  }

  if (key.includes("landing") || key.includes("conversion")) {
    return {
      title: "Mini cas (anonymisé) — Landing page locale",
      context:
        "Objectif : améliorer le taux de conversion des visiteurs en demandes (appels/formulaires) via message + preuve + FAQ locale + CTA.",
      kpis: [
        { label: "Taux de conv.", value: "3,4% → 6,1%" },
        { label: "Abandon form.", value: "↓ (moins de champs + qualif)" },
        { label: "Appels", value: "↑ (CTA clic-to-call)" },
        { label: "Qualité leads", value: "↑ (ville/urgence)" },
      ],
      disclaimer: "Données indicatives et anonymisées. Dépend du trafic et de l’offre.",
    };
  }

  // tracking/meta (fallback)
  return {
    title: "Mini cas (anonymisé) — Tracking & pilotage",
    context:
      "Objectif : attribuer clairement les leads (SEO/Maps/Ads), réduire le flou, et optimiser sur données fiables.",
    kpis: [
      { label: "Leads attribués", value: "↑ (source/canal clarifiés)" },
      { label: "CPL", value: "↓ (optimisations data)" },
      { label: "Temps de décision", value: "↓ (meilleure qualif)" },
      { label: "Reporting", value: "Dashboard mensuel" },
    ],
    disclaimer: "Données indicatives et anonymisées. La qualité dépend de l’implémentation et de la discipline UTM.",
  };
};

const zoneCtx = getZoneContext(zoneKey, town);
const playbook = getServicePlaybook(svc, zoneKey, town);
const proof = getLocalProof(zoneKey, svc);

// Liens vers pages métier×ville (cluster interne — utile + anti “page isolée”)
const jobEntries = Object.entries(JOBS) as Array<[string, any]>;
const relatedJobs = jobEntries
  .slice(0, 8)
  .map(([jobSlug, job]) => ({
    label: `${job.name} à ${town}`,
    href: `/zones/${slug}/${jobSlug}/`,
  }));

// Villes proches (depuis dataset zone)
const nearbyTowns = (zone?.towns as string[] | undefined)?.length
  ? (zone.towns as string[])
      .filter((t) => slugifyCity(t) !== slug)
      .slice(0, 10)
      .map((t) => ({ name: t, href: `/zones/${slugifyCity(t)}/` }))
  : [];

// FAQ : mix service + zone (variations)
const faq: FaqItem[] = [
  {
    q: `Pourquoi ${svc.name} est pertinent à ${town} ?`,
    a: `Parce que les recherches locales sont très “intentionnelles” : la personne veut appeler / réserver / demander un RDV. Une page dédiée “${svc.name} à ${town}” + tracking améliore la conversion.`,
  },
  {
    q: `Quel rayon d’intervention afficher autour de ${town} ?`,
    a: `On recommande : ${zoneCtx.travel.radius}. L’objectif est d’éviter les demandes hors secteur et de coller à vos déplacements réels (liste de communes + conditions).`,
  },
  {
    q: "Parking / circulation : est-ce un vrai sujet ?",
    a: zoneKey === ("val-doise-95" as any)
      ? "Oui : en zone dense, la circulation et le stationnement impactent l’agenda. On adapte la promesse (RDV/prise de contact), et on qualifie mieux les demandes."
      : "Ça dépend de votre zone : on clarifie les communes couvertes et on évite d’ouvrir trop large. Une zone maîtrisée = meilleurs leads.",
  },
  {
    q: "Combien de temps pour voir des résultats ?",
    a: "En général : Ads = plus rapide (jours/semaines). SEO/Maps = durable (semaines/mois). On accélère via pages ultra ciblées + GBP + tracking propre.",
  },
  {
    q: "Comment prouver l’impact (sans “avis”) ?",
    a: "Avec des preuves alternatives : livrables visibles, mini cas anonymisés, et tracking (clic-to-call, formulaires, UTMs, événements analytics + dashboard).",
  },
];

const title = `${svc.name} à ${town} – Pros animaux (${zone.name}) | Horizon Conversion`;
const description = `${svc.name} à ${town} : ${svc.headline} Zone : ${zone.name}. Tracking inclus pour relier SEO/Maps/Ads aux leads.`;

const breadcrumbs = [
  { name: "Accueil", item: `${baseUrl}/` },
  { name: "Zones", item: `${baseUrl}/zones/` },
  { name: zone.name, item: `${baseUrl}/zones/${zoneKey}/` },
  { name: town, item: `${baseUrl}/zones/${slug}/` },
  { name: svc.name, item: canonical },
];

const jsonLd = [
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    name: title,
    url: canonical,
    description,
    isPartOf: { "@type": "WebSite", name: "Horizon Conversion Animaux", url: baseUrl },
  },
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: breadcrumbs.map((b, i) => ({
      "@type": "ListItem",
      position: i + 1,
      name: b.name,
      item: b.item,
    })),
  },
  {
    "@context": "https://schema.org",
    "@type": "Service",
    name: `${svc.name} à ${town}`,
    serviceType: svc.name,
    areaServed: [town, zone.name],
    provider: {
      "@type": "Organization",
      name: "Horizon Conversion Animaux",
      url: baseUrl,
      telephone: "+33660921008",
      email: "contact@horizon-conversion.fr",
    },
  },
  {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    mainEntity: faq.map((f) => ({
      "@type": "Question",
      name: f.q,
      acceptedAnswer: { "@type": "Answer", text: f.a },
    })),
  },
];
---

<LayoutSEO
  title={title}
  description={description}
  baseUrl={baseUrl}
  canonical={canonical}
  ogType="website"
  ogImage={`${baseUrl}/og/ville-service-${slug}-${serviceKey}.jpg`}
  ogImageAlt={`${svc.name} à ${town} – Horizon Conversion Animaux`}
  breadcrumbs={breadcrumbs}
  jsonLd={jsonLd}
>
  <style>
    :global(body){margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;color:#0f172a;background:#fff}
    .wrap{max-width:1040px;margin:0 auto;padding:28px 16px 72px}
    .breadcrumbs{font-size:14px;color:#475569;margin:4px 0 18px}
    .breadcrumbs a{color:inherit;text-decoration:none}
    header.hero{border:1px solid #e2e8f0;border-radius:18px;background:linear-gradient(180deg,#f8fafc,#fff);padding:22px;display:grid;gap:10px}
    h1{margin:0;font-size:34px;line-height:1.1;letter-spacing:-0.02em}
    .sub{margin:0;color:#334155;max-width:95ch;line-height:1.6}

    .grid{margin-top:18px;display:grid;grid-template-columns:1.15fr .85fr;gap:18px;align-items:start}
    @media (max-width:920px){.grid{grid-template-columns:1fr}}

    .card{border:1px solid #e2e8f0;border-radius:18px;padding:18px;background:#fff;box-shadow:0 6px 20px rgba(15,23,42,.06)}
    h2{margin:0 0 10px;font-size:18px}
    h3{margin:16px 0 10px;font-size:15px}
    p{margin:0;color:#334155;line-height:1.6}
    ul{margin:10px 0 0;padding-left:18px;color:#334155;line-height:1.55}

    .badge{display:inline-block;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #e2e8f0;background:#f1f5f9;color:#334155;font-weight:900;width:fit-content}

    .pills{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .pill{display:inline-block;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #e2e8f0;background:#fff;color:#334155;text-decoration:none}
    .pill:hover{background:#f8fafc;border-color:#cbd5e1}

    .note{margin-top:12px;border:1px dashed #cbd5e1;border-radius:16px;padding:14px;background:#f8fafc;color:#334155;line-height:1.6}

    .miniGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px}
    @media (max-width:720px){.miniGrid{grid-template-columns:1fr}}
    .miniCard{border:1px solid #e2e8f0;border-radius:16px;background:#fff;padding:14px}
    .miniCard strong{display:block;font-size:13px;margin-bottom:6px}
    .meta{color:#64748b;font-size:13px;line-height:1.6}

    .kpi{border:1px solid #e2e8f0;border-radius:16px;background:#f8fafc;padding:12px}
    .kpi strong{display:block;font-size:13px}
    .kpi span{display:block;font-size:12px;color:#64748b;margin-top:2px}

    .steps{display:grid;gap:10px;margin-top:10px}
    .step{border:1px solid #e2e8f0;border-radius:16px;padding:12px 14px;background:#fff}
    .step b{display:block;font-size:13px}
    .step div{color:#64748b;font-size:13px;line-height:1.6;margin-top:4px}

    .ctaRow{margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.ctaRow{grid-template-columns:1fr}}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 14px;border-radius:14px;border:1px solid #0f172a;background:#0f172a;color:#fff;font-weight:900;text-decoration:none}
    .btn.secondary{background:#fff;color:#0f172a}

    .faq{margin-top:16px}
    .faq details{border:1px solid #e2e8f0;border-radius:16px;padding:12px 14px;background:#fff;margin-bottom:10px}
    .faq summary{cursor:pointer;font-weight:900}
    .faq p{margin:10px 0 0}

    .link{color:#0f172a;text-decoration:none;border-bottom:1px solid rgba(15,23,42,.18)}
    .link:hover{border-bottom-color:rgba(15,23,42,.45)}
  </style>

  <div class="wrap">
    <nav class="breadcrumbs" aria-label="Fil d’Ariane">
      <a href="/">Accueil</a> <span aria-hidden="true">›</span>{" "}
      <a href="/zones/">Zones</a> <span aria-hidden="true">›</span>{" "}
      <a href={`/zones/${zoneKey}/`}>{zone.name}</a> <span aria-hidden="true">›</span>{" "}
      <a href={`/zones/${slug}/`}>{town}</a> <span aria-hidden="true">›</span>{" "}
      <span>{svc.name}</span>
    </nav>

    <header class="hero">
      <span class="badge">{svc.badge}</span>
      <h1>{svc.name} à {town}</h1>
      <p class="sub">
        {svc.headline} Zone : <strong>{zone.name}</strong>. Page locale avec contenu variable (zone + service)
        pour éviter l’effet “template”. Tracking inclus : <strong>appels</strong>, <strong>formulaires</strong>, <strong>sources</strong>.
      </p>
    </header>

    <section class="grid">
      <div class="card">
        <h2>Ce que vous obtenez (livrables)</h2>
        <ul>{svc.deliverables.map((d: string) => <li>{d}</li>)}</ul>

        <h2 style="margin-top:16px;">{playbook.angleTitle}</h2>
        <ul>
          {playbook.angleBullets.map((x: string) => <li>{x}</li>)}
        </ul>

        <div class="note">
          <strong>{zoneCtx.density} :</strong> {zoneCtx.intro}<br />
          <span class="meta">Rayon conseillé : {zoneCtx.travel.radius}</span>
        </div>

        <h3>Déplacements / contraintes autour de {town}</h3>
        <div class="miniGrid">
          <div class="miniCard">
            <strong>À clarifier sur la page</strong>
            <div class="meta">
              Communes couvertes, rayon, conditions éventuelles (frais au-delà d’un rayon), et
              une question “ville” dans le formulaire pour qualifier.
            </div>
          </div>
          <div class="miniCard">
            <strong>Points d’attention ({zone.name})</strong>
            <ul style="margin:8px 0 0;padding-left:18px;">
              {zoneCtx.travel.notes.map((x: string) => <li>{x}</li>)}
            </ul>
          </div>
        </div>

        <h2 style="margin-top:16px;">Mini cas local (anonymisé) + KPIs</h2>
        <p class="meta" style="margin-top:0">{proof.context}</p>
        <div class="miniGrid" aria-label="KPIs">
          {proof.kpis.map((k: any) => (
            <div class="kpi">
              <strong>{k.label}</strong>
              <span>{k.value}</span>
            </div>
          ))}
        </div>
        <div class="note" style="margin-top:10px;">
          <strong>Note :</strong> {proof.disclaimer}
        </div>

        <h2 style="margin-top:16px;">{playbook.stepsTitle}</h2>
        <div class="steps" aria-label="Plan">
          {playbook.steps.map((s: any) => (
            <div class="step">
              <b>{s.t}</b>
              <div>{s.d}</div>
            </div>
          ))}
        </div>

        <h3>Exemples de requêtes / intentions autour de {town}</h3>
        <div class="pills" aria-label="Exemples requêtes">
          {playbook.queryExamples.map((q: string) => <span class="pill">{q}</span>)}
        </div>

        <div class="ctaRow">
          <a class="btn" href="/contact/">Demander un diagnostic</a>
          <a class="btn secondary" href="tel:+33660921008">Appeler : 06 60 92 10 08</a>
        </div>

        <div class="faq" id="faq">
          <h2 style="margin:0 0 10px;">FAQ locale (zone + service)</h2>
          {faq.map((f: FaqItem) => (
            <details>
              <summary>{f.q}</summary>
              <p>{f.a}</p>
            </details>
          ))}
        </div>
      </div>

      <aside class="card">
        <h2>KPIs suivis</h2>
        <p class="meta" style="margin-top:0">On pilote sur des métriques simples, reliées au business.</p>
        <div class="pills" aria-label="KPIs">
          {(svc.kpis || []).map((k: string) => <span class="pill">{k}</span>)}
        </div>

        <h2 style="margin-top:16px;">KPIs “cibles” (selon service)</h2>
        <div class="miniGrid" aria-label="KPIs cibles">
          {playbook.kpis.map((k: MiniKpi) => (
            <div class="kpi">
              <strong>{k.label}</strong>
              <span>{k.value}{k.note ? ` — ${k.note}` : ""}</span>
            </div>
          ))}
        </div>

        <h2 style="margin-top:16px;">À associer (cluster interne)</h2>
        <p class="meta" style="margin-top:0">
          Pages métier × {town} (intention forte) :
        </p>
        <ul>
          {relatedJobs.slice(0, 6).map((x) => (
            <li><a class="link" href={x.href}>{x.label}</a></li>
          ))}
        </ul>

        {nearbyTowns.length > 0 && (
          <>
            <h2 style="margin-top:16px;">{zoneCtx.nearbyLabel}</h2>
            <div class="pills" aria-label="Villes proches">
              {nearbyTowns.map((t) => <a class="pill" href={t.href}>{t.name}</a>)}
            </div>
          </>
        )}

        <h2 style="margin-top:16px;">Raccourcis</h2>
        <div class="pills" aria-label="Raccourcis">
          <a class="pill" href={`/zones/${slug}/`}>Page ville</a>
          <a class="pill" href={`/zones/${zoneKey}/`}>Hub zone</a>
          <a class="pill" href={`/prestations/${svc.prestationSlug}/`}>Prestation</a>
          <a class="pill" href="/tarifs/">Tarifs</a>
        </div>

        <div class="note" style="margin-top:12px;">
          <strong>Saisonnalité :</strong>
          <ul style="margin:8px 0 0;padding-left:18px;">
            {zoneCtx.seasonality.map((x: string) => <li>{x}</li>)}
          </ul>
        </div>
      </aside>
    </section>
  </div>
</LayoutSEO>