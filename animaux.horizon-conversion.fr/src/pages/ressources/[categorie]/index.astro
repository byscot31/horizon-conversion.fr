---
// src/pages/ressources/[categorie]/index.astro
import LayoutSeo from "../../../layouts/LayoutSEO.astro";
import { getCollection } from "astro:content";

const safeArray = (v) => (Array.isArray(v) ? v : []);
const stripHtml = (s) => String(s ?? "").replace(/<[^>]*>/g, "").trim();

// Labels humains du serviceType
const SERVICE_TYPE_LABEL = {
  "seo-local": "SEO local",
  "google-ads": "Google Ads",
  "google-business-profile": "Google Business Profile",
  "tracking-conversions": "Tracking & conversions",
  "page-conversion": "Page de conversion",
  "pages-locales": "Pages locales",
};

const PRESTATION_SLUGS = new Set(Object.keys(SERVICE_TYPE_LABEL));

export async function getStaticPaths() {
  const entries = await getCollection("ressources");
  const hubs = entries.filter((e) => e.id.startsWith("hub_ressources_"));

  return hubs
    .map((e) => {
      const categorie = e.data?.categorySlug ?? e.id.replace(/^hub_ressources_/, "");
      if (!categorie) return null;
      return { params: { categorie } };
    })
    .filter(Boolean);
}

// load hub via params
const categorie = Astro.params.categorie;

const entries = await getCollection("ressources");
const hub =
  entries.find((e) => {
    if (!e.id.startsWith("hub_ressources_")) return false;
    const cat = e.data?.categorySlug ?? e.id.replace(/^hub_ressources_/, "");
    return cat === categorie;
  }) ?? null;

if (!hub) throw new Error(`Missing category hub: ${categorie}`);

const page = hub.data;

// SEO
const title = page.metaTitle ?? `Ressources | ${stripHtml(page.pageTitleH1) || "Catégorie"}`;
const description = page.metaDescription ?? "";

// items attendu: [{ title, description, href, label? }]
const items = safeArray(page.items);

// related prestations (optionnel)
const relatedPrestations = safeArray(page.relatedPrestations);

// FAQ optionnelle
const faqs = page.faqs ?? null;

// Breadcrumbs (pour JSON-LD + UI)
const categoryLabel = page.breadcrumbLabel ?? (stripHtml(page.pageTitleH1) || categorie);
const breadcrumbs = [
  { label: "Ressources", href: "/ressources/" },
  { label: categoryLabel, href: `/ressources/${categorie}/` },
];

// ---------------- SchemaType AUTO (catégorie => Service si elle mappe sur une prestation) ----------------

// explicite > inférence
const inferredPrestationSlug =
  page.prestationSlug ??
  (PRESTATION_SLUGS.has(page.categorySlug ?? categorie) ? (page.categorySlug ?? categorie) : null);

const schemaType = page.schemaType ?? (inferredPrestationSlug ? "service" : "page");

// Service data auto (seulement si schemaType=service)
const service =
  schemaType === "service"
    ? {
      serviceType: SERVICE_TYPE_LABEL[inferredPrestationSlug] ?? inferredPrestationSlug ?? "Webmarketing local",
      name: page.service?.name ?? (stripHtml(page.pageTitleH1) || categoryLabel || "Service"),
    }
    : null;
---

<LayoutSeo
    title={title}
    description={description}
    schemaType={schemaType}
    pageTitleH1={page.pageTitleH1 ?? "Ressources"}
    breadcrumbs={breadcrumbs}
    faqs={faqs}
    service={service}
>
  <!-- Page Title -->
  <section class="page-title page-title-parallax parallax scroll-detect dark include-header">
    <img src="/assets/images/page-title.jpg" class="parallax-bg" alt={page.pageTitleALT ?? ""} />
    <div class="container">
      <div class="page-title-row pt-5 pb-3">

        <div class="page-title-content">
          <h1 style="font-size: 40px; line-height: 1.2; font-weight: 700; text-shadow: 1px 1px 1px rgba(0,0,0,0.5);">
            <Fragment set:html={page.pageTitleH1 ?? ""} />
          </h1>
          <span class="fw-light d-none d-md-block" style="font-size: 16px; opacity: .85; max-width: 720px;">
            {page.pageTitleLead ?? ""}
          </span>

          <div class="d-flex flex-wrap align-items-center gap-3 mt-4">
            <a href={page.cta?.buttonHref ?? "/contact/"} class="button button-large button-rounded ms-0" data-cta="1">
              {page.cta?.buttonLabel ?? "Mini-audit (15 min)"}
            </a>
            <a href="tel:+33660921008" class="button button-large button-rounded button-border button-white button-light ms-0" data-cta="1">
              Appeler : 06 60 92 10 08
            </a>
          </div>

          {!!page.proofs?.length && (
              <div class="row mt-4" style="max-width: 820px;">
                {page.proofs.slice(0, 3).map((p) => (
                    <div class="col-md-4">
                      <div style="background: rgba(0,0,0,.35); padding: 12px 14px; border-radius: 12px;">
                        <strong>{p.title}</strong>
                        <br /><small style="opacity:.85;">{p.subtitle}</small>
                      </div>
                    </div>
                ))}
              </div>
          )}
        </div>

        <nav aria-label="breadcrumb" class="d-none d-lg-block">
          <ol class="breadcrumb" style="--bs-breadcrumb-divider: '&#62;';">
            <li class="breadcrumb-item">
              <a href="/"><i class="uil uil-home"></i></a>
            </li>
            <li class="breadcrumb-item">
              <a href="/ressources/">Ressources</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
              {categoryLabel}
            </li>
          </ol>
        </nav>

      </div>
    </div>
  </section>

  <section class="section m-0" style="background-color:#eef2f5;">
    <div class="container">

      <div class="heading-block text-center border-bottom-0 mb-5 mt-4 mx-auto" style="max-width: 760px">
        <h2 class="text-transform-none font-secondary fw-normal" style="font-size: 32px;">
          {page.listTitle ?? "Articles & guides"}
        </h2>
        <span>{page.listLead ?? ""}</span>
      </div>

      <div class="row g-4">
        {items.map((it) => (
            <div class="col-lg-4">
              <div class="card border-light shadow-sm h-100">
                <div class="card-body">
                  <h3 class="text-transform-none ls-0 fw-semibold mb-2">{it.title}</h3>
                  <p class="mb-3">{it.description}</p>
                  <a class="button-link border-0 color" href={it.href} data-cta="1">
                    {it.label ?? "Lire"}
                  </a>
                </div>
              </div>
            </div>
        ))}
      </div>

      {!!relatedPrestations.length && (
          <>
            <div class="line my-5"></div>
            <div class="heading-block text-center border-bottom-0 mb-4 mx-auto" style="max-width: 760px">
              <h2 class="text-transform-none font-secondary fw-normal" style="font-size: 32px;">
                {page.relatedPrestationsTitle ?? "Besoin d’aide pour le mettre en place ?"}
              </h2>
              <span>{page.relatedPrestationsLead ?? ""}</span>
            </div>

            <div class="row g-4">
              {relatedPrestations.map((p) => (
                  <div class="col-lg-6">
                    <div class="feature-box media-box fbox-bg h-100">
                      <div class="fbox-content border-0">
                        <h3 class="text-transform-none ls-0 fw-semibold">{p.title}</h3>
                        <p class="mb-0">{p.description}</p>
                        <a class="button-link border-0 color" href={p.href} data-cta="1">
                          {p.label ?? "Voir"}
                        </a>
                      </div>
                    </div>
                  </div>
              ))}
            </div>
          </>
      )}
    </div>
  </section>

</LayoutSeo>
