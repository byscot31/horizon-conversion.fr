---
// src/pages/ressources/[categorie]/[article].astro
import LayoutSeo from "../../../layouts/LayoutSEO.astro";
import { getCollection } from "astro:content";

// Helpers
const safeArray = (v) => (Array.isArray(v) ? v : []);
const stripHtml = (s) => String(s ?? "").replace(/<[^>]*>/g, "").trim();

// Labels humains du serviceType
const SERVICE_TYPE_LABEL = {
  "seo-local": "SEO local",
  "google-ads": "Google Ads",
  "google-business-profile": "Google Business Profile",
  "tracking-conversions": "Tracking & conversions",
  "page-conversion": "Page de conversion",
  "pages-locales": "Pages locales",
};

// Slugs prestations connus
const PRESTATION_SLUGS = new Set(Object.keys(SERVICE_TYPE_LABEL));

// Build static paths
export async function getStaticPaths() {
  const entries = await getCollection("ressources");

  const posts = entries.filter(
    (e) =>
      e.id.startsWith("ressource_") ||
      String(e.data?.key ?? "").startsWith("ressource:")
  );

  return posts
    .map((e) => {
      const categorie = e.data?.categorySlug ?? null;
      const article = e.data?.slug ?? e.id.replace(/^ressource_/, "");
      if (!categorie || !article) return null;
      return { params: { categorie, article } };
    })
    .filter(Boolean);
}

// Load current post via params
const categorie = Astro.params.categorie;
const article = Astro.params.article;

const entries = await getCollection("ressources");
const post =
  entries.find((e) => {
    const cat = e.data?.categorySlug ?? null;
    const slug = e.data?.slug ?? e.id.replace(/^ressource_/, "");
    return cat === categorie && slug === article;
  }) ?? null;

if (!post) throw new Error(`Missing ressource: ${categorie}/${article}`);

const page = post.data;

// SEO
const title = page.metaTitle ?? page.title ?? "Ressource";
const description = page.metaDescription ?? page.excerpt ?? "";

// Content
const sections = safeArray(page.sections);

// Links blocks (si présents)
const links = page.links ?? {};
const inCategory = safeArray(links.inCategory);
const goFurther = safeArray(links.goFurther);
const contextLinks = safeArray(links.context);

// Breadcrumbs (optionnel dans le JSON article)
const extraBreadcrumbs = safeArray(page.breadcrumbs);

// Label / H1
const h1 = page.pageTitleH1 ?? page.title ?? "";
const breadcrumbLabel = page.breadcrumbLabel ?? stripHtml(h1) ?? page.title ?? article;

// Category label
const categoryLabel = page.categoryLabel ?? categorie;

// Breadcrumbs finals pour LayoutSEO/JSON-LD
const finalBreadcrumbs = [
  { label: "Ressources", href: "/ressources/" },
  { label: categoryLabel, href: `/ressources/${categorie}/` },
  ...extraBreadcrumbs
    .map((b) => ({ label: b.label ?? "", href: b.href ?? "/" }))
    .filter((b) => b.label),
];

// FAQ optionnelle
const faqs = page.faqs ?? null;

// ---------------- SchemaType AUTO (article => Service si lié à une prestation) ----------------

// Règle hybride : explicite > inférence via categorySlug
const inferredPrestationSlug =
  page.prestationSlug ??
  (PRESTATION_SLUGS.has(page.categorySlug ?? categorie)
    ? (page.categorySlug ?? categorie)
    : null);

// SchemaType final (tu peux forcer via page.schemaType si tu veux)
const schemaType = page.schemaType ?? (inferredPrestationSlug ? "service" : "page");

// Service data auto (enrichit JsonLd) — seulement si schemaType=service
const service =
  schemaType === "service"
    ? {
      serviceType: SERVICE_TYPE_LABEL[inferredPrestationSlug] ?? inferredPrestationSlug ?? "Webmarketing local",
      name: page.service?.name ?? (stripHtml(h1) || page.title || "Service"),
    }
    : null;
---

<LayoutSeo
    title={title}
    description={description}
    schemaType={schemaType}
    pageTitleH1={h1}
    breadcrumbs={finalBreadcrumbs}
    faqs={faqs}
    service={service}
>
  <!-- Page Title -->
  <section class="page-title page-title-parallax parallax scroll-detect dark include-header">
    <img
        src="/assets/images/page-title.jpg"
        class="parallax-bg"
        alt={page.pageTitleALT ?? page.title ?? ""}
    />
    <div class="container">
      <div class="page-title-row pt-5 pb-3">

        <div class="page-title-content">
          <h1 style="font-size: 40px; line-height: 1.2; font-weight: 700; text-shadow: 1px 1px 1px rgba(0,0,0,0.5);">
            <Fragment set:html={h1} />
          </h1>

          {page.pageTitleLead && (
              <span class="fw-light d-none d-md-block" style="font-size: 16px; opacity: .85; max-width: 720px;">
              {page.pageTitleLead}
            </span>
          )}
        </div>

        <nav aria-label="breadcrumb" class="d-none d-lg-block">
          <ol class="breadcrumb" style="--bs-breadcrumb-divider: '&#62;';">
            <li class="breadcrumb-item">
              <a href="/"><i class="uil uil-home"></i></a>
            </li>

            <li class="breadcrumb-item">
              <a href="/ressources/">Ressources</a>
            </li>

            <li class="breadcrumb-item">
              <a href={`/ressources/${categorie}/`}>{categoryLabel}</a>
            </li>

            {extraBreadcrumbs.map((b) => (
                <li class="breadcrumb-item">
                  <a href={b.href ?? "/"}>{b.label ?? ""}</a>
                </li>
            ))}

            <li class="breadcrumb-item active" aria-current="page">{breadcrumbLabel}</li>
          </ol>
        </nav>

      </div>
    </div>
  </section>

  <section id="content">
    <div class="content-wrap pt-0">
      <div class="container mt-6">
        <div class="row justify-content-center">
          <div class="col-lg-8">

            {page.intro && (
                <div class="mb-4">
                  <Fragment set:html={page.intro} />
                </div>
            )}

            {sections.map((s) => (
                <section class="mb-5">
                  {s.h2 && (
                      <h2 class="text-transform-none font-secondary fw-normal" style="font-size: 30px;">
                        {s.h2}
                      </h2>
                  )}

                  {s.lead && <p class="mb-3">{s.lead}</p>}

                  {s.html && (
                      <div class="mb-3">
                        <Fragment set:html={s.html} />
                      </div>
                  )}

                  {!!safeArray(s.items).length && (
                      <ul class="iconlist my-3">
                        {safeArray(s.items).map((li) => (
                            <li class="d-block"><i class="bi-check-lg me-1"></i> {li}</li>
                        ))}
                      </ul>
                  )}
                </section>
            ))}

          </div>

          <div class="col-lg-4">
            <div class="sticky-top" style="top: 90px;">

              {(inCategory.length > 0) && (
                  <div class="card border-light shadow-sm mb-3">
                    <div class="card-body">
                      <h3 class="text-transform-none ls-0 fw-semibold mb-2">Dans la même catégorie</h3>
                      <ul class="list-unstyled mb-0">
                        {inCategory.map((l) => (
                            <li class="mb-2">
                              <a class="button-link border-0 color" href={l.href ?? "#"}>
                                {l.label ?? l.title ?? "Lien"}
                              </a>
                            </li>
                        ))}
                      </ul>
                    </div>
                  </div>
              )}

              {(goFurther.length > 0) && (
                  <div class="card border-light shadow-sm mb-3">
                    <div class="card-body">
                      <h3 class="text-transform-none ls-0 fw-semibold mb-2">Aller plus loin</h3>
                      <ul class="list-unstyled mb-0">
                        {goFurther.map((l) => (
                            <li class="mb-2">
                              <a class="button-link border-0 color" href={l.href ?? "#"}>
                                {l.label ?? l.title ?? "Lien"}
                              </a>
                            </li>
                        ))}
                      </ul>
                    </div>
                  </div>
              )}

              {(contextLinks.length > 0) && (
                  <div class="card border-light shadow-sm mb-3">
                    <div class="card-body">
                      <h3 class="text-transform-none ls-0 fw-semibold mb-2">Liens utiles</h3>
                      <ul class="list-unstyled mb-0">
                        {contextLinks.map((l) => (
                            <li class="mb-2">
                              <a class="button-link border-0 color" href={l.href ?? "#"}>
                                {l.label ?? l.title ?? "Lien"}
                              </a>
                            </li>
                        ))}
                      </ul>
                    </div>
                  </div>
              )}

              {page.cta?.buttonHref && (
                  <div class="card border-light shadow-sm">
                    <div class="card-body">
                      <div class="fw-semibold mb-2">{page.cta?.title ?? "Besoin d’aide ?"}</div>
                      <p class="mb-3">{page.cta?.text ?? ""}</p>
                      <a class="button button-large button-rounded w-100" href={page.cta.buttonHref} data-cta="1">
                        {page.cta?.buttonLabel ?? "Contact"}
                      </a>
                    </div>
                  </div>
              )}

            </div>
          </div>

        </div>
      </div>
    </div>
  </section>
</LayoutSeo>
