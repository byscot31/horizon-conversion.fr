---
// src/components/Header.astro
import { getCollection } from "astro:content";

const safeArray = (v) => (Array.isArray(v) ? v : []);
const byLabel = (a, b) => (a.label ?? "").localeCompare(b.label ?? "", "fr");

// --- Load collections
const site = await getCollection("site").catch(() => []);
const prestations = await getCollection("prestations").catch(() => []);
const metiers = await getCollection("metiers").catch(() => []);
const zones = await getCollection("zones").catch(() => []);
const villes = await getCollection("villes").catch(() => []);
const ressources = await getCollection("ressources").catch(() => []);

// --- Find hubs
const hubPrestations = prestations.find((e) => e.id === "hub_prestations") ?? null;
const hubMetiers = metiers.find((e) => e.id === "hub_metiers") ?? null;
const hubZones = zones.find((e) => e.id === "hub_zones") ?? null;
const hubVilles = villes.find((e) => e.id === "hub_villes") ?? null;
const hubRessources = ressources.find((e) => e.id === "hub_ressources") ?? null;

const menuAccueil = [
  { label: "Accueil", href: "/" },
  { label: "Méthode", href: "/methode/" },
  { label: "Preuves", href: "/preuves/" },
  { label: "À propos", href: "/a-propos/" },
];

// --- Menus from hubs (preferred)
const menuPrestations = safeArray(hubPrestations?.data?.prestationsBlocks?.items).map((it) => ({
  label: it.title ?? "Prestation",
  href: it.button?.href ?? "/prestations/",
}));

const menuMetiers = safeArray(hubMetiers?.data?.metiersBlocks?.items).map((it) => ({
  label: it.title ?? "Métier",
  href: it.href ?? "/metiers/",
}));

const menuZones = safeArray(hubZones?.data?.zonesBlocks?.items).map((it) => ({
  label: it.title ?? "Zone",
  href: it.button?.href ?? "/zones/",
}));

const menuVilles = safeArray(hubVilles?.data?.villesBlocks?.items).map((it) => ({
  label: it.title ?? "Ville",
  href: it.button?.href ?? "/zones/",
}));

// Ressources : catégories (hub_ressources_seo-local, hub_ressources_google-ads, etc.)
const ressourcesCats = ressources
  .filter((e) => String(e.id || "").startsWith("hub_ressources_") && e.id !== "hub_ressources")
  .map((e) => ({
    label: e.data?.breadcrumbLabel ?? e.data?.title ?? e.id.replace(/^hub_ressources_/, ""),
    href: e.data?.href ?? `/ressources/${e.data?.slug ?? e.id.replace(/^hub_ressources_/, "")}/`,
  }))
  .sort(byLabel);

const menuRessources = [
  ...(hubRessources?.data?.menuItems ? safeArray(hubRessources.data.menuItems) : []),
  ...ressourcesCats,
].filter(Boolean).sort(byLabel);

// --- Mega menu Zones: 2 colonnes (zones) + villes dessous
const zoneSlugFromZoneHref = (href) => String(href || "").match(/^\/zones\/([^/]+)\/?$/)?.[1] ?? null;
const zoneSlugFromVilleHref = (href) => String(href || "").match(/^\/zones\/([^/]+)\//)?.[1] ?? null;

const villesByZone = new Map();
for (const v of menuVilles) {
  const zs = zoneSlugFromVilleHref(v.href);
  if (!zs) continue;
  const arr = villesByZone.get(zs) ?? [];
  arr.push(v);
  villesByZone.set(zs, arr);
}
for (const [k, arr] of villesByZone.entries()) arr.sort(byLabel);

const megaZones = menuZones
  .map((z) => {
    const slug = zoneSlugFromZoneHref(z.href);
    if (!slug) return null;
    return { label: z.label, href: z.href, villes: villesByZone.get(slug) ?? [] };
  })
  .filter(Boolean);

// Assure 2 colonnes max (si tu as plus de zones un jour, tu ajusteras)
const megaZones2 = megaZones.slice(0, 2);
---

<header id="header" class="transparent-header dark" data-sticky-class="not-dark">
  <div id="header-wrap">
    <div class="container">
      <div class="header-row">
        <div id="logo">
          <a href="/"><img class="logo-default" src="/assets/images/logo.png" alt="Logo" /></a>
        </div>

        <div class="primary-menu-trigger">
          <button class="cnvs-hamburger" type="button" title="Open Mobile Menu">
            <span class="cnvs-hamburger-box"><span class="cnvs-hamburger-inner"></span></span>
          </button>
        </div>

        <nav class="primary-menu with-arrows">
          <ul class="menu-container">
            <li class="menu-item">
              <a class="menu-link" href="/"><div>Accueil</div></a>
              <ul class="sub-menu-container">
                {menuAccueil.slice(1).map((it) => (
                    <li class="menu-item">
                      <a class="menu-link" href={it.href}><div>{it.label}</div></a>
                    </li>
                ))}
              </ul>
            </li>

            <li class="menu-item">
              <a class="menu-link" href="/prestations/"><div>Prestations</div></a>
              <ul class="sub-menu-container">
                {menuPrestations.sort(byLabel).map((it) => (
                    <li class="menu-item"><a class="menu-link" href={it.href}><div>{it.label}</div></a></li>
                ))}
              </ul>
            </li>

            <li class="menu-item">
              <a class="menu-link" href="/metiers/"><div>Métiers</div></a>
              <ul class="sub-menu-container">
                {menuMetiers.sort(byLabel).map((it) => (
                    <li class="menu-item"><a class="menu-link" href={it.href}><div>{it.label}</div></a></li>
                ))}
              </ul>
            </li>

            <li class="menu-item mega-menu">
              <a class="menu-link" href="/zones/"><div>Zones</div></a>
              <div class="mega-menu-content mega-menu-style-2">
                <div class="container">
                  <div class="row">
                    {megaZones2.map((z) => (
                        <ul class="sub-menu-container mega-menu-column col-lg-6">
                          <li class="menu-item mega-menu-title">
                            <a class="menu-link" href={z.href}><div>{z.label}</div></a>
                            <ul class="sub-menu-container">
                              {z.villes.map((v) => (
                                  <li class="menu-item">
                                    <a class="menu-link" href={v.href}><div>{v.label}</div></a>
                                  </li>
                              ))}
                            </ul>
                          </li>
                        </ul>
                    ))}
                  </div>
                </div>
              </div>
            </li>

            <li class="menu-item">
              <a class="menu-link" href="/ressources/"><div>Ressources</div></a>
              <ul class="sub-menu-container">
                {menuRessources.map((it) => (
                    <li class="menu-item"><a class="menu-link" href={it.href}><div>{it.label}</div></a></li>
                ))}
              </ul>
            </li>

            <li class="menu-item bg-color h-bg-dark px-xl-3">
              <a class="menu-link" href="/contact/"><div>Contact</div></a>
            </li>
          </ul>
        </nav>

      </div>
    </div>
  </div>
  <div class="header-wrap-clone"></div>
</header>
